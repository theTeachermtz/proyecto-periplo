<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•™</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }; document.documentElement.classList.add('dark');</script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100dvh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { Sparkles, Layers, Puzzle, Filter, Zap, Save, Edit3, ArrowLeft, Loader2, Search, CheckCircle2, Circle, Sun, Moon, Star, Eye, ChefHat, ShoppingCart } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- BASES DE DATOS DE INGREDIENTES ---
        const GRAMMAR_LIST = {
            "BASIC": ["Modal Verbs", "Simple Present", "Present Continuous", "Going To (Future)"],
            "ADVANCED": ["Simple Past", "Past Continuous", "Present Perfect", "Second Conditional"],
            "PRO": ["Present Perfect Continuous", "Past Perfect", "Mixed Conditionals", "Third Conditional", "Passive Voice"]
        };

        const SPECIAL_WORDS = [
            "WH Questions", "Coordinating Conjunctions (FANBOYS)", "Subordinating Conjunctions", 
            "Correlative Conjunctions", "Prepositions of Time", "Prepositions of Place", 
            "Prepositions of Movement / Direction", "Other Common Prepositions", "Quantifiers", 
            "Possessive Adjectives", "Possessive Nouns", "Possessive Pronouns", 
            "Object Pronouns", "Frequency Adverbs"
        ];

        const VOCAB_PACKS = [
            "Pack 1 (Daily Routine & Work)", "Pack 2 (Home & Communication)", 
            "Pack 3 (Travel & Conflict)", "Pack 4 (Business & Emotion)", 
            "Pack 5 (Action & Strategy)", "Pack 6 (Thoughts & Senses)", 
            "Pack 7 (Interactions & Science)", "Pack 8 (Corporate & Economy)", 
            "Pack 9 (Medical & Survival)"
        ];

        const ContentEditor = ({ content, onSave, title, setTitle, isEditing }) => {
            const [editableContent, setEditableContent] = useState(content);
            const [activeTab, setActiveTab] = useState('quizzes'); 
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);
            }, []);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            const handleChange = (section, index, field, value) => { const updated = { ...editableContent }; updated[section][index][field] = value; setEditableContent(updated); };
            const handleOptionChange = (quizIndex, optionIndex, value) => { const updated = { ...editableContent }; updated.quizzes[quizIndex].options[optionIndex] = value; setEditableContent(updated); };
            const handleCorrectSelection = (quizIndex, optionIndex) => { const updated = { ...editableContent }; updated.quizzes[quizIndex].correct = optionIndex; setEditableContent(updated); };
            const handleExit = () => { window.location.href = 'index.html'; };

            return (
                <div className="h-[100dvh] flex flex-col p-4 md:p-6 transition-colors">
                    <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-slate-200 dark:border-zinc-800 overflow-hidden flex flex-col flex-1 max-w-6xl mx-auto w-full">
                        <div className="bg-slate-900 dark:bg-black p-4 md:p-6 flex flex-col md:flex-row justify-between items-center text-white shrink-0 gap-4">
                            <div className="w-full md:w-auto flex justify-between items-center">
                                <div><h2 className="text-xl md:text-2xl font-black flex items-center gap-2"><Edit3/> {isEditing ? "Editar Juego Existente" : "Revisi√≥n Final"}</h2></div>
                                <button onClick={toggleTheme} className="p-2 text-yellow-400 md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                            </div>
                            <div className="flex gap-2 w-full md:w-auto justify-end">
                                <button onClick={toggleTheme} className="hidden md:block p-2 text-yellow-400 mr-2">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                <button onClick={handleExit} className="bg-slate-700 dark:bg-zinc-800 hover:bg-slate-600 px-4 py-2 rounded-xl font-bold text-sm md:text-base">Cancelar</button>
                                <button onClick={() => onSave(editableContent)} className="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-xl font-bold flex items-center gap-2 text-sm md:text-base"><Save size={18}/> {isEditing ? "ACTUALIZAR" : "GUARDAR"}</button>
                            </div>
                        </div>
                        <div className="p-4 md:p-6 space-y-4 md:space-y-6 overflow-hidden flex flex-col flex-1 bg-white dark:bg-zinc-950">
                            <div><label className="block text-[10px] md:text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase mb-1">T√≠tulo de la Actividad</label><input value={title} onChange={(e) => setTitle(e.target.value)} className="w-full text-lg md:text-xl font-bold p-3 border-2 border-slate-200 dark:border-zinc-800 bg-transparent dark:text-white rounded-xl focus:border-indigo-500 outline-none" placeholder="Ej. Connect 4: Past Perfect & Fanboys"/></div>
                            <div className="flex gap-2 border-b border-slate-200 dark:border-zinc-800 shrink-0 overflow-x-auto custom-scrollbar pb-1">{['quizzes', 'scrambled', 'speaking'].map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 font-bold capitalize border-b-4 transition-all whitespace-nowrap ${activeTab === tab ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-300'}`}>{tab} ({editableContent[tab]?.length || 0})</button>))}</div>
                            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 p-2 md:p-4 bg-slate-50 dark:bg-zinc-900 rounded-xl border border-slate-100 dark:border-zinc-800">
                                {activeTab === 'quizzes' && editableContent.quizzes.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm">
                                        <div className="flex justify-between mb-2"><span className="font-bold text-slate-400 dark:text-zinc-500">Quiz #{i+1}</span></div>
                                        <input value={item.question} onChange={(e) => handleChange('quizzes', i, 'question', e.target.value)} className="w-full p-2 mb-3 border dark:border-zinc-700 rounded font-medium text-slate-700 dark:text-zinc-200 text-sm bg-slate-50 dark:bg-zinc-900 focus:bg-white dark:focus:bg-black outline-none transition-colors"/>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">{item.options.map((opt, optIdx) => (<div key={optIdx} className={`flex items-center gap-2 p-2 rounded border ${optIdx === item.correct ? 'bg-green-50 dark:bg-green-900/30 border-green-300 dark:border-green-800' : 'bg-white dark:bg-zinc-900 border-slate-200 dark:border-zinc-700'}`}><button onClick={() => handleCorrectSelection(i, optIdx)} className="focus:outline-none shrink-0">{optIdx === item.correct ? <CheckCircle2 className="text-green-600 dark:text-green-400 w-5 h-5"/> : <Circle className="text-slate-300 dark:text-zinc-600 w-5 h-5 hover:text-slate-400"/>}</button><input value={opt} onChange={(e) => handleOptionChange(i, optIdx, e.target.value)} className="w-full text-xs font-bold bg-transparent outline-none text-slate-700 dark:text-zinc-300"/></div>))}</div>
                                    </div>
                                ))}
                                {activeTab === 'scrambled' && editableContent.scrambled.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm">
                                        <span className="font-bold text-slate-400 dark:text-zinc-500 text-xs block mb-1">Sentence #{i+1}:</span>
                                        <input value={item.text} onChange={(e) => handleChange('scrambled', i, 'text', e.target.value)} className="w-full p-2 mb-2 border dark:border-zinc-700 bg-transparent rounded font-bold text-slate-700 dark:text-zinc-200 outline-none focus:border-indigo-500"/>
                                        <span className="font-bold text-slate-400 dark:text-zinc-500 text-xs block mb-1">Translation:</span>
                                        <input value={item.translation} onChange={(e) => handleChange('scrambled', i, 'translation', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded text-slate-600 dark:text-zinc-400 italic outline-none focus:border-indigo-500"/>
                                    </div>
                                ))}
                                {activeTab === 'speaking' && editableContent.speaking.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 grid gap-2 shadow-sm">
                                        <div><span className="text-xs font-bold text-slate-400 dark:text-zinc-500">Spanish:</span><input value={item.spanish} onChange={(e) => handleChange('speaking', i, 'spanish', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded dark:text-white outline-none focus:border-indigo-500"/></div>
                                        <div><span className="text-xs font-bold text-slate-400 dark:text-zinc-500">English (Target):</span><input value={item.english} onChange={(e) => handleChange('speaking', i, 'english', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded font-bold text-blue-600 dark:text-blue-400 outline-none focus:border-indigo-500"/></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            const [gameTitle, setGameTitle] = useState("");
            
            // ESTADO PRINCIPAL DE INGREDIENTES: { "Modal Verbs": { type: "grammar", priority: 1 }, ... }
            const [ingredients, setIngredients] = useState({});
            
            const [grammarTab, setGrammarTab] = useState('BASIC');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedContent, setGeneratedContent] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(false);

            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isLoadingModels, setIsLoadingModels] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);

                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const editId = params.get('edit');
                    if (editId) {
                        setIsLoadingData(true);
                        try {
                            const docRef = doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setGeneratedContent(data.content);
                                setGameTitle(data.title);
                                setEditingId(editId);
                            } else alert("No se encontr√≥ el juego.");
                        } catch (e) { alert("Error cargando: " + e.message); } 
                        finally { setIsLoadingData(false); }
                    }
                };
                init();
            }, []);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            // L√ìGICA SUBWAY
            const toggleIngredient = (name, type) => {
                setIngredients(prev => {
                    const next = { ...prev };
                    if (next[name]) delete next[name];
                    else next[name] = { type, priority: 1 }; // Priority 1 por defecto (Evaluar Baja)
                    return next;
                });
            };

            const setPriority = (name, level) => {
                setIngredients(prev => ({ ...prev, [name]: { ...prev[name], priority: level } }));
            };

            const fetchModels = async () => {
                if (!apiKey) return alert("Ingresa tu API Key primero");
                setIsLoadingModels(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("Error conectando con Google");
                    const data = await response.json();
                    const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name);
                    setAvailableModels(validModels);
                    if (validModels.length > 0) {
                        const preferred = validModels.find(m => m.includes("gemini-2.5-flash")) || validModels.find(m => m.includes("gemini-2.0")) || validModels[0];
                        setSelectedModel(preferred);
                    }
                } catch (e) { alert("Error al buscar modelos: " + e.message); } 
                finally { setIsLoadingModels(false); }
            };

            const generateContent = async () => {
                if (!apiKey) return alert("Por favor ingresa tu API Key");
                if (!selectedModel) return alert("Por favor escanea y selecciona un modelo primero (bot√≥n lupa)");
                
                const itemsList = Object.keys(ingredients);
                if (itemsList.length === 0) return alert("Agrega al menos un ingrediente a tu bandeja.");
                
                // Clasificaci√≥n de Prioridades
                const highPrio = itemsList.filter(k => ingredients[k].priority === 3);
                const medPrio = itemsList.filter(k => ingredients[k].priority === 2);
                const lowPrio = itemsList.filter(k => ingredients[k].priority === 1);
                const contextOnly = itemsList.filter(k => ingredients[k].priority === 0);

                const totalEvaluated = highPrio.length + medPrio.length + lowPrio.length;
                if (totalEvaluated === 0) return alert("Debes asignarle al menos 1 estrella a alg√∫n ingrediente para que la IA sepa qu√© evaluar en las preguntas.");

                setIsGenerating(true);

                const prompt = `
                    You are an expert ESL test creator. Create a JSON object for an educational game.
                    We have selected specific topics. Some are just for context building, others MUST be EVALUATED (they must be the actual blank spaces or correct answers).
                    
                    EVALUATION PRIORITIES (Use these as the answers/blanks in proportional quantities):
                    - High Priority (Many questions testing these): ${highPrio.length ? highPrio.join(', ') : 'None'}
                    - Medium Priority (Some questions testing these): ${medPrio.length ? medPrio.join(', ') : 'None'}
                    - Low Priority (Few questions testing these): ${lowPrio.length ? lowPrio.join(', ') : 'None'}
                    
                    CONTEXT ONLY (Use these to build the sentences naturally, but DO NOT make them the blank spaces): 
                    ${contextOnly.length ? contextOnly.join(', ') : 'None'}
                    
                    QUESTION TYPES FOR 'quizzes' (20 total, exactly 5 of each type below):
                    1. Single Gap Fill (5 Qs): One blank space testing an evaluated topic.
                    2. Double Gap Fill (5 Qs): Two blank spaces in the same sentence. Options must be pairs separated by a slash (e.g., "went / bought").
                    3. Paragraph Sequence Fill (5 Qs): A short paragraph (3-4 sentences) with 3 blank spaces. Options must be comma-separated sequences of words representing the exact order (e.g., "on, because, went").
                    4. Coherence/Logic Completion (5 Qs): A sentence starter (e.g., "I wanted to go out although...") and the options are complete clauses where only one makes logical/grammatical sense to finish it.

                    IMPORTANT FOR 'scrambled' (15 items):
                    Generate ONE DEFINITIVE SENTENCE per item using the context/evaluated topics. NO slashes, NO multiple options. Just the correct sentence to be unscrambled.

                    IMPORTANT FOR 'speaking' (5 items):
                    Provide a Spanish prompt and the exact target English translation using the selected topics.

                    Output FORMAT (Strict JSON):
                    {
                        "quizzes": [{"question": "...", "options": ["A", "B", "C", "D"], "correct": 2, "explanation": "..."}],
                        "scrambled": [{"text": "English sentence.", "translation": "Spanish translation."}],
                        "speaking": [{"spanish": "...", "english": "..."}]
                    }
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${apiKey}`, { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) 
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(`Google Error: ${data.error.message}`);
                    if (!data.candidates?.[0]?.content) throw new Error("La IA no devolvi√≥ resultados.");
                    const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                    const json = JSON.parse(text);
                    setGeneratedContent(json);
                } catch (e) { alert("Error: " + e.message); } finally { setIsGenerating(false); }
            };

            const saveToFirebase = async (finalContent) => {
                if (!gameTitle) return alert("Ponle un t√≠tulo al juego");
                try {
                    const processedContent = {
                        ...finalContent,
                        scrambled: finalContent.scrambled.map(s => {
                            let cleanText = s.text.replace(/\//g, '').replace(/[()]/g, '');
                            cleanText = cleanText.charAt(0).toUpperCase() + cleanText.slice(1);
                            if (!cleanText.endsWith('.')) cleanText += '.';
                            return { ...s, text: cleanText, words: cleanText.split(' ').filter(w => w.trim() !== '') };
                        })
                    };

                    const params = new URLSearchParams(window.location.search);
                    const folderParam = params.get('folder');
                    const parentPath = (folderParam && folderParam !== 'undefined' && folderParam !== 'null') ? decodeURIComponent(folderParam) : '';

                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), { title: gameTitle, content: processedContent, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), { title: gameTitle, type: 'CONNECT4', content: processedContent, createdAt: serverTimestamp(), parentPath: parentPath });
                    }
                    window.location.href = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html'; 
                } catch (e) { alert("Error guardando: " + e.message); }
            };

            if (isLoadingData) return <div className="h-[100dvh] flex items-center justify-center text-slate-500 font-bold"><Loader2 className="animate-spin mr-2"/> Cargando datos del juego...</div>;
            if (generatedContent) return <ContentEditor content={generatedContent} onSave={saveToFirebase} title={gameTitle} setTitle={setGameTitle} isEditing={!!editingId} />;

            return (
                <div className="h-[100dvh] flex flex-col">
                    {/* HEADER */}
                    <div className="bg-slate-900 dark:bg-black px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center shrink-0 shadow-md z-10 gap-4">
                        <div className="flex items-center justify-between w-full md:w-auto">
                            <div className="flex items-center gap-4">
                                <button onClick={() => window.location.href='index.html'} className="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors"><ArrowLeft size={20}/></button>
                                <h1 className="text-xl font-black tracking-tight text-white flex items-center gap-2"><Sparkles className="text-blue-400 w-5 h-5"/> Connect 4 Builder</h1>
                            </div>
                            <button onClick={toggleTheme} className="p-2 text-yellow-400 md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-800 p-1.5 rounded-xl border border-slate-700 w-full md:w-auto overflow-x-auto custom-scrollbar">
                            <input type="password" placeholder="Tu API Key real..." value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-900 border border-slate-700 text-white rounded-lg px-3 py-2 text-xs font-mono text-center w-36 focus:border-blue-500 focus:outline-none"/>
                            <button onClick={fetchModels} disabled={isLoadingModels || !apiKey} className="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors shrink-0" title="Escanear Modelos">{isLoadingModels ? <Loader2 className="animate-spin" size={16}/> : <Search size={16}/>}</button>
                            {availableModels.length > 0 && (<select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)} className="bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-xs text-white max-w-[150px] outline-none">{availableModels.map(m => <option key={m} value={m}>{m.replace('models/', '')}</option>)}</select>)}
                            <button onClick={toggleTheme} className="hidden md:block p-2 text-yellow-400 shrink-0">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                    </div>
                    
                    {/* MAIN LAYOUT TIPO "SUBWAY" */}
                    <div className="flex flex-1 flex-col md:flex-row overflow-hidden bg-white dark:bg-zinc-950">
                        
                        {/* LEFT: INGREDIENTES (MEN√ö) */}
                        <div className="w-full md:w-1/2 border-b md:border-b-0 md:border-r border-slate-200 dark:border-zinc-800 flex flex-col h-1/2 md:h-full bg-slate-50 dark:bg-zinc-950/50">
                            <div className="p-4 md:p-6 border-b border-slate-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 shrink-0">
                                <h2 className="font-black text-slate-800 dark:text-white flex items-center gap-2 text-lg"><ChefHat className="text-orange-500"/> Men√∫ de Ingredientes</h2>
                                <p className="text-xs text-slate-400 dark:text-zinc-500 font-medium mt-1">Selecciona los temas que quieres incluir en el examen.</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-8 custom-scrollbar">
                                
                                {/* GRAMMAR */}
                                <div>
                                    <h3 className="font-black text-indigo-500 uppercase tracking-widest text-xs mb-3 flex items-center gap-2"><Layers size={14}/> Grammar</h3>
                                    <div className="space-y-4">
                                        {Object.entries(GRAMMAR_LIST).map(([level, items]) => (
                                            <div key={level}>
                                                <p className="text-[10px] font-bold text-slate-400 dark:text-zinc-600 mb-2">{level}</p>
                                                <div className="flex flex-wrap gap-2">
                                                    {items.map(item => {
                                                        const isSelected = !!ingredients[item];
                                                        return (
                                                            <button key={item} onClick={() => toggleIngredient(item, 'grammar')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${isSelected ? 'bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 border-indigo-300 dark:border-indigo-600' : 'bg-white dark:bg-zinc-800 border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-500'}`}>{item}</button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* SPECIAL WORDS */}
                                <div>
                                    <h3 className="font-black text-amber-500 uppercase tracking-widest text-xs mb-3 flex items-center gap-2"><Puzzle size={14}/> Special Words</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {SPECIAL_WORDS.map(item => {
                                            const isSelected = !!ingredients[item];
                                            return (
                                                <button key={item} onClick={() => toggleIngredient(item, 'special')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${isSelected ? 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 border-amber-300 dark:border-amber-600' : 'bg-white dark:bg-zinc-800 border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-500'}`}>{item}</button>
                                            )
                                        })}
                                    </div>
                                </div>

                                {/* VOCAB PACKS */}
                                <div>
                                    <h3 className="font-black text-emerald-500 uppercase tracking-widest text-xs mb-3 flex items-center gap-2"><Filter size={14}/> Vocab Packs</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {VOCAB_PACKS.map(item => {
                                            const isSelected = !!ingredients[item];
                                            return (
                                                <button key={item} onClick={() => toggleIngredient(item, 'vocab')} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${isSelected ? 'bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 border-emerald-300 dark:border-emerald-600' : 'bg-white dark:bg-zinc-800 border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-500'}`}>{item}</button>
                                            )
                                        })}
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        {/* RIGHT: BANDEJA DE EVALUACI√ìN (ESTRELLAS) */}
                        <div className="w-full md:w-1/2 bg-white dark:bg-zinc-900 flex flex-col relative h-1/2 md:h-full">
                            <div className="p-4 md:p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center shadow-sm z-10 shrink-0">
                                <div>
                                    <h3 className="font-black text-slate-800 dark:text-white flex items-center gap-2 text-lg"><ShoppingCart className="text-blue-500"/> Bandeja de Evaluaci√≥n</h3>
                                    <p className="text-xs text-slate-400 dark:text-zinc-500 font-medium mt-1">Define qu√© temas ser√°n la respuesta correcta (‚≠ê) y cu√°les solo contexto (üëÅÔ∏è).</p>
                                </div>
                                <span className="bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-zinc-300 px-3 py-1.5 rounded-full text-xs font-bold border border-slate-200 dark:border-zinc-700 shrink-0">{Object.keys(ingredients).length} Items</span>
                            </div>
                            
                            <div className="flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
                                {Object.keys(ingredients).length === 0 ? (
                                    <div className="h-full flex flex-col items-center justify-center text-slate-300 dark:text-zinc-600">
                                        <ShoppingCart size={48} className="mb-4 opacity-50"/>
                                        <p className="font-bold text-center">Tu bandeja est√° vac√≠a.</p>
                                        <p className="text-sm text-center">Selecciona ingredientes en el men√∫ izquierdo.</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 pb-32">
                                        {Object.entries(ingredients).map(([name, data]) => (
                                            <div key={name} className="flex flex-col md:flex-row md:items-center justify-between gap-3 p-4 bg-slate-50 dark:bg-zinc-950 border border-slate-200 dark:border-zinc-800 rounded-2xl">
                                                <div className="font-bold text-sm text-slate-700 dark:text-zinc-200">{name}</div>
                                                
                                                {/* CONTROL DE ESTRELLAS TIPO RADIO BUTTONS */}
                                                <div className="flex bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl overflow-hidden shrink-0 shadow-sm">
                                                    <button onClick={() => setPriority(name, 0)} className={`flex items-center justify-center px-3 py-1.5 transition-colors border-r border-slate-200 dark:border-zinc-700 ${data.priority === 0 ? 'bg-slate-200 dark:bg-zinc-700 text-slate-800 dark:text-white' : 'text-slate-400 hover:bg-slate-100 dark:hover:bg-zinc-800'}`} title="Solo usar para contexto (no evaluar)">
                                                        <Eye size={16}/>
                                                    </button>
                                                    <button onClick={() => setPriority(name, 1)} className={`flex items-center justify-center px-3 py-1.5 transition-colors border-r border-slate-200 dark:border-zinc-700 ${data.priority === 1 ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400' : 'text-slate-300 dark:text-zinc-600 hover:bg-slate-100 dark:hover:bg-zinc-800'}`} title="Prioridad Baja">
                                                        <Star size={16} className={data.priority >= 1 ? 'fill-current' : ''}/>
                                                    </button>
                                                    <button onClick={() => setPriority(name, 2)} className={`flex items-center justify-center px-3 py-1.5 transition-colors border-r border-slate-200 dark:border-zinc-700 ${data.priority === 2 ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400' : 'text-slate-300 dark:text-zinc-600 hover:bg-slate-100 dark:hover:bg-zinc-800'}`} title="Prioridad Media">
                                                        <Star size={16} className={data.priority >= 2 ? 'fill-current' : ''}/>
                                                        <Star size={16} className={data.priority >= 2 ? 'fill-current -ml-1.5' : '-ml-1.5'}/>
                                                    </button>
                                                    <button onClick={() => setPriority(name, 3)} className={`flex items-center justify-center px-3 py-1.5 transition-colors ${data.priority === 3 ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400' : 'text-slate-300 dark:text-zinc-600 hover:bg-slate-100 dark:hover:bg-zinc-800'}`} title="Prioridad Alta">
                                                        <Star size={16} className={data.priority === 3 ? 'fill-current' : ''}/>
                                                        <Star size={16} className={data.priority === 3 ? 'fill-current -ml-1.5' : '-ml-1.5'}/>
                                                        <Star size={16} className={data.priority === 3 ? 'fill-current -ml-1.5' : '-ml-1.5'}/>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {/* BOT√ìN GENERAR */}
                            <div className="absolute bottom-6 right-6 md:bottom-8 md:right-8 z-20 flex gap-2 w-[calc(100%-3rem)] md:w-auto justify-end">
                                <button onClick={() => generateContent()} disabled={isGenerating || Object.keys(ingredients).length === 0} className="w-full md:w-auto bg-slate-900 dark:bg-white text-white dark:text-zinc-900 px-6 md:px-8 py-3 md:py-4 rounded-full font-black text-base md:text-lg hover:bg-blue-600 dark:hover:bg-blue-500 dark:hover:text-white hover:scale-105 transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed shadow-2xl ring-4 ring-white dark:ring-zinc-900">
                                    {isGenerating ? <Loader2 className="animate-spin"/> : <Zap className="fill-yellow-400 dark:text-amber-500"/>} {isGenerating ? "Cocinando..." : "GENERAR JUEGO"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
