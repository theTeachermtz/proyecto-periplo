<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'firebase/firestore';
        // FIX: Agregu√© Loader2 aqu√≠
        import { 
            Sparkles, Layers, Puzzle, Filter, CheckSquare, Square, 
            ChevronDown, ChevronRight, Zap, Save, Edit3, Trash2, ArrowLeft, Loader2
        } from 'lucide-react';

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATOS EST√ÅTICOS ---
        const SPECIAL_WORDS = {
            "Connectors": ["to", "from", "until", "with", "without", "in", "on", "at", "about", "against", "because", "although", "while", "when", "instead of"],
            "Place Indicators": ["between", "next to", "behind", "in front of", "under", "above", "across from"],
            "Quantifiers": ["Plenty of", "A lot of", "Many", "Some", "A few", "None"],
            "Time Indicators": ["always", "usually", "now", "yesterday", "tomorrow", "soon", "since", "for"]
        };

        const VOCAB_PACKS = {
            "Pack 1 (Daily & Work)": [
                "wake up", "shower", "prepare", "take", "pick up", "get", "start", "work", "help", "send",
                "attend", "drive", "fill up", "review", "sell", "upload", "download", "leave", "make", "do",
                "visit", "walk", "own", "feed", "go", "see", "sleep", "bring", "buy", "lend"
            ],
            "Pack 2 (Comm & Home)": [
                "get in/out", "agree", "dance", "arrive", "practice", "say", "tell", "speak", "talk", "rest",
                "close", "write", "read", "call", "answer", "wait for", "meet", "check", "find", "look for",
                "eat", "drink", "cook", "clean", "wash", "turn on/off", "use", "brush", "finish", "know"
            ],
            "Pack 3 (Travel & Actions)": [
                "open", "confirm", "continue", "improve", "change", "break", "fix", "lose", "find out", "forget",
                "remember", "watch", "rain", "travel", "teach", "stay", "move", "return", "cancel", "steal",
                "fall", "hurt", "worry", "trust", "join", "share", "avoid", "book", "imagine", "come"
            ],
            "Pack 4 (Business & Feeling)": [
                "complain", "request", "explain", "recommend", "let know", "collect", "book", "sign", "promise", "discuss",
                "receive", "deliver", "order", "build", "repair", "design", "manage", "organize", "support",
                "follow", "verify", "celebrate", "sing", "understand", "learn", "teach", "listen", "laugh", "cry", "borrow"
            ],
            "Pack 5 (Strategy & Goals)": [
                "dream", "complete", "report", "solve", "submit", "suggest", "warn", "wonder", "choose", "plan",
                "repeat", "accomplish", "relax", "compare", "park", "plug", "carry", "pay", "switch", "push",
                "pull", "show", "save", "raise", "go down", "increase", "reduce", "fix", "hand", "reach"
            ]
        };

        const GRAMMAR_LEVELS = {
            "BASIC": [
                { id: "Modals", label: "Modal Verbs" },
                { id: "SimplePresent", label: "Simple Present" },
                { id: "PresentContinuous", label: "Present Continuous" },
                { id: "GoingTo", label: "Going to (Future)" }
            ],
            "ADVANCED": [
                { id: "SimplePast", label: "Simple Past" },
                { id: "PastContinuous", label: "Past Continuous" },
                { id: "PresentPerfect", label: "Present Perfect" },
                { id: "SecondConditional", label: "Second Conditional" }
            ],
            "PRO": [
                { id: "PresentPerfectPro", label: "Present Perfect" },
                { id: "PastPerfect", label: "Past Perfect" },
                { id: "PerfectContinuous", label: "Past/Present Perfect Cont." },
                { id: "ThirdConditional", label: "Third Conditional" }
            ]
        };

        // --- COMPONENTE EDITOR ---
        const ContentEditor = ({ content, onSave, onCancel, title, setTitle }) => {
            const [editableContent, setEditableContent] = useState(content);
            const [activeTab, setActiveTab] = useState('quizzes'); 

            const handleChange = (section, index, field, value) => {
                const updated = { ...editableContent };
                updated[section][index][field] = value;
                setEditableContent(updated);
            };

            return (
                <div className="max-w-5xl mx-auto p-6">
                    <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                        <div className="bg-slate-900 p-6 flex justify-between items-center text-white">
                            <div>
                                <h2 className="text-2xl font-black flex items-center gap-2"><Edit3/> Editor de Contenido</h2>
                                <p className="text-slate-400 text-sm">Revisa lo que gener√≥ la IA antes de guardar.</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={onCancel} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl font-bold">Cancelar</button>
                                <button onClick={() => onSave(editableContent)} className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2">
                                    <Save size={18}/> GUARDAR JUEGO
                                </button>
                            </div>
                        </div>

                        <div className="p-6 space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">T√≠tulo de la Actividad</label>
                                <input 
                                    value={title} 
                                    onChange={(e) => setTitle(e.target.value)} 
                                    className="w-full text-xl font-bold p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none"
                                    placeholder="Ej. Connect 4: Pack 1 Review"
                                />
                            </div>

                            <div className="flex gap-2 border-b border-slate-200">
                                {['quizzes', 'scrambled', 'speaking'].map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`px-4 py-2 font-bold capitalize border-b-4 transition-all ${activeTab === tab ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-slate-400'}`}
                                    >
                                        {tab} ({editableContent[tab]?.length || 0})
                                    </button>
                                ))}
                            </div>

                            <div className="h-[500px] overflow-y-auto custom-scrollbar space-y-4 p-2">
                                {activeTab === 'quizzes' && editableContent.quizzes.map((item, i) => (
                                    <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-slate-400">#{i+1}</span>
                                        </div>
                                        <input 
                                            value={item.question} 
                                            onChange={(e) => handleChange('quizzes', i, 'question', e.target.value)}
                                            className="w-full p-2 mb-2 border rounded font-mono text-sm"
                                        />
                                        <div className="grid grid-cols-3 gap-2">
                                            {item.options.map((opt, optIdx) => (
                                                <div key={optIdx} className={`p-2 rounded border text-xs ${optIdx === item.correct ? 'bg-green-100 border-green-300' : 'bg-white'}`}>
                                                    {opt}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}

                                {activeTab === 'scrambled' && editableContent.scrambled.map((item, i) => (
                                    <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <span className="font-bold text-slate-400 text-xs">#{i+1} Correct Sentence:</span>
                                        <input 
                                            value={item.text} 
                                            onChange={(e) => handleChange('scrambled', i, 'text', e.target.value)}
                                            className="w-full p-2 mb-2 border rounded font-bold text-slate-700"
                                        />
                                        <span className="font-bold text-slate-400 text-xs">Translation:</span>
                                        <input 
                                            value={item.translation} 
                                            onChange={(e) => handleChange('scrambled', i, 'translation', e.target.value)}
                                            className="w-full p-2 border rounded text-slate-600 italic"
                                        />
                                    </div>
                                ))}

                                {activeTab === 'speaking' && editableContent.speaking.map((item, i) => (
                                    <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-200 grid gap-2">
                                        <div>
                                            <span className="text-xs font-bold text-slate-400">Spanish:</span>
                                            <input value={item.spanish} onChange={(e) => handleChange('speaking', i, 'spanish', e.target.value)} className="w-full p-2 border rounded"/>
                                        </div>
                                        <div>
                                            <span className="text-xs font-bold text-slate-400">English (Target):</span>
                                            <input value={item.english} onChange={(e) => handleChange('speaking', i, 'english', e.target.value)} className="w-full p-2 border rounded font-bold"/>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [selectedGrammar, setSelectedGrammar] = useState(new Set());
            const [selectedVerbs, setSelectedVerbs] = useState(new Set());
            const [grammarTab, setGrammarTab] = useState('BASIC');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedContent, setGeneratedContent] = useState(null);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            const [gameTitle, setGameTitle] = useState("");
            const [expandedPacks, setExpandedPacks] = useState(new Set());

            const toggleGrammar = (id) => {
                const newSet = new Set(selectedGrammar);
                newSet.has(id) ? newSet.delete(id) : newSet.add(id);
                setSelectedGrammar(newSet);
            };
            const toggleVerb = (verb) => {
                const newSet = new Set(selectedVerbs);
                newSet.has(verb) ? newSet.delete(verb) : newSet.add(verb);
                setSelectedVerbs(newSet);
            };
            const togglePack = (packName) => {
                const verbs = VOCAB_PACKS[packName];
                const allSelected = verbs.every(v => selectedVerbs.has(v));
                const newSet = new Set(selectedVerbs);
                if (allSelected) verbs.forEach(v => newSet.delete(v));
                else verbs.forEach(v => newSet.add(v));
                setSelectedVerbs(newSet);
            };
            const togglePackExpansion = (packName) => {
                const newSet = new Set(expandedPacks);
                newSet.has(packName) ? newSet.delete(packName) : newSet.add(packName);
                setExpandedPacks(newSet);
            };

            const generateContent = async () => {
                if (!apiKey) return alert("Por favor ingresa tu API Key de Google Gemini");
                setIsGenerating(true);
                
                const verbs = Array.from(selectedVerbs);
                const grammar = Array.from(selectedGrammar);

                const prompt = `
                    Create JSON for an ESL Connect 4 game.
                    Verbs to use: ${verbs.join(', ')}. 
                    Grammar topics: ${grammar.join(', ')}.
                    Output JSON structure:
                    {
                        "quizzes": [{"question": "Sent...", "options": ["A/B", "C/D"], "correct": 0, "explanation": "..."}], // 20 items (Multiple choice, connect 2)
                        "scrambled": [{"text": "English sentence.", "translation": "Spanish translation."}], // 15 items (Order sentence, connect 3)
                        "speaking": [{"spanish": "...", "english": "...", "grammar": "..."}] // 5 items (Translate to win)
                    }
                    Ensure Scrambled sentences have punctuation included in the text string.
                    Keep sentences appropriate for learning level.
                `;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        }
                    );
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                    const json = JSON.parse(text);
                    setGeneratedContent(json);
                } catch (e) {
                    alert("Error generando contenido: " + e.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const saveToFirebase = async (finalContent) => {
                if (!gameTitle) return alert("Ponle un t√≠tulo al juego");
                try {
                    const processedContent = {
                        ...finalContent,
                        scrambled: finalContent.scrambled.map(s => ({
                            ...s,
                            words: s.text.split(' ').filter(w => w.trim() !== '')
                        }))
                    };

                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), {
                        title: gameTitle,
                        type: 'CONNECT4',
                        content: processedContent,
                        createdAt: serverTimestamp(),
                        parentPath: '' 
                    });
                    
                    alert("¬°Juego guardado exitosamente!");
                    window.location.href = 'index.html'; 
                } catch (e) {
                    alert("Error guardando: " + e.message);
                }
            };

            if (generatedContent) {
                return <ContentEditor content={generatedContent} onSave={saveToFirebase} onCancel={() => setGeneratedContent(null)} title={gameTitle} setTitle={setGameTitle} />;
            }

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans">
                    <div className="max-w-6xl mx-auto bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-8 text-white flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-black tracking-tight flex items-center gap-2"><Sparkles className="text-blue-400"/> Connect 4 Builder</h1>
                                <p className="text-slate-400 font-medium">Motor de Generaci√≥n con IA</p>
                            </div>
                            <input type="password" placeholder="API KEY" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs font-mono text-center w-32 focus:border-blue-500 focus:outline-none"/>
                        </div>

                        <div className="flex flex-col lg:flex-row h-[700px]">
                            
                            {/* GRAMMAR COLUMN */}
                            <div className="lg:w-1/3 border-r border-slate-100 bg-slate-50 flex flex-col">
                                <div className="p-6 border-b border-slate-100 bg-white">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><Layers className="text-indigo-500"/> Nivel Gramatical</h3>
                                    <div className="flex bg-slate-100 rounded-xl p-1 mb-4">
                                        {Object.keys(GRAMMAR_LEVELS).map(level => (
                                            <button key={level} onClick={() => setGrammarTab(level)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${grammarTab === level ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>{level}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-2">
                                        {GRAMMAR_LEVELS[grammarTab].map(item => (
                                            <button key={item.id} onClick={() => toggleGrammar(item.id)} className={`w-full text-left p-3 rounded-xl border transition-all flex justify-between items-center text-sm ${selectedGrammar.has(item.id) ? 'bg-indigo-50 border-indigo-500 text-indigo-900' : 'bg-white border-slate-200 text-slate-500'}`}>
                                                <span className="font-bold">{item.label}</span>
                                                {selectedGrammar.has(item.id) ? <CheckSquare size={18} className="text-indigo-600"/> : <Square size={18} className="text-slate-300"/>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-6 overflow-y-auto flex-1">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><Puzzle className="text-orange-500"/> Palabras Clave</h3>
                                    <div className="p-4 bg-orange-50 rounded-xl border border-orange-100 text-xs text-orange-800 italic">
                                        Lista pendiente de actualizaci√≥n. Se usar√°n los valores por defecto.
                                    </div>
                                </div>
                            </div>

                            {/* VOCAB COLUMN */}
                            <div className="lg:w-2/3 bg-white flex flex-col">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2"><Filter className="text-emerald-500"/> Packs de Vocabulario</h3>
                                    <span className="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-xs font-bold">{selectedVerbs.size} Verbos</span>
                                </div>
                                <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {Object.entries(VOCAB_PACKS).map(([pack, verbs]) => {
                                            const count = verbs.filter(v => selectedVerbs.has(v)).length;
                                            const isOpen = expandedPacks.has(pack);
                                            return (
                                                <div key={pack} className={`rounded-xl border-2 transition-all ${count > 0 ? 'border-emerald-500 bg-emerald-50/20' : 'border-slate-200 bg-slate-50'}`}>
                                                    <div className="p-4 flex items-center justify-between cursor-pointer" onClick={() => togglePackExpansion(pack)}>
                                                        <div className="flex items-center gap-3">
                                                            <button onClick={(e) => {e.stopPropagation(); togglePack(pack);}} className="focus:outline-none">
                                                                {count === verbs.length ? <CheckSquare className="text-emerald-600"/> : count > 0 ? <div className="w-6 h-6 bg-emerald-200 rounded flex items-center justify-center text-emerald-800 font-bold text-xs">{count}</div> : <Square className="text-slate-300"/>}
                                                            </button>
                                                            <div>
                                                                <div className="font-bold text-slate-700 text-sm">{pack}</div>
                                                                <div className="text-[10px] text-slate-400 font-bold">{verbs.length} verbs</div>
                                                            </div>
                                                        </div>
                                                        {isOpen ? <ChevronDown size={16} className="text-slate-400"/> : <ChevronRight size={16} className="text-slate-400"/>}
                                                    </div>
                                                    {isOpen && (
                                                        <div className="p-4 pt-0 border-t border-slate-200/50 grid grid-cols-2 gap-2 mt-2">
                                                            {verbs.map(v => (
                                                                <button key={v} onClick={() => toggleVerb(v)} className={`text-xs px-2 py-1.5 rounded text-left transition-colors flex items-center gap-2 ${selectedVerbs.has(v) ? 'bg-emerald-100 text-emerald-800 font-medium' : 'hover:bg-slate-200 text-slate-500'}`}>
                                                                    <div className={`w-1.5 h-1.5 rounded-full ${selectedVerbs.has(v) ? 'bg-emerald-500' : 'bg-slate-300'}`}></div> {v}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* FOOTER */}
                        <div className="p-6 bg-slate-50 border-t border-slate-200 flex justify-end items-center gap-4">
                            {isGenerating && <span className="text-indigo-600 font-bold text-sm animate-pulse">Contactando a Gemini AI...</span>}
                            <button 
                                onClick={() => generateContent()} 
                                disabled={isGenerating || selectedGrammar.size === 0 || selectedVerbs.size === 0}
                                className="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black text-lg hover:bg-blue-600 transition-all flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed shadow-xl"
                            >
                                {isGenerating ? <Loader2 className="animate-spin"/> : <Zap/>} 
                                {isGenerating ? "GENERANDO..." : "GENERAR JUEGO"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
