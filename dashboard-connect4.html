<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }; document.documentElement.classList.add('dark');</script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100dvh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { Sparkles, Layers, Puzzle, Filter, CheckSquare, Square, ChevronDown, ChevronRight, Zap, Save, Edit3, Trash2, ArrowLeft, Loader2, Search, CheckCircle2, Circle, Sun, Moon } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const SPECIAL_WORDS = { "WH Questions": ["What", "Where", "When", "Who", "Why", "Which", "How", "Whose", "Whom"], "Connectors": ["to", "from", "until", "with", "without", "in", "on", "at", "about", "against", "according to", "during", "and", "or", "but", "because", "if", "although", "while", "when", "so that", "instead of", "then", "that‚Äôs why"], "Place Indicators": ["between", "among", "next to", "behind", "in front of", "in", "on", "at", "close to", "by", "under", "below", "underneath", "over", "above", "across from", "opposite", "on the right", "on the left", "on the corner", "in the corner", "ahead", "within"], "Quantifiers": ["Plenty (of)", "A lot (of)", "Many", "Most", "Several", "Enough", "Half (of)", "Some", "A little (of)", "A few", "A bit (of)", "A couple of", "Any", "None", "The whole"], "Time Indicators": ["always", "usually", "often", "sometimes", "hardly ever", "never", "every day", "now", "right now", "at the moment", "currently", "today", "yesterday", "last night", "ago", "then", "the other day", "while", "when", "tomorrow", "next week", "soon", "later", "tonight", "if", "one day", "someday", "since", "for", "during", "until", "by"], "Possessive Adjectives": ["my", "your", "his", "her", "its", "our", "their"], "Object Pronouns": ["me", "you", "him", "her", "it", "us", "them"] };
        const VOCAB_PACKS = { "Pack 1 (Daily & Work)": ["wake up", "shower", "prepare", "take", "pick up", "get", "start", "work", "help", "send", "attend", "drive", "fill up", "review", "sell", "upload", "download", "leave", "make", "do", "visit", "walk", "own", "feed", "go", "see", "sleep", "bring", "buy", "lend"], "Pack 2 (Comm & Home)": ["get in/out", "agree", "dance", "arrive", "practice", "say", "tell", "speak", "talk", "rest", "close", "write", "read", "call", "answer", "wait for", "meet", "check", "find", "look for", "eat", "drink", "cook", "clean", "wash", "turn on/off", "use", "brush", "finish", "know"], "Pack 3 (Travel & Conflict)": ["open", "confirm", "continue", "improve", "change", "break", "fix", "lose", "find out", "forget", "remember", "watch", "rain", "travel", "teach", "stay", "move", "return", "cancel", "steal", "fall", "hurt", "worry", "trust", "join", "share", "avoid", "book", "imagine", "come"], "Pack 4 (Business & Emotion)": ["complain", "request", "explain", "recommend", "let know", "collect", "sign", "promise", "discuss", "receive", "deliver", "order", "build", "repair", "design", "manage", "organize", "support", "follow", "verify", "celebrate", "sing", "understand", "learn", "listen", "laugh", "cry", "borrow"], "Pack 5 (Action & Strategy)": ["dream", "complete", "report", "solve", "submit", "suggest", "warn", "wonder", "choose", "plan", "repeat", "accomplish", "relax", "compare", "park", "plug", "carry", "pay", "switch", "push", "pull", "show", "save", "raise", "go down", "increase", "reduce", "hand", "reach"], "Pack 6 (P6/P7 Mix 1)": ["think", "believe", "feel", "want", "need", "love", "hate", "prefer", "hope", "enjoy", "decide", "allow", "prevent", "protect", "handle", "perform", "develop", "grow", "replace", "throw", "catch", "sit", "stand", "jump", "run", "hide", "taste", "smell", "touch", "bite"], "Pack 7 (P6/P7 Mix 2)": ["invite", "accept", "refuse", "admit", "deny", "offer", "demand", "advise", "encourage", "mention", "describe", "identify", "realize", "recognize", "suppose", "guess", "measure", "weigh", "fit", "suit", "match", "fill", "empty", "burn", "freeze", "melt", "mix", "connect", "succeed", "fail"], "Pack 8 (Corporate)": ["Hire", "Fire", "Earn", "Spend", "Invest", "Owe", "Promote", "Retire", "Resign", "Operate", "Produce", "Manufacture", "Distribute", "Store", "Export", "Import", "Inspect", "Negotiate", "Persuade", "Convince", "Represent", "Regulate", "Govern", "Vote", "Resolve", "Cooperate", "Compete", "Win", "Beat", "Gain"], "Pack 9 (Medical & Survival)": ["Cure", "Heal", "Suffer", "Bleed", "Recover", "Examine", "Diagnose", "Prescribe", "Treat", "Board", "Land", "Take off", "Reserve", "Accommodate", "Check in", "Check out", "Explore", "Guide", "Wander", "Escape", "Survive", "Attack", "Defend", "Fight", "Greet", "Introduce", "Appreciate", "Forgive", "Criticize", "Praise"] };
        const GRAMMAR_LEVELS = { "BASIC": [{ id: "Modals", label: "Modal Verbs" }, { id: "SimplePresent", label: "Simple Present" }, { id: "PresentContinuous", label: "Present Continuous" }, { id: "GoingTo", label: "Going to (Future)" }], "ADVANCED": [{ id: "SimplePast", label: "Simple Past" }, { id: "PastContinuous", label: "Past Continuous" }, { id: "PresentPerfect", label: "Present Perfect" }, { id: "SecondConditional", label: "Second Conditional" }], "PRO": [{ id: "PresentPerfectPro", label: "Present Perfect" }, { id: "PastPerfect", label: "Past Perfect" }, { id: "PerfectContinuous", label: "Past/Present Perfect Cont." }, { id: "ThirdConditional", label: "Third Conditional" }] };

        const ContentEditor = ({ content, onSave, title, setTitle, isEditing }) => {
            const [editableContent, setEditableContent] = useState(content);
            const [activeTab, setActiveTab] = useState('quizzes'); 
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);
            }, []);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            const handleChange = (section, index, field, value) => { const updated = { ...editableContent }; updated[section][index][field] = value; setEditableContent(updated); };
            const handleOptionChange = (quizIndex, optionIndex, value) => { const updated = { ...editableContent }; updated.quizzes[quizIndex].options[optionIndex] = value; setEditableContent(updated); };
            const handleCorrectSelection = (quizIndex, optionIndex) => { const updated = { ...editableContent }; updated.quizzes[quizIndex].correct = optionIndex; setEditableContent(updated); };
            const handleExit = () => { window.location.href = 'index.html'; };

            return (
                <div className="h-[100dvh] flex flex-col p-4 md:p-6 transition-colors">
                    <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-slate-200 dark:border-zinc-800 overflow-hidden flex flex-col flex-1 max-w-6xl mx-auto w-full">
                        <div className="bg-slate-900 dark:bg-black p-4 md:p-6 flex flex-col md:flex-row justify-between items-center text-white shrink-0 gap-4">
                            <div className="w-full md:w-auto flex justify-between">
                                <div><h2 className="text-xl md:text-2xl font-black flex items-center gap-2"><Edit3/> {isEditing ? "Editar Juego Existente" : "Editor de Contenido"}</h2><p className="text-slate-400 text-xs md:text-sm">{isEditing ? "Modifica los detalles y guarda los cambios." : "Revisa lo que gener√≥ la IA antes de guardar."}</p></div>
                                <button onClick={toggleTheme} className="p-2 text-yellow-400 md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                            </div>
                            <div className="flex gap-2 w-full md:w-auto justify-end">
                                <button onClick={toggleTheme} className="hidden md:block p-2 text-yellow-400 mr-2">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                <button onClick={handleExit} className="bg-slate-700 dark:bg-zinc-800 hover:bg-slate-600 px-4 py-2 rounded-xl font-bold text-sm md:text-base">Cancelar</button>
                                <button onClick={() => onSave(editableContent)} className="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-xl font-bold flex items-center gap-2 text-sm md:text-base"><Save size={18}/> {isEditing ? "ACTUALIZAR" : "GUARDAR"}</button>
                            </div>
                        </div>
                        <div className="p-4 md:p-6 space-y-4 md:space-y-6 overflow-hidden flex flex-col flex-1 bg-white dark:bg-zinc-950">
                            <div><label className="block text-[10px] md:text-xs font-bold text-slate-500 dark:text-zinc-400 uppercase mb-1">T√≠tulo de la Actividad</label><input value={title} onChange={(e) => setTitle(e.target.value)} className="w-full text-lg md:text-xl font-bold p-3 border-2 border-slate-200 dark:border-zinc-800 bg-transparent dark:text-white rounded-xl focus:border-indigo-500 outline-none" placeholder="Ej. Connect 4: Pack 1 Review"/></div>
                            <div className="flex gap-2 border-b border-slate-200 dark:border-zinc-800 shrink-0 overflow-x-auto custom-scrollbar pb-1">{['quizzes', 'scrambled', 'speaking'].map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 font-bold capitalize border-b-4 transition-all whitespace-nowrap ${activeTab === tab ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-400 dark:text-zinc-500 hover:text-slate-600 dark:hover:text-zinc-300'}`}>{tab} ({editableContent[tab]?.length || 0})</button>))}</div>
                            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 p-2 md:p-4 bg-slate-50 dark:bg-zinc-900 rounded-xl border border-slate-100 dark:border-zinc-800">
                                {activeTab === 'quizzes' && editableContent.quizzes.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm">
                                        <div className="flex justify-between mb-2"><span className="font-bold text-slate-400 dark:text-zinc-500">Quiz #{i+1}</span></div>
                                        <input value={item.question} onChange={(e) => handleChange('quizzes', i, 'question', e.target.value)} className="w-full p-2 mb-3 border dark:border-zinc-700 rounded font-medium text-slate-700 dark:text-zinc-200 text-sm bg-slate-50 dark:bg-zinc-900 focus:bg-white dark:focus:bg-black outline-none transition-colors"/>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">{item.options.map((opt, optIdx) => (<div key={optIdx} className={`flex items-center gap-2 p-2 rounded border ${optIdx === item.correct ? 'bg-green-50 dark:bg-green-900/30 border-green-300 dark:border-green-800' : 'bg-white dark:bg-zinc-900 border-slate-200 dark:border-zinc-700'}`}><button onClick={() => handleCorrectSelection(i, optIdx)} className="focus:outline-none shrink-0">{optIdx === item.correct ? <CheckCircle2 className="text-green-600 dark:text-green-400 w-5 h-5"/> : <Circle className="text-slate-300 dark:text-zinc-600 w-5 h-5 hover:text-slate-400"/>}</button><input value={opt} onChange={(e) => handleOptionChange(i, optIdx, e.target.value)} className="w-full text-xs font-bold bg-transparent outline-none text-slate-700 dark:text-zinc-300"/></div>))}</div>
                                    </div>
                                ))}
                                {activeTab === 'scrambled' && editableContent.scrambled.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm">
                                        <span className="font-bold text-slate-400 dark:text-zinc-500 text-xs block mb-1">Sentence #{i+1}:</span>
                                        <input value={item.text} onChange={(e) => handleChange('scrambled', i, 'text', e.target.value)} className="w-full p-2 mb-2 border dark:border-zinc-700 bg-transparent rounded font-bold text-slate-700 dark:text-zinc-200 outline-none focus:border-indigo-500"/>
                                        <span className="font-bold text-slate-400 dark:text-zinc-500 text-xs block mb-1">Translation:</span>
                                        <input value={item.translation} onChange={(e) => handleChange('scrambled', i, 'translation', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded text-slate-600 dark:text-zinc-400 italic outline-none focus:border-indigo-500"/>
                                    </div>
                                ))}
                                {activeTab === 'speaking' && editableContent.speaking.map((item, i) => (
                                    <div key={i} className="p-4 bg-white dark:bg-zinc-950 rounded-xl border border-slate-200 dark:border-zinc-800 grid gap-2 shadow-sm">
                                        <div><span className="text-xs font-bold text-slate-400 dark:text-zinc-500">Spanish:</span><input value={item.spanish} onChange={(e) => handleChange('speaking', i, 'spanish', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded dark:text-white outline-none focus:border-indigo-500"/></div>
                                        <div><span className="text-xs font-bold text-slate-400 dark:text-zinc-500">English (Target):</span><input value={item.english} onChange={(e) => handleChange('speaking', i, 'english', e.target.value)} className="w-full p-2 border dark:border-zinc-700 bg-transparent rounded font-bold text-blue-600 dark:text-blue-400 outline-none focus:border-indigo-500"/></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = () => {
            const [selectedGrammar, setSelectedGrammar] = useState(new Set());
            const [selectedVerbs, setSelectedVerbs] = useState(new Set());
            const [selectedSpecial, setSelectedSpecial] = useState(new Set());
            const [grammarTab, setGrammarTab] = useState('BASIC');
            const [isGenerating, setIsGenerating] = useState(false);
            const [generatedContent, setGeneratedContent] = useState(null);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            const [gameTitle, setGameTitle] = useState("");
            
            const [editingId, setEditingId] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(false);

            const [expandedPacks, setExpandedPacks] = useState(new Set());
            const [expandedSpecial, setExpandedSpecial] = useState(new Set());
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isLoadingModels, setIsLoadingModels] = useState(false);

            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);

                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const editId = params.get('edit');
                    if (editId) {
                        setIsLoadingData(true);
                        try {
                            const docRef = doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setGeneratedContent(data.content);
                                setGameTitle(data.title);
                                setEditingId(editId);
                            } else {
                                alert("No se encontr√≥ el juego.");
                            }
                        } catch (e) {
                            alert("Error cargando el juego: " + e.message);
                        } finally {
                            setIsLoadingData(false);
                        }
                    }
                };
                init();
            }, []);

            useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            const toggleSet = (set, setFn, item) => { const newSet = new Set(set); newSet.has(item) ? newSet.delete(item) : newSet.add(item); setFn(newSet); };
            const toggleCategoryAll = (dataObj, categoryName, set, setFn) => { const items = dataObj[categoryName]; const allSelected = items.every(i => set.has(i)); const newSet = new Set(set); if (allSelected) items.forEach(i => newSet.delete(i)); else items.forEach(i => newSet.add(i)); setFn(newSet); };
            const togglePackExpansion = (packName) => { const newSet = new Set(expandedPacks); newSet.has(packName) ? newSet.delete(packName) : newSet.add(packName); setExpandedPacks(newSet); };

            const fetchModels = async () => {
                if (!apiKey) return alert("Ingresa tu API Key primero");
                setIsLoadingModels(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("Error conectando con Google");
                    const data = await response.json();
                    const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name);
                    setAvailableModels(validModels);
                    if (validModels.length > 0) {
                        const preferred = validModels.find(m => m.includes("gemini-2.5-flash")) || validModels.find(m => m.includes("gemini-2.0")) || validModels[0];
                        setSelectedModel(preferred);
                        alert(`¬°Modelos cargados! Seleccionado: ${preferred}`);
                    }
                } catch (e) { alert("Error al buscar modelos: " + e.message); } 
                finally { setIsLoadingModels(false); }
            };

            const generateContent = async () => {
                if (!apiKey) return alert("Por favor ingresa tu API Key");
                if (!selectedModel) return alert("Por favor escanea y selecciona un modelo primero (bot√≥n lupa)");
                
                setIsGenerating(true);
                
                const verbs = Array.from(selectedVerbs);
                const grammar = Array.from(selectedGrammar);
                const special = Array.from(selectedSpecial);
                const hasGrammar = grammar.length > 0;
                const hasConnectors = special.some(w => SPECIAL_WORDS["Connectors"].includes(w));

                let structureInstruction = hasConnectors
                    ? `Use CONNECTORS to create compound sentences. For 'quizzes', create DOUBLE-GAP questions (two blanks). Options must be PAIRS (e.g. "went / bought").`
                    : `Create simple sentences. For 'quizzes', create SINGLE or DOUBLE gap questions as appropriate. Options must match the gap count.`;

                const prompt = `
                    You are an expert ESL teacher. Create a JSON object for an educational Connect 4 game.
                    Verbs: ${verbs.join(', ')}. Grammar: ${grammar.join(', ')}. Special Words: ${special.join(', ')}.
                    ${structureInstruction}
                    IMPORTANT: 
                    1. In 'scrambled', generate ONE DEFINITIVE SENTENCE. Do NOT use slashes, parentheses, or multiple options. JUST ONE CORRECT SENTENCE. 
                    2. In 'quizzes', ensure the correct answer is NOT always the first option. Randomize the position. Provide exactly 4 options.
                    Output FORMAT (Strict JSON):
                    {
                        "quizzes": [{"question": "...", "options": ["A", "B", "C", "D"], "correct": 2, "explanation": "..."}], // 20 items
                        "scrambled": [{"text": "English sentence.", "translation": "Spanish translation."}], // 15 items
                        "speaking": [{"spanish": "...", "english": "...", "grammar": "..."}] // 5 items
                    }
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await response.json();
                    if (data.error) throw new Error(`Google Error: ${data.error.message}`);
                    if (!data.candidates?.[0]?.content) throw new Error("La IA no devolvi√≥ resultados.");
                    const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                    const json = JSON.parse(text);
                    setGeneratedContent(json);
                } catch (e) { alert("Error: " + e.message); } finally { setIsGenerating(false); }
            };

            const saveToFirebase = async (finalContent) => {
                if (!gameTitle) return alert("Ponle un t√≠tulo al juego");
                try {
                    const processedContent = {
                        ...finalContent,
                        scrambled: finalContent.scrambled.map(s => {
                            let cleanText = s.text.replace(/\//g, '').replace(/[()]/g, '');
                            cleanText = cleanText.charAt(0).toUpperCase() + cleanText.slice(1);
                            if (!cleanText.endsWith('.')) cleanText += '.';
                            return { ...s, text: cleanText, words: cleanText.split(' ').filter(w => w.trim() !== '') };
                        })
                    };

                    const params = new URLSearchParams(window.location.search);
                    const folderParam = params.get('folder');
                    const parentPath = (folderParam && folderParam !== 'undefined' && folderParam !== 'null') ? decodeURIComponent(folderParam) : '';

                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), {
                            title: gameTitle,
                            content: processedContent,
                            updatedAt: serverTimestamp()
                        });
                        alert("¬°Juego actualizado correctamente!");
                    } else {
                        await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), {
                            title: gameTitle,
                            type: 'CONNECT4',
                            content: processedContent,
                            createdAt: serverTimestamp(),
                            parentPath: parentPath 
                        });
                        alert("¬°Nuevo juego creado exitosamente!");
                    }
                    window.location.href = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html'; 
                } catch (e) { alert("Error guardando: " + e.message); }
            };

            if (isLoadingData) return <div className="h-[100dvh] flex items-center justify-center text-slate-500 font-bold"><Loader2 className="animate-spin mr-2"/> Cargando datos del juego...</div>;

            if (generatedContent) return <ContentEditor content={generatedContent} onSave={saveToFirebase} title={gameTitle} setTitle={setGameTitle} isEditing={!!editingId} />;

            return (
                <div className="h-[100dvh] flex flex-col">
                    {/* HEADER RESPONSIVE */}
                    <div className="bg-slate-900 dark:bg-black px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center shrink-0 shadow-md z-10 gap-4">
                        <div className="flex items-center justify-between w-full md:w-auto">
                            <div className="flex items-center gap-4">
                                <button onClick={() => window.location.href='index.html'} className="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors"><ArrowLeft size={20}/></button>
                                <h1 className="text-xl font-black tracking-tight text-white flex items-center gap-2"><Sparkles className="text-blue-400 w-5 h-5"/> Connect 4 Builder</h1>
                            </div>
                            <button onClick={toggleTheme} className="p-2 text-yellow-400 md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-800 p-1.5 rounded-xl border border-slate-700 w-full md:w-auto overflow-x-auto custom-scrollbar">
                            <input type="password" placeholder="Tu API Key real..." value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-900 border border-slate-700 text-white rounded-lg px-3 py-2 text-xs font-mono text-center w-36 focus:border-blue-500 focus:outline-none"/>
                            <button onClick={fetchModels} disabled={isLoadingModels || !apiKey} className="p-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors shrink-0" title="Escanear Modelos">{isLoadingModels ? <Loader2 className="animate-spin" size={16}/> : <Search size={16}/>}</button>
                            {availableModels.length > 0 && (<select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)} className="bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-xs text-white max-w-[150px] outline-none">{availableModels.map(m => <option key={m} value={m}>{m.replace('models/', '')}</option>)}</select>)}
                            <button onClick={toggleTheme} className="hidden md:block p-2 text-yellow-400 shrink-0">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                    </div>
                    
                    {/* MAIN LAYOUT (Vertical m√≥vil, Split PC) */}
                    <div className="flex flex-1 flex-col md:flex-row overflow-hidden bg-white dark:bg-zinc-950">
                        {/* LEFT: GRAMMAR & SPECIAL */}
                        <div className="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-slate-200 dark:border-zinc-800 flex flex-col h-1/2 md:h-full">
                            <div className="p-4 md:p-6 border-b border-slate-100 dark:border-zinc-800 bg-slate-50 dark:bg-zinc-900/50 shrink-0">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4"><Layers className="text-indigo-500"/> Nivel Gramatical</h3>
                                <div className="flex bg-white dark:bg-zinc-900 rounded-xl p-1 mb-4 border border-slate-200 dark:border-zinc-700">
                                    {Object.keys(GRAMMAR_LEVELS).map(level => (
                                        <button key={level} onClick={() => setGrammarTab(level)} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all uppercase ${grammarTab === level ? 'bg-slate-900 dark:bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-zinc-300'}`}>{level}</button>
                                    ))}
                                </div>
                                <div className="space-y-2 max-h-[120px] md:max-h-[160px] overflow-y-auto custom-scrollbar pr-2">
                                    {GRAMMAR_LEVELS[grammarTab].map(item => (
                                        <button key={item.id} onClick={() => toggleSet(selectedGrammar, setSelectedGrammar, item.id)} className={`w-full text-left p-3 rounded-xl border transition-all flex justify-between items-center text-sm ${selectedGrammar.has(item.id) ? 'bg-indigo-50 dark:bg-indigo-900/30 border-indigo-500 text-indigo-900 dark:text-indigo-300' : 'bg-white dark:bg-zinc-900 border-slate-200 dark:border-zinc-700 text-slate-500 dark:text-zinc-400'}`}>
                                            <span className="font-bold">{item.label}</span>
                                            {selectedGrammar.has(item.id) ? <CheckSquare size={18} className="text-indigo-600 dark:text-indigo-400"/> : <Square size={18} className="text-slate-300 dark:text-zinc-600"/>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-white dark:bg-zinc-950 custom-scrollbar">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4"><Puzzle className="text-orange-500"/> Palabras Especiales</h3>
                                <div className="space-y-4 pb-24">
                                    {Object.entries(SPECIAL_WORDS).map(([cat, words]) => { 
                                        const count = words.filter(w => selectedSpecial.has(w)).length; 
                                        const isOpen = expandedSpecial.has(cat); 
                                        return (
                                            <div key={cat} className={`bg-white dark:bg-zinc-900 rounded-xl border-2 transition-all ${count > 0 ? 'border-orange-400 shadow-sm' : 'border-slate-200 dark:border-zinc-800 shadow-sm'}`}>
                                                <div className="p-3 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors rounded-t-xl" onClick={() => toggleSet(expandedSpecial, setExpandedSpecial, cat)}>
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={(e) => {e.stopPropagation(); toggleCategoryAll(SPECIAL_WORDS, cat, selectedSpecial, setSelectedSpecial);}} className="focus:outline-none hover:scale-110 transition-transform">{count === words.length ? <CheckSquare className="text-orange-500"/> : count > 0 ? <div className="w-5 h-5 bg-orange-200 text-orange-800 rounded flex items-center justify-center font-bold text-[10px]">{count}</div> : <Square className="text-slate-300 dark:text-zinc-600"/>}</button>
                                                        <div><div className="font-bold text-slate-700 dark:text-zinc-300 text-xs uppercase">{cat}</div></div>
                                                    </div>
                                                    {isOpen ? <ChevronDown size={14} className="text-slate-400"/> : <ChevronRight size={14} className="text-slate-400"/>}
                                                </div>
                                                {isOpen && (
                                                    <div className="p-3 pt-0 border-t border-slate-100 dark:border-zinc-800 flex flex-wrap gap-2 mt-2 bg-slate-50/50 dark:bg-zinc-950/50 rounded-b-xl">
                                                        {words.map(w => (
                                                            <button key={w} onClick={() => toggleSet(selectedSpecial, setSelectedSpecial, w)} className={`text-[10px] px-2 py-1 rounded transition-colors border font-bold ${selectedSpecial.has(w) ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-400 border-orange-300 dark:border-orange-700' : 'bg-white dark:bg-zinc-800 border-slate-200 dark:border-zinc-700 text-slate-500 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-500'}`}>{w}</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ); 
                                    })}
                                </div>
                            </div>
                        </div>
                        
                        {/* RIGHT: VOCABULARY & BUTTON */}
                        <div className="w-full md:w-2/3 bg-slate-50 dark:bg-zinc-950 flex flex-col relative h-1/2 md:h-full">
                            <div className="p-4 md:p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between items-center bg-white dark:bg-zinc-900 shadow-sm z-10 shrink-0">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><Filter className="text-emerald-500"/> Vocabulario</h3>
                                <span className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400 px-4 py-1.5 rounded-full text-xs font-bold border border-emerald-200 dark:border-emerald-800/50">{selectedVerbs.size} Verbos</span>
                            </div>
                            <div className="flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pb-32">
                                    {Object.entries(VOCAB_PACKS).map(([pack, verbs]) => { 
                                        const count = verbs.filter(v => selectedVerbs.has(v)).length; 
                                        const isOpen = expandedPacks.has(pack); 
                                        return (
                                            <div key={pack} className={`bg-white dark:bg-zinc-900 rounded-xl border-2 transition-all ${count > 0 ? 'border-emerald-500 shadow-md' : 'border-slate-200 dark:border-zinc-800 shadow-sm'}`}>
                                                <div className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-zinc-800 transition-colors rounded-t-xl" onClick={() => togglePackExpansion(pack)}>
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={(e) => {e.stopPropagation(); toggleCategoryAll(VOCAB_PACKS, pack, selectedVerbs, setSelectedVerbs);}} className="focus:outline-none hover:scale-110 transition-transform">{count === verbs.length ? <CheckSquare className="text-emerald-600"/> : count > 0 ? <div className="w-6 h-6 bg-emerald-200 text-emerald-800 rounded flex items-center justify-center font-bold text-xs">{count}</div> : <Square className="text-slate-300 dark:text-zinc-600"/>}</button>
                                                        <div><div className="font-bold text-slate-700 dark:text-zinc-200 text-sm">{pack}</div><div className="text-[10px] text-slate-400 dark:text-zinc-500 font-bold">{verbs.length} verbs</div></div>
                                                    </div>
                                                    {isOpen ? <ChevronDown size={16} className="text-slate-400"/> : <ChevronRight size={16} className="text-slate-400"/>}
                                                </div>
                                                {isOpen && (
                                                    <div className="p-4 pt-0 border-t border-slate-100 dark:border-zinc-800 grid grid-cols-2 gap-2 mt-2 bg-slate-50/50 dark:bg-zinc-950/50 rounded-b-xl">
                                                        {verbs.map(v => (
                                                            <button key={v} onClick={() => toggleSet(selectedVerbs, setSelectedVerbs, v)} className={`text-xs px-2 py-1.5 rounded text-left transition-colors flex items-center gap-2 border ${selectedVerbs.has(v) ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-400 font-bold border-emerald-200 dark:border-emerald-800' : 'bg-white dark:bg-zinc-800 border-slate-200 dark:border-zinc-700 text-slate-500 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-600'}`}><div className={`w-1.5 h-1.5 rounded-full shrink-0 ${selectedVerbs.has(v) ? 'bg-emerald-500' : 'bg-slate-300 dark:bg-zinc-600'}`}></div> {v}</button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ); 
                                    })}
                                </div>
                            </div>
                            
                            {/* BOT√ìN GENERAR (Fijo abajo) */}
                            <div className="absolute bottom-6 right-6 md:bottom-8 md:right-8 z-20">
                                <button onClick={() => generateContent()} disabled={isGenerating || (selectedGrammar.size === 0 && selectedSpecial.size === 0) || selectedVerbs.size === 0} className="bg-slate-900 dark:bg-white text-white dark:text-zinc-900 px-6 md:px-8 py-3 md:py-4 rounded-full font-black text-base md:text-lg hover:bg-blue-600 dark:hover:bg-blue-500 dark:hover:text-white hover:scale-105 transition-all flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed shadow-2xl ring-4 ring-white dark:ring-zinc-900">
                                    {isGenerating ? <Loader2 className="animate-spin"/> : <Zap className="fill-yellow-400 dark:text-amber-500"/>} {isGenerating ? "GENERANDO..." : "GENERAR JUEGO"}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
