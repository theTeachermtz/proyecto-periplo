<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 Game | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ®</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .token-drop { animation: drop 0.5s cubic-bezier(0.5, 0, 0.75, 0); }
        @keyframes drop { from { transform: translateY(-300px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-bounce-in { animation: bounceIn 0.3s ease-out; }
        @keyframes bounceIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { Trophy, HelpCircle, Brain, Mic, CheckCircle2, XCircle, ArrowRight, Undo2, RotateCcw, LogOut, Loader2 } from 'lucide-react';

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GAME LOGIC ---
        const shuffleArray = (array) => {
            if (!array) return [];
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // --- SUB-COMPONENTS ---
        const ScrambleChallenge = ({ data, onComplete }) => {
            const [shuffledWords, setShuffledWords] = useState([]);
            const [selectedWords, setSelectedWords] = useState([]);
            const [status, setStatus] = useState('playing');

            useEffect(() => {
                if (data && data.words) {
                    const wordsWithIds = data.words.map((w, i) => ({ id: i, text: w }));
                    setShuffledWords(shuffleArray(wordsWithIds));
                    setSelectedWords([]);
                    setStatus('playing');
                }
            }, [data]);

            const checkAnswer = () => {
                const built = selectedWords.map(w => w.text).join(" ");
                if (built.trim() === data.text.trim()) {
                    setStatus('correct');
                    setTimeout(() => onComplete(true), 1500);
                } else {
                    setStatus('wrong');
                }
            };

            return (
                <div className="w-full text-center">
                    <h3 className="text-xl font-bold text-blue-600 mb-4 flex justify-center items-center gap-2"><Brain/> Unscramble</h3>
                    <div className={`min-h-[60px] bg-slate-50 rounded-xl p-4 mb-4 flex flex-wrap gap-2 justify-center border-2 transition-colors ${status === 'correct' ? 'border-green-500 bg-green-50' : status === 'wrong' ? 'border-red-300 bg-red-50' : 'border-slate-200'}`}>
                        {selectedWords.map(w => (
                            <button key={w.id} onClick={() => {
                                if (status !== 'playing') return;
                                setShuffledWords([...shuffledWords, w]);
                                setSelectedWords(selectedWords.filter(sw => sw.id !== w.id));
                            }} className="bg-white border px-3 py-1.5 rounded-lg shadow-sm font-bold text-slate-700 animate-bounce-in">{w.text}</button>
                        ))}
                        {selectedWords.length === 0 && <span className="text-slate-400 italic text-sm">Tap words below...</span>}
                    </div>
                    
                    <div className="flex flex-wrap gap-2 justify-center mb-6">
                        {status !== 'correct' && shuffledWords.map(w => (
                            <button key={w.id} onClick={() => {
                                if (status !== 'playing') return;
                                setSelectedWords([...selectedWords, w]);
                                setShuffledWords(shuffledWords.filter(sw => sw.id !== w.id));
                            }} className="bg-blue-100 text-blue-800 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition-all border border-blue-200">{w.text}</button>
                        ))}
                    </div>

                    {status === 'wrong' && (
                        <div className="mb-4 animate-bounce-in">
                            <div className="text-red-500 font-bold mb-1 flex items-center justify-center gap-1"><XCircle size={16}/> Incorrect</div>
                            <div className="text-slate-500 text-sm">Correct: <b>{data.text}</b></div>
                        </div>
                    )}
                    
                    {status === 'correct' && <div className="text-green-600 font-bold mb-4 animate-bounce flex items-center justify-center gap-1"><CheckCircle2/> Perfect!</div>}

                    {status === 'playing' ? (
                        <button onClick={checkAnswer} disabled={shuffledWords.length > 0} className="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">CHECK ANSWER</button>
                    ) : status === 'wrong' ? (
                        <button onClick={() => onComplete(false)} className="bg-slate-800 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2 mx-auto">Continue <ArrowRight size={16}/></button>
                    ) : null}
                </div>
            );
        };

        const QuizChallenge = ({ data, onComplete }) => {
            const [selected, setSelected] = useState(null);
            const [status, setStatus] = useState('playing'); // playing, correct, wrong
            
            const handleSelect = (idx) => {
                if (status !== 'playing') return;
                setSelected(idx);
                
                if (idx === data.correct) {
                    setStatus('correct');
                    setTimeout(() => onComplete(true), 1500);
                } else {
                    setStatus('wrong');
                }
            };

            return (
                <div className="w-full">
                    <h3 className="text-xl font-bold text-purple-600 mb-4 text-center flex justify-center items-center gap-2"><HelpCircle/> Quiz</h3>
                    <div className="bg-slate-50 p-6 rounded-2xl mb-6 font-medium text-lg text-center text-slate-800 border border-slate-100 shadow-sm">{data.question}</div>
                    
                    <div className="grid gap-3">
                        {data.options.map((opt, idx) => (
                            <button key={idx} onClick={() => handleSelect(idx)} 
                                className={`p-4 rounded-xl border-2 text-left font-bold transition-all flex justify-between items-center ${
                                    status === 'playing' ? 'bg-white border-slate-100 hover:border-purple-200 hover:bg-purple-50 text-slate-600' :
                                    idx === data.correct ? 'bg-green-100 border-green-500 text-green-800' :
                                    selected === idx ? 'bg-red-100 border-red-500 text-red-800' : 'opacity-40 bg-white border-slate-100'
                                }`}
                            >
                                <span>{opt}</span>
                                {status !== 'playing' && idx === data.correct && <CheckCircle2 className="text-green-600"/>}
                                {status === 'wrong' && selected === idx && <XCircle className="text-red-600"/>}
                            </button>
                        ))}
                    </div>

                    {status === 'wrong' && (
                        <div className="mt-6 flex flex-col items-center animate-bounce-in">
                            <div className="text-red-500 font-bold mb-2">Incorrect Answer</div>
                            <button onClick={() => onComplete(false)} className="bg-slate-800 text-white px-6 py-2 rounded-full font-bold flex items-center gap-2">Continue <ArrowRight size={16}/></button>
                        </div>
                    )}
                </div>
            );
        };

        const GameBoard = () => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [gameData, setGameData] = useState(null);
            const [board, setBoard] = useState(Array(6).fill(null).map(() => Array(7).fill(null)));
            const [currentPlayer, setCurrentPlayer] = useState('red');
            const [winner, setWinner] = useState(null);
            const [modal, setModal] = useState(null); // { type, data, pendingMove }
            const [questionPools, setQuestionPools] = useState({ quizzes: [], scrambled: [], speaking: [] });

            useEffect(() => {
                const init = async () => {
                    try {
                        const params = new URLSearchParams(window.location.search);
                        const id = params.get('id');
                        if (!id) throw new Error("Falta ID de juego en la URL");
                        
                        // CORRECCIÃ“N: Apuntando a 'quizzes' en lugar de 'boardgames'
                        const snap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', id));
                        
                        if (snap.exists()) {
                            const content = snap.data().content;
                            if (!content) throw new Error("El juego no tiene contenido vÃ¡lido.");

                            setGameData(snap.data());
                            setQuestionPools({
                                quizzes: shuffleArray(content.quizzes || []),
                                scrambled: shuffleArray(content.scrambled || []),
                                speaking: shuffleArray(content.speaking || [])
                            });
                        } else {
                            throw new Error("No se encontrÃ³ el juego.");
                        }
                    } catch (err) {
                        console.error(err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                init();
            }, []);

            const checkWin = (board, player) => {
                const R = 6, C = 7;
                const check = (r, c, dr, dc) => {
                    let cnt = 0;
                    for(let i=0; i<4; i++) {
                        if(r+dr*i >= 0 && r+dr*i < R && c+dc*i >=0 && c+dc*i < C && board[r+dr*i][c+dc*i] === player) cnt++;
                    }
                    return cnt === 4;
                };
                for(let r=0; r<R; r++) for(let c=0; c<C; c++) {
                    if (check(r,c,0,1) || check(r,c,1,0) || check(r,c,1,1) || check(r,c,1,-1)) return true;
                }
                return false;
            };

            const handleColumnClick = (col) => {
                if (winner || modal) return;
                let row = -1;
                for (let r = 5; r >= 0; r--) {
                    if (!board[r][col]) { row = r; break; }
                }
                if (row === -1) return;

                // Random Challenge Tier
                const rand = Math.random();
                let tier = 'quiz';
                if (rand > 0.7 && questionPools.speaking.length > 0) tier = 'speaking';
                else if (rand > 0.35 && questionPools.scrambled.length > 0) tier = 'scramble';
                else if (questionPools.quizzes.length === 0) {
                    // Fallback logic if empty
                    if (questionPools.scrambled.length > 0) tier = 'scramble';
                    else if (questionPools.speaking.length > 0) tier = 'speaking';
                    else tier = 'none'; // No questions left
                }

                if (tier === 'none') {
                    executeMove(row, col);
                    return;
                }
                
                let question = null;
                if (tier === 'quiz') {
                    question = questionPools.quizzes[0];
                    setQuestionPools(p => ({...p, quizzes: p.quizzes.slice(1)}));
                } else if (tier === 'scramble') {
                    question = questionPools.scrambled[0];
                    setQuestionPools(p => ({...p, scrambled: p.scrambled.slice(1)}));
                } else if (tier === 'speaking') {
                    question = questionPools.speaking[0];
                    setQuestionPools(p => ({...p, speaking: p.speaking.slice(1)}));
                }

                setModal({ type: tier, data: question, pendingMove: { row, col } });
            };

            const executeMove = (r, c) => {
                const newBoard = board.map(row => [...row]);
                newBoard[r][c] = currentPlayer;
                setBoard(newBoard);
                if (checkWin(newBoard, currentPlayer)) setWinner(currentPlayer);
                else setCurrentPlayer(currentPlayer === 'red' ? 'yellow' : 'red');
            };

            const handleChallengeComplete = (success) => {
                if (success) executeMove(modal.pendingMove.row, modal.pendingMove.col);
                else setCurrentPlayer(currentPlayer === 'red' ? 'yellow' : 'red'); // Lose turn
                setModal(null);
            };

            const handleExit = () => {
                const folder = gameData?.parentPath || '';
                window.location.href = `index.html?folder=${encodeURIComponent(folder)}`;
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-indigo-500"><Loader2 className="animate-spin" size={40}/></div>;
            if (error) return (
                <div className="h-screen flex flex-col items-center justify-center p-8 text-center">
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">Ups, algo saliÃ³ mal</h2>
                    <p className="text-slate-500 mb-6">{error}</p>
                    <button onClick={() => window.location.href='index.html'} className="bg-slate-900 text-white px-6 py-2 rounded-xl font-bold">Volver al Inicio</button>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-100 font-sans p-4">
                    <div className="w-full max-w-4xl">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <div>
                                <h1 className="text-3xl md:text-4xl font-black text-slate-900 tracking-tight">{gameData?.title || 'Connect 4'}</h1>
                                <div className="flex gap-2 mt-1">
                                    <span className="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider">AI Challenge</span>
                                </div>
                            </div>
                            
                            {!winner && (
                                <div className={`px-8 py-3 rounded-full font-bold text-white shadow-xl text-lg flex items-center gap-3 border-4 border-white/20 ${currentPlayer === 'red' ? 'bg-red-500' : 'bg-yellow-500'}`}>
                                    <div className="w-4 h-4 rounded-full bg-white"/>
                                    Turno: {currentPlayer === 'red' ? 'ROJO' : 'AMARILLO'}
                                </div>
                            )}
                        </div>

                        <div className="bg-blue-700 p-4 md:p-6 rounded-[2.5rem] shadow-2xl border-b-[12px] border-blue-900 relative mx-auto max-w-[600px]">
                            <div className="grid grid-cols-7 gap-2 md:gap-3 bg-blue-600 p-3 rounded-2xl border border-blue-500/30">
                                {board.map((row, r) => (
                                    row.map((cell, c) => (
                                        <div key={`${r}-${c}`} onClick={() => handleColumnClick(c)} className="aspect-square bg-blue-900 rounded-full flex items-center justify-center cursor-pointer shadow-inner relative overflow-hidden group">
                                            {/* Hover Effect */}
                                            {!cell && !winner && (
                                                <div className={`w-full h-full rounded-full opacity-0 group-hover:opacity-30 scale-75 transition-opacity ${currentPlayer === 'red' ? 'bg-red-500' : 'bg-yellow-400'}`}></div>
                                            )}
                                            {/* Token */}
                                            {cell && <div className={`w-full h-full rounded-full token-drop shadow-[inset_0_-4px_6px_rgba(0,0,0,0.2)] border-[6px] ${cell === 'red' ? 'bg-red-500 border-red-600' : 'bg-yellow-400 border-yellow-500'}`}></div>}
                                        </div>
                                    ))
                                ))}
                            </div>
                            
                            {/* Legs of the board */}
                            <div className="absolute -bottom-8 left-8 w-6 h-12 bg-blue-900 rounded-b-xl -z-10"></div>
                            <div className="absolute -bottom-8 right-8 w-6 h-12 bg-blue-900 rounded-b-xl -z-10"></div>
                        </div>

                        <div className="mt-12 flex justify-center">
                            <button onClick={handleExit} className="flex items-center gap-2 text-slate-400 hover:text-slate-600 font-bold bg-white px-6 py-3 rounded-xl shadow-sm hover:shadow transition-all uppercase text-sm tracking-widest"><LogOut size={18}/> Salir</button>
                        </div>
                    </div>

                    {/* CHALLENGE MODAL */}
                    {modal && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-[2rem] p-8 max-w-lg w-full shadow-2xl animate-bounce-in border-t-8 border-indigo-500 relative">
                                <div className="absolute top-4 right-4 text-xs font-bold text-slate-300 uppercase tracking-widest">{modal.type} CHALLENGE</div>
                                
                                {modal.type === 'quiz' && <QuizChallenge data={modal.data} onComplete={handleChallengeComplete} />}
                                {modal.type === 'scramble' && <ScrambleChallenge data={modal.data} onComplete={handleChallengeComplete} />}
                                {modal.type === 'speaking' && (
                                    <div className="text-center w-full">
                                        <h3 className="text-xl font-bold text-orange-500 mb-4 flex justify-center gap-2 items-center"><Mic/> Translate</h3>
                                        <div className="bg-orange-50 p-6 rounded-2xl border-2 border-orange-100 mb-6">
                                            <p className="text-2xl font-black text-slate-800 leading-tight">"{modal.data.spanish}"</p>
                                        </div>
                                        <p className="text-sm text-slate-400 mb-6">Say it in English: <b>{modal.data.english}</b></p>
                                        <div className="grid grid-cols-2 gap-4">
                                            <button onClick={() => handleChallengeComplete(false)} className="py-4 bg-red-50 border-2 border-red-100 text-red-600 font-bold rounded-xl hover:bg-red-100 transition-colors">Incorrect</button>
                                            <button onClick={() => handleChallengeComplete(true)} className="py-4 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition-all flex justify-center gap-2 items-center"><CheckCircle2 size={20}/> Correct</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* WINNER OVERLAY */}
                    {winner && (
                        <div className="fixed inset-0 bg-slate-900/95 flex items-center justify-center z-50 animate-bounce-in">
                            <div className="text-center text-white">
                                <Trophy size={120} className="mx-auto text-yellow-400 mb-6 animate-bounce drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"/>
                                <h1 className="text-7xl font-black mb-2 tracking-tighter">{winner === 'red' ? 'ROJO' : 'AMARILLO'}</h1>
                                <p className="text-2xl font-medium text-slate-400 mb-10 tracking-widest uppercase">GANA LA PARTIDA</p>
                                <div className="flex flex-col gap-4">
                                    <button onClick={() => window.location.reload()} className="bg-white text-slate-900 px-10 py-4 rounded-full font-black text-xl hover:scale-105 transition-transform flex items-center justify-center gap-3"><RotateCcw/> Jugar Otra Vez</button>
                                    <button onClick={handleExit} className="text-slate-500 hover:text-white font-bold transition-colors uppercase tracking-widest text-sm">Volver al MenÃº</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<GameBoard />);
    </script>
</body>
</html>
