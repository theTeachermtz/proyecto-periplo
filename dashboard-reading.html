<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; height: 100vh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'firebase/firestore';
        import { BookOpen, Brain, Sparkles, Save, RefreshCw, Eye, Edit3, ArrowLeft, CheckSquare, Square, Globe, Feather, Briefcase, Zap, HeartHandshake } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CATALOGO DE G√âNEROS ---
        const GENRES = {
            "Real World (Internet Research)": [
                { id: 'biography', label: 'Biography (Real Person)', icon: Globe },
                { id: 'news', label: 'Breaking News / Current Events', icon: Globe },
                { id: 'tech', label: 'Tech Trends & Innovation', icon: Globe },
                { id: 'history', label: 'Historical Event', icon: Globe },
                { id: 'travel', label: 'Travel Guide (Real Place)', icon: Globe }
            ],
            "Professional & Advice": [
                { id: 'advice', label: 'Advice / Consultation', icon: HeartHandshake, desc: 'Situation -> Pros/Cons -> Advice' },
                { id: 'email', label: 'Email / Letter', icon: Briefcase },
                { id: 'interview', label: 'Job Interview Simulation', icon: Briefcase },
                { id: 'recipe', label: 'Recipe / Instructions', icon: Briefcase }
            ],
            "Fiction & Creative": [
                { id: 'story', label: 'Short Story / Fable', icon: Feather },
                { id: 'scifi', label: 'Sci-Fi / Future', icon: Feather },
                { id: 'mystery', label: 'Mystery / Detective', icon: Feather },
                { id: 'dialogue', label: 'Dialogue / Script', icon: Feather },
                { id: 'anecdote', label: 'Funny Anecdote', icon: Feather }
            ]
        };

        const GRAMMAR_OPTIONS = {
            Basic: [ { id: 'present_simple', label: 'Present Simple' }, { id: 'present_continuous', label: 'Present Continuous' }, { id: 'future_will_going', label: 'Future (Will/Going to)' }, { id: 'past_simple', label: 'Past Simple' }, { id: 'prepositions', label: 'Prepositions' } ],
            Advanced: [ { id: 'past_narrative', label: 'Past Narrative (Simple/Cont)' }, { id: 'used_to', label: 'Used to / Would' }, { id: 'second_conditional', label: 'Second Conditional' }, { id: 'relative_clauses', label: 'Relative Clauses' }, { id: 'modals_deduction', label: 'Modals of Deduction' } ],
            Pro: [ { id: 'present_perfect', label: 'Present Perfect' }, { id: 'past_perfect', label: 'Past Perfect' }, { id: 'third_conditional', label: 'Third Conditional' }, { id: 'passive_voice', label: 'Passive Voice' }, { id: 'phrasal_verbs', label: 'Advanced Phrasal Verbs' } ]
        };

        const ReadingBuilder = () => {
            const [step, setStep] = useState('config'); 
            const [loading, setLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            
            // CONFIGURACI√ìN PERSISTENTE
            const [config, setConfig] = useState({ 
                level: 'Basic', // Nivel visual actual (pesta√±a)
                genre: 'story', 
                topic: '', 
                // Estado unificado para gram√°tica { Basic: Set, Advanced: Set... }
                selectedGrammar: { Basic: new Set(), Advanced: new Set(), Pro: new Set() }
            });
            
            const [readingData, setReadingData] = useState({ title: '', content: '', tokens: [] });

            // TOKENIZER
            const processContent = (text) => {
                const regex = /([a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+|[^a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë\s]+|\s+)/g;
                const parts = text.match(regex) || [];
                return parts.map((part, index) => ({
                    id: index, text: part, isWord: /^[a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+$/.test(part), isHidden: false
                }));
            };

            const toggleGrammar = (level, id) => {
                const newSet = new Set(config.selectedGrammar[level]);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setConfig(prev => ({ ...prev, selectedGrammar: { ...prev.selectedGrammar, [level]: newSet } }));
            };

            const generateReading = async () => {
                if (!apiKey) return alert("Falta API Key");
                setLoading(true);

                // Recopilar toda la gram√°tica seleccionada de todos los niveles
                const allSelectedGrammar = [
                    ...Array.from(config.selectedGrammar.Basic).map(id => GRAMMAR_OPTIONS.Basic.find(g => g.id === id).label),
                    ...Array.from(config.selectedGrammar.Advanced).map(id => GRAMMAR_OPTIONS.Advanced.find(g => g.id === id).label),
                    ...Array.from(config.selectedGrammar.Pro).map(id => GRAMMAR_OPTIONS.Pro.find(g => g.id === id).label)
                ];

                const needsSearch = GENRES["Real World (Internet Research)"].some(g => g.id === config.genre);
                const topicPrompt = config.topic ? `Specific Topic/Scenario: "${config.topic}"` : "Topic: Choose a creative and engaging topic relevant to the genre.";

                // INSTRUCCIONES DIN√ÅMICAS SEG√öN SELECCI√ìN
                let instructions = "";
                
                // 1. L√≥gica de Gram√°tica vs Contexto
                if (allSelectedGrammar.length === 0) {
                    instructions += `\n- GRAMMAR MODE: FREE CREATION. Focus 100% on the natural flow of the text, the scenario provided, and the specific format of the genre (${config.genre}). Do not worry about specific grammar constraints.`;
                } else {
                    instructions += `\n- GRAMMAR MODE: GUIDED (Soft). Priority #1 is the Scenario/Context. Priority #2 is Grammar. Try to incorporate these structures naturally (approx 40% weight): ${allSelectedGrammar.join(', ')}. Do NOT force them if they sound unnatural.`;
                }

                // 2. L√≥gica Espec√≠fica por G√©nero
                if (config.genre === 'advice') {
                    instructions += `\n- STRUCTURE REQUIRED: This is an ADVICE text. 
                    1. Breakdown of the user's situation.
                    2. Comparison of Pros and Cons.
                    3. Final Summary with Concrete Advice.`;
                } else if (config.genre === 'interview') {
                    instructions += `\n- STRUCTURE REQUIRED: Simulation of a job interview. Create a dialogue script based on the specific profile provided in the topic (e.g. Mexican Engineer).`;
                } else if (config.genre === 'email') {
                    instructions += `\n- STRUCTURE REQUIRED: A professional or personal email draft strictly adhering to the purpose described in the topic.`;
                }

                const prompt = `
                    Generate an English reading text.
                    Target Audience Level: ${config.level} (Ajust vocabulary difficulty accordingly).
                    Genre: ${config.genre}.
                    ${topicPrompt}
                    ${instructions}

                    ${needsSearch ? "IMPORTANT: Use Google Search to find REAL, ACCURATE, and CURRENT information. Do not invent facts." : "Use your creativity."}

                    Output JSON:
                    {
                        "title": "Title here",
                        "content": "Full text body here. Formatted correctly with line breaks (\\n) for paragraphs."
                    }
                `;

                try {
                    const tools = needsSearch ? [{ googleSearchRetrieval: {} }] : [];
                    // Usamos el modelo 2.5 Flash que sabemos que tienes
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            tools: tools, 
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    setReadingData({
                        title: result.title,
                        content: result.content,
                        tokens: processContent(result.content)
                    });
                    setStep('editor');

                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveActivity = async () => {
                if (!readingData.title) return alert("Falta t√≠tulo");
                try {
                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), {
                        title: readingData.title,
                        type: 'READING', 
                        content: {
                            text: readingData.content,
                            blanks: readingData.tokens.filter(t => t.isHidden).map(t => t.id) 
                        },
                        level: config.level,
                        genre: config.genre,
                        createdAt: serverTimestamp()
                    });
                    alert("Lectura guardada!");
                    window.location.href = 'index.html';
                } catch (e) { alert(e.message); }
            };

            const toggleHidden = (idx) => {
                const newTokens = [...readingData.tokens];
                if (newTokens[idx].isWord) {
                    newTokens[idx].isHidden = !newTokens[idx].isHidden;
                    setReadingData({ ...readingData, tokens: newTokens });
                }
            };

            if (step === 'config') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 font-sans">
                        <div className="max-w-6xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200 flex flex-col h-[90vh]">
                            {/* Header */}
                            <div className="bg-slate-900 p-6 text-white flex justify-between items-center shrink-0">
                                <div>
                                    <h1 className="text-2xl font-black flex items-center gap-2"><BookOpen className="text-emerald-400"/> Reading Builder</h1>
                                    <p className="text-slate-400 text-xs uppercase font-bold tracking-widest mt-1">Motor de Generaci√≥n de Textos</p>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => window.location.href='index.html'} className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-bold text-sm transition-all">Cancelar / Salir</button>
                                    <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-800 border-slate-700 rounded-lg px-3 py-2 text-xs w-32 focus:border-blue-500 focus:outline-none" placeholder="API Key"/>
                                </div>
                            </div>

                            <div className="flex flex-col md:flex-row flex-1 overflow-hidden">
                                {/* Left: Genre & Level */}
                                <div className="md:w-1/3 bg-slate-50 border-r border-slate-200 flex flex-col">
                                    {/* Level Tabs */}
                                    <div className="p-4 border-b border-slate-200 bg-white">
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Nivel de Dificultad</label>
                                        <div className="flex gap-1 bg-slate-100 p-1 rounded-xl">
                                            {['Basic', 'Advanced', 'Pro'].map(l => (
                                                <button key={l} onClick={() => setConfig({...config, level: l})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${config.level===l ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>{l}</button>
                                            ))}
                                        </div>
                                    </div>
                                    {/* Grammar Selection (Context Aware) */}
                                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar bg-slate-50">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Gram√°tica ({config.level})</label>
                                            <span className="text-[10px] bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full font-bold">{config.selectedGrammar[config.level].size}</span>
                                        </div>
                                        <div className="space-y-1">
                                            {GRAMMAR_OPTIONS[config.level].map(g => (
                                                <button key={g.id} onClick={() => toggleGrammar(config.level, g.id)} className={`w-full text-left p-3 rounded-xl border flex items-center gap-3 transition-all ${config.selectedGrammar[config.level].has(g.id) ? 'bg-indigo-50 border-indigo-500 text-indigo-900' : 'bg-white border-slate-200 text-slate-500 hover:border-indigo-200'}`}>
                                                    {config.selectedGrammar[config.level].has(g.id) ? <CheckSquare size={16} className="text-indigo-600"/> : <Square size={16} className="text-slate-300"/>}
                                                    <span className="text-xs font-bold">{g.label}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Center: Genre Selection */}
                                <div className="md:w-1/3 bg-white border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-100">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block">Tipo de Texto</label>
                                    </div>
                                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar">
                                        <div className="space-y-6">
                                            {Object.entries(GENRES).map(([cat, items]) => (
                                                <div key={cat}>
                                                    <p className="text-[9px] font-black text-slate-300 uppercase mb-2 tracking-widest">{cat}</p>
                                                    <div className="space-y-1">
                                                        {items.map(g => (
                                                            <button key={g.id} onClick={() => setConfig({...config, genre: g.id})} className={`w-full text-left p-3 rounded-xl border flex items-center justify-between transition-all ${config.genre === g.id ? 'bg-emerald-50 border-emerald-500 text-emerald-900 ring-1 ring-emerald-500 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`p-1.5 rounded-lg ${config.genre === g.id ? 'bg-emerald-200 text-emerald-800' : 'bg-slate-100 text-slate-400'}`}><g.icon size={16}/></div>
                                                                    <div>
                                                                        <div className="text-xs font-bold">{g.label}</div>
                                                                        {g.desc && <div className="text-[9px] opacity-70">{g.desc}</div>}
                                                                    </div>
                                                                </div>
                                                                {config.genre === g.id && <div className="w-2 h-2 rounded-full bg-emerald-500"></div>}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Right: Prompt & Action */}
                                <div className="md:w-1/3 p-6 flex flex-col bg-slate-50">
                                    <div className="flex-1 flex flex-col">
                                        <label className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest block">Detalles del Tema / Situaci√≥n</label>
                                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex-1 flex flex-col">
                                            <textarea 
                                                value={config.topic} 
                                                onChange={e => setConfig({...config, topic: e.target.value})} 
                                                className="w-full flex-1 bg-transparent border-none outline-none text-sm text-slate-700 resize-none placeholder-slate-300"
                                                placeholder={config.genre === 'advice' ? "Describe la situaci√≥n: 'Soy un ingeniero que quiere pedir aumento...'" : "Ej: Biograf√≠a de Elon Musk, Noticia sobre Marte..."}
                                            ></textarea>
                                        </div>
                                        <div className="mt-4 text-[10px] text-slate-400 px-2">
                                            {config.selectedGrammar.Basic.size + config.selectedGrammar.Advanced.size + config.selectedGrammar.Pro.size === 0 
                                                ? "‚ú® Modo Libre: La IA se enfocar√° 100% en el tema." 
                                                : "‚öñÔ∏è Modo Mixto: La IA priorizar√° el tema (60%) e integrar√° la gram√°tica (40%)."}
                                        </div>
                                    </div>

                                    <div className="mt-6">
                                        <button onClick={generateReading} disabled={loading} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-emerald-600 transition-all flex items-center justify-center gap-3 disabled:opacity-50 shadow-xl hover:shadow-2xl hover:-translate-y-1">
                                            {loading ? <Loader2 className="animate-spin"/> : <Sparkles className="fill-yellow-400 text-yellow-400"/>} 
                                            {loading ? "Creando..." : "Generar Texto"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- EDITOR STEP ---
            if (step === 'editor') {
                const hiddenCount = readingData.tokens.filter(t => t.isHidden).length;
                return (
                    <div className="min-h-screen bg-slate-50 p-6 font-sans">
                        <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden flex flex-col h-[90vh]">
                            <div className="bg-white p-4 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10 shrink-0">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setStep('config')} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-800 transition-colors"><ArrowLeft size={20}/></button>
                                    <div>
                                        <h2 className="font-black text-slate-800 text-lg">Editor de Huecos</h2>
                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Haz clic en las palabras para ocultarlas ({hiddenCount} seleccionadas)</p>
                                    </div>
                                </div>
                                <button onClick={saveActivity} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-emerald-200"><Save size={18}/> Guardar</button>
                            </div>

                            <div className="p-8 overflow-y-auto custom-scrollbar flex-1">
                                <input 
                                    value={readingData.title} 
                                    onChange={e => setReadingData({...readingData, title: e.target.value})}
                                    className="text-3xl font-black text-slate-900 w-full border-none outline-none mb-6 placeholder-slate-300 bg-transparent"
                                    placeholder="T√≠tulo de la Lectura..."
                                />
                                <div className="leading-loose text-lg text-slate-700 bg-slate-50 p-8 rounded-[2rem] border border-slate-100 shadow-inner text-justify">
                                    {readingData.tokens.map((t, i) => (
                                        <span 
                                            key={i} 
                                            onClick={() => toggleHidden(i)}
                                            className={`inline-block mx-[1px] px-1 rounded cursor-pointer transition-all border-b-2 select-none ${
                                                t.isHidden 
                                                ? 'bg-emerald-100 text-emerald-800 border-emerald-400 font-bold' 
                                                : t.isWord ? 'border-transparent hover:bg-slate-200 hover:border-slate-300' : 'border-transparent'
                                            }`}
                                        >
                                            {t.text}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingBuilder />);
    </script>
</body>
</html>
