<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' };</script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { BookOpen, Sparkles, Save, ArrowLeft, Globe, Feather, Briefcase, HeartHandshake, Loader2, Search, Lightbulb, Image as ImageIcon, X, Link as LinkIcon, HelpCircle, Sun, Moon, Edit3, CheckCircle2, ChevronLeft, ChevronRight, Flame } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const GENRES = {
            "Real World": [
                { id: 'biography', label: 'Biography (Real Person)', icon: Globe },
                { id: 'news', label: 'Breaking News / Current Events', icon: Globe },
                { id: 'reddit_drama', label: 'r/AmIOverReacting', icon: Flame, desc: '3 historias reales (Slang & Rants)' }
            ],
            "Professional": [
                { id: 'advice', label: 'Advice / Consultation', icon: HeartHandshake, desc: 'Dilemas complejos' },
                { id: 'email', label: 'Email / Letter', icon: Briefcase },
                { id: 'interview', label: 'Job Interview Simulation', icon: Briefcase }
            ],
            "Creative": [
                { id: 'story', label: 'Short Story', icon: Feather },
                { id: 'dialogue', label: 'Dialogue / Script', icon: Feather },
                { id: 'grammar_check', label: 'Grammar Check', icon: Feather, desc: 'ESL Standard (A1-C2)' }
            ]
        };

        const ReadingBuilder = () => {
            const [step, setStep] = useState('config'); 
            const [loading, setLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            const [parentPath, setParentPath] = useState('');
            const [editingId, setEditingId] = useState(null);
            
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isLoadingModels, setIsLoadingModels] = useState(false);
            
            const [config, setConfig] = useState({ level: 'Basic', genre: 'biography', topic: '' });
            
            const [readingData, setReadingData] = useState({ title: '', stories: [] });
            const [curIdx, setCurIdx] = useState(0);

            const [isDarkMode, setIsDarkMode] = useState(true);
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [isEditingText, setIsEditingText] = useState(false);
            const [tempText, setTempText] = useState("");

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);
                else setIsDarkMode(true);

                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const folder = params.get('folder');
                    if (folder && folder !== 'undefined' && folder !== 'null') setParentPath(decodeURIComponent(folder));
                    const editId = params.get('edit');
                    if (editId) {
                        try {
                            const docSnap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId));
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                let loadedStories = [];
                                if (data.stories) {
                                    loadedStories = data.stories.map(s => ({
                                        ...s,
                                        content: s.text,
                                        tokens: processContent(s.text, [], s.blanks)
                                    }));
                                } else if (data.content) {
                                    loadedStories = [{
                                        title: data.title,
                                        content: data.content.text,
                                        fun_fact: data.content.fun_fact || "",
                                        image_url: data.content.image_url || "",
                                        questions: data.content.questions || [],
                                        tokens: processContent(data.content.text, [], data.content.blanks)
                                    }];
                                }

                                setReadingData({ title: data.title, stories: loadedStories });
                                setConfig(prev => ({ ...prev, level: data.level, genre: data.genre }));
                                setCurIdx(0);
                                setEditingId(editId);
                                setStep('editor');
                                setHasUnsavedChanges(false);
                            }
                        } catch (e) { console.error(e); }
                    }
                };
                init();

                const handleBeforeUnload = (e) => { if (hasUnsavedChanges) e.preventDefault(); };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [hasUnsavedChanges]);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            const safeNavigate = (url) => {
                if (!hasUnsavedChanges || confirm("‚ö†Ô∏è Tienes cambios sin guardar. ¬øSeguro que quieres salir y perderlos?")) window.location.href = url;
            };

            const safeGoBack = () => {
                if (!hasUnsavedChanges || confirm("‚ö†Ô∏è Perder√°s la lectura generada si regresas sin guardar. ¬øContinuar?")) {
                    setStep('config'); setHasUnsavedChanges(false);
                }
            };

            const cleanWord = (w) => w.toLowerCase().replace(/[^a-z0-9√°√©√≠√≥√∫√±]/g, '');

            const processContent = (text, suggestions = [], existingBlanks = []) => {
                const regex = /([a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+|[^a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë\s]+|\s+)/g;
                const parts = text.match(regex) || [];
                let tokens = parts.map((part, index) => ({ id: index, text: part, isWord: /^[a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+$/.test(part), isHidden: existingBlanks.includes(index), isSuggested: false }));

                if (suggestions.length > 0) {
                    suggestions.forEach(sug => {
                        const sugWords = sug.split(' ').map(cleanWord).filter(w => w);
                        for (let i = 0; i < tokens.length; i++) {
                            if (!tokens[i].isWord) continue;
                            let match = true; let tokenIdx = i; let matchedTokens = [];
                            for (let j = 0; j < sugWords.length; j++) {
                                while(tokenIdx < tokens.length && !tokens[tokenIdx].isWord) tokenIdx++;
                                if (tokenIdx >= tokens.length || cleanWord(tokens[tokenIdx].text) !== sugWords[j]) { match = false; break; }
                                matchedTokens.push(tokenIdx); tokenIdx++;
                            }
                            if (match) matchedTokens.forEach(idx => tokens[idx].isSuggested = true);
                        }
                    });
                }
                return tokens;
            };

            const fetchModels = async () => {
                if (!apiKey) return alert("Ingresa tu API Key primero");
                setIsLoadingModels(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("Error conectando con Google");
                    const data = await response.json();
                    const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name);
                    setAvailableModels(validModels);
                    if (validModels.length > 0) setSelectedModel(validModels.find(m => m.includes("gemini-1.5-flash")) || validModels[0]);
                } catch (e) { alert(e.message); } finally { setIsLoadingModels(false); }
            };

            const generateReading = async () => {
                if (!apiKey) return alert("Falta API Key");
                if (!selectedModel) return alert("Selecciona un modelo primero");
                setLoading(true);

                const needsSearch = GENRES["Real World"].some(g => g.id === config.genre);
                const isReddit = config.genre === 'reddit_drama';
                const storyCount = isReddit ? 3 : 1;
                
                let levelInstructions = "Write in 'COOL MODE': Tell the story like a charismatic, eloquent storyteller explaining it to a friend or like a fascinating YouTube video essay. Keep the language natural, easy to follow, and highly engaging. AVOID dry, academic, or overly formal 'encyclopedia' language.";
                
                if (config.genre === 'grammar_check') {
                    if(config.level === 'Basic') levelInstructions = "GRAMMAR FOCUS: CEFR A1/A2. Use simple vocabulary and basic present/past simple structures. Short clear sentences.";
                    else if(config.level === 'Advanced') levelInstructions = "GRAMMAR FOCUS: CEFR B1/B2. Use moderate complexity, past narrative tenses, perfect tenses.";
                    else levelInstructions = "GRAMMAR FOCUS: CEFR C1/C2. Use rich vocabulary, passive voice, advanced phrasal verbs.";
                }

                let genreInstructions = "";
                if(config.genre === 'biography') genreInstructions = "Must be a 4-paragraph biography: 1. Early life/formation. 2. Rise to fame/achievements. 3. Polemics/struggles. 4. Current life/future/legacy.";
                else if(config.genre === 'advice') genreInstructions = "Present a complex moral or professional dilemma, nuanced pros and cons, and a final advice.";
                else if(isReddit) genreInstructions = "Search the subreddit r/AmIOverReacting. Pick 3 distinct, highly engaging, popular recent stories. Keep the authentic Reddit tone, slang (e.g., 'gaslighting', 'red flags'), and rants. Filter out extreme profanity but keep the drama. Present them as 3 separate stories.";

                const prompt = `
                    Generate an English reading activity. 
                    Genre: ${config.genre}. ${genreInstructions}
                    Topic: ${config.topic || "Choose an engaging topic relevant to the genre."}
                    ${levelInstructions}

                    MANDATORY JSON OUTPUT FORMAT:
                    {
                        "album_title": "Catchy Overall Title (e.g., 'Reddit Drama of the Week' or 'Marie Curie Biography')",
                        "stories": [
                            {
                                "title": "Specific Story Title",
                                "content": "Full text body here. Use \\n\\n to separate paragraphs.",
                                "fun_fact": "A short, mind-blowing 'Did You Know?' fact related to the topic.",
                                "suggested_words_to_blank": ["verb1", "phrasal verb", "key noun"],
                                "questions": [
                                    { "q": "Question asking for a specific detail?", "a": "Short answer", "paragraph_index": 0 }
                                ]
                            }
                        ]
                    }

                    Rules:
                    - You MUST generate exactly ${storyCount} item(s) in the 'stories' array.
                    - 'suggested_words_to_blank' MUST contain 5-8 key vocabulary words or verbs actually present in the text.
                    - 'questions' MUST contain exactly 3 reading comprehension questions per story. 'paragraph_index' is a 0-based integer indicating which paragraph contains the answer.
                    ${needsSearch ? "IMPORTANT: USE THE GOOGLE SEARCH TOOL to ensure facts/stories are real and accurate." : ""}
                    RETURN ONLY RAW JSON.
                `;

                try {
                    const tools = needsSearch ? [{ googleSearch: {} }] : [];
                    const generationConfig = needsSearch ? {} : { responseMimeType: "application/json" };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools, generationConfig })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim(); 
                    const result = JSON.parse(text);
                    
                    const processedStories = result.stories.map(s => ({
                        title: s.title,
                        content: s.content,
                        fun_fact: s.fun_fact || "",
                        image_url: "",
                        questions: s.questions || [],
                        tokens: processContent(s.content, s.suggested_words_to_blank || [])
                    }));

                    setReadingData({ title: result.album_title, stories: processedStories });
                    setCurIdx(0);
                    setStep('editor');
                    setHasUnsavedChanges(true);
                } catch (e) { alert("Error: " + e.message); console.error(e); } finally { setLoading(false); }
            };

            const saveActivity = async () => {
                if (!readingData.title) return alert("Falta el T√≠tulo Principal del √Ålbum");
                try {
                    const savedStories = readingData.stories.map(s => ({
                        title: s.title, text: s.content, fun_fact: s.fun_fact, image_url: s.image_url,
                        blanks: s.tokens.filter(t => t.isHidden).map(t => t.id),
                        questions: s.questions
                    }));

                    const payload = {
                        title: readingData.title, type: 'READING', level: config.level, genre: config.genre, parentPath: parentPath,
                        stories: savedStories
                    };

                    if (editingId) await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), { ...payload, updatedAt: serverTimestamp() }); 
                    else await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), { ...payload, createdAt: serverTimestamp() }); 
                    
                    setHasUnsavedChanges(false);
                    window.location.href = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html';
                } catch (e) { alert("Error guardando: " + e.message); }
            };

            const toggleHidden = (tokenIdx) => {
                setHasUnsavedChanges(true);
                setReadingData(prev => {
                    const newStories = [...prev.stories];
                    const curStory = newStories[curIdx];
                    curStory.tokens = curStory.tokens.map((t, i) => i === tokenIdx && t.isWord ? { ...t, isHidden: !t.isHidden } : t);
                    return { ...prev, stories: newStories };
                });
            };

            const handleImageDrop = (e) => {
                e.preventDefault();
                setHasUnsavedChanges(true);
                const html = e.dataTransfer.getData('text/html');
                const uri = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/uri-list');
                let foundUrl = '';
                if (html) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const img = doc.querySelector('img');
                    if (img) foundUrl = img.src;
                }
                if (!foundUrl && uri) foundUrl = uri;
                if (foundUrl) {
                    setReadingData(prev => {
                        const newStories = [...prev.stories];
                        newStories[curIdx].image_url = foundUrl;
                        return { ...prev, stories: newStories };
                    });
                } else alert("No se detect√≥ una imagen v√°lida.");
            };

            const handleTextEditToggle = () => {
                if (!isEditingText) {
                    setTempText(readingData.stories[curIdx].content);
                    setIsEditingText(true);
                } else {
                    if (confirm("¬øAplicar y Commitear cambios en el texto? Los huecos seleccionados podr√≠an desfasarse.")) {
                        setHasUnsavedChanges(true);
                        setReadingData(prev => {
                            const newStories = [...prev.stories];
                            const curStory = newStories[curIdx];
                            curStory.content = tempText;
                            curStory.tokens = processContent(tempText, [], curStory.tokens.filter(t=>t.isHidden).map(t=>t.id));
                            return { ...prev, stories: newStories };
                        });
                        setIsEditingText(false);
                    }
                }
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-slate-50 dark:bg-zinc-950 font-sans transition-colors duration-300">
                        {step === 'config' ? (
                            <div className="max-w-5xl mx-auto p-4 md:p-6 flex flex-col h-screen">
                                <div className="bg-slate-900 dark:bg-zinc-900 p-4 md:p-6 rounded-t-3xl text-white flex flex-col md:flex-row justify-between items-center shrink-0 border-b border-slate-800 dark:border-zinc-800 gap-4">
                                    <div className="w-full md:w-auto flex justify-between md:justify-start items-center">
                                        <div><h1 className="text-xl md:text-2xl font-black flex items-center gap-2"><BookOpen className="text-emerald-400" size={24}/> Reading Builder</h1><p className="text-slate-400 text-[10px] md:text-xs uppercase font-bold tracking-widest mt-1">Motor de Generaci√≥n IA</p></div>
                                        <button onClick={toggleTheme} className="p-2 hover:bg-slate-800 dark:hover:bg-zinc-800 rounded-lg transition-colors text-yellow-400 md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                    </div>
                                    <div className="flex flex-wrap items-center gap-2 w-full md:w-auto justify-end">
                                        <button onClick={() => safeNavigate('index.html')} className="p-2 hover:bg-slate-800 dark:hover:bg-zinc-800 rounded-lg transition-colors"><ArrowLeft size={20}/></button>
                                        <button onClick={toggleTheme} className="hidden md:block p-2 hover:bg-slate-800 dark:hover:bg-zinc-800 rounded-lg transition-colors text-yellow-400">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                        <div className="hidden md:block w-px h-6 bg-slate-700 mx-2"></div>
                                        <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-800 dark:bg-zinc-800 rounded-lg px-3 py-2 text-xs w-28 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-center" placeholder="API Key"/>
                                        <button onClick={fetchModels} disabled={isLoadingModels || !apiKey} className="p-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg"><Search size={16}/></button>
                                        {availableModels.length > 0 && (<select value={selectedModel} onChange={e => setSelectedModel(e.target.value)} className="bg-slate-800 dark:bg-zinc-800 rounded-lg px-2 py-2 text-xs text-white max-w-[120px]">{availableModels.map(m => <option key={m} value={m}>{m.replace('models/', '')}</option>)}</select>)}
                                    </div>
                                </div>
                                
                                <div className="flex flex-1 flex-col md:flex-row overflow-hidden bg-white dark:bg-zinc-950 border-x border-b border-slate-200 dark:border-zinc-800 rounded-b-3xl shadow-xl transition-colors">
                                    {/* LEFT: CONFIG (Top on mobile) */}
                                    <div className="w-full md:w-1/2 p-4 md:p-6 border-b md:border-b-0 md:border-r border-slate-100 dark:border-zinc-800 flex flex-col h-1/2 md:h-auto">
                                        <label className="text-xs font-black text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-3">G√©nero de Lectura</label>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-6">
                                            {Object.entries(GENRES).map(([cat, items]) => (
                                                <div key={cat}><p className="text-[10px] font-black text-slate-300 dark:text-zinc-600 uppercase mb-2 tracking-widest">{cat}</p>
                                                    <div className="space-y-2">
                                                        {items.map(g => (
                                                            <button key={g.id} onClick={() => setConfig({...config, genre: g.id})} className={`w-full text-left p-3 md:p-4 rounded-xl border flex items-center justify-between transition-all ${config.genre === g.id ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-400 dark:border-emerald-500 text-emerald-900 dark:text-emerald-300 ring-1 ring-emerald-400' : 'bg-white dark:bg-zinc-900 border-slate-200 dark:border-zinc-700 text-slate-600 dark:text-zinc-400 hover:border-slate-300 dark:hover:border-zinc-500'}`}>
                                                                <div className="flex items-center gap-3"><g.icon size={18} className={config.genre === g.id ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400 dark:text-zinc-500'}/><div><div className="font-bold text-sm">{g.label}</div>{g.desc && <div className="text-[10px] opacity-70 line-clamp-1">{g.desc}</div>}</div></div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* RIGHT: TOPIC & GEN (Bottom on mobile) */}
                                    <div className="w-full md:w-1/2 p-4 md:p-6 bg-slate-50 dark:bg-zinc-900/50 flex flex-col relative overflow-y-auto h-1/2 md:h-auto">
                                        {config.genre === 'grammar_check' && (
                                            <div className="mb-4 md:mb-6 animate-in fade-in slide-in-from-top-4">
                                                <label className="text-xs font-black text-indigo-400 dark:text-indigo-500 uppercase tracking-widest mb-3 flex items-center gap-2"><CheckCircle2 size={16}/> Est√°ndar CEFR</label>
                                                <div className="flex gap-2 bg-white dark:bg-zinc-900 p-1.5 rounded-xl border border-indigo-100 dark:border-zinc-800 shadow-sm">
                                                    {['Basic', 'Advanced', 'Pro'].map(l => (
                                                        <button key={l} onClick={() => setConfig({...config, level: l})} className={`flex-1 py-2 md:py-3 text-sm font-bold rounded-lg transition-all ${config.level===l ? 'bg-indigo-500 dark:bg-indigo-600 text-white shadow-md' : 'text-slate-500 dark:text-zinc-400 hover:bg-slate-50 dark:hover:bg-zinc-800'}`}>{l}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        <label className="text-xs font-black text-slate-400 dark:text-zinc-500 uppercase tracking-widest mb-3">Tema Espec√≠fico (Opcional)</label>
                                        <textarea value={config.topic} onChange={e => setConfig({...config, topic: e.target.value})} className="w-full flex-1 min-h-[100px] md:min-h-[150px] bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-2xl p-4 outline-none focus:border-emerald-500 dark:focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 resize-none font-medium text-slate-700 dark:text-zinc-200 placeholder-slate-300 dark:placeholder-zinc-600" placeholder="Ej: Biograf√≠a de Marie Curie, Un dilema sobre robar wifi..."></textarea>
                                        
                                        <button onClick={generateReading} disabled={loading || !selectedModel} className="w-full mt-4 md:mt-6 py-4 md:py-5 bg-slate-900 dark:bg-white text-white dark:text-zinc-900 rounded-2xl font-black uppercase tracking-widest hover:bg-emerald-600 dark:hover:bg-emerald-500 dark:hover:text-white transition-all flex items-center justify-center gap-3 disabled:opacity-50 shadow-xl hover:-translate-y-1 shrink-0 text-sm md:text-base">
                                            {loading ? <Loader2 className="animate-spin"/> : <Sparkles className="text-yellow-400 dark:text-amber-500"/>} {loading ? "Construyendo..." : "Generar con Gemini"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="max-w-5xl mx-auto p-4 md:p-6 h-screen flex flex-col">
                                <div className="bg-white dark:bg-zinc-900 p-4 rounded-t-3xl border border-slate-200 dark:border-zinc-800 flex flex-col md:flex-row justify-between items-center shrink-0 transition-colors gap-4">
                                    <div className="flex items-center justify-between w-full md:w-auto gap-4">
                                        <div className="flex items-center gap-4">
                                            <button onClick={safeGoBack} className="p-2 bg-slate-100 dark:bg-zinc-800 hover:bg-slate-200 dark:hover:bg-zinc-700 text-slate-600 dark:text-zinc-300 rounded-full transition-colors"><ArrowLeft size={20}/></button>
                                            <div><h2 className="font-black text-lg dark:text-zinc-100">Editor {hasUnsavedChanges && <span className="text-rose-500 text-sm ml-2">*</span>}</h2><p className="text-[10px] text-slate-400 dark:text-zinc-500 font-bold uppercase tracking-widest hidden md:block">Palabras amarillas son sugerencias</p></div>
                                        </div>
                                        <button onClick={toggleTheme} className="p-2 text-slate-400 hover:text-amber-400 dark:hover:text-amber-400 transition-colors md:hidden">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                    </div>
                                    <div className="flex items-center gap-2 w-full md:w-auto justify-end">
                                        <button onClick={toggleTheme} className="hidden md:block p-2 text-slate-400 hover:text-amber-400 dark:hover:text-amber-400 transition-colors">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                                        <div className="hidden md:block w-px h-6 bg-slate-200 dark:bg-zinc-700"></div>
                                        
                                        <button onClick={handleTextEditToggle} className={`px-3 py-2 md:px-4 rounded-xl font-bold flex items-center gap-2 transition-all text-xs md:text-sm ${isEditingText ? 'bg-amber-500 hover:bg-amber-600 text-white shadow-md animate-pulse' : 'bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-zinc-300 hover:bg-slate-200 dark:hover:bg-zinc-700'}`}>
                                            {isEditingText ? <><CheckCircle2 size={16}/> Commit</> : <><Edit3 size={16}/> Texto</>}
                                        </button>
                                        
                                        <button onClick={saveActivity} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 md:px-6 rounded-xl font-bold flex items-center gap-2 shadow-lg text-xs md:text-sm"><Save size={16}/> Guardar</button>
                                    </div>
                                </div>
                                
                                {/* BARRA NAVEGACI√ìN DE HISTORIAS (Si es √°lbum) */}
                                {readingData.stories.length > 1 && (
                                    <div className="bg-indigo-50 dark:bg-indigo-900/30 border-x border-b border-indigo-100 dark:border-indigo-800/50 p-2 md:p-3 flex items-center justify-between">
                                        <span className="text-[10px] md:text-xs font-black text-indigo-800 dark:text-indigo-300 uppercase tracking-widest flex items-center gap-2"><BookOpen size={14}/> √Ålbum</span>
                                        <div className="flex items-center gap-2 md:gap-4">
                                            <button onClick={() => setCurIdx(c => Math.max(0, c - 1))} disabled={curIdx === 0} className="p-1 text-indigo-600 dark:text-indigo-400 disabled:opacity-30 hover:bg-indigo-200 dark:hover:bg-indigo-800 rounded"><ChevronLeft size={18}/></button>
                                            <span className="font-bold text-xs md:text-sm dark:text-zinc-200">{curIdx + 1} / {readingData.stories.length}</span>
                                            <button onClick={() => setCurIdx(c => Math.min(readingData.stories.length - 1, c + 1))} disabled={curIdx === readingData.stories.length - 1} className="p-1 text-indigo-600 dark:text-indigo-400 disabled:opacity-30 hover:bg-indigo-200 dark:hover:bg-indigo-800 rounded"><ChevronRight size={18}/></button>
                                        </div>
                                    </div>
                                )}

                                <div className="flex-1 overflow-y-auto bg-white dark:bg-zinc-950 border-x border-b border-slate-200 dark:border-zinc-800 p-4 md:p-8 rounded-b-3xl transition-colors">
                                    
                                    <div className="mb-6 md:mb-8">
                                        <label className="text-[10px] text-slate-400 dark:text-zinc-500 font-bold uppercase tracking-widest">T√≠tulo General</label>
                                        <input value={readingData.title} onChange={e => {setHasUnsavedChanges(true); setReadingData({...readingData, title: e.target.value});}} className="text-2xl md:text-4xl font-black w-full border-none outline-none bg-transparent dark:text-zinc-100 placeholder-slate-300 dark:placeholder-zinc-700" placeholder="T√≠tulo Principal..."/>
                                    </div>

                                    <div className="mb-6 md:mb-8">
                                        <label className="text-[10px] text-slate-400 dark:text-zinc-500 font-bold uppercase tracking-widest">T√≠tulo de esta Historia</label>
                                        <input value={readingData.stories[curIdx]?.title || ''} onChange={e => {
                                            setHasUnsavedChanges(true);
                                            setReadingData(prev => {
                                                const newStories = [...prev.stories];
                                                newStories[curIdx].title = e.target.value;
                                                return { ...prev, stories: newStories };
                                            });
                                        }} className="text-xl md:text-2xl font-bold w-full border-b border-dashed border-slate-300 dark:border-zinc-700 outline-none bg-transparent dark:text-zinc-300 placeholder-slate-300 dark:placeholder-zinc-700 pb-2" placeholder="Subt√≠tulo..."/>
                                    </div>
                                    
                                    <div className="mb-6 md:mb-8 space-y-2">
                                        {!readingData.stories[curIdx]?.image_url ? (
                                            <div onDrop={handleImageDrop} onDragOver={e=>e.preventDefault()} className="rounded-2xl border-2 border-dashed border-slate-300 dark:border-zinc-700 bg-slate-50 dark:bg-zinc-900 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 hover:border-indigo-300 transition-colors p-4 md:p-8 relative flex flex-col items-center justify-center text-slate-400 dark:text-zinc-500 cursor-pointer">
                                                <ImageIcon size={24} className="mb-2 md:mb-3"/>
                                                <span className="text-xs md:text-sm font-bold uppercase tracking-widest text-center">Arrastra imagen aqu√≠</span>
                                            </div>
                                        ) : (
                                            <div className="relative w-full h-48 md:h-64 rounded-2xl overflow-hidden group border-4 border-slate-100 dark:border-zinc-800 shadow-sm">
                                                <img src={readingData.stories[curIdx].image_url} className="w-full h-full object-cover"/>
                                                <button onClick={() => {
                                                    setHasUnsavedChanges(true); 
                                                    setReadingData(prev => {
                                                        const newS = [...prev.stories]; newS[curIdx].image_url = ''; return {...prev, stories: newS};
                                                    });
                                                }} className="absolute top-2 right-2 md:top-4 md:right-4 bg-black/70 text-white p-1.5 md:p-2 rounded-full hover:bg-red-500 transition-colors z-10 backdrop-blur"><X size={16}/></button>
                                            </div>
                                        )}
                                        {!readingData.stories[curIdx]?.image_url && (
                                            <div className="flex items-center gap-2 bg-white dark:bg-zinc-900 border border-slate-200 dark:border-zinc-700 rounded-xl px-3 py-2 md:px-4 md:py-3">
                                                <LinkIcon size={16} className="text-slate-400 dark:text-zinc-500 shrink-0"/>
                                                <input value={readingData.stories[curIdx]?.image_url || ''} onChange={e => {
                                                    setHasUnsavedChanges(true); 
                                                    setReadingData(prev => {
                                                        const newS = [...prev.stories]; newS[curIdx].image_url = e.target.value; return {...prev, stories: newS};
                                                    });
                                                }} className="w-full text-xs md:text-sm outline-none text-slate-700 dark:text-zinc-300 font-medium bg-transparent" placeholder="O pega enlace directo..."/>
                                            </div>
                                        )}
                                    </div>

                                    {isEditingText ? (
                                        <textarea 
                                            value={tempText} 
                                            onChange={e => setTempText(e.target.value)} 
                                            className="w-full min-h-[300px] text-base md:text-lg text-slate-800 dark:text-zinc-200 bg-slate-50 dark:bg-zinc-900 p-4 md:p-12 rounded-[2rem] border-2 border-amber-300 shadow-inner leading-relaxed md:leading-[2.5rem] mb-8 resize-none outline-none focus:ring-4 focus:ring-amber-100 dark:focus:ring-amber-900/30 transition-all font-medium"
                                        />
                                    ) : (
                                        <div className="text-base md:text-lg text-slate-800 dark:text-zinc-200 bg-slate-50 dark:bg-zinc-900 p-4 md:p-12 rounded-[2rem] border border-slate-100 dark:border-zinc-800 shadow-inner leading-relaxed md:leading-[2.5rem] mb-8 text-justify transition-colors">
                                            {readingData.stories[curIdx]?.tokens.map((t, i) => {
                                                const curStory = readingData.stories[curIdx];
                                                const prevHidden = i > 0 && curStory.tokens[i-1].isHidden && curStory.tokens[i-1].isWord;
                                                const nextHidden = i < curStory.tokens.length - 1 && curStory.tokens[i+1].isHidden && curStory.tokens[i+1].isWord;
                                                
                                                let classes = "inline-block px-0.5 cursor-pointer transition-colors border-b-2 select-none ";
                                                
                                                if (t.isHidden) {
                                                    classes += "bg-emerald-100 dark:bg-emerald-900/40 text-emerald-900 dark:text-emerald-300 border-emerald-400 dark:border-emerald-600 font-black ";
                                                    if (!prevHidden) classes += "rounded-l-lg pl-2 border-l-2 "; 
                                                    if (!nextHidden) classes += "rounded-r-lg pr-2 border-r-2 "; 
                                                    if (prevHidden && nextHidden) classes += "border-x-0 "; 
                                                    classes += "mx-0 "; 
                                                } else if (t.isWord) {
                                                    classes += "border-transparent mx-[1px] rounded hover:bg-slate-200 dark:hover:bg-zinc-700 ";
                                                    if (t.isSuggested) classes += "ring-2 ring-amber-300 dark:ring-amber-600 bg-amber-50 dark:bg-amber-900/30 text-amber-900 dark:text-amber-300 font-bold animate-pulse ";
                                                } else {
                                                    if (t.text.match(/\n/)) return <br key={i}/>;
                                                    classes = "inline-block "; 
                                                }

                                                return <span key={i} onClick={() => toggleHidden(i)} className={classes}>{t.text}</span>;
                                            })}
                                        </div>
                                    )}

                                    {readingData.stories[curIdx]?.fun_fact && (
                                        <div className="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-400 dark:border-amber-600 p-4 md:p-6 rounded-r-2xl mb-8 flex gap-3 md:gap-4 items-start shadow-sm">
                                            <div className="bg-amber-100 dark:bg-amber-800 p-2 rounded-full text-amber-600 dark:text-amber-300 shrink-0"><Lightbulb size={20}/></div>
                                            <textarea value={readingData.stories[curIdx].fun_fact} onChange={e => {
                                                setHasUnsavedChanges(true); 
                                                setReadingData(prev => {
                                                    const newS = [...prev.stories]; newS[curIdx].fun_fact = e.target.value; return {...prev, stories: newS};
                                                });
                                            }} className="w-full bg-transparent border-none outline-none text-amber-900 dark:text-amber-200 font-medium resize-none text-sm md:text-base" rows={3}/>
                                        </div>
                                    )}

                                    <div className="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/50 p-4 md:p-8 rounded-[2rem]">
                                        <h4 className="font-black text-indigo-800 dark:text-indigo-400 uppercase tracking-widest text-xs mb-4 md:mb-6 flex items-center gap-2"><HelpCircle size={16}/> Preguntas Generadas</h4>
                                        <div className="space-y-3 md:space-y-4">
                                            {readingData.stories[curIdx]?.questions.map((q, i) => (
                                                <div key={i} className="bg-white dark:bg-zinc-800 p-4 md:p-5 rounded-2xl shadow-sm border border-indigo-50 dark:border-zinc-700">
                                                    <p className="font-bold text-slate-800 dark:text-zinc-200 text-sm md:text-base">{i+1}. {q.q}</p>
                                                    <p className="text-xs md:text-sm text-indigo-600 dark:text-indigo-400 font-medium mt-1">R: {q.a} <span className="opacity-50 text-slate-400 dark:text-zinc-500 text-xs ml-2">(P√°rrafo {q.paragraph_index + 1})</span></p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingBuilder />);
    </script>
</body>
</html>
