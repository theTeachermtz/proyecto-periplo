<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; height: 100vh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { BookOpen, Sparkles, Save, ArrowLeft, Globe, Feather, Briefcase, HeartHandshake, Loader2, Search, Lightbulb, Image as ImageIcon, X, Link as LinkIcon, HelpCircle } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const GENRES = {
            "Real World": [
                { id: 'biography', label: 'Biography (Real Person)', icon: Globe },
                { id: 'news', label: 'Breaking News / Current Events', icon: Globe },
                { id: 'travel', label: 'Travel Guide (Real Place)', icon: Globe }
            ],
            "Professional": [
                { id: 'advice', label: 'Advice / Consultation', icon: HeartHandshake, desc: 'Dilemas complejos' },
                { id: 'email', label: 'Email / Letter', icon: Briefcase }
            ],
            "Creative": [
                { id: 'story', label: 'Short Story', icon: Feather },
                { id: 'anecdote', label: 'Funny Anecdote', icon: Feather }
            ]
        };

        const ReadingBuilder = () => {
            const [step, setStep] = useState('config'); 
            const [loading, setLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            const [parentPath, setParentPath] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(false);
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isLoadingModels, setIsLoadingModels] = useState(false);
            
            const [config, setConfig] = useState({ level: 'Basic', genre: 'biography', topic: '' });
            const [readingData, setReadingData] = useState({ title: '', content: '', fun_fact: '', image_url: '', tokens: [], questions: [] });

            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const folder = params.get('folder');
                    if (folder && folder !== 'undefined' && folder !== 'null') setParentPath(decodeURIComponent(folder));
                    const editId = params.get('edit');
                    if (editId) {
                        setIsLoadingData(true);
                        try {
                            const docRef = doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setReadingData({
                                    title: data.title,
                                    content: data.content.text,
                                    fun_fact: data.content.fun_fact || "", 
                                    image_url: data.content.image_url || "", 
                                    tokens: processContent(data.content.text, [], data.content.blanks),
                                    questions: data.content.questions || []
                                });
                                setConfig(prev => ({ ...prev, level: data.level, genre: data.genre }));
                                setEditingId(editId);
                                setStep('editor');
                            }
                        } catch (e) { console.error(e); } finally { setIsLoadingData(false); }
                    }
                };
                init();
            }, []);

            // Normalizador mejorado para ignorar mayÃºsculas y puntuaciÃ³n bÃ¡sica
            const cleanWord = (w) => w.toLowerCase().replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±]/g, '');

            const processContent = (text, suggestions = [], existingBlanks = []) => {
                const regex = /([a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+|[^a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+|\s+)/g;
                const parts = text.match(regex) || [];
                
                let tokens = parts.map((part, index) => ({ 
                    id: index, 
                    text: part, 
                    isWord: /^[a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+$/.test(part), 
                    isHidden: existingBlanks.includes(index),
                    isSuggested: false
                }));

                // LÃ³gica para encontrar sugerencias (incluso frases de varias palabras)
                if (suggestions.length > 0) {
                    suggestions.forEach(sug => {
                        const sugWords = sug.split(' ').map(cleanWord).filter(w => w);
                        for (let i = 0; i < tokens.length; i++) {
                            if (!tokens[i].isWord) continue;
                            
                            // Check si empieza la coincidencia
                            let match = true;
                            let tokenIdx = i;
                            let matchedTokens = [];

                            for (let j = 0; j < sugWords.length; j++) {
                                // Avanzar espacios
                                while(tokenIdx < tokens.length && !tokens[tokenIdx].isWord) tokenIdx++;
                                
                                if (tokenIdx >= tokens.length || cleanWord(tokens[tokenIdx].text) !== sugWords[j]) {
                                    match = false; break;
                                }
                                matchedTokens.push(tokenIdx);
                                tokenIdx++;
                            }

                            if (match) {
                                matchedTokens.forEach(idx => tokens[idx].isSuggested = true);
                            }
                        }
                    });
                }
                return tokens;
            };

            const fetchModels = async () => {
                if (!apiKey) return alert("Ingresa tu API Key primero");
                setIsLoadingModels(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("Error conectando con Google");
                    const data = await response.json();
                    const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name);
                    setAvailableModels(validModels);
                    if (validModels.length > 0) {
                        const preferred = validModels.find(m => m.includes("gemini-1.5-flash")) || validModels.find(m => m.includes("gemini-2.0")) || validModels[0];
                        setSelectedModel(preferred);
                    }
                } catch (e) { alert("Error al buscar modelos: " + e.message); } finally { setIsLoadingModels(false); }
            };

            const generateReading = async () => {
                if (!apiKey) return alert("Falta API Key");
                if (!selectedModel) return alert("Por favor escanea y selecciona un modelo primero");
                setLoading(true);

                const needsSearch = GENRES["Real World"].some(g => g.id === config.genre);
                
                // MAPPING CEFR
                let cefr = "";
                if(config.level === 'Basic') cefr = "CEFR A1/A2. Use simple vocabulary and basic present/past simple structures. Short clear sentences.";
                else if(config.level === 'Advanced') cefr = "CEFR B1/B2. Use moderate complexity, past narrative tenses, perfect tenses, and some conditionals.";
                else cefr = "CEFR C1/C2. Use rich, sophisticated vocabulary, passive voice, advanced phrasal verbs, and complex clauses.";

                // MAPPING GENRE
                let genreInstructions = "";
                if(config.genre === 'biography') genreInstructions = "Must be detailed, at least 3-4 distinct paragraphs chronologically.";
                else if(config.genre === 'advice') genreInstructions = "Present a complex moral or professional dilemma, nuanced pros and cons, and a final advice. Avoid trivial problems.";

                const prompt = `
                    Generate an English reading text. 
                    Target Level: ${cefr}
                    Genre: ${config.genre}. ${genreInstructions}
                    Topic: ${config.topic || "Choose an engaging topic relevant to the genre."}

                    MANDATORY JSON OUTPUT FORMAT:
                    {
                        "title": "Title here",
                        "content": "Full text body here. Use \\n\\n to separate paragraphs.",
                        "fun_fact": "A short 'Did You Know?' fact in English.",
                        "suggested_words_to_blank": ["verb1", "phrasal verb", "key noun"],
                        "questions": [
                            { "q": "Question asking for a specific detail?", "a": "Short answer", "paragraph_index": 0 }
                        ]
                    }

                    Rules:
                    - 'suggested_words_to_blank' MUST contain 5-8 key vocabulary words or verbs actually present in the text.
                    - 'questions' MUST contain exactly 3 reading comprehension questions. 'paragraph_index' is a 0-based integer indicating which paragraph contains the answer.
                    ${needsSearch ? "IMPORTANT: USE THE GOOGLE SEARCH TOOL to ensure facts are accurate." : ""}
                    RETURN ONLY RAW JSON.
                `;

                try {
                    const tools = needsSearch ? [{ googleSearch: {} }] : [];
                    const generationConfig = needsSearch ? {} : { responseMimeType: "application/json" };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools, generationConfig })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim(); 
                    const result = JSON.parse(text);
                    
                    setReadingData({
                        title: result.title,
                        content: result.content,
                        fun_fact: result.fun_fact || "", 
                        image_url: "", 
                        questions: result.questions || [],
                        tokens: processContent(result.content, result.suggested_words_to_blank || [])
                    });
                    setStep('editor');
                } catch (e) { alert("Error: " + e.message); console.error(e); } finally { setLoading(false); }
            };

            const saveActivity = async () => {
                if (!readingData.title) return alert("Falta tÃ­tulo");
                try {
                    const payload = {
                        title: readingData.title,
                        type: 'READING', 
                        content: {
                            text: readingData.content,
                            fun_fact: readingData.fun_fact,
                            image_url: readingData.image_url, 
                            blanks: readingData.tokens.filter(t => t.isHidden).map(t => t.id),
                            questions: readingData.questions 
                        },
                        level: config.level,
                        genre: config.genre,
                        parentPath: parentPath 
                    };
                    if (editingId) { await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), { ...payload, updatedAt: serverTimestamp() }); } 
                    else { await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), { ...payload, createdAt: serverTimestamp() }); }
                    window.location.href = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html';
                } catch (e) { alert("Error guardando: " + e.message); }
            };

            const toggleHidden = (idx) => {
                const newTokens = [...readingData.tokens];
                if (newTokens[idx].isWord) { newTokens[idx].isHidden = !newTokens[idx].isHidden; setReadingData({ ...readingData, tokens: newTokens }); }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans">
                    {step === 'config' ? (
                        <div className="max-w-5xl mx-auto p-6 flex flex-col h-screen">
                            <div className="bg-slate-900 p-6 rounded-t-3xl text-white flex justify-between items-center shrink-0">
                                <div><h1 className="text-2xl font-black flex items-center gap-2"><BookOpen className="text-emerald-400"/> Reading Builder</h1><p className="text-slate-400 text-xs uppercase font-bold tracking-widest mt-1">Motor IA (Normas CEFR)</p></div>
                                <div className="flex items-center gap-2"><button onClick={() => window.location.href='index.html'} className="p-2 hover:bg-slate-800 rounded-lg transition-colors"><ArrowLeft/></button><input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-800 rounded-lg px-3 py-2 text-xs w-28 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-center" placeholder="API Key"/><button onClick={fetchModels} disabled={isLoadingModels || !apiKey} className="p-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg"><Search size={16}/></button>{availableModels.length > 0 && (<select value={selectedModel} onChange={e => setSelectedModel(e.target.value)} className="bg-slate-800 rounded-lg px-2 py-2 text-xs text-white max-w-[120px]">{availableModels.map(m => <option key={m} value={m}>{m.replace('models/', '')}</option>)}</select>)}</div>
                            </div>
                            
                            <div className="flex flex-1 overflow-hidden bg-white border-x border-b border-slate-200 rounded-b-3xl shadow-xl">
                                {/* LEFT: CONFIG */}
                                <div className="w-1/2 p-6 border-r border-slate-100 flex flex-col">
                                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Nivel (CEFR Standard)</label>
                                    <div className="flex gap-2 bg-slate-100 p-1.5 rounded-xl mb-8">
                                        {['Basic', 'Advanced', 'Pro'].map(l => (
                                            <button key={l} onClick={() => setConfig({...config, level: l})} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all ${config.level===l ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>{l}</button>
                                        ))}
                                    </div>

                                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">GÃ©nero de Lectura</label>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-6">
                                        {Object.entries(GENRES).map(([cat, items]) => (
                                            <div key={cat}><p className="text-[10px] font-black text-slate-300 uppercase mb-2 tracking-widest">{cat}</p>
                                                <div className="space-y-2">
                                                    {items.map(g => (
                                                        <button key={g.id} onClick={() => setConfig({...config, genre: g.id})} className={`w-full text-left p-4 rounded-xl border flex items-center justify-between transition-all ${config.genre === g.id ? 'bg-emerald-50 border-emerald-400 text-emerald-900 ring-1 ring-emerald-400' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                                                            <div className="flex items-center gap-3"><g.icon size={18} className={config.genre === g.id ? 'text-emerald-600' : 'text-slate-400'}/><div><div className="font-bold text-sm">{g.label}</div>{g.desc && <div className="text-[10px] opacity-70">{g.desc}</div>}</div></div>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* RIGHT: TOPIC & GEN */}
                                <div className="w-1/2 p-6 bg-slate-50 flex flex-col">
                                    <label className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Tema EspecÃ­fico (Opcional)</label>
                                    <textarea value={config.topic} onChange={e => setConfig({...config, topic: e.target.value})} className="w-full h-40 bg-white border border-slate-200 rounded-2xl p-4 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 resize-none font-medium text-slate-700 placeholder-slate-300" placeholder="Ej: BiografÃ­a de Marie Curie, Un dilema sobre robar wifi en la oficina..."></textarea>
                                    
                                    <div className="flex-1"></div>

                                    <button onClick={generateReading} disabled={loading || !selectedModel} className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest hover:bg-emerald-600 transition-all flex items-center justify-center gap-3 disabled:opacity-50 shadow-xl hover:-translate-y-1">
                                        {loading ? <Loader2 className="animate-spin"/> : <Sparkles className="text-yellow-400"/>} {loading ? "Construyendo Lectura..." : "Generar con Gemini"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="max-w-5xl mx-auto p-6 h-screen flex flex-col">
                            <div className="bg-white p-4 rounded-t-3xl border border-slate-200 flex justify-between items-center shrink-0">
                                <div className="flex items-center gap-4"><button onClick={() => setStep('config')} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-full"><ArrowLeft size={20}/></button><div><h2 className="font-black text-lg">Editor de Huecos</h2><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Las palabras amarillas son sugerencias de la IA</p></div></div>
                                <button onClick={saveActivity} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg"><Save size={18}/> Guardar Final</button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto bg-white border-x border-b border-slate-200 p-8 rounded-b-3xl">
                                <input value={readingData.title} onChange={e => setReadingData({...readingData, title: e.target.value})} className="text-3xl font-black w-full border-none outline-none mb-8 bg-transparent" placeholder="TÃ­tulo..."/>
                                
                                {/* TEXTO INTERACTIVO CON FUSIÃ“N VISUAL Y SUGERENCIAS */}
                                <div className="text-lg text-slate-800 bg-slate-50 p-8 rounded-3xl border border-slate-100 shadow-inner leading-[2.5rem] mb-8 text-justify">
                                    {readingData.tokens.map((t, i) => {
                                        const prevHidden = i > 0 && readingData.tokens[i-1].isHidden && readingData.tokens[i-1].isWord;
                                        const nextHidden = i < readingData.tokens.length - 1 && readingData.tokens[i+1].isHidden && readingData.tokens[i+1].isWord;
                                        
                                        let classes = "inline-block px-0.5 cursor-pointer transition-colors border-b-2 select-none ";
                                        
                                        if (t.isHidden) {
                                            classes += "bg-emerald-100 text-emerald-900 border-emerald-400 font-black ";
                                            if (!prevHidden) classes += "rounded-l-lg pl-2 border-l-2 "; // Empieza bloque
                                            if (!nextHidden) classes += "rounded-r-lg pr-2 border-r-2 "; // Termina bloque
                                            if (prevHidden && nextHidden) classes += "border-x-0 "; // Medio bloque
                                            classes += "mx-0 "; // Elimina margen para fusionar
                                        } else if (t.isWord) {
                                            classes += "border-transparent mx-[1px] rounded hover:bg-slate-200 ";
                                            if (t.isSuggested) classes += "ring-2 ring-amber-300 bg-amber-50 animate-pulse text-amber-900 font-bold ";
                                        } else {
                                            classes = "inline-block "; // PuntuaciÃ³n/Espacios
                                        }

                                        return <span key={i} onClick={() => toggleHidden(i)} className={classes}>{t.text}</span>;
                                    })}
                                </div>

                                {/* PREGUNTAS GENERADAS */}
                                <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-3xl mb-8">
                                    <h4 className="font-black text-indigo-800 uppercase tracking-widest text-xs mb-4 flex items-center gap-2"><HelpCircle size={16}/> Preguntas Post-Reading Generadas</h4>
                                    <div className="space-y-3">
                                        {readingData.questions.map((q, i) => (
                                            <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-indigo-50">
                                                <p className="font-bold text-sm">{i+1}. {q.q}</p>
                                                <p className="text-xs text-slate-500 mt-1">R: {q.a} <span className="opacity-50">(PÃ¡rrafo {q.paragraph_index + 1})</span></p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingBuilder />);
    </script>
</body>
</html>
