<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; height: 100vh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { BookOpen, Brain, Sparkles, Save, RefreshCw, Eye, Edit3, ArrowLeft, CheckSquare, Square, Globe, Feather, Briefcase, Zap, HeartHandshake, Loader2, Search } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const GENRES = {
            "Real World (Internet Research)": [
                { id: 'biography', label: 'Biography (Real Person)', icon: Globe },
                { id: 'news', label: 'Breaking News / Current Events', icon: Globe },
                { id: 'tech', label: 'Tech Trends & Innovation', icon: Globe },
                { id: 'history', label: 'Historical Event', icon: Globe },
                { id: 'travel', label: 'Travel Guide (Real Place)', icon: Globe }
            ],
            "Professional & Advice": [
                { id: 'advice', label: 'Advice / Consultation', icon: HeartHandshake, desc: 'Situation -> Pros/Cons -> Advice' },
                { id: 'email', label: 'Email / Letter', icon: Briefcase },
                { id: 'interview', label: 'Job Interview Simulation', icon: Briefcase },
                { id: 'recipe', label: 'Recipe / Instructions', icon: Briefcase }
            ],
            "Fiction & Creative": [
                { id: 'story', label: 'Short Story / Fable', icon: Feather },
                { id: 'scifi', label: 'Sci-Fi / Future', icon: Feather },
                { id: 'mystery', label: 'Mystery / Detective', icon: Feather },
                { id: 'dialogue', label: 'Dialogue / Script', icon: Feather },
                { id: 'anecdote', label: 'Funny Anecdote', icon: Feather }
            ]
        };

        const GRAMMAR_OPTIONS = {
            Basic: [ { id: 'present_simple', label: 'Present Simple' }, { id: 'present_continuous', label: 'Present Continuous' }, { id: 'future_will_going', label: 'Future (Will/Going to)' }, { id: 'past_simple', label: 'Past Simple' }, { id: 'prepositions', label: 'Prepositions' } ],
            Advanced: [ { id: 'past_narrative', label: 'Past Narrative (Simple/Cont)' }, { id: 'used_to', label: 'Used to / Would' }, { id: 'second_conditional', label: 'Second Conditional' }, { id: 'relative_clauses', label: 'Relative Clauses' }, { id: 'modals_deduction', label: 'Modals of Deduction' } ],
            Pro: [ { id: 'present_perfect', label: 'Present Perfect' }, { id: 'past_perfect', label: 'Past Perfect' }, { id: 'third_conditional', label: 'Third Conditional' }, { id: 'passive_voice', label: 'Passive Voice' }, { id: 'phrasal_verbs', label: 'Advanced Phrasal Verbs' } ]
        };

        const ReadingBuilder = () => {
            const [step, setStep] = useState('config'); 
            const [loading, setLoading] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('periplo_google_key') || '');
            
            // ESTADO PARA CARPETAS Y EDICI√ìN
            const [parentPath, setParentPath] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(false);

            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isLoadingModels, setIsLoadingModels] = useState(false);

            const [config, setConfig] = useState({ 
                level: 'Basic', 
                genre: 'story', 
                topic: '', 
                selectedGrammar: { Basic: new Set(), Advanced: new Set(), Pro: new Set() }
            });
            
            const [readingData, setReadingData] = useState({ title: '', content: '', tokens: [] });

            // INICIALIZACI√ìN: Capturar Carpeta e ID de edici√≥n
            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    
                    // 1. Capturar Carpeta (Para guardar donde debe ser)
                    const folder = params.get('folder');
                    if (folder && folder !== 'undefined' && folder !== 'null') {
                        setParentPath(decodeURIComponent(folder));
                    }

                    // 2. Capturar ID de Edici√≥n
                    const editId = params.get('edit');
                    if (editId) {
                        setIsLoadingData(true);
                        try {
                            const docRef = doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                
                                // Reconstruir datos para editar
                                setReadingData({
                                    title: data.title,
                                    content: data.content.text,
                                    tokens: processContent(data.content.text).map((t, i) => ({
                                        ...t,
                                        isHidden: data.content.blanks.includes(i)
                                    }))
                                });
                                setConfig(prev => ({ ...prev, level: data.level, genre: data.genre }));
                                setEditingId(editId);
                                setStep('editor');
                            }
                        } catch (e) { console.error(e); } 
                        finally { setIsLoadingData(false); }
                    }
                };
                init();
            }, []);

            const processContent = (text) => {
                const regex = /([a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+|[^a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë\s]+|\s+)/g;
                const parts = text.match(regex) || [];
                return parts.map((part, index) => ({
                    id: index, text: part, isWord: /^[a-zA-Z0-9'√°√©√≠√≥√∫√±√Å√â√ç√ì√ö√ë]+$/.test(part), isHidden: false
                }));
            };

            const toggleGrammar = (level, id) => {
                const newSet = new Set(config.selectedGrammar[level]);
                if (newSet.has(id)) newSet.delete(id); else newSet.add(id);
                setConfig(prev => ({ ...prev, selectedGrammar: { ...prev.selectedGrammar, [level]: newSet } }));
            };

            const fetchModels = async () => {
                if (!apiKey) return alert("Ingresa tu API Key primero");
                setIsLoadingModels(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("Error conectando con Google");
                    const data = await response.json();
                    const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name);
                    setAvailableModels(validModels);
                    if (validModels.length > 0) {
                        const preferred = validModels.find(m => m.includes("gemini-1.5-flash")) || validModels.find(m => m.includes("gemini-2.0")) || validModels[0];
                        setSelectedModel(preferred);
                        alert(`¬°Conectado! Usando: ${preferred.replace('models/', '')}`);
                    }
                } catch (e) { alert("Error: " + e.message); } 
                finally { setIsLoadingModels(false); }
            };

            const generateReading = async () => {
                if (!apiKey) return alert("Falta API Key");
                if (!selectedModel) return alert("Por favor escanea y selecciona un modelo primero (bot√≥n lupa)");
                setLoading(true);

                const allSelectedGrammar = [
                    ...Array.from(config.selectedGrammar.Basic).map(id => GRAMMAR_OPTIONS.Basic.find(g => g.id === id).label),
                    ...Array.from(config.selectedGrammar.Advanced).map(id => GRAMMAR_OPTIONS.Advanced.find(g => g.id === id).label),
                    ...Array.from(config.selectedGrammar.Pro).map(id => GRAMMAR_OPTIONS.Pro.find(g => g.id === id).label)
                ];

                const needsSearch = GENRES["Real World (Internet Research)"].some(g => g.id === config.genre);
                const topicPrompt = config.topic ? `Specific Topic/Scenario: "${config.topic}"` : "Topic: Choose a creative and engaging topic relevant to the genre.";

                let instructions = "";
                if (allSelectedGrammar.length === 0) {
                    instructions += `\n- GRAMMAR MODE: FREE CREATION. Focus 100% on the natural flow.`;
                } else {
                    instructions += `\n- GRAMMAR MODE: GUIDED. Try to incorporate: ${allSelectedGrammar.join(', ')}.`;
                }

                if (config.genre === 'advice') instructions += `\n- STRUCTURE: Situation -> Pros/Cons -> Advice.`;
                else if (config.genre === 'interview') instructions += `\n- STRUCTURE: Dialogue script of a job interview.`;
                else if (config.genre === 'email') instructions += `\n- STRUCTURE: Professional email format.`;

                // --- AQU√ç EST√Å EL FIX DEL FUN FACT ---
                instructions += `\n- CRITICAL: At the very end of the text, append a separate paragraph titled "üí° Fun Fact" or "Did You Know?" with an interesting real-world fact or curiosity related to the topic (use Google Search to find a good one if needed).`;

                const prompt = `
                    Generate an English reading text.
                    Level: ${config.level}. Genre: ${config.genre}.
                    ${topicPrompt}
                    ${instructions}

                    ${needsSearch ? "IMPORTANT: USE THE GOOGLE SEARCH TOOL to find REAL facts." : "Use your creativity."}

                    RETURN ONLY RAW JSON:
                    {
                        "title": "Title here",
                        "content": "Full text body here with \\n for line breaks."
                    }
                `;

                try {
                    const tools = needsSearch ? [{ googleSearch: {} }] : [];
                    const generationConfig = needsSearch ? {} : { responseMimeType: "application/json" };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${selectedModel}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            tools: tools, 
                            generationConfig: generationConfig
                        })
                    });

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json|```/g, "").trim(); 
                    
                    const result = JSON.parse(text);
                    setReadingData({
                        title: result.title,
                        content: result.content,
                        tokens: processContent(result.content)
                    });
                    setStep('editor');

                } catch (e) {
                    alert("Error: " + e.message);
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            const saveActivity = async () => {
                if (!readingData.title) return alert("Falta t√≠tulo");
                try {
                    const payload = {
                        title: readingData.title,
                        type: 'READING', 
                        content: {
                            text: readingData.content,
                            blanks: readingData.tokens.filter(t => t.isHidden).map(t => t.id) 
                        },
                        level: config.level,
                        genre: config.genre,
                        parentPath: parentPath // <--- AQU√ç EST√Å EL FIX DE GUARDADO
                    };

                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), {
                            ...payload,
                            updatedAt: serverTimestamp()
                        });
                        alert("¬°Lectura actualizada!");
                    } else {
                        await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), {
                            ...payload,
                            createdAt: serverTimestamp()
                        });
                        alert("¬°Lectura creada y guardada!");
                    }
                    
                    // Volver al index preservando la carpeta si existe
                    const returnUrl = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html';
                    window.location.href = returnUrl;

                } catch (e) { alert("Error guardando: " + e.message); }
            };

            const toggleHidden = (idx) => {
                const newTokens = [...readingData.tokens];
                if (newTokens[idx].isWord) {
                    newTokens[idx].isHidden = !newTokens[idx].isHidden;
                    setReadingData({ ...readingData, tokens: newTokens });
                }
            };

            const handleExit = () => {
                const returnUrl = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html';
                window.location.href = returnUrl;
            };

            if (isLoadingData) return <div className="h-screen flex items-center justify-center text-slate-500 font-bold"><Loader2 className="animate-spin mr-2"/> Cargando lectura...</div>;

            if (step === 'config') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 font-sans">
                        <div className="max-w-6xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200 flex flex-col h-[90vh]">
                            <div className="bg-slate-900 p-6 text-white flex justify-between items-center shrink-0 gap-4">
                                <div><h1 className="text-2xl font-black flex items-center gap-2"><BookOpen className="text-emerald-400"/> Reading Builder</h1><p className="text-slate-400 text-xs uppercase font-bold tracking-widest mt-1">Motor de Generaci√≥n de Textos</p></div>
                                <div className="flex items-center gap-2">
                                    <button onClick={handleExit} className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-bold text-sm transition-all flex items-center gap-2"><ArrowLeft size={16}/> Salir</button>
                                    <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('periplo_google_key', e.target.value)}} className="bg-slate-900 border-slate-700 rounded-lg px-3 py-2 text-xs w-28 focus:border-emerald-500 focus:outline-none text-center" placeholder="API Key"/>
                                    <button onClick={fetchModels} disabled={isLoadingModels || !apiKey} className="p-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg transition-colors" title="Escanear Modelos">{isLoadingModels ? <Loader2 className="animate-spin" size={16}/> : <Search size={16}/>}</button>
                                    {availableModels.length > 0 && (<select value={selectedModel} onChange={(e) => setSelectedModel(e.target.value)} className="bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-xs text-white max-w-[120px]">{availableModels.map(m => <option key={m} value={m}>{m.replace('models/', '')}</option>)}</select>)}
                                </div>
                            </div>
                            <div className="flex flex-col md:flex-row flex-1 overflow-hidden">
                                <div className="md:w-1/3 bg-slate-50 border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-200 bg-white"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">Nivel de Dificultad</label><div className="flex gap-1 bg-slate-100 p-1 rounded-xl">{['Basic', 'Advanced', 'Pro'].map(l => (<button key={l} onClick={() => setConfig({...config, level: l})} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${config.level===l ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>{l}</button>))}</div></div>
                                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar bg-slate-50"><div className="flex justify-between items-center mb-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Gram√°tica ({config.level})</label><span className="text-[10px] bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full font-bold">{config.selectedGrammar[config.level].size}</span></div><div className="space-y-1">{GRAMMAR_OPTIONS[config.level].map(g => (<button key={g.id} onClick={() => toggleGrammar(config.level, g.id)} className={`w-full text-left p-3 rounded-xl border flex items-center gap-3 transition-all ${config.selectedGrammar[config.level].has(g.id) ? 'bg-indigo-50 border-indigo-500 text-indigo-900' : 'bg-white border-slate-200 text-slate-500 hover:border-indigo-200'}`}>{config.selectedGrammar[config.level].has(g.id) ? <CheckSquare size={16} className="text-indigo-600"/> : <Square size={16} className="text-slate-300"/>}<span className="text-xs font-bold">{g.label}</span></button>))}</div></div>
                                </div>
                                <div className="md:w-1/3 bg-white border-r border-slate-200 flex flex-col">
                                    <div className="p-4 border-b border-slate-100"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block">Tipo de Texto</label></div>
                                    <div className="p-4 flex-1 overflow-y-auto custom-scrollbar"><div className="space-y-6">{Object.entries(GENRES).map(([cat, items]) => (<div key={cat}><p className="text-[9px] font-black text-slate-300 uppercase mb-2 tracking-widest">{cat}</p><div className="space-y-1">{items.map(g => (<button key={g.id} onClick={() => setConfig({...config, genre: g.id})} className={`w-full text-left p-3 rounded-xl border flex items-center justify-between transition-all ${config.genre === g.id ? 'bg-emerald-50 border-emerald-500 text-emerald-900 ring-1 ring-emerald-500 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}><div className="flex items-center gap-3"><div className={`p-1.5 rounded-lg ${config.genre === g.id ? 'bg-emerald-200 text-emerald-800' : 'bg-slate-100 text-slate-400'}`}><g.icon size={16}/></div><div><div className="text-xs font-bold">{g.label}</div>{g.desc && <div className="text-[9px] opacity-70">{g.desc}</div>}</div></div>{config.genre === g.id && <div className="w-2 h-2 rounded-full bg-emerald-500"></div>}</button>))}</div></div>))}</div></div>
                                </div>
                                <div className="md:w-1/3 p-6 flex flex-col bg-slate-50">
                                    <div className="flex-1 flex flex-col"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest block">Detalles del Tema / Situaci√≥n</label><div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex-1 flex flex-col"><textarea value={config.topic} onChange={e => setConfig({...config, topic: e.target.value})} className="w-full flex-1 bg-transparent border-none outline-none text-sm text-slate-700 resize-none placeholder-slate-300" placeholder={config.genre === 'advice' ? "Describe la situaci√≥n: 'Soy un ingeniero que quiere pedir aumento...'" : "Ej: Biograf√≠a de Elon Musk, Noticia sobre Marte..."}></textarea></div><div className="mt-4 text-[10px] text-slate-400 px-2">{config.selectedGrammar.Basic.size + config.selectedGrammar.Advanced.size + config.selectedGrammar.Pro.size === 0 ? "‚ú® Modo Libre: La IA se enfocar√° 100% en el tema." : "‚öñÔ∏è Modo Mixto: La IA priorizar√° el tema (60%) e integrar√° la gram√°tica (40%)."}</div></div>
                                    <div className="mt-6"><button onClick={generateReading} disabled={loading || !selectedModel} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-sm uppercase tracking-widest hover:bg-emerald-600 transition-all flex items-center justify-center gap-3 disabled:opacity-50 shadow-xl hover:shadow-2xl hover:-translate-y-1">{loading ? <Loader2 className="animate-spin"/> : <Sparkles className="fill-yellow-400 text-yellow-400"/>} {loading ? "Creando..." : "Generar Texto"}</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'editor') {
                const hiddenCount = readingData.tokens.filter(t => t.isHidden).length;
                return (
                    <div className="min-h-screen bg-slate-50 p-6 font-sans">
                        <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden flex flex-col h-[90vh]">
                            <div className="bg-white p-4 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10 shrink-0">
                                <div className="flex items-center gap-4"><button onClick={() => setStep('config')} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-800 transition-colors"><ArrowLeft size={20}/></button><div><h2 className="font-black text-slate-800 text-lg">Editor de Huecos</h2><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Haz clic en las palabras para ocultarlas ({hiddenCount} seleccionadas)</p></div></div>
                                <div className="flex gap-2">
                                    <button onClick={handleExit} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl font-bold">Cancelar</button>
                                    <button onClick={saveActivity} className="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-emerald-200"><Save size={18}/> {editingId ? "Actualizar" : "Guardar"}</button>
                                </div>
                            </div>
                            <div className="p-8 overflow-y-auto custom-scrollbar flex-1">
                                <input value={readingData.title} onChange={e => setReadingData({...readingData, title: e.target.value})} className="text-3xl font-black text-slate-900 w-full border-none outline-none mb-6 placeholder-slate-300 bg-transparent" placeholder="T√≠tulo de la Lectura..."/>
                                <div className="leading-loose text-lg text-slate-700 bg-slate-50 p-8 rounded-[2rem] border border-slate-100 shadow-inner text-justify">{readingData.tokens.map((t, i) => (<span key={i} onClick={() => toggleHidden(i)} className={`inline-block mx-[1px] px-1 rounded cursor-pointer transition-all border-b-2 select-none ${t.isHidden ? 'bg-emerald-100 text-emerald-800 border-emerald-400 font-bold' : t.isWord ? 'border-transparent hover:bg-slate-200 hover:border-slate-300' : 'border-transparent'}`}>{t.text}</span>))}</div>
                            </div>
                        </div>
                    </div>
                );
            }
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingBuilder />);
    </script>
</body>
</html>
