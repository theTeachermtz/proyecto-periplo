<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flashcards - Periplo v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .btn-icon { @apply p-2 rounded-lg transition-colors duration-200; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Save, Languages, Eraser, Sparkles, Image as ImageIcon, 
            Volume2, VolumeX, ArrowRightLeft, Loader2, Search, X, Zap, 
            ArrowUp, ArrowDown, Copy, Settings, ExternalLink
        } from 'lucide-react';

        // --- üîë TUS CLAVES AQU√ç ---
        
        // 1. CLAVE DE GOOGLE (IA para generar listas)
        // Usa el truco de partirla si GitHub te da problemas
        const googleApiKey = "AIzaSy" + "AIzaSyAqaCIAPDXeOvInAUpxU5DRrwoRapLwdjM"; 

        // 2. CLAVE DE PIXABAY (Im√°genes)
        const pixabayApiKey = "54261518-ae514f8c15f5fdf02ac955551"; 

        const DashboardCreador = () => {
            // --- ESTADOS ---
            const generateUniqueId = () => (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substr(2);

            const [title, setTitle] = useState(localStorage.getItem('tempNewActivityName') || '');
            const [cards, setCards] = useState([{ internalId: generateUniqueId(), front: '', back: '', image: null }]);
            
            // Configuraci√≥n
            const [audioConfig, setAudioConfig] = useState({ en: true, es: false }); // Por defecto solo ingl√©s activado
            const [isGeneratingList, setIsGeneratingList] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [toasts, setToasts] = useState([]);
            
            // Galer√≠a
            const [galleryModal, setGalleryModal] = useState({ isOpen: false, cardId: null, searchTerm: '', results: [], loading: false, type: 'all' });
            const [bulkImageLoading, setBulkImageLoading] = useState(false);

            useEffect(() => { localStorage.removeItem('tempNewActivityName'); }, []);

            // --- HELPERS ---
            const addToast = (message, type = 'error') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 5000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const cleanJsonText = (text) => text.replace(/```json/g, '').replace(/```/g, '').trim();

            // --- AUDIO ---
            const playBrowserAudio = (text, lang) => {
                if (!text) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang === 'es' ? 'es-ES' : 'en-US'; 
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            };

            // --- ACCIONES DE TABLA ---
            const swapColumns = () => {
                if(confirm("¬øEst√°s seguro de intercambiar Ingl√©s ‚Üî Espa√±ol en todas las tarjetas?")) {
                    setCards(prev => prev.map(c => ({ ...c, front: c.back, back: c.front })));
                }
            };

            const handleMoveCard = (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === cards.length - 1)) return;
                const newCards = [...cards];
                [newCards[index], newCards[index + direction]] = [newCards[index + direction], newCards[index]];
                setCards(newCards);
            };

            const handleDuplicateCard = (index) => {
                const newCards = [...cards];
                const clone = { ...cards[index], internalId: generateUniqueId() };
                newCards.splice(index + 1, 0, clone);
                setCards(newCards);
            };

            // --- APIS ---
            const generateListWithAI = async () => {
                if (!googleApiKey || googleApiKey.includes("TU_CLAVE")) return addToast("Falta clave Google", 'error');
                if (!aiPrompt.trim()) return;
                setIsGeneratingList(true);
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${googleApiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Genera una lista JSON exacta sobre: "${aiPrompt}". Formato: [{"front": "Ingl√©s", "back": "Espa√±ol"}]. JSON raw.` }] }]
                            })
                        }
                    );
                    if (!response.ok) throw new Error("Error API Google");
                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const newItems = JSON.parse(cleanJsonText(rawText));
                    if (Array.isArray(newItems)) {
                        const formattedItems = newItems.map(item => ({ internalId: generateUniqueId(), front: item.front || '', back: item.back || '', image: null }));
                        setCards(prev => [...prev, ...formattedItems]);
                        setAiPrompt('');
                        addToast("Lista generada", 'success');
                    }
                } catch (e) { addToast("Error generando lista", 'error'); } 
                finally { setIsGeneratingList(false); }
            };

            const searchPixabay = async (query, type = 'all') => {
                if (!pixabayApiKey || pixabayApiKey.includes("TU_CLAVE")) throw new Error("Falta clave Pixabay");
                const safeQuery = encodeURIComponent(query);
                // Tipo: 'all' busca todo, 'photo' fotos reales, 'vector' dibujos
                const typeParam = type === 'all' ? '' : `&image_type=${type}`;
                const response = await fetch(`https://pixabay.com/api/?key=${pixabayApiKey}&q=${safeQuery}${typeParam}&per_page=20&safesearch=true`);
                if(!response.ok) throw new Error("Error Pixabay");
                const data = await response.json();
                return data.hits;
            };

            // --- GALER√çA MANUAL ---
            const openGallery = async (cardId, term) => {
                if (!term) return addToast("Escribe texto primero", "warning");
                setGalleryModal({ isOpen: true, cardId, searchTerm: term, results: [], loading: true, type: 'all' });
                try {
                    const hits = await searchPixabay(term, 'all');
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (e) { setGalleryModal(prev => ({ ...prev, isOpen: false })); addToast(e.message, 'error'); }
            };

            const handleGallerySearch = async (e) => {
                e?.preventDefault();
                setGalleryModal(prev => ({ ...prev, loading: true }));
                try {
                    const hits = await searchPixabay(galleryModal.searchTerm, galleryModal.type);
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (e) { addToast("Error b√∫squeda", 'error'); }
            };

            const autoFillImages = async () => {
                const pending = cards.filter(c => c.front && !c.image);
                if (pending.length === 0) return addToast("Nada que rellenar", 'info');
                setBulkImageLoading(true);
                let count = 0;
                for (let card of pending) {
                    try {
                        const hits = await searchPixabay(card.front);
                        if (hits?.[0]) {
                            setCards(prev => prev.map(c => c.internalId === card.internalId ? { ...c, image: hits[0].webformatURL } : c));
                            count++;
                        }
                    } catch (e) {}
                    await new Promise(r => setTimeout(r, 400));
                }
                setBulkImageLoading(false);
                addToast(`Im√°genes a√±adidas: ${count}`, 'success');
            };

            // --- GUARDAR ---
            const handleSave = () => {
                if (!title.trim()) return addToast("Ponle t√≠tulo", 'warning');
                console.log({ title, cards });
                addToast("¬°Guardado exitoso!", 'success');
                if(confirm("Juego guardado. ¬øSalir?")) window.location.href = "/";
            };

            return (
                <div className="min-h-screen bg-slate-100 py-8 px-4 font-sans text-slate-900 pb-32">
                    
                    {/* MODAL GALER√çA */}
                    {galleryModal.isOpen && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col h-[85vh] overflow-hidden animate-in zoom-in-95 duration-200">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg flex gap-2"><ImageIcon/> Galer√≠a de Im√°genes</h3>
                                    <button onClick={() => setGalleryModal({ ...galleryModal, isOpen: false })} className="p-2 hover:bg-slate-200 rounded-full"><X/></button>
                                </div>
                                <div className="p-4 bg-white border-b space-y-3">
                                    <form onSubmit={handleGallerySearch} className="flex gap-2">
                                        <input autoFocus value={galleryModal.searchTerm} onChange={e => setGalleryModal({ ...galleryModal, searchTerm: e.target.value })} className="flex-1 border-2 border-indigo-100 rounded-lg px-4 py-2 font-bold outline-none focus:border-indigo-500" />
                                        <button type="submit" className="bg-indigo-600 text-white px-6 rounded-lg font-bold hover:bg-indigo-700">Buscar</button>
                                    </form>
                                    <div className="flex gap-4 text-sm font-bold text-slate-600">
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="gtype" checked={galleryModal.type === 'all'} onChange={() => { setGalleryModal({...galleryModal, type: 'all'}); handleGallerySearch(); }}/> Todo</label>
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="gtype" checked={galleryModal.type === 'photo'} onChange={() => { setGalleryModal({...galleryModal, type: 'photo'}); handleGallerySearch(); }}/> Fotos Reales üì∏</label>
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="gtype" checked={galleryModal.type === 'vector'} onChange={() => { setGalleryModal({...galleryModal, type: 'vector'}); handleGallerySearch(); }}/> Dibujos üé®</label>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-100 scroller">
                                    {galleryModal.loading ? <div className="text-center py-20"><Loader2 className="animate-spin mx-auto mb-2" size={40}/> Cargando...</div> : 
                                     galleryModal.results.length === 0 ? <div className="text-center py-20 text-slate-400 font-bold">Sin resultados. Intenta buscar en Ingl√©s.</div> : 
                                     <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                        {galleryModal.results.map(img => (
                                            <button key={img.id} onClick={() => {
                                                setCards(prev => prev.map(c => c.internalId === galleryModal.cardId ? { ...c, image: img.webformatURL } : c));
                                                setGalleryModal({...galleryModal, isOpen: false});
                                            }} className="aspect-square rounded-xl overflow-hidden border-2 border-transparent hover:border-indigo-500 bg-white shadow-sm hover:scale-105 transition-all group relative">
                                                <img src={img.previewURL} loading="lazy" className="w-full h-full object-cover"/>
                                                <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] p-1 opacity-0 group-hover:opacity-100 truncate">{img.tags}</div>
                                            </button>
                                        ))}
                                     </div>
                                    }
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOASTS */}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`px-4 py-3 rounded-xl shadow-xl text-sm font-bold pointer-events-auto border-2 ${t.type==='error'?'bg-red-50 border-red-100 text-red-600':'bg-green-50 border-green-100 text-green-700'} animate-in slide-in-from-right`}>{t.message}</div>
                        ))}
                    </div>

                    <div className="max-w-6xl mx-auto space-y-6">
                        {/* HEADER PRINCIPAL */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-2 z-30">
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <button onClick={() => window.location.href='/'} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><ArrowRightLeft className="rotate-180" size={20}/></button>
                                <div className="h-8 w-px bg-slate-200"></div>
                                <input value={title} onChange={e => setTitle(e.target.value)} placeholder="T√≠tulo de la Actividad..." className="text-lg font-black bg-transparent outline-none placeholder:text-slate-300 w-full md:w-64"/>
                            </div>
                            
                            <div className="flex gap-2 items-center">
                                {/* TOGGLES DE AUDIO */}
                                <div className="flex items-center bg-slate-100 rounded-lg p-1 mr-2 border border-slate-200">
                                    <button onClick={() => setAudioConfig({...audioConfig, en: !audioConfig.en})} className={`px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-all ${audioConfig.en ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                        {audioConfig.en ? <Volume2 size={14}/> : <VolumeX size={14}/>} EN
                                    </button>
                                    <button onClick={() => setAudioConfig({...audioConfig, es: !audioConfig.es})} className={`px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-all ${audioConfig.es ? 'bg-pink-600 text-white shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                        {audioConfig.es ? <Volume2 size={14}/> : <VolumeX size={14}/>} ES
                                    </button>
                                </div>
                                <button onClick={handleSave} className="bg-slate-900 text-white px-5 py-2 rounded-xl font-bold hover:bg-black shadow-lg hover:shadow-xl transition-all flex items-center gap-2"><Save size={18}/> Guardar</button>
                            </div>
                        </div>

                        {/* BARRA DE HERRAMIENTAS IA */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Generador de Listas */}
                            <div className="bg-indigo-600 rounded-2xl p-1 shadow-lg">
                                <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 flex gap-2 items-center">
                                    <Sparkles className="text-white shrink-0" size={20}/>
                                    <input value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Animales de granja..." className="flex-1 bg-white/20 border-none rounded-lg px-3 py-1.5 text-white placeholder:text-white/50 font-bold outline-none focus:bg-white focus:text-indigo-900 transition-colors" onKeyDown={e => e.key === 'Enter' && generateListWithAI()}/>
                                    <button onClick={generateListWithAI} disabled={isGeneratingList || !aiPrompt} className="bg-white text-indigo-700 px-4 py-1.5 rounded-lg font-bold hover:bg-indigo-50 disabled:opacity-50 text-sm">
                                        {isGeneratingList ? <Loader2 className="animate-spin"/> : 'Generar'}
                                    </button>
                                </div>
                            </div>
                            {/* Auto Im√°genes */}
                            <button onClick={autoFillImages} disabled={bulkImageLoading} className="bg-white border-2 border-pink-100 text-pink-600 rounded-2xl p-4 font-bold hover:bg-pink-50 hover:border-pink-200 shadow-sm transition-all flex items-center justify-center gap-3 disabled:opacity-50">
                                {bulkImageLoading ? <Loader2 className="animate-spin" size={24}/> : <Zap size={24}/>}
                                <span>Rellenar im√°genes faltantes (Magia)</span>
                            </button>
                        </div>

                        {/* TABLA DE CONTENIDO */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            {/* Header Tabla */}
                            <div className="grid grid-cols-12 gap-4 p-4 bg-slate-50 border-b border-slate-200 text-xs font-black text-slate-400 uppercase tracking-wider items-center">
                                <div className="col-span-1 text-center">#</div>
                                <div className="col-span-4 pl-2">Ingl√©s (Front)</div>
                                <div className="col-span-1 flex justify-center"><button onClick={swapColumns} className="p-1 hover:bg-slate-200 rounded text-slate-500 transition-colors" title="Intercambiar columnas"><ArrowRightLeft size={16}/></button></div>
                                <div className="col-span-4 pl-2">Espa√±ol (Back)</div>
                                <div className="col-span-2 text-right pr-2">Acciones</div>
                            </div>

                            <div className="divide-y divide-slate-100">
                                {cards.map((card, index) => (
                                    <div key={card.internalId} className="grid grid-cols-1 sm:grid-cols-12 gap-4 p-4 hover:bg-slate-50 transition-colors group items-start">
                                        
                                        {/* CONTROLES IZQUIERDA */}
                                        <div className="sm:col-span-1 flex flex-row sm:flex-col items-center justify-center gap-1 sm:pt-2">
                                            <div className="font-black text-slate-300 text-xs mb-1">{index + 1}</div>
                                            <button onClick={() => handleMoveCard(index, -1)} className="text-slate-300 hover:text-indigo-600"><ArrowUp size={14}/></button>
                                            <button onClick={() => handleMoveCard(index, 1)} className="text-slate-300 hover:text-indigo-600"><ArrowDown size={14}/></button>
                                        </div>

                                        {/* INGL√âS */}
                                        <div className="sm:col-span-4 space-y-2">
                                            <div className="flex gap-2">
                                                <input value={card.front} onChange={e => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, front: e.target.value} : c))} className="w-full border-2 border-slate-200 rounded-xl px-3 py-2 font-bold text-slate-700 focus:border-indigo-500 outline-none transition-colors" placeholder="Ingl√©s"/>
                                                {audioConfig.en && (
                                                    <button onClick={() => playBrowserAudio(card.front, 'en')} className="btn-icon bg-indigo-50 text-indigo-500 hover:bg-indigo-100 shrink-0"><Volume2 size={18}/></button>
                                                )}
                                            </div>
                                        </div>

                                        {/* IMAGEN CENTRAL (La "Grapa") */}
                                        <div className="sm:col-span-1 flex justify-center sm:pt-1">
                                            {card.image ? (
                                                <div className="relative w-14 h-14 bg-slate-200 rounded-lg border border-slate-300 group/img shadow-sm">
                                                    <img src={card.image} className="w-full h-full object-cover rounded-lg cursor-pointer hover:opacity-90" onClick={() => openGallery(card.internalId, card.front)}/>
                                                    <button onClick={() => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, image: null} : c))} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow hover:scale-110"><X size={12}/></button>
                                                </div>
                                            ) : (
                                                <div className="flex gap-1">
                                                    <button onClick={() => openGallery(card.internalId, card.front)} className="w-14 h-14 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-300 hover:border-indigo-400 hover:text-indigo-500 bg-slate-50 transition-all" title="Buscar Imagen"><Search size={20}/></button>
                                                </div>
                                            )}
                                        </div>

                                        {/* ESPA√ëOL */}
                                        <div className="sm:col-span-4 space-y-2">
                                            <div className="flex gap-2">
                                                <input value={card.back} onChange={e => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, back: e.target.value} : c))} className="w-full border-2 border-slate-200 rounded-xl px-3 py-2 font-bold text-slate-700 focus:border-pink-500 outline-none transition-colors" placeholder="Espa√±ol"/>
                                                {audioConfig.es && (
                                                    <button onClick={() => playBrowserAudio(card.back, 'es')} className="btn-icon bg-pink-50 text-pink-500 hover:bg-pink-100 shrink-0"><Volume2 size={18}/></button>
                                                )}
                                            </div>
                                        </div>

                                        {/* ACCIONES DERECHA */}
                                        <div className="sm:col-span-2 flex justify-end gap-2 items-center sm:h-full">
                                            {/* Google Fallback */}
                                            <button onClick={() => window.open(`https://www.google.com/search?tbm=isch&q=${card.front || card.back}`, '_blank')} className="btn-icon text-slate-400 hover:bg-green-50 hover:text-green-600" title="Buscar en Google"><ExternalLink size={18}/></button>
                                            <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                            <button onClick={() => handleDuplicateCard(index)} className="btn-icon text-slate-400 hover:bg-indigo-50 hover:text-indigo-600" title="Duplicar"><Copy size={18}/></button>
                                            <button onClick={() => { if(cards.length > 1) setCards(prev => prev.filter(c => c.internalId !== card.internalId)) }} className="btn-icon text-slate-400 hover:bg-red-50 hover:text-red-600" title="Eliminar"><Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <button onClick={() => setCards([...cards, { internalId: generateUniqueId(), front: '', back: '', image: null }])} className="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-white transition-all flex items-center justify-center gap-2"><Plus/> A√±adir Nueva Fila</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<DashboardCreador />);
    </script>
</body>
</html>


