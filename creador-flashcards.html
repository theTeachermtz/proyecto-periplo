<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flashcards - Periplo v7.0 (Indestructible)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; }
        .scroller::-webkit-scrollbar { width: 8px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .btn-icon { @apply p-2 rounded-lg transition-colors duration-200; }
        /* Ajuste para iconos FontAwesome */
        i { font-size: 1.1em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // DESEMPAQUETADO SEGURO DE REACT
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // ==========================================
        // 游댢 ZONA DE CLAVES (PEGA TUS DATOS AQU칈)
        // ==========================================

        // 1. CLAVE DE GOOGLE (IA) 
        // Pega tu clave NUEVA aqu칤. El sistema borrar치 duplicados autom치ticamente.
        const googleApiKey = "AIzaSy" + "AIzaSyB99EBmGJZvUF9e14c1BIWPnbyCNoLDoAI"; 

        // 2. CLAVE DE PIXABAY (Dibujos)
        const pixabayApiKey = "54261518-ae514f8c15f5fdf02ac955551"; 

        // 3. CLAVE DE UNSPLASH (Fotos Pro)
        const unsplashApiKey = "SQZCJjY0Bcp4ugL9zcOOjHWHOo0hV2zwM3Ixu0oa_fU"; 

        // ==========================================

        const DashboardCreador = () => {
            // AUTOCORRECTOR DE CLAVE GOOGLE
            const getCleanKey = () => {
                let k = googleApiKey.trim();
                // Si la clave tiene el prefijo repetido, lo arreglamos
                if (k.length > 50 && k.includes("AIzaSyAIzaSy")) {
                    console.log("游댢 Correcci칩n autom치tica: Clave duplicada detectada.");
                    return k.replace("AIzaSyAIzaSy", "AIzaSy");
                }
                return k;
            };

            const generateUniqueId = () => (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substr(2);

            const [title, setTitle] = useState(localStorage.getItem('tempNewActivityName') || '');
            const [cards, setCards] = useState([{ internalId: generateUniqueId(), front: '', back: '', image: null }]);
            
            // Idiomas
            const [langConfig, setLangConfig] = useState({ left: 'en-US', right: 'es-MX' }); 
            const [audioEnabled, setAudioEnabled] = useState({ left: true, right: false });

            const [isGeneratingList, setIsGeneratingList] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [toasts, setToasts] = useState([]);
            
            // Galer칤a
            const [galleryModal, setGalleryModal] = useState({ isOpen: false, cardId: null, searchTerm: '', results: [], loading: false, source: 'unsplash' });
            const [bulkImageLoading, setBulkImageLoading] = useState(false);
            const [manualLinkMode, setManualLinkMode] = useState(null);

            useEffect(() => { localStorage.removeItem('tempNewActivityName'); }, []);

            // Helpers
            const addToast = (message, type = 'error') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 5000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const cleanJsonText = (text) => text.replace(/```json/g, '').replace(/```/g, '').trim();

            // Audio Browser
            const playBrowserAudio = (text, langCode) => {
                if (!text) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = langCode; 
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            };

            // Acciones Tabla
            const swapColumns = () => {
                if(confirm("쯀ntercambiar idiomas y audios en todo?")) {
                    setCards(prev => prev.map(c => ({ ...c, front: c.back, back: c.front })));
                    setLangConfig(prev => ({ left: prev.right, right: prev.left }));
                    setAudioEnabled(prev => ({ left: prev.right, right: prev.left }));
                }
            };

            const handleMoveCard = (index, direction) => {
                if ((direction === -1 && index === 0) || (direction === 1 && index === cards.length - 1)) return;
                const newCards = [...cards];
                [newCards[index], newCards[index + direction]] = [newCards[index + direction], newCards[index]];
                setCards(newCards);
            };

            const handleDuplicateCard = (index) => {
                const newCards = [...cards];
                const clone = { ...cards[index], internalId: generateUniqueId() };
                newCards.splice(index + 1, 0, clone);
                setCards(newCards);
            };

            // --- API GOOGLE (IA) ---
            const generateListWithAI = async () => {
                const validKey = getCleanKey();
                
                if (!validKey || validKey.includes("TU_RESTO")) return addToast("Falta clave Google", 'error');
                if (!aiPrompt.trim()) return;
                
                setIsGeneratingList(true);
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${validKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Genera una lista JSON exacta sobre: "${aiPrompt}". Formato: [{"front": "Ingl칠s", "back": "Espa침ol"}]. JSON raw.` }] }]
                            })
                        }
                    );
                    
                    if (!response.ok) {
                        const err = await response.json();
                        console.error("Error Google API:", err);
                        throw new Error(`Error ${response.status}: ${err.error?.message || 'Revisa tu clave'}`);
                    }

                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!rawText) throw new Error("La IA no respondi칩 nada");

                    const newItems = JSON.parse(cleanJsonText(rawText));
                    
                    if (Array.isArray(newItems)) {
                        const formattedItems = newItems.map(item => ({ internalId: generateUniqueId(), front: item.front || '', back: item.back || '', image: null }));
                        setCards(prev => [...prev, ...formattedItems]);
