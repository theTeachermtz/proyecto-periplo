<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flashcards - Periplo v16.1 (Prompt Blindado)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; }
        .btn-icon { @apply p-2 rounded-lg transition-colors duration-200; }
        select { @apply bg-white/20 border-none rounded-lg px-2 py-1 text-white text-xs outline-none cursor-pointer hover:bg-white/30 font-bold max-w-[200px]; }
        option { @apply text-slate-900 bg-white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // ==========================================
        // üîß TUS CLAVES AQU√ç
        // ==========================================

        // 1. CLAVE DE GOOGLE (IA) 
        const googleApiKey = "AIzaSy" + "AIzaSyCEkwvmCZkPe2ae0vQsR07SwBQT1RHRc4g"; 

        // 2. PIXABAY (Dibujos)
        const pixabayApiKey = "54261518-ae514f8c15f5fdf02ac955551"; 

        // 3. UNSPLASH (Fotos Pro)
        const unsplashApiKey = "SQZCJjY0Bcp4ugL9zcOOjHWHOo0hV2zwM3Ixu0oa_fU"; 

        // ==========================================

        const DashboardCreador = () => {
            const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

            const [title, setTitle] = useState(localStorage.getItem('tempNewActivityName') || '');
            const [cards, setCards] = useState([{ internalId: generateUniqueId(), front: '', back: '', image: null }]);
            const [aiPrompt, setAiPrompt] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [galleryModal, setGalleryModal] = useState({ isOpen: false, cardId: null, searchTerm: '', results: [], loading: false, source: 'unsplash' });
            const [toasts, setToasts] = useState([]);
            
            const [langConfig, setLangConfig] = useState({ left: 'en-US', right: 'es-MX' }); 
            const [audioEnabled, setAudioEnabled] = useState({ left: true, right: false });
            
            // ESC√ÅNER DE MODELOS
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState('');
            const [isScanning, setIsScanning] = useState(false);

            useEffect(() => { localStorage.removeItem('tempNewActivityName'); }, []);

            // --- HELPERS ---
            const getCleanKey = () => {
                let k = googleApiKey.trim();
                if (k.indexOf("AIzaSyAIzaSy") !== -1) return k.replace("AIzaSyAIzaSy", "AIzaSy");
                return k;
            };

            const addToast = (message, type = 'error') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 6000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const cleanJsonText = (text) => text.replace(/```json/g, '').replace(/```/g, '').trim();

            const playAudio = (text, lang) => {
                if (!text) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang; u.rate = 0.9;
                window.speechSynthesis.speak(u);
            };

            // --- 1. ESCANEAR MODELOS ---
            const scanModels = async () => {
                const key = getCleanKey();
                if (!key || key.includes("TU_RESTO")) return addToast("Falta la clave de Google", 'error');
                
                setIsScanning(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error?.message || "Error al listar modelos");

                    const validModels = (data.models || [])
                        .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                        .map(m => m.name.replace("models/", ""));

                    if (validModels.length === 0) throw new Error("Tu clave no tiene acceso a ning√∫n modelo de texto.");

                    setAvailableModels(validModels);
                    // Priorizar el modelo que ya te funcion√≥ (2.5-flash) si existe, sino el primero
                    const best = validModels.find(m => m.includes("2.5-flash")) || validModels.find(m => m.includes("flash")) || validModels[0];
                    setSelectedModel(best);
                    addToast(`¬°Conectado! Se encontraron ${validModels.length} modelos.`, 'success');

                } catch (e) {
                    addToast("Error al escanear: " + e.message, 'error');
                } finally {
                    setIsScanning(false);
                }
            };

            // --- 2. GENERAR (PROMPT MEJORADO) ---
            const generateList = async () => {
                const key = getCleanKey();
                if (!selectedModel) return addToast("Primero escanea y elige un modelo", 'warning');
                if (!aiPrompt.trim()) return;
                
                setIsGenerating(true);
                try {
                    // PROMPT BLINDADO: Instrucciones estrictas para evitar errores de formato
                    const promptText = `
                        Act√∫a como un profesor de idiomas experto. Genera una lista de vocabulario sobre el tema: "${aiPrompt}".
                        
                        REGLAS OBLIGATORIAS:
                        1. Ignora cualquier texto t√©cnico, metadatos o nombres de modelos (como 'gemini', 'usando modelo') que aparezcan en el tema. C√©ntrate solo en el tema sem√°ntico.
                        2. FORMATO EXACTO: Devuelve SOLO un array JSON puro.
                        3. ESTRUCTURA: [{"front": "Palabra en INGL√âS", "back": "Traducci√≥n en ESPA√ëOL"}].
                        4. CONTENIDO: Genera entre 5 y 10 pares de palabras/frases relevantes.
                        5. IMPORTANTE: 'front' DEBE ser Ingl√©s y 'back' DEBE ser Espa√±ol.
                        6. No incluyas markdown, ni comillas extra, solo el JSON raw.
                    `;

                    console.log("Enviando a modelo:", selectedModel);
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: promptText }] }]
                            })
                        }
                    );

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(`Error (${response.status}): ${err.error?.message || 'Desconocido'}`);
                    }

                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const newItems = JSON.parse(cleanJsonText(rawText));
                    
                    if (Array.isArray(newItems)) {
                        const formatted = newItems.map(item => ({ internalId: generateUniqueId(), front: item.front || '', back: item.back || '', image: null }));
                        setCards(prev => [...prev, ...formatted]);
                        setAiPrompt('');
                        addToast(`¬°Lista generada correctamente!`, 'success');
                    }
                } catch (e) {
                    addToast(e.message, 'error');
                } finally {
                    setIsGenerating(false);
                }
            };

            // --- IM√ÅGENES ---
            const searchImages = async (query, source = 'unsplash') => {
                const safeQuery = encodeURIComponent(query);
                let url = '';
                
                if (source === 'unsplash') {
                    if (!unsplashApiKey.includes("SQZ")) throw new Error("Falta clave Unsplash");
                    url = `https://api.unsplash.com/search/photos?query=${safeQuery}&per_page=20&client_id=${unsplashApiKey}`;
                } else {
                    if (!pixabayApiKey.includes("5426")) throw new Error("Falta clave Pixabay");
                    url = `https://pixabay.com/api/?key=${pixabayApiKey}&q=${safeQuery}&image_type=vector&per_page=20&safesearch=true`;
                }

                const res = await fetch(url);
                if (!res.ok) throw new Error("Error buscando im√°genes");
                const data = await res.json();
                
                return source === 'unsplash' 
                    ? data.results.map(img => ({ id: img.id, preview: img.urls.small, full: img.urls.regular }))
                    : data.hits.map(img => ({ id: img.id, preview: img.previewURL, full: img.webformatURL }));
            };

            const openGallery = async (cardId, term) => {
                if (!term) return addToast("Escribe algo en la tarjeta primero", "warning");
                setGalleryModal({ isOpen: true, cardId, searchTerm: term, results: [], loading: true, source: 'unsplash' });
                try {
                    const hits = await searchImages(term, 'unsplash');
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (e) {
                    try {
                        const hits = await searchImages(term, 'pixabay');
                        setGalleryModal(prev => ({ ...prev, results: hits, loading: false, source: 'pixabay' }));
                    } catch(err) { addToast("No se encontraron im√°genes", 'error'); }
                }
            };

            const handleGallerySearch = async (e) => {
                e?.preventDefault();
                setGalleryModal(prev => ({ ...prev, loading: true }));
                try {
                    const hits = await searchImages(galleryModal.searchTerm, galleryModal.source);
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (e) { addToast("Error en la b√∫squeda", 'error'); }
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen bg-slate-100 py-8 px-4 font-sans text-slate-900 pb-32">
                    {/* MODAL */}
                    {galleryModal.isOpen && (
                        <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-4xl rounded-2xl h-[85vh] flex flex-col overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-lg"><i className="fa-solid fa-image"></i> Galer√≠a</h3>
                                    <button onClick={() => setGalleryModal({ ...galleryModal, isOpen: false })} className="p-2 hover:bg-slate-200 rounded-full"><i className="fa-solid fa-times"></i></button>
                                </div>
                                <div className="p-4 bg-white border-b space-y-3">
                                    <form onSubmit={handleGallerySearch} className="flex gap-2">
                                        <input autoFocus value={galleryModal.searchTerm} onChange={e => setGalleryModal({ ...galleryModal, searchTerm: e.target.value })} className="flex-1 border-2 border-indigo-100 rounded-lg px-4 py-2 font-bold outline-none focus:border-indigo-500" />
                                        <button type="submit" className="bg-indigo-600 text-white px-6 rounded-lg font-bold">Buscar</button>
                                    </form>
                                    <div className="flex gap-4 text-sm font-bold text-slate-600">
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={galleryModal.source === 'unsplash'} onChange={() => { setGalleryModal({...galleryModal, source: 'unsplash'}); handleGallerySearch(); }}/> Fotos</label>
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="radio" checked={galleryModal.source === 'pixabay'} onChange={() => { setGalleryModal({...galleryModal, source: 'pixabay'}); handleGallerySearch(); }}/> Dibujos</label>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-100 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                                    {galleryModal.loading ? <div className="col-span-full text-center py-20"><i className="fa-solid fa-spinner fa-spin fa-2x"></i></div> : 
                                     galleryModal.results.map(img => (
                                        <button key={img.id} onClick={() => {
                                            setCards(prev => prev.map(c => c.internalId === galleryModal.cardId ? { ...c, image: img.full } : c));
                                            setGalleryModal({...galleryModal, isOpen: false});
                                        }} className="aspect-square rounded-xl overflow-hidden bg-gray-200 hover:scale-105 transition-all">
                                            <img src={img.preview} className="w-full h-full object-cover"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOASTS */}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`px-4 py-3 rounded-xl shadow-xl text-sm font-bold pointer-events-auto border-2 ${t.type==='error'?'bg-red-50 border-red-100 text-red-600':'bg-green-50 border-green-100 text-green-700'}`}>{t.message}</div>
                        ))}
                    </div>

                    <div className="max-w-6xl mx-auto space-y-6">
                        {/* HEADER */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center sticky top-2 z-30">
                            <div className="flex items-center gap-3">
                                <button onClick={() => window.location.href='/'} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500"><i className="fa-solid fa-arrow-left"></i></button>
                                <input value={title} onChange={e => setTitle(e.target.value)} placeholder="T√≠tulo de la Actividad..." className="text-lg font-black bg-transparent outline-none w-full md:w-64"/>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex items-center bg-slate-100 rounded-lg p-1 mr-2">
                                    <button onClick={() => setAudioEnabled({...audioEnabled, left: !audioEnabled.left})} className={`px-3 py-1.5 rounded text-xs font-bold ${audioEnabled.left ? 'bg-indigo-600 text-white' : 'text-slate-400'}`}>EN <i className={`fa-solid ${audioEnabled.left ? 'fa-volume-high' : 'fa-volume-xmark'}`}></i></button>
                                    <button onClick={() => setAudioEnabled({...audioEnabled, right: !audioEnabled.right})} className={`px-3 py-1.5 rounded text-xs font-bold ${audioEnabled.right ? 'bg-pink-600 text-white' : 'text-slate-400'}`}>ES <i className={`fa-solid ${audioEnabled.right ? 'fa-volume-high' : 'fa-volume-xmark'}`}></i></button>
                                </div>
                                <button onClick={() => confirm("¬øGuardar y salir?") && (window.location.href='/')} className="bg-slate-900 text-white px-5 py-2 rounded-xl font-bold hover:bg-black"><i className="fa-solid fa-save"></i> Guardar</button>
                            </div>
                        </div>

                        {/* IA BARRA CON ESC√ÅNER */}
                        <div className="bg-indigo-600 rounded-2xl p-1 shadow-lg">
                            <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 flex flex-col gap-2">
                                <div className="flex gap-2 items-center">
                                    <i className="fa-solid fa-wand-magic-sparkles text-white"></i>
                                    <input value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Animales marinos..." className="flex-1 bg-white/20 border-none rounded-lg px-3 py-1.5 text-white font-bold outline-none focus:bg-white focus:text-indigo-900 transition-colors" onKeyDown={e => e.key === 'Enter' && generateList()}/>
                                    <button onClick={generateList} disabled={isGenerating || !aiPrompt || !selectedModel} className="bg-white text-indigo-700 px-4 py-1.5 rounded-lg font-bold hover:bg-indigo-50 disabled:opacity-50 text-sm">
                                        {isGenerating ? <i className="fa-solid fa-spinner fa-spin"></i> : 'Generar'}
                                    </button>
                                </div>
                                
                                {/* ZONA DE SELECCI√ìN DE MODELO */}
                                <div className="flex items-center gap-2 pl-7">
                                    {availableModels.length > 0 ? (
                                        <select value={selectedModel} onChange={e => setSelectedModel(e.target.value)} className="bg-black/20 text-white border-none rounded px-2 py-1 text-xs font-mono">
                                            {availableModels.map(m => <option key={m} value={m} className="text-black">{m}</option>)}
                                        </select>
                                    ) : (
                                        <button onClick={scanModels} disabled={isScanning} className="text-xs bg-indigo-500 hover:bg-indigo-400 text-white px-3 py-1 rounded-lg flex items-center gap-2 transition-colors border border-indigo-400">
                                            {isScanning ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-search"></i>}
                                            {isScanning ? "Conectando..." : "üîç Escanear Modelos Disponibles (Clic aqu√≠)"}
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* TABLA */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="grid grid-cols-12 gap-4 p-4 bg-slate-50 border-b text-xs font-black text-slate-400 uppercase">
                                <div className="col-span-1 text-center">#</div>
                                <div className="col-span-4 pl-2">Ingl√©s</div>
                                <div className="col-span-1 text-center"><button onClick={() => { 
                                    setCards(c => c.map(x => ({...x, front: x.back, back: x.front}))); 
                                    setLangConfig(l => ({left: l.right, right: l.left}));
                                }}><i className="fa-solid fa-right-left"></i></button></div>
                                <div className="col-span-4 pl-2">Espa√±ol</div>
                                <div className="col-span-2 text-right">Acciones</div>
                            </div>

                            <div className="divide-y divide-slate-100">
                                {cards.map((card, index) => (
                                    <div key={card.internalId} className="grid grid-cols-1 sm:grid-cols-12 gap-4 p-4 hover:bg-slate-50 items-start">
                                        <div className="sm:col-span-1 text-center font-black text-slate-300 pt-2">{index + 1}</div>
                                        
                                        <div className="sm:col-span-4 flex gap-2">
                                            <input value={card.front} onChange={e => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, front: e.target.value} : c))} className="w-full border-2 border-slate-200 rounded-xl px-3 py-2 font-bold focus:border-indigo-500 outline-none"/>
                                            {audioEnabled.left && <button onClick={() => playAudio(card.front, langConfig.left)} className="text-indigo-500"><i className="fa-solid fa-volume-high"></i></button>}
                                        </div>

                                        <div className="sm:col-span-1 flex justify-center pt-1">
                                            {card.image ? (
                                                <div className="relative w-14 h-14 rounded-lg overflow-hidden group">
                                                    <img src={card.image} className="w-full h-full object-cover cursor-pointer" onClick={() => openGallery(card.internalId, card.front)}/>
                                                    <button onClick={() => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, image: null} : c))} className="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-xs"><i className="fa-solid fa-times"></i></button>
                                                </div>
                                            ) : (
                                                <button onClick={() => openGallery(card.internalId, card.front)} className="w-14 h-14 rounded-lg border-2 border-dashed border-slate-300 text-slate-300 hover:border-indigo-500 hover:text-indigo-500"><i className="fa-solid fa-image"></i></button>
                                            )}
                                        </div>

                                        <div className="sm:col-span-4 flex gap-2">
                                            <input value={card.back} onChange={e => setCards(prev => prev.map(c => c.internalId === card.internalId ? {...c, back: e.target.value} : c))} className="w-full border-2 border-slate-200 rounded-xl px-3 py-2 font-bold focus:border-pink-500 outline-none"/>
                                            {audioEnabled.right && <button onClick={() => playAudio(card.back, langConfig.right)} className="text-pink-500"><i className="fa-solid fa-volume-high"></i></button>}
                                        </div>

                                        <div className="sm:col-span-2 flex justify-end gap-2 pt-2">
                                            <button onClick={() => {
                                                const newCards = [...cards];
                                                newCards.splice(index + 1, 0, { ...card, internalId: generateUniqueId() });
                                                setCards(newCards);
                                            }} className="text-slate-400 hover:text-indigo-600"><i className="fa-solid fa-copy"></i></button>
                                            <button onClick={() => cards.length > 1 && setCards(prev => prev.filter(c => c.internalId !== card.internalId))} className="text-slate-400 hover:text-red-600"><i className="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <button onClick={() => setCards([...cards, { internalId: generateUniqueId(), front: '', back: '', image: null }])} className="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-white transition-all flex items-center justify-center gap-2"><i className="fa-solid fa-plus"></i> A√±adir Fila</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<DashboardCreador />);
    </script>
</body>
</html>
