<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Flashcards - Periplo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; }
        /* Scrollbar bonita para la galer√≠a */
        .scroller::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .scroller::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Save, FileText, Languages, Eraser, 
            Sparkles, Image as ImageIcon, Volume2, ArrowRightLeft, 
            Loader2, Play, AlertCircle, CheckCircle, Search, X, 
            Zap, Grid
        } from 'lucide-react';
// --- üîë TUS CLAVES AQU√ç ---
        
        // 1. CLAVE DE GOOGLE (La que empieza con AIzaSy... para las listas)
        // Usamos el truco de partirla en dos para que GitHub no se queje:
        const googleApiKey = "AIzaSyD4d-" + "Kx1jQbgrKIdeOftv7BM729m7MIGPo"; 

        // 2. CLAVE DE PIXABAY (La que empieza con n√∫meros... para las fotos)
        const pixabayApiKey = "54261518-ae514f8c15f5fdf02ac955551";

        const DashboardCreador = () => {
            // --- ESTADOS ---
            const generateUniqueId = () => {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            };

            const [title, setTitle] = useState(localStorage.getItem('tempNewActivityName') || '');
            const [cards, setCards] = useState([
                { internalId: generateUniqueId(), front: '', back: '', image: null }
            ]);
            
            const [isGeneratingList, setIsGeneratingList] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [toasts, setToasts] = useState([]);
            
            // Estados para la Galer√≠a Integrada
            const [galleryModal, setGalleryModal] = useState({ isOpen: false, cardId: null, searchTerm: '', results: [], loading: false });
            const [bulkImageLoading, setBulkImageLoading] = useState(false);

            useEffect(() => { localStorage.removeItem('tempNewActivityName'); }, []);

            // --- HELPERS ---
            const addToast = (message, type = 'error') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 5000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
            const cleanJsonText = (text) => text.replace(/```json/g, '').replace(/```/g, '').trim();

            // --- AUDIO DEL NAVEGADOR ---
            const playBrowserAudio = (text) => {
                if (!text) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; 
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            };

            // --- API: GENERAR LISTA (GOOGLE GEMINI) ---
            const generateListWithAI = async () => {
                if (!googleApiKey || googleApiKey.includes("TU_CLAVE")) return addToast("Falta la API Key de Google.", 'error');
                if (!aiPrompt.trim()) return;
                setIsGeneratingList(true);
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${googleApiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Genera una lista JSON exacta sobre: "${aiPrompt}". Formato: [{"front": "Ingl√©s", "back": "Espa√±ol"}]. Solo JSON raw.` }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        }
                    );
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    const newItems = JSON.parse(cleanJsonText(rawText));
                    if (Array.isArray(newItems)) {
                        const formattedItems = newItems.map(item => ({
                            internalId: generateUniqueId(),
                            front: item.front || '',
                            back: item.back || '',
                            image: null
                        }));
                        setCards(prev => [...prev, ...formattedItems]);
                        setAiPrompt('');
                        addToast("Lista generada con √©xito", 'success');
                    }
                } catch (error) {
                    addToast("Error generando lista: " + error.message, 'error');
                } finally {
                    setIsGeneratingList(false);
                }
            };

            // --- API: BUSCAR IM√ÅGENES (PIXABAY) ---
            
            // Funci√≥n interna para buscar
            const searchPixabay = async (query) => {
                if (!pixabayApiKey || pixabayApiKey.includes("TU_CLAVE")) throw new Error("Falta Clave Pixabay");
                const safeQuery = encodeURIComponent(query);
                // Pedimos tipo 'vector' para que parezcan dibujos escolares, o 'photo' si prefieres
                const response = await fetch(`https://pixabay.com/api/?key=${pixabayApiKey}&q=${safeQuery}&image_type=vector&per_page=12&safesearch=true`);
                if(!response.ok) throw new Error("Error Pixabay");
                const data = await response.json();
                return data.hits; // Array de im√°genes
            };

            // 1. Abrir Galer√≠a Manual
            const openGallery = async (cardId, term) => {
                if (!term) return addToast("Escribe una palabra primero", "warning");
                setGalleryModal({ isOpen: true, cardId, searchTerm: term, results: [], loading: true });
                
                try {
                    const hits = await searchPixabay(term);
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (error) {
                    setGalleryModal(prev => ({ ...prev, isOpen: false }));
                    addToast(error.message, 'error');
                }
            };

            // Buscar dentro del modal si el usuario cambia el texto
            const handleModalSearch = async (e) => {
                e.preventDefault();
                setGalleryModal(prev => ({ ...prev, loading: true }));
                try {
                    const hits = await searchPixabay(galleryModal.searchTerm);
                    setGalleryModal(prev => ({ ...prev, results: hits, loading: false }));
                } catch (error) {
                    addToast("Error buscando", 'error');
                }
            };

            const selectImage = (url) => {
                setCards(cards => cards.map(c => c.internalId === galleryModal.cardId ? { ...c, image: url } : c));
                setGalleryModal({ isOpen: false, cardId: null, searchTerm: '', results: [], loading: false });
            };

            // 2. Auto-Relleno Masivo (La magia de Wordwall)
            const autoFillImages = async () => {
                if (!pixabayApiKey || pixabayApiKey.includes("TU_CLAVE")) return addToast("Falta API Key de Pixabay", 'error');
                
                const pendingCards = cards.filter(c => c.front && !c.image);
                if (pendingCards.length === 0) return addToast("Todas las palabras ya tienen imagen.", 'success');
                
                setBulkImageLoading(true);
                let count = 0;

                for (let card of pendingCards) {
                    try {
                        const hits = await searchPixabay(card.front);
                        if (hits && hits.length > 0) {
                            // Tomamos la primera imagen (la m√°s relevante)
                            const bestImage = hits[0].webformatURL;
                            setCards(prev => prev.map(c => c.internalId === card.internalId ? { ...c, image: bestImage } : c));
                            count++;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                    // Peque√±a pausa para no saturar la API
                    await new Promise(r => setTimeout(r, 500));
                }
                
                setBulkImageLoading(false);
                addToast(`Se encontraron im√°genes para ${count} palabras.`, 'success');
            };


            // --- CRUD ---
            const handleAddCard = () => setCards([...cards, { internalId: generateUniqueId(), front: '', back: '', image: null }]);
            const handleDeleteCard = (id) => {
                if (cards.length === 1) return;
                setCards(cards.filter(c => c.internalId !== id));
            };
            const handleCardChange = (id, field, value) => setCards(cards.map(c => c.internalId === id ? { ...c, [field]: value } : c));
            const handleRemoveImage = (id) => setCards(cards.map(c => c.internalId === id ? { ...c, image: null } : c));
            
            const handleSave = () => {
                if (!title.trim()) return addToast("A√±ade un t√≠tulo primero.", 'warning');
                const payload = {
                    title,
                    cards: cards.map((c, i) => ({ id: i + 1, front: c.front, back: c.back, image: c.image }))
                };
                console.log("GUARDANDO:", payload);
                addToast("Guardado (Simulaci√≥n).", 'success');
                if(confirm("¬°Juego guardado! (Simulaci√≥n)\n¬øVolver al men√∫?")) window.location.href = "/";
            };

            return (
                <div className="min-h-screen bg-slate-50 py-8 px-2 sm:px-6 lg:px-8 relative font-sans">
                    
                    {/* MODAL DE GALER√çA (TIPO WORDWALL) */}
                    {galleryModal.isOpen && (
                        <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 className="font-black text-slate-700 flex items-center gap-2"><ImageIcon size={20}/> Buscar Imagen</h3>
                                    <button onClick={() => setGalleryModal({ ...galleryModal, isOpen: false })} className="p-2 hover:bg-slate-200 rounded-full"><X/></button>
                                </div>
                                <div className="p-4 border-b border-slate-100">
                                    <form onSubmit={handleModalSearch} className="flex gap-2">
                                        <input autoFocus value={galleryModal.searchTerm} onChange={e => setGalleryModal({ ...galleryModal, searchTerm: e.target.value })} className="flex-1 border-2 border-indigo-100 rounded-lg px-4 py-2 font-bold text-slate-700 focus:border-indigo-500 outline-none" placeholder="Buscar..."/>
                                        <button type="submit" className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700">Buscar</button>
                                    </form>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-100 scroller">
                                    {galleryModal.loading ? (
                                        <div className="flex flex-col items-center justify-center h-40 text-slate-400">
                                            <Loader2 size={40} className="animate-spin mb-2"/> Buscando en Pixabay...
                                        </div>
                                    ) : galleryModal.results.length === 0 ? (
                                        <div className="text-center text-slate-400 py-10 font-bold">No se encontraron resultados :(</div>
                                    ) : (
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                            {galleryModal.results.map(img => (
                                                <button key={img.id} onClick={() => selectImage(img.webformatURL)} className="group relative aspect-square rounded-xl overflow-hidden border-2 border-transparent hover:border-indigo-500 focus:border-indigo-500 bg-white shadow-sm transition-all">
                                                    <img src={img.previewURL} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"/>
                                                    <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOASTS */}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                        {toasts.map(t => (
                            <div key={t.id} className={`px-4 py-3 rounded-lg shadow-lg text-sm font-bold pointer-events-auto ${t.type==='error'?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>
                                {t.message}
                            </div>
                        ))}
                    </div>

                    <div className="max-w-5xl mx-auto space-y-6">
                        {/* HEADER */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-black text-slate-800 flex items-center gap-2"><Languages className="text-indigo-600"/> Creador Pro</h1>
                                <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">Modo Constructor</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.location.href='/'} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition-colors">Salir</button>
                                <button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg hover:shadow-indigo-200 transition-all flex items-center gap-2"><Save size={18}/> Guardar</button>
                            </div>
                        </div>

                        {/* GENERADOR LISTAS IA */}
                        <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl p-1 shadow-lg">
                            <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 flex flex-col sm:flex-row gap-4 items-center">
                                <div className="text-white font-black flex items-center gap-2 whitespace-nowrap"><Sparkles size={20}/> Generar Lista:</div>
                                <input value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} placeholder="Ej: Verbos de cocina..." className="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-2 font-bold text-white placeholder:text-white/50 focus:bg-white focus:text-slate-900 outline-none transition-colors" onKeyDown={e => e.key === 'Enter' && generateListWithAI()}/>
                                <button onClick={generateListWithAI} disabled={isGeneratingList || !aiPrompt} className="bg-white text-slate-900 px-6 py-2 rounded-lg font-bold hover:bg-indigo-50 disabled:opacity-50 transition-all">
                                    {isGeneratingList ? <Loader2 className="animate-spin"/> : 'Generar'}
                                </button>
                            </div>
                        </div>

                        {/* LISTA */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-6 border-b border-slate-100 bg-slate-50 flex flex-wrap gap-4 justify-between items-end">
                                <div className="flex-1 min-w-[200px]">
                                    <label className="text-xs font-black text-slate-400 uppercase">T√≠tulo</label>
                                    <input value={title} onChange={e => setTitle(e.target.value)} placeholder="Ej: Unit 1 - Vocabulary" className="w-full text-xl font-bold bg-transparent border-none outline-none placeholder:text-slate-300 text-slate-800"/>
                                </div>
                                <button onClick={autoFillImages} disabled={bulkImageLoading} className="px-4 py-2 bg-pink-100 text-pink-700 font-bold rounded-lg hover:bg-pink-200 transition-colors flex items-center gap-2 text-sm disabled:opacity-50">
                                    {bulkImageLoading ? <Loader2 className="animate-spin" size={16}/> : <Zap size={16}/>} Auto-Im√°genes (Magic)
                                </button>
                            </div>

                            <div className="divide-y divide-slate-100">
                                {cards.map((card, i) => (
                                    <div key={card.internalId} className="p-4 hover:bg-slate-50 transition-colors group">
                                        <div className="flex flex-col sm:flex-row gap-4 items-start">
                                            <div className="hidden sm:flex flex-col items-center justify-center w-8 pt-3">
                                                <span className="text-xs font-black text-slate-300">#{i+1}</span>
                                            </div>

                                            <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                                                <div className="space-y-1">
                                                    <div className="flex gap-2">
                                                        <input value={card.front} onChange={e => handleCardChange(card.internalId, 'front', e.target.value)} className="w-full border-2 border-slate-200 rounded-lg px-3 py-2 font-bold text-slate-700 focus:border-indigo-500 outline-none" placeholder="Ingl√©s"/>
                                                        <button onClick={() => playBrowserAudio(card.front)} className="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors" title="Escuchar"><Volume2 size={20}/></button>
                                                    </div>
                                                </div>
                                                <div className="space-y-1">
                                                    <input value={card.back} onChange={e => handleCardChange(card.internalId, 'back', e.target.value)} className="w-full border-2 border-slate-200 rounded-lg px-3 py-2 font-bold text-slate-700 focus:border-pink-500 outline-none" placeholder="Espa√±ol"/>
                                                </div>
                                            </div>

                                            <div className="w-full sm:w-auto flex sm:flex-col gap-2 pt-1">
                                                {card.image ? (
                                                    <div className="relative w-16 h-16 sm:w-20 sm:h-20 bg-slate-100 rounded-lg border border-slate-200 group/img">
                                                        <img src={card.image} className="w-full h-full object-cover rounded-lg cursor-pointer" onClick={() => openGallery(card.internalId, card.front)}/>
                                                        <button onClick={() => handleRemoveImage(card.internalId)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:scale-110 transition-transform"><X size={12}/></button>
                                                    </div>
                                                ) : (
                                                    <div className="flex gap-1">
                                                        <button onClick={() => openGallery(card.internalId, card.front)} className="p-3 bg-slate-100 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors flex flex-col items-center justify-center gap-1 w-20 h-20 border-2 border-dashed border-slate-200" title="Buscar Imagen">
                                                            <ImageIcon size={24}/>
                                                            <span className="text-[10px] font-bold">Buscar</span>
                                                        </button>
                                                    </div>
                                                )}
                                                
                                                <button onClick={() => handleDeleteCard(card.internalId)} className="p-2 text-slate-300 hover:text-red-500 rounded-lg sm:mt-auto ml-auto hidden sm:block" title="Eliminar"><Trash2 size={18}/></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="p-4 bg-slate-50 border-t border-slate-200">
                                <button onClick={handleAddCard} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold hover:border-indigo-400 hover:text-indigo-600 hover:bg-white transition-all flex items-center justify-center gap-2"><Plus/> A√±adir Palabra</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<DashboardCreador />);
    </script>
</body>
</html>


