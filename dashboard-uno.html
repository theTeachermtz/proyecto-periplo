<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Builder | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }; document.documentElement.classList.add('dark');</script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; height: 100dvh; overflow: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, serverTimestamp } from 'firebase/firestore';
        import { Zap, Puzzle, CheckSquare, Square, ChevronDown, ChevronRight, Save, ArrowLeft, Loader2, Sun, Moon, ShoppingCart, Dices } from 'lucide-react';

        // Tu configuración exacta de Firebase
        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Vocabulario estructurado para el dashboard
        const UNO_DICTIONARY = [
            { word: 'clima', article: 'el' }, { word: 'problema', article: 'el' }, { word: 'sistema', article: 'el' }, { word: 'mapa', article: 'el' }, { word: 'día', article: 'el' }, { word: 'sofá', article: 'el' }, { word: 'árbol', article: 'el' }, { word: 'corazón', article: 'el' }, { word: 'sol', article: 'el' }, { word: 'hospital', article: 'el' }, { word: 'dolor', article: 'el' }, { word: 'baño', article: 'el' }, { word: 'reloj', article: 'el' }, { word: 'celular', article: 'el' }, { word: 'internet', article: 'el' }, { word: 'viaje', article: 'el' },
            { word: 'mano', article: 'la' }, { word: 'foto', article: 'la' }, { word: 'moto', article: 'la' }, { word: 'radio', article: 'la' }, { word: 'actriz', article: 'la' }, { word: 'verdad', article: 'la' }, { word: 'canción', article: 'la' }, { word: 'pasión', article: 'la' }, { word: 'luz', article: 'la' }, { word: 'voz', article: 'la' }, { word: 'ciudad', article: 'la' }, { word: 'misión', article: 'la' }, { word: 'noche', article: 'la' }, { word: 'clase', article: 'la' }, { word: 'sangre', article: 'la' }, { word: 'gente', article: 'la' },
            { word: 'lunes', article: 'el', validArticles: ['el', 'los'] }, { word: 'paraguas', article: 'el', validArticles: ['el', 'los'] }, { word: 'virus', article: 'el', validArticles: ['el', 'los'] },
            { word: 'artista', article: 'el', validArticles: ['el', 'la'] }, { word: 'estudiante', article: 'el', validArticles: ['el', 'la'] }, { word: 'paciente', article: 'el', validArticles: ['el', 'la'] }, { word: 'cliente', article: 'el', validArticles: ['el', 'la'] }, { word: 'turista', article: 'el', validArticles: ['el', 'la'] }
        ];

        // Agrupación para la UI
        const VOCAB_CATEGORIES = {
            "Masculinos (EL / LOS)": UNO_DICTIONARY.filter(w => w.article === 'el' || w.article === 'los'),
            "Femeninos (LA / LAS)": UNO_DICTIONARY.filter(w => w.article === 'la' || w.article === 'las'),
            "Neutros y Especiales": UNO_DICTIONARY.filter(w => w.validArticles && w.validArticles.length > 1)
        };

        const Dashboard = () => {
            const [gameTitle, setGameTitle] = useState("");
            const [selectedWords, setSelectedWords] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [expandedCats, setExpandedCats] = useState(new Set(Object.keys(VOCAB_CATEGORIES)));
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const editId = params.get('edit');
                if (editId) {
                    getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editId)).then(docSnap => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setGameTitle(data.title);
                            setEditingId(editId);
                            if (data.content && data.content.wordPool) setSelectedWords(data.content.wordPool);
                        }
                    });
                }
            }, []);

            useEffect(() => { document.documentElement.className = isDarkMode ? 'dark' : ''; }, [isDarkMode]);

            const toggleWord = (wordObj) => {
                const isSelected = selectedWords.some(w => w.word === wordObj.word);
                if (isSelected) setSelectedWords(selectedWords.filter(w => w.word !== wordObj.word));
                else setSelectedWords([...selectedWords, wordObj]);
            };

            const toggleCat = (catName) => {
                setExpandedCats(prev => {
                    const next = new Set(prev);
                    next.has(catName) ? next.delete(catName) : next.add(catName);
                    return next;
                });
            };

            const saveToFirebase = async () => {
                if (!gameTitle) return alert("Ponle un título al juego");
                if (selectedWords.length < 10) return alert("Selecciona al menos 10 palabras para armar un mazo decente.");
                
                setIsSaving(true);
                try {
                    const content = { wordPool: selectedWords }; // Esto es lo que leerá el juego de UNO
                    const params = new URLSearchParams(window.location.search);
                    const parentPath = params.get('folder') ? decodeURIComponent(params.get('folder')) : '';

                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', editingId), { title: gameTitle, content: content, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'users', 'teacher_builder_001', 'quizzes'), { title: gameTitle, type: 'UNO', content: content, createdAt: serverTimestamp(), parentPath: parentPath });
                    }
                    window.location.href = parentPath ? `index.html?folder=${encodeURIComponent(parentPath)}` : 'index.html'; 
                } catch (e) { alert("Error guardando: " + e.message); }
                finally { setIsSaving(false); }
            };

            return (
                <div className="h-[100dvh] flex flex-col">
                    {/* NAVBAR */}
                    <div className="bg-slate-900 dark:bg-black px-4 py-4 flex justify-between items-center shadow-md z-10">
                        <div className="flex items-center gap-4">
                            <button onClick={() => window.location.href='index.html'} className="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl"><ArrowLeft size={20}/></button>
                            <h1 className="text-xl font-black text-white flex items-center gap-2"><Dices className="text-blue-400"/> UNO Builder</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="text-yellow-400">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                            <button onClick={saveToFirebase} disabled={isSaving || selectedWords.length < 10} className="bg-green-500 hover:bg-green-600 text-white px-6 py-2.5 rounded-xl font-bold flex gap-2 disabled:opacity-50">
                                {isSaving ? <Loader2 className="animate-spin"/> : <Save/>} Guardar
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex flex-1 overflow-hidden">
                        {/* LEFT: DICTIONARY */}
                        <div className="w-1/2 border-r border-slate-200 dark:border-zinc-800 bg-slate-50 dark:bg-zinc-950 flex flex-col">
                            <div className="p-6 border-b border-slate-200 dark:border-zinc-800 shrink-0">
                                <h2 className="font-black text-slate-800 dark:text-white flex gap-2 text-lg"><Puzzle className="text-purple-500"/> Vocabulario (Género)</h2>
                                <p className="text-xs text-slate-400 mt-1">Selecciona al menos 10 palabras para generar el mazo.</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                                {Object.entries(VOCAB_CATEGORIES).map(([cat, words]) => {
                                    const isOpen = expandedCats.has(cat);
                                    return (
                                        <div key={cat} className="bg-white dark:bg-zinc-900 rounded-xl border border-slate-200 dark:border-zinc-800 shadow-sm overflow-hidden">
                                            <div className="p-4 flex items-center justify-between cursor-pointer bg-slate-100 dark:bg-zinc-800/50" onClick={() => toggleCat(cat)}>
                                                <div className="font-bold text-slate-700 dark:text-zinc-200">{cat} ({words.length})</div>
                                                {isOpen ? <ChevronDown size={16} className="text-slate-400"/> : <ChevronRight size={16} className="text-slate-400"/>}
                                            </div>
                                            {isOpen && (
                                                <div className="p-4 flex flex-wrap gap-2">
                                                    {words.map(w => {
                                                        const isSel = selectedWords.some(sw => sw.word === w.word);
                                                        return (
                                                            <button key={w.word} onClick={() => toggleWord(w)} className={`px-3 py-1.5 rounded font-bold text-xs border transition-all ${isSel ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400 border-blue-300' : 'bg-white dark:bg-zinc-800 text-slate-600 dark:text-zinc-400 border-slate-200 hover:border-slate-400'}`}>
                                                                {w.word}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        
                        {/* RIGHT: SELECTED WORDS */}
                        <div className="w-1/2 bg-white dark:bg-zinc-900 flex flex-col">
                            <div className="p-6 border-b border-slate-200 dark:border-zinc-800 flex justify-between shrink-0">
                                <div>
                                    <h3 className="font-black text-slate-800 dark:text-white flex gap-2 text-lg"><ShoppingCart className="text-emerald-500"/> Mazo para el Juego</h3>
                                </div>
                                <span className={`px-3 py-1.5 rounded-full text-xs font-bold border ${selectedWords.length >= 10 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>{selectedWords.length} / 10 Mínimo</span>
                            </div>
                            <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
                                <input value={gameTitle} onChange={e => setGameTitle(e.target.value)} className="text-3xl font-black w-full border-b-2 border-slate-300 dark:border-zinc-700 pb-2 mb-8 bg-transparent dark:text-white outline-none" placeholder="Escribe el Título..."/>
                                <div className="grid grid-cols-3 gap-3">
                                    {selectedWords.map(w => (
                                        <div key={w.word} className="bg-slate-50 dark:bg-zinc-950 border border-slate-200 dark:border-zinc-800 rounded-xl p-3 text-center">
                                            <span className="font-bold text-slate-800 dark:text-zinc-200 block">{w.word}</span>
                                            <span className="text-[10px] text-slate-400 uppercase font-black">{w.validArticles ? w.validArticles.join(' / ') : w.article}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>