<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Activity | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .droppable-active { background-color: #dcfce7; border-color: #22c55e; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { Loader2, CheckCircle2, RotateCcw, ArrowLeft, BookOpen, Lightbulb } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ReadingActivity = () => {
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [tokens, setTokens] = useState([]);
            const [dropped, setDropped] = useState({});
            const [result, setResult] = useState(null);

            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const id = params.get('id');
                    if (!id) return;
                    
                    const snap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', id));
                    if (snap.exists()) {
                        const savedData = snap.data();
                        setData(savedData);
                        
                        const regex = /([a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+|[^a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+|\s+)/g;
                        const parts = savedData.content.text.match(regex) || [];
                        const processedTokens = parts.map((part, index) => ({
                            id: index,
                            text: part,
                            isHidden: savedData.content.blanks.includes(index)
                        }));
                        setTokens(processedTokens);
                    }
                    setLoading(false);
                };
                init();
            }, []);

            const handleDragStart = (e, word) => { e.dataTransfer.setData("word", word); };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, index) => {
                e.preventDefault();
                const word = e.dataTransfer.getData("word");
                setDropped(prev => ({ ...prev, [index]: word }));
            };
            const removeDrop = (index) => {
                const newDropped = { ...dropped };
                delete newDropped[index];
                setDropped(newDropped);
            };
            const checkAnswers = () => {
                const isAllCorrect = tokens.filter(t => t.isHidden).every(t => dropped[t.id] === t.text);
                setResult(isAllCorrect ? 'correct' : 'wrong');
                if (isAllCorrect) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            };

            const handleExit = () => {
                // INTENTA VOLVER A LA CARPETA SI ES POSIBLE, SINO AL INDEX
                const params = new URLSearchParams(window.location.search);
                // AquÃ­ idealmente pasarÃ­amos el folderId en la URL al cargar el juego para saber a donde volver
                window.location.href = 'index.html'; 
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400"><Loader2 className="animate-spin mr-2"/> Cargando lectura...</div>;
            if (!data) return <div className="h-screen flex items-center justify-center text-red-400">Lectura no encontrada</div>;

            const wordBank = tokens.filter(t => t.isHidden).map(t => t.text).sort(() => Math.random() - 0.5); 
            const availableWords = wordBank.filter(word => {
                const totalInText = tokens.filter(t => t.text === word && t.isHidden).length;
                const totalPlaced = Object.values(dropped).filter(w => w === word).length;
                return totalPlaced < totalInText;
            });

            return (
                <div className="max-w-4xl mx-auto p-6 min-h-screen font-sans">
                    <button onClick={handleExit} className="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold text-sm uppercase tracking-wider"><ArrowLeft size={16}/> Volver</button>
                    
                    <div className="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div className="bg-slate-900 p-8 text-white">
                            <div className="flex items-center gap-3 mb-2 opacity-50">
                                <BookOpen size={20}/>
                                <span className="text-xs font-bold uppercase tracking-widest">{data.genre} â€¢ {data.level}</span>
                            </div>
                            <h1 className="text-3xl font-black">{data.title}</h1>
                        </div>

                        <div className="p-10">
                            <div className="leading-loose text-lg text-slate-700 mb-8 text-justify">
                                {tokens.map((t, i) => {
                                    if (t.isHidden) {
                                        const val = dropped[t.id];
                                        let statusColor = 'border-slate-300 bg-slate-50';
                                        if (result === 'correct') statusColor = 'border-green-500 bg-green-100 text-green-800';
                                        if (result === 'wrong' && val) statusColor = val === t.text ? 'border-green-500 bg-green-100' : 'border-red-500 bg-red-100 text-red-800';

                                        return (
                                            <span 
                                                key={i}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => !result && handleDrop(e, t.id)}
                                                onClick={() => !result && removeDrop(t.id)}
                                                className={`inline-flex items-center justify-center min-w-[80px] h-8 mx-1 px-2 border-b-2 rounded transition-all align-middle font-bold cursor-pointer ${statusColor}`}
                                            >
                                                {val || <span className="opacity-20 text-xs">...</span>}
                                            </span>
                                        );
                                    }
                                    return <span key={i}>{t.text}</span>;
                                })}
                            </div>

                            {/* FUN FACT BOX */}
                            {data.content.fun_fact && (
                                <div className="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-r-xl mb-8 flex gap-4">
                                    <div className="shrink-0 text-amber-500"><Lightbulb size={24} className="fill-amber-500 text-amber-600"/></div>
                                    <div>
                                        <h4 className="font-black text-amber-700 uppercase text-xs tracking-widest mb-1">Did You Know?</h4>
                                        <p className="text-amber-900 font-medium text-sm">{data.content.fun_fact}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="bg-slate-50 p-8 border-t border-slate-200">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Banco de Palabras (Arrastra al texto)</h3>
                            <div className="flex flex-wrap gap-3 min-h-[50px]">
                                {availableWords.map((w, i) => (
                                    <div 
                                        key={i} 
                                        draggable={!result}
                                        onDragStart={(e) => handleDragStart(e, w)}
                                        className="bg-white border border-slate-200 px-4 py-2 rounded-lg font-bold text-slate-700 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all cursor-grab active:cursor-grabbing"
                                    >
                                        {w}
                                    </div>
                                ))}
                                {availableWords.length === 0 && !result && <div className="text-slate-400 text-sm italic">Â¡Todas las palabras colocadas!</div>}
                            </div>

                            <div className="mt-8 flex justify-end">
                                {result === 'correct' ? (
                                    <button onClick={() => window.location.reload()} className="bg-green-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform flex items-center gap-2"><CheckCircle2/> Â¡Excelente! Otra vez</button>
                                ) : (
                                    <button 
                                        onClick={checkAnswers} 
                                        disabled={availableWords.length > 0}
                                        className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Comprobar Respuestas
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingActivity />);
    </script>
</body>
</html>
