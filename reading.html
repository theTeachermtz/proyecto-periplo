<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Activity | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s; }
        
        .token-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            margin: 0 0.2em;
            padding: 0 0.5em;
            border-radius: 0.3em;
            min-width: 5em; 
            height: 1.8em;  
            transition: all 0.2s ease;
        }

        .token-hidden-light { background-color: #f1f5f9; border: 2px dashed #94a3b8; border-bottom-width: 4px; }
        .token-hidden-dark { background-color: #334155; border: 2px dashed #64748b; border-bottom-width: 4px; }
        
        .token-filled { background-color: #e0e7ff; border: 2px solid #6366f1; color: #3730a3; font-weight: 800; border-bottom-width: 4px; }
        .token-correct { background-color: #dcfce7; border: 2px solid #22c55e; color: #14532d; border-bottom-width: 4px; }
        .token-wrong { background-color: #fee2e2; border: 2px solid #ef4444; color: #7f1d1d; border-bottom-width: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { Loader2, CheckCircle2, RotateCcw, ArrowLeft, BookOpen, Lightbulb, Puzzle, Moon, Sun, ZoomIn, ZoomOut } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ReadingActivity = () => {
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState(null);
            const [tokens, setTokens] = useState([]);
            const [dropped, setDropped] = useState({});
            const [result, setResult] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [fontSize, setFontSize] = useState(20);

            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const id = params.get('id');
                    if (!id) return;
                    
                    const snap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', id));
                    if (snap.exists()) {
                        const savedData = snap.data();
                        setData(savedData);
                        const regex = /([a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+|[^a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+|\s+)/g;
                        const parts = savedData.content.text.match(regex) || [];
                        const processedTokens = parts.map((part, index) => ({
                            id: index,
                            text: part,
                            isHidden: savedData.content.blanks.includes(index)
                        }));
                        setTokens(processedTokens);
                    }
                    setLoading(false);
                };
                init();
            }, []);

            const handleDragStart = (e, word) => { e.dataTransfer.setData("word", word); };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, index) => {
                e.preventDefault();
                const word = e.dataTransfer.getData("word");
                setDropped(prev => ({ ...prev, [index]: word }));
            };
            const removeDrop = (index) => {
                const newDropped = { ...dropped };
                delete newDropped[index];
                setDropped(newDropped);
            };
            const checkAnswers = () => {
                const isAllCorrect = tokens.filter(t => t.isHidden).every(t => dropped[t.id] === t.text);
                setResult(isAllCorrect ? 'correct' : 'wrong');
                if (isAllCorrect) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            };

            const handleExit = () => { window.location.href = 'index.html'; };

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400 bg-slate-50"><Loader2 className="animate-spin mr-2"/> Cargando lectura...</div>;
            if (!data) return <div className="h-screen flex items-center justify-center text-red-400">Lectura no encontrada</div>;

            const wordBank = tokens.filter(t => t.isHidden).map(t => t.text).sort(() => Math.random() - 0.5); 
            const availableWords = wordBank.filter(word => {
                const totalInText = tokens.filter(t => t.text === word && t.isHidden).length;
                const totalPlaced = Object.values(dropped).filter(w => w === word).length;
                return totalPlaced < totalInText;
            });

            const isChatMode = data.genre === 'interview' || data.genre === 'dialogue';
            let chatSegments = [];
            if (isChatMode) {
                let currentSegment = [];
                tokens.forEach(t => {
                    if (t.text.includes('\n')) {
                        if (currentSegment.length > 0) chatSegments.push(currentSegment);
                        currentSegment = [];
                    } else { currentSegment.push(t); }
                });
                if (currentSegment.length > 0) chatSegments.push(currentSegment);
            }

            return (
                <div className={`min-h-screen font-sans flex flex-col transition-colors duration-300 ${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'}`}>
                    
                    {/* Header */}
                    <div className={`px-6 py-4 flex items-center justify-between shrink-0 sticky top-0 z-30 shadow-sm transition-colors ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 border-b'}`}>
                        <div className="flex items-center gap-4">
                            <button onClick={handleExit} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-slate-700 text-slate-400' : 'hover:bg-slate-100 text-slate-500'}`}><ArrowLeft size={20}/></button>
                            <div>
                                <h1 className={`text-xl font-black leading-none ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>{data.title}</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${isDarkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-100 text-indigo-700'}`}>{data.genre}</span>
                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${isDarkMode ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-500'}`}>{data.level}</span>
                                </div>
                            </div>
                        </div>
                        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-xl border ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                            <button onClick={() => setFontSize(s => Math.max(16, s - 2))} className={`p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-white hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`} title="Disminuir letra"><ZoomOut size={18}/></button>
                            <span className={`text-xs font-bold w-10 text-center ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{fontSize}px</span>
                            <button onClick={() => setFontSize(s => Math.min(40, s + 2))} className={`p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-white hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`} title="Aumentar letra"><ZoomIn size={18}/></button>
                            <div className={`w-px h-4 mx-1 ${isDarkMode ? 'bg-slate-700' : 'bg-slate-300'}`}></div>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-yellow-400 hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`}>{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                    </div>

                    {/* Main Layout - Split Screen */}
                    <div className="max-w-7xl mx-auto w-full p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1">
                        
                        {/* COLUMNA IZQUIERDA: TEXTO */}
                        <div className="lg:col-span-8 space-y-8">
                            <div className={`rounded-3xl shadow-sm border p-8 md:p-12 leading-loose transition-colors ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-200' : 'bg-white border-slate-200 text-slate-700'} font-medium`} style={{ fontSize: `${fontSize}px` }}>
                                {isChatMode ? (
                                    <div className="space-y-6">
                                        {chatSegments.map((segment, segIdx) => (
                                            <div key={segIdx} className={`flex ${segIdx % 2 === 0 ? 'justify-start' : 'justify-end'}`}>
                                                <div className={`max-w-[85%] p-4 rounded-2xl ${segIdx % 2 === 0 ? (isDarkMode ? 'bg-slate-700 rounded-tl-none' : 'bg-slate-100 rounded-tl-none') : (isDarkMode ? 'bg-indigo-900 text-indigo-100 rounded-tr-none' : 'bg-indigo-50 text-indigo-900 rounded-tr-none')}`}>
                                                    {segment.map((t, i) => {
                                                        if (t.isHidden) {
                                                            const val = dropped[t.id];
                                                            let className = isDarkMode ? 'token-hidden-dark' : 'token-hidden-light';
                                                            if (val) className = 'token-filled'; 
                                                            if (result === 'correct') className = 'token-correct';
                                                            if (result === 'wrong' && val) className = val === t.text ? 'token-correct' : 'token-wrong';
                                                            return <span key={t.id} onDragOver={handleDragOver} onDrop={(e) => !result && handleDrop(e, t.id)} onClick={() => !result && removeDrop(t.id)} className={`token-base cursor-pointer ${className}`}>{val || ""}</span>;
                                                        }
                                                        return <span key={t.id}>{t.text}</span>;
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-justify">
                                        {tokens.map((t, i) => {
                                            if (t.isHidden) {
                                                const val = dropped[t.id];
                                                let className = isDarkMode ? 'token-hidden-dark' : 'token-hidden-light';
                                                if (val) className = 'token-filled'; 
                                                if (result === 'correct') className = 'token-correct';
                                                if (result === 'wrong' && val) className = val === t.text ? 'token-correct' : 'token-wrong';
                                                return <span key={i} onDragOver={handleDragOver} onDrop={(e) => !result && handleDrop(e, t.id)} onClick={() => !result && removeDrop(t.id)} className={`token-base cursor-pointer ${className}`}>{val || ""}</span>;
                                            }
                                            if (t.text.match(/\n/)) return <br key={i}/>;
                                            return <span key={i}>{t.text}</span>;
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* FUN FACT BOX */}
                            {data.content.fun_fact && (
                                <div className={`border-l-8 rounded-r-2xl p-6 shadow-sm flex gap-5 items-start ${isDarkMode ? 'bg-amber-900/30 border-amber-600' : 'bg-amber-50 border-amber-400'}`} style={{ fontSize: `${fontSize * 0.9}px` }}>
                                    <div className={`p-3 rounded-full shadow-sm shrink-0 ${isDarkMode ? 'bg-slate-800 text-amber-400' : 'bg-white text-amber-500'}`}>
                                        <Lightbulb size={28} strokeWidth={2.5}/>
                                    </div>
                                    <div>
                                        <h3 className={`font-black text-sm uppercase tracking-widest mb-2 ${isDarkMode ? 'text-amber-400' : 'text-amber-800'}`}>Did You Know?</h3>
                                        <p className={`font-medium leading-relaxed ${isDarkMode ? 'text-amber-100' : 'text-amber-900'}`}>{data.content.fun_fact}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* COLUMNA DERECHA: BANCO + IMAGEN (STICKY) */}
                        <div className="lg:col-span-4 relative">
                            <div className="sticky top-24 space-y-6">
                                
                                {/* WORD BANK */}
                                <div className={`rounded-2xl shadow-xl border overflow-hidden ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                    <div className="bg-slate-900 p-4 flex items-center justify-between text-white">
                                        <div className="flex items-center gap-2 font-bold uppercase text-xs tracking-widest"><Puzzle size={16} className="text-emerald-400"/> Word Bank</div>
                                        <span className="bg-slate-800 px-2 py-1 rounded text-[10px] font-bold text-slate-300">{availableWords.length} left</span>
                                    </div>
                                    <div className={`p-6 min-h-[150px] ${isDarkMode ? 'bg-slate-800/50' : 'bg-slate-50'}`}>
                                        {availableWords.length === 0 && !result ? (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400 py-8"><CheckCircle2 size={32} className="mb-2 opacity-50"/><p className="text-sm font-bold">Â¡Todo listo!</p><p className="text-xs">Revisa y comprueba</p></div>
                                        ) : (
                                            <div className="flex flex-wrap gap-2">
                                                {availableWords.map((w, i) => (
                                                    <div key={i} draggable={!result} onDragStart={(e) => handleDragStart(e, w)} className={`border border-b-4 px-3 py-2 rounded-lg font-bold shadow-sm cursor-grab active:cursor-grabbing transition-all text-sm ${isDarkMode ? 'bg-slate-700 border-slate-600 border-b-slate-900 text-slate-200 hover:bg-indigo-900' : 'bg-white border-slate-300 border-b-slate-300 text-slate-700 hover:bg-indigo-50'}`}>{w}</div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className={`p-4 border-t ${isDarkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                                        {result === 'correct' ? (
                                            <button onClick={() => window.location.reload()} className="w-full bg-green-500 text-white py-3 rounded-xl font-black shadow-lg hover:bg-green-600 hover:-translate-y-1 transition-all flex items-center justify-center gap-2 animate-bounce"><RotateCcw size={20}/> Â¡Jugar de Nuevo!</button>
                                        ) : (
                                            <button onClick={checkAnswers} disabled={availableWords.length > 0} className="w-full bg-slate-900 text-white py-3 rounded-xl font-black shadow-lg hover:bg-indigo-600 hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:bg-slate-900">Comprobar</button>
                                        )}
                                    </div>
                                </div>

                                {/* IMAGE CARD (Mover aquÃ­) */}
                                {data.content.image_url && (
                                    <div className={`rounded-2xl overflow-hidden shadow-md border-4 ${isDarkMode ? 'border-slate-700' : 'border-white'}`}>
                                        <img src={data.content.image_url} alt="Topic" className="w-full h-auto object-cover"/>
                                    </div>
                                )}

                                <div className={`rounded-xl p-4 border text-xs font-medium leading-relaxed ${isDarkMode ? 'bg-indigo-900/30 border-indigo-800 text-indigo-300' : 'bg-blue-50 border-blue-100 text-blue-800'}`}>
                                    ðŸ’¡ <strong>Tip:</strong> Lee el contexto de la oraciÃ³n antes de arrastrar la palabra. Si te equivocas, haz clic en la palabra en el texto para devolverla al banco.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingActivity />);
    </script>
</body>
</html>
