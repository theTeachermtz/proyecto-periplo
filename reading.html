<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Activity | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' };</script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/scroll-behaviour.min.js"></script>
    <script>
        window.onload = function() {
            MobileDragDrop.polyfill({ 
                holdToDrag: 300,
                // Activa el plugin de auto-scroll nativo del polyfill
                dragImageTranslateOverride: mobileDragDrop.scrollBehaviourDragImageTranslateOverride
            }); 
            // Para asegurar fluidez en iOS
            window.addEventListener('touchmove', function() {}, {passive: false});
        };
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800;900&display=swap'); 
        html, body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background-color 0.3s; overflow-x: hidden; }
        
        .token-base {
            display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;
            padding: 0 0.5em; min-width: 3em; height: 1.8em; transition: all 0.2s ease;
        }

        .token-start { border-top-left-radius: 0.3em; border-bottom-left-radius: 0.3em; margin-left: 0.2em; border-left-width: 2px !important; }
        .token-end { border-top-right-radius: 0.3em; border-bottom-right-radius: 0.3em; margin-right: 0.2em; border-right-width: 2px !important; }
        .token-middle { border-left-width: 0px !important; border-right-width: 0px !important; margin: 0; border-radius: 0; }
        .token-single { border-radius: 0.3em; margin: 0 0.2em; border-left-width: 2px !important; border-right-width: 2px !important; }

        .token-hidden-light { background-color: #f1f5f9; border: 2px dashed #94a3b8; border-bottom-width: 4px; }
        .token-hidden-dark { background-color: #334155; border: 2px dashed #64748b; border-bottom-width: 4px; }
        .token-filled { background-color: #e0e7ff; border: 2px solid #6366f1; color: #3730a3; font-weight: 800; border-bottom-width: 4px; }
        .token-correct { background-color: #dcfce7; border: 2px solid #22c55e; color: #14532d; border-bottom-width: 4px; }
        .token-wrong { background-color: #fee2e2; border: 2px solid #ef4444; color: #7f1d1d; border-bottom-width: 4px; }

        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
        .timer-bar { animation: shrink linear forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { Loader2, CheckCircle2, RotateCcw, ArrowLeft, Lightbulb, Puzzle, Moon, Sun, ZoomIn, ZoomOut, Timer, Swords, ArrowRight, PlayCircle } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ReadingActivity = () => {
            const [loading, setLoading] = useState(true);
            const [activityData, setActivityData] = useState(null);
            const [stories, setStories] = useState([]);
            const [curIdx, setCurIdx] = useState(-1); 

            const [tokens, setTokens] = useState([]);
            const [dropped, setDropped] = useState({});
            const [result, setResult] = useState(null);
            
            const [isDarkMode, setIsDarkMode] = useState(true);
            
            // FONT SIZE ADAPTATIVO: Si es celular, arranca en 16px. Si es compu, en 20px.
            const [fontSize, setFontSize] = useState(window.innerWidth < 768 ? 16 : 20);

            const [qaMode, setQaMode] = useState(false);
            const [currentQIdx, setCurrentQIdx] = useState(0);
            const [timeLeft, setTimeLeft] = useState(12);
            const [showParagraphHelp, setShowParagraphHelp] = useState(false);
            const [qaFinished, setQaFinished] = useState(false);
            const [score, setScore] = useState(0);
            const timerRef = useRef(null);

            useEffect(() => {
                const savedTheme = localStorage.getItem('themePreference');
                if (savedTheme === 'light') setIsDarkMode(false);

                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const id = params.get('id');
                    if (!id) return;
                    
                    const snap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', id));
                    if (snap.exists()) {
                        const savedData = snap.data();
                        setActivityData(savedData);
                        
                        let loadedStories = [];
                        if (savedData.stories) {
                            loadedStories = savedData.stories;
                        } else if (savedData.content) {
                            loadedStories = [{
                                title: savedData.title,
                                text: savedData.content.text,
                                fun_fact: savedData.content.fun_fact,
                                image_url: savedData.content.image_url,
                                blanks: savedData.content.blanks,
                                questions: savedData.content.questions
                            }];
                        }

                        const processed = loadedStories.map(s => {
                            const regex = /([a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+|[^a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+|\s+)/g;
                            const parts = s.text.match(regex) || [];
                            return {
                                ...s,
                                tokens: parts.map((part, index) => ({
                                    id: index, text: part, isWord: /^[a-zA-Z0-9'Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘]+$/.test(part), isHidden: s.blanks.includes(index)
                                }))
                            };
                        });

                        setStories(processed);
                        if (processed.length === 1) startStory(0, processed[0]);
                    }
                    setLoading(false);
                };
                init();
            }, []);

            // ALGORITMO DE AUTO-SCROLL SEGURO DURANTE EL DRAG
            useEffect(() => {
                let scrollInterval = null;
                const handleDragOverEdge = (e) => {
                    const threshold = 100; // Si el dedo estÃ¡ a 100px del borde
                    const speed = 15; // Velocidad de scroll
                    
                    // Detectar toque o mouse
                    const clientY = e.clientY || (e.touches && e.touches.length > 0 ? e.touches[0].clientY : 0);
                    if (!clientY) return;

                    if (clientY < threshold) {
                        // Scroll Arriba
                        if (!scrollInterval) scrollInterval = setInterval(() => window.scrollBy(0, -speed), 20);
                    } else if (window.innerHeight - clientY < threshold) {
                        // Scroll Abajo
                        if (!scrollInterval) scrollInterval = setInterval(() => window.scrollBy(0, speed), 20);
                    } else {
                        // Detener scroll si estÃ¡ al centro
                        if (scrollInterval) { clearInterval(scrollInterval); scrollInterval = null; }
                    }
                };

                const handleDragEndEdge = () => {
                    if (scrollInterval) { clearInterval(scrollInterval); scrollInterval = null; }
                };

                window.addEventListener('dragover', handleDragOverEdge);
                window.addEventListener('touchmove', handleDragOverEdge, { passive: true });
                window.addEventListener('dragend', handleDragEndEdge);
                window.addEventListener('drop', handleDragEndEdge);
                window.addEventListener('touchend', handleDragEndEdge);
                
                return () => {
                    window.removeEventListener('dragover', handleDragOverEdge);
                    window.removeEventListener('touchmove', handleDragOverEdge);
                    window.removeEventListener('dragend', handleDragEndEdge);
                    window.removeEventListener('drop', handleDragEndEdge);
                    window.removeEventListener('touchend', handleDragEndEdge);
                    if (scrollInterval) clearInterval(scrollInterval);
                };
            }, []);

            const toggleTheme = () => { setIsDarkMode(!isDarkMode); localStorage.setItem('themePreference', !isDarkMode ? 'dark' : 'light'); };

            const startStory = (index, storyObj = null) => {
                const s = storyObj || stories[index];
                setCurIdx(index);
                setTokens(s.tokens);
                setDropped({});
                setResult(null);
                setQaMode(false);
                setQaFinished(false);
                setCurrentQIdx(0);
                setScore(0);
            };

            const backToMenu = () => {
                if (stories.length === 1) window.location.href = 'index.html'; 
                else setCurIdx(-1);
            };

            const handleExit = () => { window.location.href = 'index.html'; };

            const handleDragStart = (e, word) => { e.dataTransfer.setData("text/plain", word); };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, index) => {
                e.preventDefault();
                const word = e.dataTransfer.getData("text/plain");
                if(!word) return;
                setDropped(prev => ({ ...prev, [index]: word }));
            };
            const removeDrop = (index) => { const newDropped = { ...dropped }; delete newDropped[index]; setDropped(newDropped); };
            
            const checkAnswers = () => {
                const isAllCorrect = tokens.filter(t => t.isHidden).every(t => dropped[t.id] === t.text);
                setResult(isAllCorrect ? 'correct' : 'wrong');
                if (isAllCorrect) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            };

            const currentStory = stories[curIdx];

            const startChallenge = () => {
                if (!currentStory.questions || currentStory.questions.length === 0) { alert("Esta lectura no tiene preguntas."); return; }
                setQaMode(true);
                startTimer();
            };

            const startTimer = () => {
                setTimeLeft(12);
                setShowParagraphHelp(false);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { clearInterval(timerRef.current); setShowParagraphHelp(true); return 0; }
                        return prev - 1;
                    });
                }, 1000);
            };

            const handleSentenceClick = (sentence) => {
                const q = currentStory.questions[currentQIdx];
                const cleanAnswer = q.a.toLowerCase().replace(/[^a-z0-9]/g, '');
                const cleanSentence = sentence.toLowerCase().replace(/[^a-z0-9]/g, '');

                if (cleanSentence.includes(cleanAnswer) || cleanAnswer.includes(cleanSentence.substring(0, 10))) {
                    confetti({ particleCount: 50, spread: 30, origin: { y: 0.8 } });
                    setScore(s => s + 1);
                    nextQuestion();
                } else {
                    const el = document.getElementById('qa-box');
                    el.classList.add('bg-red-100', 'animate-shake');
                    setTimeout(() => el.classList.remove('bg-red-100', 'animate-shake'), 500);
                }
            };

            const nextQuestion = () => {
                if (currentQIdx < currentStory.questions.length - 1) {
                    setCurrentQIdx(idx => idx + 1);
                    startTimer();
                } else {
                    setQaFinished(true);
                    if (timerRef.current) clearInterval(timerRef.current);
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.5 } });
                }
            };

            const getTargetParagraphSentences = () => {
                if (!currentStory || !currentStory.questions) return [];
                const q = currentStory.questions[currentQIdx];
                const pIndex = q.paragraph_index || 0;
                const paragraphs = currentStory.text.split(/\n\n+/);
                const targetP = paragraphs[pIndex] || paragraphs[0]; 
                return targetP.split(/(?<=\.)\s+/).filter(s => s.trim().length > 0);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-slate-400 bg-slate-50 dark:bg-zinc-950"><Loader2 className="animate-spin mr-2"/> Cargando...</div>;
            if (!activityData) return <div className="h-screen flex items-center justify-center text-red-400 dark:bg-zinc-950">Lectura no encontrada</div>;

            if (curIdx === -1) {
                return (
                    <div className={`min-h-screen font-sans p-6 transition-colors duration-300 ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-800'}`}>
                        <div className="max-w-5xl mx-auto">
                            <div className="flex justify-between items-center mb-12">
                                <button onClick={handleExit} className={`p-3 rounded-full transition-colors ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700 text-slate-300' : 'bg-white shadow-sm hover:bg-slate-100 text-slate-600'}`}><ArrowLeft size={24}/></button>
                                <button onClick={toggleTheme} className={`p-3 rounded-full transition-colors ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700 text-yellow-400' : 'bg-white shadow-sm hover:bg-slate-100 text-slate-600'}`}>{isDarkMode ? <Sun size={24}/> : <Moon size={24}/>}</button>
                            </div>
                            
                            <div className="text-center mb-16">
                                <h1 className="text-5xl font-black mb-4">{activityData.title}</h1>
                                <p className="text-xl font-medium opacity-60 uppercase tracking-widest">{stories.length} Historias Disponibles</p>
                            </div>

                            <div className="grid md:grid-cols-3 gap-6">
                                {stories.map((s, i) => (
                                    <div key={i} onClick={() => startStory(i)} className={`p-8 rounded-[2rem] shadow-xl border cursor-pointer hover:-translate-y-2 hover:shadow-2xl transition-all group ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:border-indigo-500' : 'bg-white border-slate-200 hover:border-indigo-400'}`}>
                                        <div className="w-16 h-16 bg-indigo-500 text-white rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><PlayCircle size={32}/></div>
                                        <h3 className="text-2xl font-black mb-2 line-clamp-3">{s.title || `Historia ${i+1}`}</h3>
                                        <p className="text-sm font-bold opacity-50 uppercase tracking-widest mt-6">Comenzar</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            const wordBank = tokens.filter(t => t.isHidden).map(t => t.text).sort(() => Math.random() - 0.5); 
            const availableWords = wordBank.filter(word => {
                const totalInText = tokens.filter(t => t.text === word && t.isHidden).length;
                const totalPlaced = Object.values(dropped).filter(w => w === word).length;
                return totalPlaced < totalInText;
            });

            return (
                <div className={`min-h-screen font-sans flex flex-col transition-colors duration-300 ${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'}`}>
                    
                    {/* Header */}
                    <div className={`px-4 md:px-6 py-4 flex items-center justify-between shrink-0 sticky top-0 z-30 shadow-sm transition-colors ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200 border-b'}`}>
                        <div className="flex items-center gap-3 md:gap-4">
                            <button onClick={backToMenu} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-slate-700 text-slate-400' : 'hover:bg-slate-100 text-slate-500'}`}><ArrowLeft size={20}/></button>
                            <div>
                                <h1 className={`text-lg md:text-xl font-black leading-tight line-clamp-1 ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>{currentStory.title || activityData.title}</h1>
                                <div className="hidden md:flex items-center gap-2 mt-1">
                                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${isDarkMode ? 'bg-indigo-900 text-indigo-300' : 'bg-indigo-100 text-indigo-700'}`}>{activityData.genre}</span>
                                </div>
                            </div>
                        </div>
                        <div className={`flex items-center gap-1 md:gap-2 px-2 py-1.5 md:px-3 rounded-xl border shrink-0 ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                            <button onClick={() => setFontSize(s => Math.max(14, s - 2))} className={`p-1 md:p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-white hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`}><ZoomOut size={18}/></button>
                            <span className={`text-xs font-bold w-6 md:w-10 text-center ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{fontSize}</span>
                            <button onClick={() => setFontSize(s => Math.min(40, s + 2))} className={`p-1 md:p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-white hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`}><ZoomIn size={18}/></button>
                            <div className={`hidden md:block w-px h-4 mx-1 ${isDarkMode ? 'bg-slate-700' : 'bg-slate-300'}`}></div>
                            <button onClick={toggleTheme} className={`hidden md:block p-1.5 rounded hover:bg-opacity-20 ${isDarkMode ? 'text-yellow-400 hover:bg-white' : 'text-slate-600 hover:bg-slate-300'}`}>{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                        </div>
                    </div>

                    {qaMode && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center p-6 animate-in zoom-in-95 duration-300">
                            {qaFinished ? (
                                <div className="bg-white dark:bg-slate-800 rounded-[3rem] p-12 text-center max-w-lg w-full shadow-2xl">
                                    <div className="w-24 h-24 bg-emerald-100 dark:bg-emerald-900/50 text-emerald-500 dark:text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle2 size={48} strokeWidth={3}/></div>
                                    <h2 className="text-4xl font-black text-slate-800 dark:text-white mb-2">Â¡Completado!</h2>
                                    <p className="text-lg text-slate-500 dark:text-slate-400 font-bold mb-8">PuntuaciÃ³n: {score} / {currentStory.questions.length}</p>
                                    <button onClick={backToMenu} className="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-2xl font-black text-lg hover:-translate-y-1 transition-transform">{stories.length > 1 ? 'Volver al MenÃº' : 'Salir'}</button>
                                </div>
                            ) : (
                                <div id="qa-box" className="bg-white dark:bg-slate-800 w-full max-w-3xl rounded-[2rem] overflow-hidden shadow-2xl transition-colors duration-200">
                                    <div className="bg-slate-900 text-white p-6 relative">
                                        <div className="flex justify-between items-center relative z-10">
                                            <span className="font-black tracking-widest text-slate-400 text-xs uppercase flex items-center gap-2"><Swords size={16}/> Pregunta {currentQIdx + 1} de {currentStory.questions.length}</span>
                                            <div className={`font-black text-2xl flex items-center gap-2 ${timeLeft <= 3 ? 'text-red-400 animate-pulse' : 'text-emerald-400'}`}><Timer size={24}/> {timeLeft}s</div>
                                        </div>
                                        <div className="absolute bottom-0 left-0 h-1.5 bg-emerald-500 timer-bar" style={{ animationDuration: '12s', animationPlayState: timeLeft === 0 ? 'paused' : 'running' }}></div>
                                    </div>
                                    <div className="p-6 md:p-12 text-center">
                                        <h3 className={`text-xl md:text-3xl font-black mb-8 ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>"{currentStory.questions[currentQIdx].q}"</h3>
                                        {showParagraphHelp ? (
                                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 text-left">
                                                <div className="bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-400 text-xs font-black uppercase tracking-widest p-3 rounded-t-xl text-center border-b border-amber-200 dark:border-amber-900/50">Â¡Tiempo agotado! Encuentra la respuesta aquÃ­:</div>
                                                <div className={`p-4 md:p-8 rounded-b-xl border border-t-0 leading-relaxed text-base md:text-lg font-medium shadow-inner ${isDarkMode ? 'bg-slate-900 border-slate-700 text-slate-300' : 'bg-slate-50 border-amber-100 text-slate-700'}`}>
                                                    {getTargetParagraphSentences().map((sentence, i) => (
                                                        <span key={i} onClick={() => handleSentenceClick(sentence)} className="inline hover:bg-amber-200 dark:hover:bg-indigo-900 cursor-pointer transition-colors rounded px-1 py-0.5 mx-0.5 border border-transparent hover:border-amber-300 dark:hover:border-indigo-700">{sentence}. </span>
                                                    ))}
                                                </div>
                                                <p className="text-center text-xs text-slate-400 mt-4 uppercase font-bold tracking-widest">Haz clic en la oraciÃ³n correcta</p>
                                            </div>
                                        ) : (
                                            <div className="h-32 md:h-48 flex items-center justify-center flex-col text-slate-400">
                                                <Lightbulb size={40} className="mb-4 opacity-30"/>
                                                <p className="font-bold">Piensa rÃ¡pido...</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* REDISEÃ‘O ADAPTATIVO: FOTO -> PALABRAS -> LECTURA (En Celular) */}
                    <div className={`max-w-7xl mx-auto w-full p-4 md:p-6 flex flex-col lg:grid lg:grid-cols-12 gap-6 md:gap-8 flex-1 ${qaMode ? 'hidden' : ''}`}>
                        
                        {/* COLUMNA LECTURA (En compu a la Izquierda, en cel hasta Abajo) */}
                        <div className="order-3 lg:order-1 lg:col-span-8 space-y-6 md:space-y-8">
                            <div className={`rounded-3xl shadow-sm border p-6 md:p-12 leading-loose transition-colors ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-200' : 'bg-white border-slate-200 text-slate-700'} font-medium text-justify`} style={{ fontSize: `${fontSize}px` }}>
                                {tokens.map((t, i) => {
                                    if (t.isHidden) {
                                        const val = dropped[t.id];
                                        let stateClass = isDarkMode ? 'token-hidden-dark' : 'token-hidden-light';
                                        if (val) stateClass = 'token-filled'; 
                                        if (result === 'correct') stateClass = 'token-correct';
                                        if (result === 'wrong' && val) stateClass = val === t.text ? 'token-correct' : 'token-wrong';
                                        
                                        const prevIsHidden = i > 0 && tokens[i-1].isHidden && tokens[i-1].isWord;
                                        const nextIsHidden = i < tokens.length - 1 && tokens[i+1].isHidden && tokens[i+1].isWord;
                                        
                                        let shapeClass = "token-single";
                                        if (prevIsHidden && nextIsHidden) shapeClass = "token-middle";
                                        else if (prevIsHidden && !nextIsHidden) shapeClass = "token-end";
                                        else if (!prevIsHidden && nextIsHidden) shapeClass = "token-start";

                                        return <span key={i} onDragOver={handleDragOver} onDrop={(e) => !result && handleDrop(e, t.id)} onClick={() => !result && removeDrop(t.id)} className={`token-base cursor-pointer ${stateClass} ${shapeClass}`}>{val || ""}</span>;
                                    }
                                    if (t.text.match(/\n/)) return <br key={i}/>;
                                    return <span key={i}>{t.text}</span>;
                                })}
                            </div>

                            {currentStory.fun_fact && (
                                <div className={`border-l-8 rounded-r-2xl p-4 md:p-6 shadow-sm flex gap-4 md:gap-5 items-start ${isDarkMode ? 'bg-amber-900/30 border-amber-600' : 'bg-amber-50 border-amber-400'}`} style={{ fontSize: `${fontSize * 0.8}px` }}>
                                    <div className={`p-2 md:p-3 rounded-full shadow-sm shrink-0 ${isDarkMode ? 'bg-slate-800 text-amber-400' : 'bg-white text-amber-500'}`}><Lightbulb size={24} strokeWidth={2.5}/></div>
                                    <div><h3 className={`font-black text-xs md:text-sm uppercase tracking-widest mb-1 md:mb-2 ${isDarkMode ? 'text-amber-400' : 'text-amber-800'}`}>Did You Know?</h3><p className={`font-medium leading-relaxed ${isDarkMode ? 'text-amber-100' : 'text-amber-900'}`}>{currentStory.fun_fact}</p></div>
                                </div>
                            )}
                        </div>

                        {/* COLUMNA HERRAMIENTAS (En compu a la Derecha, en cel Arriba) */}
                        <div className="order-1 lg:order-2 lg:col-span-4 relative flex flex-col lg:block gap-6">
                            <div className="sticky top-24 flex flex-col gap-6">
                                
                                {/* IMAGEN (En celular va primero, en desktop va abajo del Word Bank) */}
                                {currentStory.image_url && (
                                    <div className={`order-1 lg:order-2 rounded-2xl overflow-hidden shadow-md border-4 ${isDarkMode ? 'border-slate-700' : 'border-white'}`}>
                                        <img src={currentStory.image_url} alt="Topic" className="w-full max-h-64 object-cover"/>
                                    </div>
                                )}

                                {/* WORD BANK */}
                                <div className={`order-2 lg:order-1 rounded-2xl shadow-xl border overflow-hidden flex flex-col ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`}>
                                    <div className="bg-slate-900 p-3 md:p-4 flex items-center justify-between text-white shrink-0">
                                        <div className="flex items-center gap-2 font-bold uppercase text-[10px] md:text-xs tracking-widest"><Puzzle size={16} className="text-emerald-400"/> Word Bank</div>
                                        <span className="bg-slate-800 px-2 py-1 rounded text-[10px] font-bold text-slate-300">{availableWords.length} left</span>
                                    </div>
                                    
                                    <div className={`p-4 md:p-6 min-h-[120px] md:min-h-[150px] flex-1 ${isDarkMode ? 'bg-slate-800/50' : 'bg-slate-50'}`} style={{ fontSize: `${Math.max(14, fontSize * 0.8)}px` }}>
                                        {availableWords.length === 0 && !result ? (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400 py-4 md:py-8"><CheckCircle2 size={32} className="mb-2 opacity-50"/><p className="text-sm font-bold">Â¡Todo listo!</p></div>
                                        ) : (
                                            <div className="flex flex-wrap gap-2">
                                                {availableWords.map((w, i) => (
                                                    <div key={i} draggable={!result} onDragStart={(e) => handleDragStart(e, w)} className={`border border-b-4 px-3 py-1.5 md:py-2 rounded-lg font-bold shadow-sm cursor-grab active:cursor-grabbing transition-all ${isDarkMode ? 'bg-slate-700 border-slate-600 border-b-slate-900 text-slate-200 hover:bg-indigo-900' : 'bg-white border-slate-300 border-b-slate-300 text-slate-700 hover:bg-indigo-50'}`}>{w}</div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className={`p-4 border-t space-y-3 shrink-0 ${isDarkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                                        {result === 'correct' ? (
                                            <>
                                                <button onClick={() => startStory(curIdx)} className="w-full bg-green-500 text-white py-3 rounded-xl font-black shadow-lg hover:bg-green-600 hover:-translate-y-1 transition-transform flex items-center justify-center gap-2 text-sm md:text-base"><RotateCcw size={20}/> Jugar de Nuevo</button>
                                                {currentStory.questions && currentStory.questions.length > 0 && (
                                                    <button onClick={startChallenge} className="w-full bg-indigo-600 text-white py-3 md:py-4 rounded-xl font-black shadow-xl shadow-indigo-500/40 hover:bg-indigo-700 hover:-translate-y-1 transition-transform flex items-center justify-center gap-2 animate-in fade-in zoom-in duration-500 text-sm md:text-base"><Swords size={20}/> CHALLENGE Q&A <ArrowRight size={18}/></button>
                                                )}
                                            </>
                                        ) : (
                                            <button onClick={checkAnswers} disabled={availableWords.length > 0} className="w-full bg-slate-900 text-white py-3 rounded-xl font-black shadow-lg hover:bg-indigo-600 hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:bg-slate-900 text-sm md:text-base">Comprobar</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingActivity />);
    </script>
</body>
</html>
