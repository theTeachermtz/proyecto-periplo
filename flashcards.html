<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; } .perspective-1000 { perspective: 1000px; } .rotate-y-180 { transform: rotateY(180deg); } .transform-style-3d { transform-style: preserve-3d; } .backface-hidden { backface-visibility: hidden; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { Play, RotateCcw, Check, X, ArrowLeft, ArrowRight, Pause, Volume2, LogOut, Shuffle, Loader2 } from 'lucide-react';

        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const Game = () => {
            const [gameState, setGameState] = useState('LOADING');
            const [gameData, setGameData] = useState(null);
            const [cards, setCards] = useState([]);
            const [current, setCurrent] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [isShuffled, setIsShuffled] = useState(false);
            const [originalCards, setOriginalCards] = useState([]);

            useEffect(() => {
                const init = async () => {
                    const id = new URLSearchParams(window.location.search).get('id');
                    if (!id) return alert("Sin ID");
                    const snap = await getDoc(doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', id));
                    if (snap.exists()) {
                        const d = snap.data();
                        const c = d.questions.map(q => ({...q, status:'pending'}));
                        setGameData(d);
                        setCards(c);
                        setOriginalCards(c);
                        setGameState('WELCOME');
                    }
                };
                init();
            }, []);

            const handleExit = () => {
                // SALIDA SEGURA: Va al index con la carpeta correcta
                const folder = gameData?.parentPath || '';
                window.location.href = `index.html?folder=${encodeURIComponent(folder)}`;
            };

            const speak = (txt, lang) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                u.lang = lang==='en'?'en-US':'es-MX';
                window.speechSynthesis.speak(u);
            }

            const playAudio = () => {
                if(isFlipped && gameData) speak(cards[current].back, gameData.config.audio.right);
            }
            useEffect(playAudio, [isFlipped]);

            if (gameState === 'LOADING') return <div className="h-screen flex items-center justify-center text-indigo-600"><Loader2 className="animate-spin" size={48}/></div>;

            return (
                <div className="h-screen flex items-center justify-center p-4 bg-slate-100">
                    <div className="w-full max-w-4xl h-[650px] bg-white rounded-3xl shadow-2xl flex flex-col border border-slate-200 overflow-hidden relative">
                        {/* Header */}
                        <div className="h-16 border-b flex items-center justify-between px-6 bg-slate-50">
                            <button onClick={()=>setIsPaused(true)}><Pause className="text-slate-400 hover:text-indigo-600"/></button>
                            <span className="font-bold text-slate-500 text-sm">{current + 1} / {cards.length}</span>
                            <button onClick={handleExit} className="flex gap-2 items-center text-xs font-bold text-slate-400 hover:text-rose-500 uppercase">Salir <LogOut size={16}/></button>
                        </div>

                        {/* Game Area */}
                        <div className="flex-1 bg-slate-50 flex flex-col relative">
                            {gameState === 'WELCOME' && (
                                <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/90 backdrop-blur">
                                    <h1 className="text-4xl font-black mb-4">{gameData.title}</h1>
                                    <button onClick={()=>setGameState('PLAYING')} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:scale-105 transition-all">JUGAR</button>
                                </div>
                            )}

                            {gameState === 'PLAYING' && (
                                <div className="flex-1 flex flex-col items-center justify-center p-6">
                                    <div className="w-full max-w-md aspect-[4/3] perspective-1000 cursor-pointer group" onClick={()=>setIsFlipped(!isFlipped)}>
                                        <div className={`relative w-full h-full transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                                            {/* Front */}
                                            <div className="absolute inset-0 w-full h-full bg-white rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 backface-hidden border-b-8 border-slate-200">
                                                {cards[current].image && <img src={cards[current].image} className="h-32 mb-4 object-cover rounded-lg" style={{transform: `scale(${cards[current].crop?.zoom||1}) translate(${cards[current].crop?.x-50||0}%, ${cards[current].crop?.y-50||0}%)`}}/>}
                                                <h2 className="text-4xl font-black text-slate-800">{cards[current].front}</h2>
                                                <button onClick={(e)=>{e.stopPropagation(); speak(cards[current].front, gameData.config.audio.left)}} className="mt-4 p-2 bg-indigo-50 rounded-full text-indigo-500"><Volume2/></button>
                                            </div>
                                            {/* Back */}
                                            <div className="absolute inset-0 w-full h-full bg-white rounded-3xl shadow-xl flex flex-col items-center justify-center p-6 rotate-y-180 backface-hidden border-b-8 border-indigo-200">
                                                <h2 className="text-4xl font-black text-indigo-600 mb-8">{cards[current].back}</h2>
                                                <div className="flex gap-2 w-full" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={()=>{setIsFlipped(false); setCurrent(c=>(c+1)%cards.length)}} className="flex-1 bg-emerald-50 text-emerald-600 py-3 rounded-xl font-bold">Siguiente</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Controls */}
                                    <div className="flex gap-8 mt-8">
                                        <button onClick={()=>setCurrent(c=>Math.max(0,c-1))} disabled={current===0} className="p-3 bg-white rounded-full shadow disabled:opacity-50"><ArrowLeft/></button>
                                        <button onClick={()=>setCurrent(c=>Math.min(cards.length-1,c+1))} disabled={current===cards.length-1} className="p-3 bg-white rounded-full shadow disabled:opacity-50"><ArrowRight/></button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Pause Modal */}
                        {isPaused && (
                            <div className="absolute inset-0 bg-slate-900/50 backdrop-blur z-50 flex items-center justify-center">
                                <div className="bg-white p-8 rounded-3xl w-64 flex flex-col gap-3">
                                    <h3 className="font-bold text-center mb-2">PAUSA</h3>
                                    <button onClick={()=>setIsPaused(false)} className="bg-indigo-600 text-white py-3 rounded-xl font-bold">Continuar</button>
                                    <button onClick={handleExit} className="text-rose-500 font-bold py-2">Salir</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>
</body>
</html>
