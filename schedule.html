<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda tu Clase | Periplo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, query } from 'firebase/firestore';
        import { Calendar, ChevronLeft, Video, Lock, UserPlus, ArrowLeft } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DAYS = ['LUN', 'MAR', 'MIER', 'JUE', 'VIE', 'SAB'];
        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];

        const formatTimeDisplay = (time24) => {
            const [hour] = time24.split(':');
            const h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'pm' : 'am';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`;
        };

        const MY_NAME_KEY = 'periplo_student_name';

        const StudentSchedule = () => {
            const [events, setEvents] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [studentName, setStudentName] = useState(localStorage.getItem(MY_NAME_KEY) || '');

            useEffect(() => {
                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            const handleSlotClick = (day, time) => {
                const existing = events.find(e => e.day === day && e.time === time);
                
                // Si existe y NO es mío -> Bloqueado
                if (existing) {
                    if (existing.title === studentName) { // Usamos el Título como nombre del estudiante para simplificar la lógica de "Es mio"
                        alert("¡Esta es tu clase!");
                    }
                    return; 
                }
                setSelectedSlot({ day, time });
                setModalOpen(true);
            };

            const bookClass = async () => {
                if (!studentName.trim()) return alert("Dime tu nombre para apartar");
                localStorage.setItem(MY_NAME_KEY, studentName);

                try {
                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'), {
                        day: selectedSlot.day,
                        time: selectedSlot.time,
                        title: studentName, // El título será el nombre del alumno
                        type: 'class',
                        notes: 'Reservado por alumno',
                        customColor: 'bg-emerald-200 border-emerald-300 text-emerald-900', // Verde automático para reservas de alumnos
                        meetLink: '' // El profe lo pondrá después
                    });
                    setModalOpen(false);
                    alert("¡Apartado! Espera a que el profe ponga el link.");
                } catch (e) { alert("Error: " + e.message); }
            };

            return (
                <div className="min-h-screen bg-stone-50 font-sans text-stone-800 flex flex-col h-screen overflow-hidden">
                    <div className="bg-white p-4 border-b border-stone-200 flex justify-between items-center shrink-0 shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <button onClick={() => window.location.href='index.html'} className="p-2 hover:bg-stone-100 rounded-lg text-stone-500"><ArrowLeft/></button>
                            <h1 className="text-xl font-black text-stone-800 tracking-tight flex gap-2 items-center"><Calendar className="text-teal-500"/> Agenda tu Clase</h1>
                        </div>
                        {studentName && <div className="text-xs font-bold bg-teal-50 text-teal-700 px-3 py-1 rounded-full">Hola, {studentName}</div>}
                    </div>

                    <div className="flex-1 overflow-auto p-4">
                        <div className="min-w-[900px] bg-white rounded-2xl shadow-xl border border-stone-200 overflow-hidden">
                            <div className="grid grid-cols-[100px_repeat(6,_1fr)] border-b-2 border-stone-200 bg-stone-100 sticky top-0 z-30 shadow-sm">
                                <div className="p-4 text-center text-xs font-black text-stone-300 uppercase tracking-wider flex items-center justify-center border-r border-stone-200 bg-stone-200">HORA</div>
                                {DAYS.map(day => (<div key={day} className="p-4 text-center text-lg font-black text-stone-800 border-r border-stone-200 last:border-r-0 tracking-tight">{day}</div>))}
                            </div>

                            <div className="divide-y divide-stone-100">
                                {TIMES.map(time => (
                                    <div key={time} className="grid grid-cols-[100px_repeat(6,_1fr)] min-h-[80px]">
                                        <div className="p-3 text-xs font-black text-stone-400 flex flex-col items-center justify-center border-r border-stone-200 bg-stone-50"><span>{formatTimeDisplay(time)}</span></div>
                                        {DAYS.map(day => {
                                            const event = events.find(e => e.day === day && e.time === time);
                                            // LOGICA DE PRIVACIDAD: ¿Es mío?
                                            // Asumimos que si el 'title' coincide con mi nombre guardado, es mío.
                                            const isMine = event && event.title === studentName;
                                            
                                            return (
                                                <div key={`${day}-${time}`} onClick={() => handleSlotClick(day, time)} className="relative p-1 border-r border-stone-100 last:border-r-0 transition-all duration-200 group">
                                                    {event ? (
                                                        isMine ? (
                                                            <div className="h-full w-full rounded-xl p-2 border-2 shadow-sm flex flex-col justify-between bg-emerald-100 border-emerald-300 text-emerald-900">
                                                                <div className="font-black text-xs uppercase">TU CLASE</div>
                                                                {event.meetLink ? (
                                                                    <a href={event.meetLink} target="_blank" className="bg-white/50 hover:bg-white text-emerald-700 font-bold text-[10px] py-1 px-2 rounded flex items-center gap-1"><Video size={12}/> UNIRSE</a>
                                                                ) : <span className="text-[10px] opacity-60">Sin link aún</span>}
                                                            </div>
                                                        ) : (
                                                            <div className="h-full w-full bg-stone-100 border-stone-200 border rounded-xl flex items-center justify-center cursor-not-allowed">
                                                                <div className="flex items-center gap-1 text-stone-400 font-bold text-xs uppercase"><Lock size={12}/> Ocupado</div>
                                                            </div>
                                                        )
                                                    ) : (
                                                        <div className="h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                                            <div className="flex items-center gap-1 text-teal-400 font-bold text-xs"><UserPlus size={16}/> Apartar</div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {modalOpen && (
                        <div className="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6">
                                <h3 className="text-xl font-black text-stone-800 mb-2">Reservar Clase</h3>
                                <p className="text-stone-500 text-sm mb-6">Para el {selectedSlot.day} a las {formatTimeDisplay(selectedSlot.time)}</p>
                                <label className="block text-xs font-bold text-stone-400 uppercase mb-2">Tu Nombre Completo</label>
                                <input value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl mb-6 font-bold text-stone-800 focus:border-teal-500 outline-none" placeholder="Ej. Juan Pérez" autoFocus/>
                                <div className="flex gap-2">
                                    <button onClick={() => setModalOpen(false)} className="flex-1 py-3 text-stone-400 font-bold hover:bg-stone-50 rounded-xl transition-colors">Cancelar</button>
                                    <button onClick={bookClass} className="flex-1 py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-lg transition-colors">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<StudentSchedule />);
    </script>
</body>
</html>