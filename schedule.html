<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Agenda | Periplo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' };</script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .pulse-yellow { animation: pulse-yellow 2s infinite; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        /* STICKY COLUMN MAGIC */
        .sticky-col { position: sticky; left: 0; z-index: 20; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, serverTimestamp } from 'firebase/firestore';
        import { format, startOfWeek, addDays, isSameDay, addWeeks, isBefore, isAfter, parseISO } from 'date-fns';
        import { es } from 'date-fns/locale';
        import { Calendar as CalendarIcon, ChevronLeft, ChevronRight, Video, Lock, UserPlus, ArrowLeft, Sun, Moon, CheckCircle2, X, Clock, ArrowRightLeft } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];
        const formatTimeDisplay = (time24) => { const h = parseInt(time24.split(':')[0], 10); return `${h % 12 || 12}:00 ${h >= 12 ? 'pm' : 'am'}`; };
        
        const normalizeName = (name) => name ? name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

        const StudentSchedule = () => {
            const [events, setEvents] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            const [bookingModal, setBookingModal] = useState(null); 
            const [actionModal, setActionModal] = useState(null); 
            const [rescheduleMode, setRescheduleMode] = useState(null); 
            
            const [studentName, setStudentName] = useState('');
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const urlName = params.get('student');
                if (urlName) setStudentName(decodeURIComponent(urlName));
                else {
                    const savedName = localStorage.getItem('periplo_student_name');
                    if (savedName) setStudentName(savedName);
                }

                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            // NAVEGACIÃ“N DE FECHAS (Regla: MÃ¡ximo 2 semanas adelante)
            const weekStart = startOfWeek(currentDate, { weekStartsOn: 1 });
            const weekDays = Array.from({ length: 6 }).map((_, i) => addDays(weekStart, i)); // Lunes a SÃ¡bado
            
            const handlePrevWeek = () => {
                const prev = addWeeks(currentDate, -1);
                if (!isBefore(prev, startOfWeek(new Date(), { weekStartsOn: 1 }))) setCurrentDate(prev);
            };
            const handleNextWeek = () => {
                const next = addWeeks(currentDate, 1);
                if (!isAfter(next, addWeeks(new Date(), 2))) setCurrentDate(next);
            };

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            // LOGICA NOTIFICACIONES AL PROFE
            const notifyTeacher = async (message) => {
                await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'notifications'), {
                    message, createdAt: serverTimestamp(), read: false
                });
            };

            // CHECK LÃMITES
            const canBookMore = (targetDateStr) => {
                const normName = normalizeName(studentName);
                const myEvents = events.filter(e => e.student && normalizeName(e.student) === normName);
                
                // 1. Ya tiene clase ese dÃ­a?
                const hasClassToday = myEvents.some(e => e.date === targetDateStr || (!e.date && e.day === format(parseISO(targetDateStr), 'EEE', {locale:es}).toUpperCase().replace('.','')));
                if (hasClassToday) {
                    alert("âš ï¸ Ya tienes una clase agendada para este dÃ­a. MÃ¡ximo 1 por dÃ­a.");
                    return false;
                }

                // 2. Ya tiene 3 clases en la semana de la fecha target?
                const targetWeekStart = startOfWeek(parseISO(targetDateStr), { weekStartsOn: 1 });
                let countThisWeek = 0;
                myEvents.forEach(e => {
                    if (e.date) {
                        const evWeekStart = startOfWeek(parseISO(e.date), { weekStartsOn: 1 });
                        if (isSameDay(evWeekStart, targetWeekStart)) countThisWeek++;
                    } else {
                        countThisWeek++; // Legados asumen todas las semanas
                    }
                });

                if (countThisWeek >= 3) {
                    alert("âš ï¸ Has alcanzado el lÃ­mite de 3 clases esta semana.");
                    return false;
                }

                return true;
            };

            const getEventForSlot = (dateStr, dayName, time) => {
                return events.find(e => (e.date === dateStr && e.time === time) || (!e.date && e.day === dayName && e.time === time));
            };

            const handleSlotClick = (dateStr, dayName, time) => {
                const existing = getEventForSlot(dateStr, dayName, time);

                if (rescheduleMode) {
                    if (existing) return; 
                    if (confirm(`Â¿Mover clase al ${dayName} ${dateStr} a las ${formatTimeDisplay(time)}?`)) {
                        performReschedule(dateStr, dayName, time);
                    }
                    return;
                }

                if (existing) {
                    const isMine = existing.student && normalizeName(existing.student) === normalizeName(studentName);
                    if (isMine) {
                        if (existing.meetLink) window.open(existing.meetLink, '_blank');
                        else setActionModal(existing);
                    }
                    return;
                }

                if (!studentName) {
                    setBookingModal({ dateStr, dayName, time });
                } else {
                    if (canBookMore(dateStr)) {
                        if(confirm(`Â¿Reservar NUEVA clase el ${dateStr} a las ${formatTimeDisplay(time)}?`)) {
                            bookClass(dateStr, dayName, time, studentName);
                        }
                    }
                }
            };

            const bookClass = async (dateStr, dayName, time, name) => {
                localStorage.setItem('periplo_student_name', name);
                setStudentName(name);
                try {
                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'), {
                        date: dateStr, day: dayName, time,
                        title: "Clase de " + name.split(' ')[0], student: name,
                        type: 'class', notes: 'Agendado por alumno',
                        customColor: 'bg-emerald-200 border-emerald-300 text-emerald-900', meetLink: '' 
                    });
                    notifyTeacher(`ðŸ“— ${name} agendÃ³ una clase el ${dateStr} a las ${time}`);
                    setBookingModal(null);
                } catch (e) { alert("Error: " + e.message); }
            };

            const cancelClass = async () => {
                if (!actionModal) return;
                if (confirm("Â¿Seguro que quieres CANCELAR esta clase? El espacio quedarÃ¡ libre.")) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', actionModal.id));
                        notifyTeacher(`ðŸš¨ ${studentName} CANCELÃ“ su clase del ${actionModal.date || actionModal.day} a las ${actionModal.time}`);
                        setActionModal(null);
                    } catch (e) { alert("Error: " + e.message); }
                }
            };

            const initReschedule = () => { setRescheduleMode(actionModal); setActionModal(null); };

            const performReschedule = async (newDate, newDayName, newTime) => {
                if (!rescheduleMode) return;
                try {
                    await updateDoc(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', rescheduleMode.id), {
                        date: newDate, day: newDayName, time: newTime
                    });
                    notifyTeacher(`ðŸ”„ ${studentName} MOVIÃ“ su clase al ${newDate} a las ${newTime}`);
                    setRescheduleMode(null);
                } catch (e) { alert("Error: " + e.message); }
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-stone-50 dark:bg-zinc-950 text-stone-800 dark:text-stone-100 font-sans flex flex-col h-screen overflow-hidden transition-colors duration-300">
                        
                        {/* HEADER */}
                        {rescheduleMode ? (
                            <div className="bg-amber-500 text-white p-4 shadow-md z-50 flex justify-between items-center animate-in slide-in-from-top">
                                <div className="flex items-center gap-3"><ArrowRightLeft className="animate-pulse"/><div><p className="font-black text-sm uppercase">Modo ReprogramaciÃ³n</p><p className="text-xs">Selecciona un espacio vacÃ­o (amarillo).</p></div></div>
                                <button onClick={() => setRescheduleMode(null)} className="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold">Cancelar</button>
                            </div>
                        ) : (
                            <div className="bg-white dark:bg-zinc-900 p-4 border-b border-stone-200 dark:border-zinc-800 flex justify-between items-center shrink-0 shadow-sm z-10">
                                <div className="flex items-center gap-3">
                                    <div className="bg-teal-500 p-2 rounded-lg text-white shadow-md"><CalendarIcon size={20}/></div>
                                    <div><h1 className="text-lg font-black text-stone-800 dark:text-white leading-none">TU AGENDA</h1>{studentName ? <p className="text-xs font-bold text-teal-600 dark:text-teal-400 mt-1">Hola, {studentName} ðŸ‘‹</p> : <p className="text-xs text-stone-400 dark:text-zinc-500 mt-1">Modo Invitado</p>}</div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2 bg-stone-100 dark:bg-zinc-800 px-3 py-1.5 rounded-xl border border-stone-200 dark:border-zinc-700">
                                        <button onClick={handlePrevWeek} disabled={isBefore(addWeeks(currentDate, -1), startOfWeek(new Date(), {weekStartsOn:1}))} className="p-1 hover:bg-white dark:hover:bg-zinc-700 rounded disabled:opacity-30"><ChevronLeft size={16}/></button>
                                        <span className="font-bold text-xs min-w-[100px] text-center capitalize">{format(weekStart, 'MMM d')} - {format(addDays(weekStart, 5), 'MMM d')}</span>
                                        <button onClick={handleNextWeek} disabled={isAfter(addWeeks(currentDate, 1), addWeeks(new Date(), 2))} className="p-1 hover:bg-white dark:hover:bg-zinc-700 rounded disabled:opacity-30"><ChevronRight size={16}/></button>
                                    </div>
                                    <button onClick={toggleTheme} className="p-2 rounded-full bg-stone-100 dark:bg-zinc-800 text-stone-600 dark:text-amber-400 hover:bg-stone-200 dark:hover:bg-zinc-700"><Sun size={18} className={isDarkMode ? 'block' : 'hidden'}/><Moon size={18} className={!isDarkMode ? 'block' : 'hidden'}/></button>
                                </div>
                            </div>
                        )}

                        {/* GRID */}
                        <div className="flex-1 overflow-auto p-4 custom-scrollbar relative">
                            <div className="min-w-[800px] bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-stone-200 dark:border-zinc-800">
                                <div className="grid grid-cols-[80px_repeat(6,_1fr)] border-b-2 border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950 sticky top-0 z-30 shadow-sm">
                                    <div className="sticky-corner p-4 text-center text-xs font-black text-stone-400 dark:text-zinc-500 uppercase flex items-center justify-center border-r border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950">HORA</div>
                                    {weekDays.map(day => {
                                        const isToday = isSameDay(day, new Date());
                                        return (
                                            <div key={day.toString()} className={`p-3 text-center border-r border-stone-200 dark:border-zinc-800 last:border-r-0 ${isToday ? 'bg-teal-50 dark:bg-teal-900/20 border-b-4 border-b-teal-500' : ''}`}>
                                                <div className={`text-[10px] font-bold uppercase ${isToday ? 'text-teal-600 dark:text-teal-400' : 'text-stone-400 dark:text-zinc-500'}`}>{format(day, 'EEE', { locale: es })}</div>
                                                <div className={`text-lg font-black tracking-tight ${isToday ? 'text-teal-700 dark:text-teal-300' : 'text-stone-800 dark:text-zinc-300'}`}>{format(day, 'd')}</div>
                                            </div>
                                        )
                                    })}
                                </div>

                                <div className="divide-y divide-stone-100 dark:divide-zinc-800">
                                    {TIMES.map(time => (
                                        <div key={time} className="grid grid-cols-[80px_repeat(6,_1fr)] min-h-[90px]">
                                            <div className="sticky-col p-2 text-xs font-black text-stone-400 dark:text-zinc-500 flex flex-col items-center justify-center border-r border-stone-200 dark:border-zinc-800 bg-stone-50 dark:bg-zinc-950/90 backdrop-blur-sm shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]"><span>{formatTimeDisplay(time)}</span></div>
                                            {weekDays.map(day => {
                                                const dateStr = format(day, 'yyyy-MM-dd');
                                                const dayName = format(day, 'EEE', {locale: es}).toUpperCase().replace('.',''); // ej: "LUN"
                                                const event = getEventForSlot(dateStr, dayName, time);
                                                const isMine = event && studentName && normalizeName(event.student) === normalizeName(studentName);
                                                const isToday = isSameDay(day, new Date());
                                                
                                                let cellClass = `relative p-1 border-r border-stone-100 dark:border-zinc-800 last:border-r-0 transition-all duration-200 group ${isToday ? 'bg-teal-50/30 dark:bg-teal-900/5' : ''}`;
                                                let cellContent = null;

                                                if (rescheduleMode) {
                                                    if (event) cellClass += " bg-stone-100 dark:bg-zinc-950 opacity-30 cursor-not-allowed";
                                                    else {
                                                        cellClass += " cursor-pointer bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 border-amber-200";
                                                        cellContent = <div className="h-full w-full rounded-xl border-2 border-dashed border-amber-300 flex items-center justify-center animate-pulse"><span className="text-amber-600 font-bold text-xs uppercase flex items-center gap-1"><ArrowRightLeft size={14}/> Mover AquÃ­</span></div>;
                                                    }
                                                } else {
                                                    if (event) {
                                                        if (isMine) {
                                                            cellClass += " cursor-pointer";
                                                            cellContent = (
                                                                <div className="h-full w-full rounded-xl p-2 border-2 shadow-md flex flex-col justify-between bg-emerald-100 border-emerald-300 dark:bg-emerald-900/40 dark:border-emerald-500 hover:scale-[1.02]">
                                                                    <div><div className="text-[10px] font-black text-emerald-800 dark:text-emerald-300 uppercase mb-1 flex items-center gap-1"><CheckCircle2 size={10}/> TU CLASE</div><div className="text-sm font-bold text-emerald-900 dark:text-emerald-100 leading-tight">{event.title}</div></div>
                                                                    {event.meetLink ? <div className="bg-white/80 text-emerald-700 font-bold text-[10px] py-1.5 px-2 rounded-lg flex items-center justify-center gap-1 mt-1"><Video size={12}/> ENTRAR</div> : <span className="text-[10px] text-emerald-800 dark:text-emerald-400 flex items-center gap-1"><Clock size={10}/> Modificar</span>}
                                                                </div>
                                                            );
                                                        } else {
                                                            cellClass += " cursor-not-allowed";
                                                            cellContent = <div className="h-full w-full bg-stone-100 dark:bg-zinc-800/50 border border-stone-200 dark:border-zinc-700 rounded-xl flex items-center justify-center opacity-70"><div className="flex items-center gap-1 text-stone-400 dark:text-zinc-600 font-bold text-xs uppercase"><Lock size={12}/> Ocupado</div></div>;
                                                        }
                                                    } else {
                                                        cellClass += " cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20";
                                                        cellContent = <div className="h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><div className="flex flex-col items-center gap-1 text-teal-500 dark:text-teal-400"><UserPlus size={20}/><span className="text-[10px] font-bold uppercase">Apartar</span></div></div>;
                                                    }
                                                }

                                                return <div key={`${dateStr}-${time}`} onClick={() => handleSlotClick(dateStr, dayName, time)} className={cellClass}>{cellContent}</div>;
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* MODALS REUTILIZADOS ABAJO */}
                        {actionModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden border border-stone-200 dark:border-zinc-700">
                                    <div className="p-6">
                                        <h3 className="text-xl font-black text-stone-800 dark:text-white mb-1">Gestionar Clase</h3>
                                        <p className="text-stone-500 dark:text-zinc-400 text-sm mb-6 font-medium">{actionModal.date || actionModal.day} â€¢ {formatTimeDisplay(actionModal.time)}</p>
                                        <div className="space-y-3">
                                            <button onClick={initReschedule} className="w-full py-4 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 rounded-xl font-bold border-2 border-amber-200 dark:border-amber-800 hover:bg-amber-200 transition-colors flex items-center justify-center gap-2"><ArrowRightLeft size={18}/> Posponer / Mover</button>
                                            <button onClick={cancelClass} className="w-full py-4 bg-white dark:bg-zinc-800 text-rose-500 rounded-xl font-bold border-2 border-rose-100 dark:border-rose-900 hover:bg-rose-50 transition-colors flex items-center justify-center gap-2"><X size={18}/> Cancelar Clase</button>
                                        </div>
                                    </div>
                                    <div className="bg-stone-50 dark:bg-zinc-950 p-4 border-t border-stone-200 dark:border-zinc-800 text-center"><button onClick={() => setActionModal(null)} className="text-sm font-bold text-stone-400 hover:text-stone-600">Volver</button></div>
                                </div>
                            </div>
                        )}

                        {bookingModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 border border-stone-200 dark:border-zinc-700">
                                    <h3 className="text-xl font-black text-stone-800 dark:text-white mb-2">Nueva Reserva</h3>
                                    <label className="block text-xs font-black text-stone-400 uppercase mb-2">Tu Nombre Completo</label>
                                    <input value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full px-4 py-3 bg-stone-50 dark:bg-zinc-800 border-2 border-stone-200 dark:border-zinc-700 rounded-xl mb-6 font-bold text-stone-900 dark:text-white focus:border-teal-500 outline-none" placeholder="Ej. Juan PÃ©rez" autoFocus/>
                                    <div className="flex gap-3"><button onClick={() => setBookingModal(null)} className="flex-1 py-3 text-stone-500 font-bold hover:bg-stone-100 dark:hover:bg-zinc-800 rounded-xl">Cancelar</button><button onClick={() => bookClass(bookingModal.dateStr, bookingModal.dayName, bookingModal.time, studentName)} className="flex-1 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold shadow-lg">Confirmar</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<StudentSchedule />);
    </script>
</body>
</html>
