<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Agenda | Periplo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ConfiguraciÃ³n de Tailwind para Modo Oscuro manual
        tailwind.config = { darkMode: 'class' };
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, query } from 'firebase/firestore';
        import { Calendar, ChevronLeft, Video, Lock, UserPlus, ArrowLeft, Sun, Moon, CheckCircle2 } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DAYS = ['LUN', 'MAR', 'MIER', 'JUE', 'VIE', 'SAB'];
        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];

        const formatTimeDisplay = (time24) => {
            const [hour] = time24.split(':');
            const h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'pm' : 'am';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`;
        };

        const StudentSchedule = () => {
            const [events, setEvents] = useState([]);
            const [modalOpen, setModalOpen] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);
            
            // ESTADO: Identidad del Alumno (Desde URL o LocalStorage)
            const [studentName, setStudentName] = useState('');
            const [isDarkMode, setIsDarkMode] = useState(true); // DEFAULT OSCURO

            useEffect(() => {
                // 1. Identificar al alumno por la URL
                const params = new URLSearchParams(window.location.search);
                const urlName = params.get('student');
                
                if (urlName) {
                    setStudentName(decodeURIComponent(urlName));
                } else {
                    // Fallback: LocalStorage si ya habÃ­a entrado antes
                    const savedName = localStorage.getItem('periplo_student_name');
                    if (savedName) setStudentName(savedName);
                }

                // 2. Cargar Eventos
                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const handleSlotClick = (day, time) => {
                const existing = events.find(e => e.day === day && e.time === time);
                
                // Si existe evento
                if (existing) {
                    // Comparar (Case insensitive y trim) para asegurar match
                    const isMine = existing.student && studentName && existing.student.trim().toLowerCase() === studentName.trim().toLowerCase();
                    
                    if (isMine) {
                        if (existing.meetLink) window.open(existing.meetLink, '_blank');
                        else alert("Tu clase estÃ¡ agendada. El profesor pondrÃ¡ el link pronto.");
                    } else {
                        // Es de otro o bloqueado
                        // No hacemos nada, es solo visual "Busy"
                    }
                    return; 
                }

                // Si estÃ¡ vacÃ­o, permitir reservar
                setSelectedSlot({ day, time });
                setModalOpen(true);
            };

            const bookClass = async () => {
                if (!studentName.trim()) return alert("Necesitamos tu nombre para apartar la clase.");
                
                // Guardar nombre para el futuro si no vino por URL
                localStorage.setItem('periplo_student_name', studentName);

                try {
                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'), {
                        day: selectedSlot.day,
                        time: selectedSlot.time,
                        title: "Clase de " + studentName.split(' ')[0], // TÃ­tulo genÃ©rico
                        student: studentName, // IMPORTANTE: Campo clave para el filtro
                        type: 'class',
                        notes: 'Reservado por alumno',
                        customColor: 'bg-teal-100 border-teal-300 text-teal-900', // Color default bonito
                        meetLink: '' 
                    });
                    setModalOpen(false);
                    alert("Â¡Apartado exitoso!");
                } catch (e) { alert("Error: " + e.message); }
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-stone-50 dark:bg-zinc-950 text-stone-800 dark:text-stone-100 font-sans flex flex-col h-screen overflow-hidden transition-colors duration-300">
                        
                        {/* HEADER */}
                        <div className="bg-white dark:bg-zinc-900 p-4 border-b border-stone-200 dark:border-zinc-800 flex justify-between items-center shrink-0 shadow-sm z-10">
                            <div className="flex items-center gap-3">
                                <div className="bg-teal-500 p-2 rounded-lg text-white shadow-md"><Calendar size={20}/></div>
                                <div>
                                    <h1 className="text-lg font-black text-stone-800 dark:text-white leading-none">TU AGENDA</h1>
                                    {studentName ? (
                                        <p className="text-xs font-bold text-teal-600 dark:text-teal-400 mt-1">Hola, {studentName} ðŸ‘‹</p>
                                    ) : (
                                        <p className="text-xs text-stone-400 dark:text-zinc-500 mt-1">Vista de Invitado</p>
                                    )}
                                </div>
                            </div>
                            <button onClick={toggleTheme} className="p-2 rounded-full bg-stone-100 dark:bg-zinc-800 text-stone-600 dark:text-amber-400 hover:bg-stone-200 dark:hover:bg-zinc-700 transition-all">
                                {isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}
                            </button>
                        </div>

                        {/* CALENDAR GRID */}
                        <div className="flex-1 overflow-auto p-4">
                            <div className="min-w-[800px] bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-stone-200 dark:border-zinc-800 overflow-hidden">
                                {/* Header DÃ­as */}
                                <div className="grid grid-cols-[80px_repeat(6,_1fr)] border-b-2 border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950 sticky top-0 z-30 shadow-sm">
                                    <div className="p-4 text-center text-xs font-black text-stone-300 dark:text-zinc-600 uppercase tracking-wider flex items-center justify-center border-r border-stone-200 dark:border-zinc-800">HORA</div>
                                    {DAYS.map(day => (<div key={day} className="p-4 text-center text-lg font-black text-stone-800 dark:text-zinc-300 border-r border-stone-200 dark:border-zinc-800 last:border-r-0 tracking-tight">{day}</div>))}
                                </div>

                                {/* Body Horas */}
                                <div className="divide-y divide-stone-100 dark:divide-zinc-800">
                                    {TIMES.map(time => (
                                        <div key={time} className="grid grid-cols-[80px_repeat(6,_1fr)] min-h-[90px]">
                                            <div className="p-2 text-xs font-black text-stone-400 dark:text-zinc-500 flex flex-col items-center justify-center border-r border-stone-200 dark:border-zinc-800 bg-stone-50 dark:bg-zinc-950"><span>{formatTimeDisplay(time)}</span></div>
                                            {DAYS.map(day => {
                                                const event = events.find(e => e.day === day && e.time === time);
                                                
                                                // LÃ“GICA MAESTRA DE PRIVACIDAD
                                                const isMine = event && studentName && event.student && event.student.trim().toLowerCase() === studentName.trim().toLowerCase();
                                                
                                                return (
                                                    <div key={`${day}-${time}`} onClick={() => handleSlotClick(day, time)} className={`relative p-1 border-r border-stone-100 dark:border-zinc-800 last:border-r-0 transition-all duration-200 group`}>
                                                        {event ? (
                                                            isMine ? (
                                                                // VISTA: ES MI CLASE (Verde + Link)
                                                                <div className="h-full w-full rounded-xl p-2 border-2 shadow-md flex flex-col justify-between bg-emerald-100 border-emerald-300 dark:bg-emerald-900/40 dark:border-emerald-500 cursor-pointer hover:scale-[1.02] transition-transform">
                                                                    <div>
                                                                        <div className="text-[10px] font-black text-emerald-800 dark:text-emerald-300 uppercase tracking-wider mb-1 flex items-center gap-1"><CheckCircle2 size={10}/> TU CLASE</div>
                                                                        <div className="text-sm font-bold text-emerald-900 dark:text-emerald-100 leading-tight">{event.title}</div>
                                                                    </div>
                                                                    {event.meetLink ? (
                                                                        <div className="bg-white/80 dark:bg-black/40 text-emerald-700 dark:text-emerald-300 font-bold text-[10px] py-1.5 px-2 rounded-lg flex items-center justify-center gap-1 mt-1 hover:bg-white dark:hover:bg-black transition-colors"><Video size={12}/> ENTRAR AHORA</div>
                                                                    ) : <span className="text-[10px] opacity-60 text-emerald-800 dark:text-emerald-400 text-center block">Link pendiente</span>}
                                                                </div>
                                                            ) : (
                                                                // VISTA: OCUPADO (Gris + Candado)
                                                                <div className="h-full w-full bg-stone-100 dark:bg-zinc-800/50 border border-stone-200 dark:border-zinc-700 rounded-xl flex flex-col items-center justify-center cursor-not-allowed opacity-70">
                                                                    <Lock size={16} className="text-stone-300 dark:text-zinc-600 mb-1"/>
                                                                    <span className="text-[10px] font-bold text-stone-400 dark:text-zinc-500 uppercase tracking-widest">Ocupado</span>
                                                                </div>
                                                            )
                                                        ) : (
                                                            // VISTA: DISPONIBLE (Hover para reservar)
                                                            <div className="h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                                                <div className="flex flex-col items-center gap-1 text-teal-500 dark:text-teal-400">
                                                                    <UserPlus size={20}/>
                                                                    <span className="text-[10px] font-bold uppercase">Apartar</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* MODAL RESERVA */}
                        {modalOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 border border-stone-200 dark:border-zinc-700">
                                    <h3 className="text-xl font-black text-stone-800 dark:text-white mb-1">Reservar Clase</h3>
                                    <p className="text-stone-500 dark:text-zinc-400 text-sm mb-6 font-medium">{selectedSlot.day} a las {formatTimeDisplay(selectedSlot.time)}</p>
                                    
                                    <label className="block text-xs font-black text-stone-400 dark:text-zinc-500 uppercase mb-2">Tu Nombre Completo</label>
                                    <input 
                                        value={studentName} 
                                        onChange={e => setStudentName(e.target.value)} 
                                        disabled={!!studentName && window.location.search.includes('student')} // Bloquear si viene por URL
                                        className="w-full px-4 py-3 bg-stone-50 dark:bg-zinc-800 border-2 border-stone-200 dark:border-zinc-700 rounded-xl mb-6 font-bold text-stone-900 dark:text-white focus:border-teal-500 outline-none transition-colors" 
                                        placeholder="Ej. Juan PÃ©rez"
                                        autoFocus
                                    />
                                    
                                    <div className="flex gap-3">
                                        <button onClick={() => setModalOpen(false)} className="flex-1 py-3 text-stone-500 dark:text-zinc-400 font-bold hover:bg-stone-100 dark:hover:bg-zinc-800 rounded-xl transition-colors">Cancelar</button>
                                        <button onClick={bookClass} className="flex-1 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-500/30 transition-all transform active:scale-95">Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<StudentSchedule />);
    </script>
</body>
</html>
