<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Agenda | Periplo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .pulse-yellow { animation: pulse-yellow 2s infinite; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query } from 'firebase/firestore';
        import { Calendar, ChevronLeft, Video, Lock, UserPlus, ArrowLeft, Sun, Moon, CheckCircle2, X, Clock, ArrowRightLeft, AlertCircle } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DAYS = ['LUN', 'MAR', 'MIER', 'JUE', 'VIE', 'SAB'];
        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];

        const formatTimeDisplay = (time24) => {
            const [hour] = time24.split(':');
            const h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'pm' : 'am';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`;
        };

        // Funci√≥n para normalizar nombres (ignorar may√∫sculas, espacios extra y acentos simples)
        const normalizeName = (name) => {
            if (!name) return "";
            return name.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        };

        const StudentSchedule = () => {
            const [events, setEvents] = useState([]);
            
            // MODALES Y ESTADOS
            const [bookingModal, setBookingModal] = useState(null); // { day, time } para reservar nuevo
            const [actionModal, setActionModal] = useState(null); // { event } para cancelar/posponer
            const [rescheduleMode, setRescheduleMode] = useState(null); // { event } cuando est√°s eligiendo nuevo horario
            
            const [studentName, setStudentName] = useState('');
            const [isDarkMode, setIsDarkMode] = useState(true);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const urlName = params.get('student');
                if (urlName) setStudentName(decodeURIComponent(urlName));
                else {
                    const savedName = localStorage.getItem('periplo_student_name');
                    if (savedName) setStudentName(savedName);
                }

                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, []);

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            // --- L√ìGICA DE CLICS EN CASILLAS ---
            const handleSlotClick = (day, time) => {
                const existing = events.find(e => e.day === day && e.time === time);

                // 1. MODO POSPONER (RESCHEDULE)
                if (rescheduleMode) {
                    if (existing) return; // No puedes mover a un lugar ocupado
                    if (confirm(`¬øMover clase al ${day} a las ${formatTimeDisplay(time)}?`)) {
                        performReschedule(day, time);
                    }
                    return;
                }

                // 2. CLIC EN EVENTO EXISTENTE
                if (existing) {
                    // Verificar si es MI clase
                    const isMine = existing.student && normalizeName(existing.student) === normalizeName(studentName);
                    
                    if (isMine) {
                        if (existing.meetLink) {
                            window.open(existing.meetLink, '_blank');
                        } else {
                            // Si no hay link, abrir men√∫ de gesti√≥n
                            setActionModal(existing);
                        }
                    } else {
                        // Es de otro (Busy) -> No hace nada
                    }
                    return;
                }

                // 3. CLIC EN ESPACIO VAC√çO (RESERVAR NUEVO)
                if (!studentName) {
                    // Si no tiene identidad, pedimos nombre
                    setBookingModal({ day, time });
                } else {
                    // Si ya tiene identidad, confirmamos directo
                    if(confirm(`¬øApartar clase para el ${day} a las ${formatTimeDisplay(time)}?`)) {
                        bookClass(day, time, studentName);
                    }
                }
            };

            // --- ACCIONES ---

            const bookClass = async (day, time, name) => {
                localStorage.setItem('periplo_student_name', name);
                setStudentName(name);
                try {
                    await addDoc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'), {
                        day, time,
                        title: "Clase de " + name.split(' ')[0],
                        student: name,
                        type: 'class',
                        notes: 'Reservado por alumno',
                        customColor: 'bg-emerald-200 border-emerald-300 text-emerald-900',
                        meetLink: '' 
                    });
                    setBookingModal(null);
                } catch (e) { alert("Error: " + e.message); }
            };

            const cancelClass = async () => {
                if (!actionModal) return;
                if (confirm("¬øSeguro que quieres cancelar esta clase? Se borrar√° de la agenda.")) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', actionModal.id));
                        setActionModal(null);
                        alert("Clase cancelada.");
                    } catch (e) { alert("Error: " + e.message); }
                }
            };

            const initReschedule = () => {
                setRescheduleMode(actionModal);
                setActionModal(null);
            };

            const performReschedule = async (newDay, newTime) => {
                if (!rescheduleMode) return;
                try {
                    await updateDoc(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', rescheduleMode.id), {
                        day: newDay,
                        time: newTime
                    });
                    setRescheduleMode(null);
                    alert("¬°Clase movida con √©xito!");
                } catch (e) { alert("Error: " + e.message); }
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-stone-50 dark:bg-zinc-950 text-stone-800 dark:text-stone-100 font-sans flex flex-col h-screen overflow-hidden transition-colors duration-300">
                        
                        {/* HEADER + BANNER POSPONER */}
                        {rescheduleMode ? (
                            <div className="bg-amber-500 text-white p-4 shadow-md z-50 flex justify-between items-center animate-in slide-in-from-top">
                                <div className="flex items-center gap-3">
                                    <ArrowRightLeft className="animate-pulse"/>
                                    <div>
                                        <p className="font-black text-sm uppercase">Modo Reprogramaci√≥n</p>
                                        <p className="text-xs">Selecciona un espacio vac√≠o (amarillo) para mover tu clase.</p>
                                    </div>
                                </div>
                                <button onClick={() => setRescheduleMode(null)} className="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-xs font-bold">Cancelar</button>
                            </div>
                        ) : (
                            <div className="bg-white dark:bg-zinc-900 p-4 border-b border-stone-200 dark:border-zinc-800 flex justify-between items-center shrink-0 shadow-sm z-10">
                                <div className="flex items-center gap-3">
                                    <div className="bg-teal-500 p-2 rounded-lg text-white shadow-md"><Calendar size={20}/></div>
                                    <div>
                                        <h1 className="text-lg font-black text-stone-800 dark:text-white leading-none">TU AGENDA</h1>
                                        {studentName ? (
                                            <p className="text-xs font-bold text-teal-600 dark:text-teal-400 mt-1">Hola, {studentName} üëã</p>
                                        ) : (
                                            <p className="text-xs text-stone-400 dark:text-zinc-500 mt-1">Vista de Invitado</p>
                                        )}
                                    </div>
                                </div>
                                <button onClick={toggleTheme} className="p-2 rounded-full bg-stone-100 dark:bg-zinc-800 text-stone-600 dark:text-amber-400 hover:bg-stone-200 dark:hover:bg-zinc-700 transition-all">
                                    {isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}
                                </button>
                            </div>
                        )}

                        {/* CALENDAR GRID */}
                        <div className="flex-1 overflow-auto p-4">
                            <div className="min-w-[800px] bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-stone-200 dark:border-zinc-800 overflow-hidden">
                                {/* Header D√≠as */}
                                <div className="grid grid-cols-[80px_repeat(6,_1fr)] border-b-2 border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950 sticky top-0 z-30 shadow-sm">
                                    <div className="p-4 text-center text-xs font-black text-stone-300 dark:text-zinc-600 uppercase tracking-wider flex items-center justify-center border-r border-stone-200 dark:border-zinc-800">HORA</div>
                                    {DAYS.map(day => (<div key={day} className="p-4 text-center text-lg font-black text-stone-800 dark:text-zinc-300 border-r border-stone-200 dark:border-zinc-800 last:border-r-0 tracking-tight">{day}</div>))}
                                </div>

                                {/* Body Horas */}
                                <div className="divide-y divide-stone-100 dark:divide-zinc-800">
                                    {TIMES.map(time => (
                                        <div key={time} className="grid grid-cols-[80px_repeat(6,_1fr)] min-h-[90px]">
                                            <div className="p-2 text-xs font-black text-stone-400 dark:text-zinc-500 flex flex-col items-center justify-center border-r border-stone-200 dark:border-zinc-800 bg-stone-50 dark:bg-zinc-950"><span>{formatTimeDisplay(time)}</span></div>
                                            {DAYS.map(day => {
                                                const event = events.find(e => e.day === day && e.time === time);
                                                const isMine = event && studentName && normalizeName(event.student) === normalizeName(studentName);
                                                
                                                // ESTILOS SEG√öN ESTADO
                                                let cellContent = null;
                                                let cellClass = "relative p-1 border-r border-stone-100 dark:border-zinc-800 last:border-r-0 transition-all duration-200 group";

                                                if (rescheduleMode) {
                                                    // MODO REPROGRAMACI√ìN
                                                    if (event) {
                                                        // Ocupado (No elegible)
                                                        cellClass += " bg-stone-100 dark:bg-zinc-950 opacity-30 cursor-not-allowed";
                                                    } else {
                                                        // Libre (Elegible)
                                                        cellClass += " cursor-pointer bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 dark:hover:bg-amber-900/30 border-amber-200 dark:border-amber-800";
                                                        cellContent = (
                                                            <div className="h-full w-full rounded-xl border-2 border-dashed border-amber-300 dark:border-amber-600 flex items-center justify-center animate-pulse">
                                                                <span className="text-amber-600 dark:text-amber-400 font-bold text-xs uppercase flex items-center gap-1"><ArrowRightLeft size={14}/> Mover Aqu√≠</span>
                                                            </div>
                                                        );
                                                    }
                                                } else {
                                                    // MODO NORMAL
                                                    if (event) {
                                                        if (isMine) {
                                                            cellClass += " cursor-pointer";
                                                            cellContent = (
                                                                <div className="h-full w-full rounded-xl p-2 border-2 shadow-md flex flex-col justify-between bg-emerald-100 border-emerald-300 dark:bg-emerald-900/40 dark:border-emerald-500 hover:scale-[1.02] transition-transform">
                                                                    <div>
                                                                        <div className="text-[10px] font-black text-emerald-800 dark:text-emerald-300 uppercase tracking-wider mb-1 flex items-center gap-1"><CheckCircle2 size={10}/> TU CLASE</div>
                                                                        <div className="text-sm font-bold text-emerald-900 dark:text-emerald-100 leading-tight">{event.title}</div>
                                                                    </div>
                                                                    {event.meetLink ? (
                                                                        <div className="bg-white/80 dark:bg-black/40 text-emerald-700 dark:text-emerald-300 font-bold text-[10px] py-1.5 px-2 rounded-lg flex items-center justify-center gap-1 mt-1"><Video size={12}/> ENTRAR</div>
                                                                    ) : <span className="text-[10px] opacity-60 text-emerald-800 dark:text-emerald-400 text-center block">Ver opciones...</span>}
                                                                </div>
                                                            );
                                                        } else {
                                                            cellClass += " cursor-not-allowed";
                                                            cellContent = (
                                                                <div className="h-full w-full bg-stone-100 dark:bg-zinc-800/50 border border-stone-200 dark:border-zinc-700 rounded-xl flex flex-col items-center justify-center opacity-70">
                                                                    <div className="flex items-center gap-1 text-stone-400 dark:text-zinc-600 font-bold text-xs uppercase"><Lock size={12}/> Ocupado</div>
                                                                </div>
                                                            );
                                                        }
                                                    } else {
                                                        // VAC√çO
                                                        cellClass += " cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20";
                                                        cellContent = (
                                                            <div className="h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <div className="flex flex-col items-center gap-1 text-teal-500 dark:text-teal-400">
                                                                    <UserPlus size={20}/>
                                                                    <span className="text-[10px] font-bold uppercase">Apartar</span>
                                                                </div>
                                                            </div>
                                                        );
                                                    }
                                                }

                                                return (
                                                    <div key={`${day}-${time}`} onClick={() => handleSlotClick(day, time)} className={cellClass}>
                                                        {cellContent}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* MODAL GESTI√ìN (CANCELAR / POSPONER) */}
                        {actionModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden border border-stone-200 dark:border-zinc-700">
                                    <div className="p-6">
                                        <h3 className="text-xl font-black text-stone-800 dark:text-white mb-1">Gestionar Clase</h3>
                                        <p className="text-stone-500 dark:text-zinc-400 text-sm mb-6">{actionModal.day} ‚Ä¢ {formatTimeDisplay(actionModal.time)}</p>
                                        
                                        <div className="space-y-3">
                                            <button onClick={initReschedule} className="w-full py-4 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-200 rounded-xl font-bold border-2 border-amber-200 dark:border-amber-800 hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors flex items-center justify-center gap-2">
                                                <Clock size={18}/> Posponer / Mover
                                            </button>
                                            <button onClick={cancelClass} className="w-full py-4 bg-white dark:bg-zinc-800 text-rose-500 rounded-xl font-bold border-2 border-rose-100 dark:border-rose-900 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors flex items-center justify-center gap-2">
                                                <X size={18}/> Cancelar Clase
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-stone-50 dark:bg-zinc-950 p-4 border-t border-stone-200 dark:border-zinc-800 text-center">
                                        <button onClick={() => setActionModal(null)} className="text-sm font-bold text-stone-400 hover:text-stone-600 dark:hover:text-zinc-300">Volver</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* MODAL RESERVA INICIAL (SI NO TIENE NOMBRE) */}
                        {bookingModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 border border-stone-200 dark:border-zinc-700">
                                    <h3 className="text-xl font-black text-stone-800 dark:text-white mb-2">Reservar Clase</h3>
                                    <label className="block text-xs font-black text-stone-400 dark:text-zinc-500 uppercase mb-2">Tu Nombre Completo</label>
                                    <input value={studentName} onChange={e => setStudentName(e.target.value)} className="w-full px-4 py-3 bg-stone-50 dark:bg-zinc-800 border-2 border-stone-200 dark:border-zinc-700 rounded-xl mb-6 font-bold text-stone-900 dark:text-white focus:border-teal-500 outline-none transition-colors" placeholder="Ej. Juan P√©rez" autoFocus/>
                                    <div className="flex gap-3">
                                        <button onClick={() => setBookingModal(null)} className="flex-1 py-3 text-stone-500 dark:text-zinc-400 font-bold hover:bg-stone-100 dark:hover:bg-zinc-800 rounded-xl transition-colors">Cancelar</button>
                                        <button onClick={() => bookClass(bookingModal.day, bookingModal.time, studentName)} className="flex-1 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-500/30 transition-all transform active:scale-95">Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<StudentSchedule />);
    </script>
</body>
</html>
