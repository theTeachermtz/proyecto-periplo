<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Schedule | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script>
        window.onload = function() {
            MobileDragDrop.polyfill({ holdToDrag: 300 }); 
            window.addEventListener('touchmove', function() {}, {passive: false});
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sticky-col { position: sticky; left: 0; z-index: 20; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; }
        .draggable-item { touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, writeBatch, orderBy, limit, getDocs } from 'firebase/firestore';
        import { format, startOfWeek, addDays, isSameDay, addWeeks, parseISO } from 'date-fns';
        import { es } from 'date-fns/locale';
        import { Plus, X, Trash2, Save, Calendar as CalendarIcon, Copy, Repeat, Palette, CheckCircle2, Moon, Sun, GripVertical, Check, ArrowLeft, ChevronLeft, ChevronRight, Link as LinkIcon, Video, User, Bell, Wrench } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // OFFSET HORARIO (Ontario = +1 en invierno)
        const MY_TIME_OFFSET = 1; 

        const DAYS = ['LUN', 'MAR', 'MIER', 'JUE', 'VIE', 'SAB'];
        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];
        
        const formatTimeDisplay = (time24, offset = 0) => { 
            let h = parseInt(time24.split(':')[0], 10) + offset;
            const ampm = (h >= 12 && h < 24) ? 'pm' : 'am';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`; 
        };

        const FRUIT_FLOWER_PALETTE = [ { id: 'lavanda', class: 'bg-violet-200 border-violet-300 text-violet-900 dark:bg-violet-900/50 dark:border-violet-500 dark:text-violet-100' }, { id: 'lirio', class: 'bg-stone-50 border-stone-200 text-stone-600 dark:bg-stone-800 dark:border-stone-500 dark:text-stone-200' }, { id: 'menta', class: 'bg-teal-200 border-teal-300 text-teal-900 dark:bg-teal-900/50 dark:border-teal-500 dark:text-teal-100' }, { id: 'durazno', class: 'bg-orange-200 border-orange-300 text-orange-900 dark:bg-orange-900/50 dark:border-orange-500 dark:text-orange-100' }, { id: 'cereza', class: 'bg-rose-300 border-rose-400 text-rose-900 dark:bg-rose-900/50 dark:border-rose-500 dark:text-rose-100' }, { id: 'arandano', class: 'bg-blue-300 border-blue-400 text-blue-900 dark:bg-blue-900/50 dark:border-blue-500 dark:text-blue-100' }, { id: 'kiwi', class: 'bg-lime-200 border-lime-300 text-lime-900 dark:bg-lime-900/50 dark:border-lime-500 dark:text-lime-100' }, { id: 'uva', class: 'bg-purple-300 border-purple-400 text-purple-900 dark:bg-purple-900/50 dark:border-purple-500 dark:text-purple-100' }, { id: 'fresa', class: 'bg-pink-200 border-pink-300 text-pink-900 dark:bg-pink-900/50 dark:border-pink-500 dark:text-pink-100' }, { id: 'mandarina', class: 'bg-amber-200 border-amber-300 text-amber-900 dark:bg-amber-900/50 dark:border-amber-500 dark:text-amber-100' }, { id: 'coco', class: 'bg-stone-200 border-stone-300 text-stone-800 dark:bg-stone-700 dark:border-stone-500 dark:text-stone-100' }, { id: 'ciruela', class: 'bg-fuchsia-200 border-fuchsia-300 text-fuchsia-900 dark:bg-fuchsia-900/50 dark:border-fuchsia-500 dark:text-fuchsia-100' }, { id: 'manzana', class: 'bg-emerald-200 border-emerald-300 text-emerald-900 dark:bg-emerald-900/50 dark:border-emerald-500 dark:text-emerald-100' }, { id: 'cielo', class: 'bg-sky-200 border-sky-300 text-sky-900 dark:bg-sky-900/50 dark:border-sky-500 dark:text-sky-100' }, { id: 'coral', class: 'bg-red-200 border-red-300 text-red-900 dark:bg-red-900/50 dark:border-red-500 dark:text-red-100' } ];
        const ACTIVITY_TYPES = [ { id: 'class', label: 'Clase', color: 'bg-teal-100 border-teal-300 text-teal-900 dark:bg-teal-900/60 dark:border-teal-500 dark:text-teal-100' }, { id: 'personal', label: 'Personal', color: 'bg-green-100 border-green-300 text-green-900 dark:bg-green-900/60 dark:border-green-500 dark:text-green-100' }, { id: 'project', label: 'Proyecto', color: 'bg-red-100 border-red-300 text-red-900 dark:bg-red-900/60 dark:border-red-500 dark:text-red-100' }, { id: 'other', label: 'Otro', color: 'bg-gray-200 border-gray-300 text-gray-900 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100' }, { id: 'lunch', label: 'Comida', color: 'bg-yellow-100 border-yellow-300 text-yellow-900 dark:bg-yellow-900/60 dark:border-yellow-500 dark:text-yellow-100' } ];

        export default function App() {
            const [events, setEvents] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [now, setNow] = useState(new Date()); 
            
            const [notifications, setNotifications] = useState([]);
            const [showNotifs, setShowNotifs] = useState(false);
            const hasUnread = notifications.some(n => !n.read);

            const [isDarkMode, setIsDarkMode] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentSlot, setCurrentSlot] = useState(null); 
            const [editingEvent, setEditingEvent] = useState(null);
            
            const [draggedEventId, setDraggedEventId] = useState(null);
            const [duplicationMode, setDuplicationMode] = useState({ active: false, sourceEvent: null, selectedSlots: [] });
            const [deleteConfirm, setDeleteConfirm] = useState({ open: false, event: null, deleteAll: false });
            
            const [formData, setFormData] = useState({ title: '', student: '', type: 'class', notes: '', meetLink: '', customColor: '', applyToAllWeek: false, applyColorToAll: false });
            const [isStudentManuallyEdited, setIsStudentManuallyEdited] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 60000);
                if ("Notification" in window && Notification.permission !== "denied" && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const qNotif = query(collection(db, 'artifacts', 'periplo-app-v1', 'notifications'), orderBy('createdAt', 'desc'), limit(5));
                const unsubNotif = onSnapshot(qNotif, (snapshot) => {
                    setNotifications(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' && change.doc.data().createdAt) {
                            const data = change.doc.data();
                            const isRecent = (Date.now() - data.createdAt.toMillis()) < 10000; 
                            if (isRecent && Notification.permission === "granted" && !data.read) {
                                new Notification("ActualizaciÃ³n Periplo", { body: data.message });
                            }
                        }
                    });
                });

                return () => { clearInterval(timer); unsubscribe(); unsubNotif(); };
            }, []);

            const weekStart = startOfWeek(currentDate, { weekStartsOn: 1 });
            const weekDays = Array.from({ length: 6 }).map((_, i) => addDays(weekStart, i));

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const copyStudentLink = () => {
                if (!formData.student.trim()) return alert("Escribe el nombre del alumno");
                const link = `${window.location.href.replace('dashboard-schedule.html', 'schedule.html')}?student=${encodeURIComponent(formData.student.trim())}`;
                navigator.clipboard.writeText(link);
                alert("Link copiado: " + link);
            };

            const handleTitleChange = (e) => {
                const val = e.target.value;
                setFormData(prev => (!isStudentManuallyEdited ? { ...prev, title: val, student: val } : { ...prev, title: val }));
            };
            const handleStudentChange = (e) => { setFormData(prev => ({ ...prev, student: e.target.value })); setIsStudentManuallyEdited(true); };

            const toggleNotifs = async () => {
                setShowNotifs(!showNotifs);
                if (!showNotifs && hasUnread) {
                    const batch = writeBatch(db);
                    notifications.filter(n => !n.read).forEach(n => {
                        batch.update(doc(db, 'artifacts', 'periplo-app-v1', 'notifications', n.id), { read: true });
                    });
                    await batch.commit();
                }
            };

            // CRUD & MODALS
            const getEventForSlot = (dateStr, dayName, time) => events.find(e => (e.date === dateStr && e.time === time) || (!e.date && e.day === dayName && e.time === time));

            const handleSlotClick = (dateStr, dayName, time) => {
                if (duplicationMode.active) {
                    if (!getEventForSlot(dateStr, dayName, time)) {
                        const s = [...duplicationMode.selectedSlots];
                        const idx = s.findIndex(x => x.dateStr === dateStr && x.time === time);
                        if(idx >= 0) s.splice(idx,1); else s.push({dateStr, dayName, time});
                        setDuplicationMode({...duplicationMode, selectedSlots: s});
                    }
                    return;
                }
                const existingEvent = getEventForSlot(dateStr, dayName, time);
                setCurrentSlot({ dateStr, dayName, time });
                setIsStudentManuallyEdited(false);
                if (existingEvent) setFormData({ title: existingEvent.title, student: existingEvent.student || '', type: existingEvent.type, notes: existingEvent.notes || '', meetLink: existingEvent.meetLink || '', customColor: existingEvent.customColor || '', applyToAllWeek: false, applyColorToAll: false });
                else setFormData({ title: '', student: '', type: 'class', notes: '', meetLink: '', customColor: '', applyToAllWeek: false, applyColorToAll: false });
                setEditingEvent(existingEvent || null);
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.title.trim()) return;
                const finalStudent = formData.student.trim() || formData.title.trim();
                const eventData = { title: formData.title.trim(), student: finalStudent, type: formData.type, notes: formData.notes, meetLink: formData.meetLink, customColor: formData.type === 'class' ? formData.customColor : '' };
                const batch = writeBatch(db);

                try {
                    if (editingEvent) {
                        batch.update(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', editingEvent.id), { ...eventData, date: currentSlot.dateStr });
                        if (formData.applyColorToAll && formData.type === 'class' && formData.customColor) {
                            events.filter(e => e.id !== editingEvent.id && e.type === 'class' && e.title.toLowerCase() === formData.title.toLowerCase()).forEach(e => batch.update(doc(db, 'artifacts/periplo-app-v1', 'schedule', e.id), { customColor: formData.customColor }));
                        }
                    } else {
                        if (formData.applyToAllWeek) {
                            weekDays.forEach(d => {
                                batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { date: format(d, 'yyyy-MM-dd'), day: format(d, 'EEE', {locale:es}).toUpperCase().replace('.',''), time: currentSlot.time, ...eventData });
                            });
                        } else {
                            batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { date: currentSlot.dateStr, day: currentSlot.dayName, time: currentSlot.time, ...eventData });
                        }
                    }
                    await batch.commit();
                } catch (e) { alert(e.message); }
                setIsModalOpen(false);
            };

            const confirmDelete = async () => {
                if (!deleteConfirm.event) return;
                try {
                    const batch = writeBatch(db);
                    if (deleteConfirm.deleteAll) {
                        events.filter(e => e.title.toLowerCase() === deleteConfirm.event.title.toLowerCase()).forEach(e => batch.delete(doc(db, 'artifacts/periplo-app-v1', 'schedule', e.id)));
                    } else batch.delete(doc(db, 'artifacts/periplo-app-v1', 'schedule', deleteConfirm.event.id));
                    await batch.commit();
                } catch (e) { alert(e.message); }
                setDeleteConfirm({ open: false, event: null, deleteAll: false });
                setIsModalOpen(false);
            };

            // DND
            const handleDragStart = (e, id) => { setDraggedEventId(id); e.dataTransfer.setData('id', id); e.dataTransfer.effectAllowed = 'move'; };
            const handleDrop = async (e, tDate, tDay, tTime) => {
                e.preventDefault();
                const id = e.dataTransfer.getData('id');
                if(!id) return;
                const evToMove = events.find(x => x.id === id);
                if(!evToMove) return;
                try { await updateDoc(doc(db, 'artifacts/periplo-app-v1', 'schedule', id), { date: tDate, day: tDay, time: tTime }); } catch(err) { alert(err.message); }
                setDraggedEventId(null);
            };

            const confirmDuplication = async () => {
                const { sourceEvent, selectedSlots } = duplicationMode;
                const batch = writeBatch(db);
                selectedSlots.forEach(s => { batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { ...sourceEvent, id: undefined, date: s.dateStr, day: s.dayName, time: s.time }); });
                await batch.commit();
                setDuplicationMode({ active: false, sourceEvent: null, selectedSlots: [] });
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-stone-50 dark:bg-zinc-950 text-stone-800 dark:text-stone-100 font-sans flex flex-col h-screen overflow-hidden transition-colors duration-300 relative">
                        
                        {duplicationMode.active && (
                            <div className="fixed top-0 left-0 right-0 z-50 bg-indigo-600 text-white shadow-lg p-3 flex justify-between px-8 animate-in slide-in-from-top">
                                <div><Copy className="inline mr-2 w-4"/> Duplicando "{duplicationMode.sourceEvent.title}" ({duplicationMode.selectedSlots.length})</div>
                                <div><button onClick={()=>setDuplicationMode({active:false, sourceEvent:null, selectedSlots:[]})} className="mr-4 hover:underline">Cancelar</button><button onClick={confirmDuplication} className="bg-white text-indigo-70
