<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Schedule | Periplo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
    <script>
        window.onload = function() {
            MobileDragDrop.polyfill({ holdToDrag: 300 }); 
            window.addEventListener('touchmove', function() {}, {passive: false});
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .sticky-col { position: sticky; left: 0; z-index: 20; }
        .sticky-corner { position: sticky; left: 0; top: 0; z-index: 40; }
        /* Mejora para el arrastre tÃ¡ctil en Chrome Mobile */
        .draggable-item { touch-action: none; -webkit-user-drag: element; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, writeBatch, orderBy, limit, getDocs } from 'firebase/firestore';
        import { format, startOfWeek, addDays, isSameDay, addWeeks, parseISO } from 'date-fns';
        import { es } from 'date-fns/locale';
        import { Plus, X, Trash2, Save, Calendar as CalendarIcon, Copy, Repeat, Palette, CheckCircle2, Moon, Sun, GripVertical, Check, ArrowLeft, ChevronLeft, ChevronRight, Link as LinkIcon, Video, User, Bell, Wrench, BookOpen } from 'lucide-react';

        const firebaseConfig = { apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo", authDomain: "proyecto-periplo.firebaseapp.com", projectId: "proyecto-periplo", storageBucket: "proyecto-periplo.firebasestorage.app", messagingSenderId: "236795998392", appId: "1:236795998392:web:0da24b4f018611b55c844d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // OFFSET HORARIO (Ontario)
        const MY_TIME_OFFSET = 1; 

        const DAYS = ['LUN', 'MAR', 'MIER', 'JUE', 'VIE', 'SAB'];
        const TIMES = ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00'];
        
        const formatTimeDisplay = (time24, offset = 0) => { 
            let h = parseInt(time24.split(':')[0], 10) + offset;
            const ampm = (h >= 12 && h < 24) ? 'pm' : 'am';
            const h12 = h % 12 || 12;
            return `${h12}:00 ${ampm}`; 
        };

        const FRUIT_FLOWER_PALETTE = [ { id: 'lavanda', class: 'bg-violet-200 border-violet-300 text-violet-900 dark:bg-violet-900/50 dark:border-violet-500 dark:text-violet-100' }, { id: 'lirio', class: 'bg-stone-50 border-stone-200 text-stone-600 dark:bg-stone-800 dark:border-stone-500 dark:text-stone-200' }, { id: 'menta', class: 'bg-teal-200 border-teal-300 text-teal-900 dark:bg-teal-900/50 dark:border-teal-500 dark:text-teal-100' }, { id: 'durazno', class: 'bg-orange-200 border-orange-300 text-orange-900 dark:bg-orange-900/50 dark:border-orange-500 dark:text-orange-100' }, { id: 'cereza', class: 'bg-rose-300 border-rose-400 text-rose-900 dark:bg-rose-900/50 dark:border-rose-500 dark:text-rose-100' }, { id: 'arandano', class: 'bg-blue-300 border-blue-400 text-blue-900 dark:bg-blue-900/50 dark:border-blue-500 dark:text-blue-100' }, { id: 'kiwi', class: 'bg-lime-200 border-lime-300 text-lime-900 dark:bg-lime-900/50 dark:border-lime-500 dark:text-lime-100' }, { id: 'uva', class: 'bg-purple-300 border-purple-400 text-purple-900 dark:bg-purple-900/50 dark:border-purple-500 dark:text-purple-100' }, { id: 'fresa', class: 'bg-pink-200 border-pink-300 text-pink-900 dark:bg-pink-900/50 dark:border-pink-500 dark:text-pink-100' }, { id: 'mandarina', class: 'bg-amber-200 border-amber-300 text-amber-900 dark:bg-amber-900/50 dark:border-amber-500 dark:text-amber-100' }, { id: 'coco', class: 'bg-stone-200 border-stone-300 text-stone-800 dark:bg-stone-700 dark:border-stone-500 dark:text-stone-100' }, { id: 'ciruela', class: 'bg-fuchsia-200 border-fuchsia-300 text-fuchsia-900 dark:bg-fuchsia-900/50 dark:border-fuchsia-500 dark:text-fuchsia-100' }, { id: 'manzana', class: 'bg-emerald-200 border-emerald-300 text-emerald-900 dark:bg-emerald-900/50 dark:border-emerald-500 dark:text-emerald-100' }, { id: 'cielo', class: 'bg-sky-200 border-sky-300 text-sky-900 dark:bg-sky-900/50 dark:border-sky-500 dark:text-sky-100' }, { id: 'coral', class: 'bg-red-200 border-red-300 text-red-900 dark:bg-red-900/50 dark:border-red-500 dark:text-red-100' } ];
        
        const ACTIVITY_TYPES = [ 
            { id: 'class', label: 'Clase', color: 'bg-teal-100 border-teal-300 text-teal-900 dark:bg-teal-900/60 dark:border-teal-500 dark:text-teal-100', defaultTitle: '' }, 
            { id: 'personal', label: 'Personal', color: 'bg-emerald-100 border-emerald-300 text-emerald-900 dark:bg-emerald-900/60 dark:border-emerald-500 dark:text-emerald-100', defaultTitle: 'Personal' }, 
            { id: 'project', label: 'Proyecto', color: 'bg-rose-100 border-rose-300 text-rose-900 dark:bg-rose-900/60 dark:border-rose-500 dark:text-rose-100', defaultTitle: 'Proyecto' }, 
            { id: 'other', label: 'Otro', color: 'bg-stone-200 border-stone-300 text-stone-900 dark:bg-stone-800 dark:border-stone-600 dark:text-stone-100', defaultTitle: 'Otro' }, 
            { id: 'lunch', label: 'Comida', color: 'bg-amber-100 border-amber-300 text-amber-900 dark:bg-amber-900/60 dark:border-amber-500 dark:text-amber-100', defaultTitle: 'Comida' } 
        ];

        export default function App() {
            const [events, setEvents] = useState([]);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [now, setNow] = useState(new Date()); 
            
            const [notifications, setNotifications] = useState([]);
            const [showNotifs, setShowNotifs] = useState(false);
            const hasUnread = notifications.some(n => !n.read);

            const [isDarkMode, setIsDarkMode] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentSlot, setCurrentSlot] = useState(null); 
            const [editingEvent, setEditingEvent] = useState(null);
            
            const [draggedEventId, setDraggedEventId] = useState(null);
            const [duplicationMode, setDuplicationMode] = useState({ active: false, sourceEvent: null, selectedSlots: [] });
            const [deleteConfirm, setDeleteConfirm] = useState({ open: false, event: null, deleteAll: false });
            
            const [formData, setFormData] = useState({ title: '', student: '', type: 'class', notes: '', meetLink: '', customColor: '', applyToAllWeek: false, applyColorToAll: false });
            const [isStudentManuallyEdited, setIsStudentManuallyEdited] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 60000);
                if ("Notification" in window && Notification.permission !== "denied" && Notification.permission !== "granted") Notification.requestPermission();
                
                const q = query(collection(db, 'artifacts', 'periplo-app-v1', 'schedule'));
                const unsubscribe = onSnapshot(q, (snapshot) => { setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });

                const qNotif = query(collection(db, 'artifacts', 'periplo-app-v1', 'notifications'), orderBy('createdAt', 'desc'), limit(5));
                const unsubNotif = onSnapshot(qNotif, (snapshot) => {
                    setNotifications(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' && change.doc.data().createdAt) {
                            const data = change.doc.data();
                            const isRecent = (Date.now() - data.createdAt.toMillis()) < 10000; 
                            if (isRecent && Notification.permission === "granted" && !data.read) new Notification("Periplo", { body: data.message });
                        }
                    });
                });
                return () => { clearInterval(timer); unsubscribe(); unsubNotif(); };
            }, []);

            const weekStart = startOfWeek(currentDate, { weekStartsOn: 1 });
            const weekDays = Array.from({ length: 6 }).map((_, i) => addDays(weekStart, i));

            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const copyStudentLink = () => {
                if (!formData.student.trim()) return alert("Escribe el nombre del alumno");
                const link = `${window.location.href.replace('dashboard-schedule.html', 'schedule.html')}?student=${encodeURIComponent(formData.student.trim())}`;
                navigator.clipboard.writeText(link);
                alert("Link copiado:\n" + link);
            };

            const handleTitleChange = (e) => {
                const val = e.target.value;
                setFormData(prev => (!isStudentManuallyEdited ? { ...prev, title: val, student: val } : { ...prev, title: val }));
            };
            const handleStudentChange = (e) => { setFormData(prev => ({ ...prev, student: e.target.value })); setIsStudentManuallyEdited(true); };

            const handleTypeChange = (newTypeId) => {
                const config = ACTIVITY_TYPES.find(t => t.id === newTypeId);
                setFormData(prev => ({
                    ...prev,
                    type: newTypeId,
                    title: config.defaultTitle || (prev.type !== 'class' ? '' : prev.title),
                    customColor: ''
                }));
            };

            const toggleNotifs = async () => {
                setShowNotifs(!showNotifs);
                if (!showNotifs && hasUnread) {
                    const batch = writeBatch(db);
                    notifications.filter(n => !n.read).forEach(n => batch.update(doc(db, 'artifacts', 'periplo-app-v1', 'notifications', n.id), { read: true }));
                    await batch.commit();
                }
            };

            // CRUD & MODALS
            const getEventForSlot = (dateStr, dayName, time) => events.find(e => (e.date === dateStr && e.time === time) || (!e.date && e.day === dayName && e.time === time));

            const handleSlotClick = (dateStr, dayName, time) => {
                if (duplicationMode.active) {
                    if (!getEventForSlot(dateStr, dayName, time)) {
                        const s = [...duplicationMode.selectedSlots];
                        const idx = s.findIndex(x => x.dateStr === dateStr && x.time === time);
                        if(idx >= 0) s.splice(idx,1); else s.push({dateStr, dayName, time});
                        setDuplicationMode({...duplicationMode, selectedSlots: s});
                    }
                    return;
                }
                const existingEvent = getEventForSlot(dateStr, dayName, time);
                setCurrentSlot({ dateStr, dayName, time });
                setIsStudentManuallyEdited(false);
                if (existingEvent) {
                    setFormData({ title: existingEvent.title, student: existingEvent.student || '', type: existingEvent.type || 'class', notes: existingEvent.notes || '', meetLink: existingEvent.meetLink || '', customColor: existingEvent.customColor || '', applyToAllWeek: false, applyColorToAll: false });
                } else {
                    setFormData({ title: '', student: '', type: 'class', notes: '', meetLink: '', customColor: '', applyToAllWeek: false, applyColorToAll: false });
                }
                setEditingEvent(existingEvent || null);
                setIsModalOpen(true);
            };

            const handleSave = async () => {
                if (!formData.title.trim()) return;
                const finalStudent = formData.type === 'class' ? (formData.student.trim() || formData.title.trim()) : '';
                const eventData = { title: formData.title.trim(), student: finalStudent, type: formData.type, notes: formData.notes, meetLink: formData.type === 'class' ? formData.meetLink : '', customColor: formData.type === 'class' ? formData.customColor : '' };
                const batch = writeBatch(db);

                try {
                    if (editingEvent) {
                        batch.update(doc(db, 'artifacts', 'periplo-app-v1', 'schedule', editingEvent.id), { ...eventData, date: currentSlot.dateStr });
                        if (formData.applyColorToAll && formData.type === 'class' && formData.customColor) {
                            events.filter(e => e.id !== editingEvent.id && e.type === 'class' && e.title.toLowerCase() === formData.title.toLowerCase()).forEach(e => batch.update(doc(db, 'artifacts/periplo-app-v1', 'schedule', e.id), { customColor: formData.customColor }));
                        }
                    } else {
                        if (formData.applyToAllWeek) {
                            weekDays.forEach(d => {
                                batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { date: format(d, 'yyyy-MM-dd'), day: format(d, 'EEE', {locale:es}).toUpperCase().replace('.',''), time: currentSlot.time, ...eventData });
                            });
                        } else {
                            batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { date: currentSlot.dateStr, day: currentSlot.dayName, time: currentSlot.time, ...eventData });
                        }
                    }
                    await batch.commit();
                } catch (e) { alert(e.message); }
                setIsModalOpen(false);
            };

            // ACCIONES SEGURAS DE BOTONES
            const initDeleteTile = (e, ev) => {
                e.preventDefault();
                e.stopPropagation();
                setDeleteConfirm({ open: true, event: ev, deleteAll: false });
            };

            const initDuplicateModal = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDuplicationMode({ active: true, sourceEvent: editingEvent, selectedSlots: [] });
                setIsModalOpen(false); 
            };

            const confirmDelete = async () => {
                if (!deleteConfirm.event) return;
                try {
                    const batch = writeBatch(db);
                    if (deleteConfirm.deleteAll) {
                        events.filter(e => e.title.toLowerCase() === deleteConfirm.event.title.toLowerCase()).forEach(e => batch.delete(doc(db, 'artifacts/periplo-app-v1', 'schedule', e.id)));
                    } else batch.delete(doc(db, 'artifacts/periplo-app-v1', 'schedule', deleteConfirm.event.id));
                    await batch.commit();
                } catch (e) { alert(e.message); }
                setDeleteConfirm({ open: false, event: null, deleteAll: false });
                setIsModalOpen(false);
            };

            // DND MOBILE FIX
            const handleDragStart = (e, id) => { 
                setDraggedEventId(id); 
                e.dataTransfer.setData('text/plain', id); // OBLIGATORIO PARA CELULARES
                e.dataTransfer.effectAllowed = 'move'; 
            };
            const handleDrop = async (e, tDate, tDay, tTime) => {
                e.preventDefault();
                const id = e.dataTransfer.getData('text/plain'); // LEER FORMATO CORRECTO
                if(!id) return;
                const evToMove = events.find(x => x.id === id);
                if(!evToMove) return;
                try { await updateDoc(doc(db, 'artifacts/periplo-app-v1', 'schedule', id), { date: tDate, day: tDay, time: tTime }); } catch(err) { alert(err.message); }
                setDraggedEventId(null);
            };

            const confirmDuplication = async () => {
                const { sourceEvent, selectedSlots } = duplicationMode;
                const batch = writeBatch(db);
                selectedSlots.forEach(s => { batch.set(doc(collection(db, 'artifacts', 'periplo-app-v1', 'schedule')), { ...sourceEvent, id: undefined, date: s.dateStr, day: s.dayName, time: s.time }); });
                await batch.commit();
                setDuplicationMode({ active: false, sourceEvent: null, selectedSlots: [] });
            };

            return (
                <div className={`${isDarkMode ? 'dark' : ''}`}>
                    <div className="min-h-screen bg-stone-50 dark:bg-zinc-950 text-stone-800 dark:text-stone-100 font-sans flex flex-col h-screen overflow-hidden transition-colors duration-300 relative">
                        
                        {duplicationMode.active && (
                            <div className="fixed top-0 left-0 right-0 z-50 bg-indigo-600 text-white shadow-lg p-3 flex justify-between px-8 animate-in slide-in-from-top">
                                <div><Copy className="inline mr-2 w-4"/> Duplicando "{duplicationMode.sourceEvent.title}" ({duplicationMode.selectedSlots.length})</div>
                                <div><button onClick={()=>setDuplicationMode({active:false, sourceEvent:null, selectedSlots:[]})} className="mr-4 hover:underline">Cancelar</button><button onClick={confirmDuplication} className="bg-white text-indigo-700 px-4 py-1 rounded font-bold">Pegar</button></div>
                            </div>
                        )}

                        <header className="bg-white dark:bg-zinc-900 shadow-sm border-b border-stone-200 dark:border-zinc-800 p-4 flex justify-between shrink-0 z-40">
                            <div className="flex items-center gap-4">
                                <button onClick={() => window.location.href='index.html'} className="p-2 bg-stone-100 dark:bg-zinc-800 rounded-lg hover:bg-stone-200 dark:hover:bg-zinc-700"><ArrowLeft size={18}/></button>
                                <div className="flex items-center gap-2 bg-stone-100 dark:bg-zinc-800 px-3 py-1 rounded-xl border border-stone-200 dark:border-zinc-700">
                                    <button onClick={() => setCurrentDate(addWeeks(currentDate, -1))} className="hover:bg-white dark:hover:bg-zinc-700 p-1 rounded transition-colors"><ChevronLeft size={18}/></button>
                                    <span className="font-bold text-sm min-w-[120px] text-center capitalize">{format(weekStart, 'MMM d')} - {format(addDays(weekStart, 5), 'MMM d')}</span>
                                    <button onClick={() => setCurrentDate(addWeeks(currentDate, 1))} className="hover:bg-white dark:hover:bg-zinc-700 p-1 rounded transition-colors"><ChevronRight size={18}/></button>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-xs font-bold text-stone-500 bg-stone-100 dark:bg-zinc-800 px-3 py-1.5 rounded-lg border border-stone-200 dark:border-zinc-700 hidden md:block">
                                    ðŸŒ UTC {MY_TIME_OFFSET > 0 ? `+${MY_TIME_OFFSET}` : MY_TIME_OFFSET}
                                </div>
                                <div className="relative">
                                    <button onClick={toggleNotifs} className={`p-2 rounded-full relative transition-colors ${hasUnread ? 'bg-red-50 text-red-500 dark:bg-red-900/30' : 'bg-indigo-50 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400'}`}>
                                        <Bell size={20}/>
                                        {hasUnread && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse border border-white dark:border-zinc-900"></span>}
                                    </button>
                                    {showNotifs && (
                                        <div className="absolute right-0 mt-2 w-72 bg-white dark:bg-zinc-800 rounded-xl shadow-2xl border border-stone-200 dark:border-zinc-700 p-2 z-50 animate-in slide-in-from-top-2">
                                            <h4 className="text-xs font-black p-2 border-b border-stone-100 dark:border-zinc-700 uppercase tracking-widest text-stone-400">Ãšltimos Movimientos</h4>
                                            {notifications.map((n, i) => (
                                                <div key={i} className={`p-3 text-sm border-b border-stone-50 dark:border-zinc-700/50 last:border-0 leading-tight ${n.read ? 'opacity-60' : 'font-medium'}`}>
                                                    {n.message}
                                                    <div className="text-[9px] opacity-50 mt-1">{n.createdAt?.toDate().toLocaleString()}</div>
                                                </div>
                                            ))}
                                            {notifications.length === 0 && <div className="p-4 text-xs text-center opacity-50">No hay notificaciones</div>}
                                        </div>
                                    )}
                                </div>
                                <button onClick={toggleTheme} className="p-2 rounded-full bg-stone-100 dark:bg-zinc-800 text-stone-600 dark:text-amber-400 hover:bg-stone-200 dark:hover:bg-zinc-700 transition-colors">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto p-4 custom-scrollbar relative">
                            <div className="min-w-[900px] bg-white dark:bg-zinc-900 rounded-2xl shadow-xl border border-stone-200 dark:border-zinc-800">
                                <div className="grid grid-cols-[80px_repeat(6,_1fr)] border-b-2 border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950 sticky top-0 z-30 shadow-sm">
                                    <div className="sticky-corner p-4 text-center text-xs font-black text-stone-300 dark:text-zinc-600 uppercase border-r border-stone-200 dark:border-zinc-800 bg-stone-100 dark:bg-zinc-950 flex items-center justify-center">HORA</div>
                                    {weekDays.map(day => {
                                        const isToday = isSameDay(day, now);
                                        return (
                                            <div key={day.toString()} className={`p-3 text-center border-r border-stone-200 dark:border-zinc-800 last:border-r-0 ${isToday ? 'bg-indigo-50 dark:bg-indigo-900/20 border-b-4 border-b-indigo-500' : ''}`}>
                                                <div className={`text-[10px] font-bold uppercase ${isToday ? 'text-indigo-600 dark:text-indigo-400' : 'text-stone-400 dark:text-zinc-500'}`}>{format(day, 'EEE', { locale: es })}</div>
                                                <div className={`text-lg font-black tracking-tight ${isToday ? 'text-indigo-700 dark:text-indigo-300' : 'text-stone-800 dark:text-zinc-300'}`}>{format(day, 'd')}</div>
                                            </div>
                                        )
                                    })}
                                </div>

                                <div className="divide-y divide-stone-100 dark:divide-zinc-800">
                                    {TIMES.map(time => {
                                        const currentLocalHour = parseInt(format(now, 'HH'), 10);
                                        const mexicoHour = currentLocalHour - MY_TIME_OFFSET;
                                        const mexicoHourStr = `${mexicoHour.toString().padStart(2, '0')}:00`;
                                        const isCurrentHourRow = time === mexicoHourStr;

                                        return (
                                            /* FIJAMOS LA ALTURA A 110px ESTRICTOS PARA QUE NO SE DEFORME */
                                            <div key={time} className="grid grid-cols-[80px_repeat(6,_1fr)] h-[110px]">
                                                <div className={`sticky-col p-2 text-xs font-black flex items-center justify-center border-r border-stone-200 dark:border-zinc-800 backdrop-blur-sm shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] ${isCurrentHourRow ? 'bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300' : 'bg-stone-50 dark:bg-zinc-950/90 text-stone-400 dark:text-zinc-500'}`}>
                                                    {formatTimeDisplay(time, MY_TIME_OFFSET)}
                                                </div>
                                                {weekDays.map(day => {
                                                    const dateStr = format(day, 'yyyy-MM-dd');
                                                    const dayName = format(day, 'EEE', {locale: es}).toUpperCase().replace('.','');
                                                    const event = getEventForSlot(dateStr, dayName, time);
                                                    
                                                    const isDuplicationTarget = duplicationMode.active && !event;
                                                    const isSelectedForDuplication = duplicationMode.selectedSlots.some(s => s.dateStr === dateStr && s.time === time);
                                                    const isToday = isSameDay(day, now);

                                                    let cellColor = 'bg-stone-50 border-stone-200 dark:bg-zinc-900 dark:border-zinc-800';
                                                    if (event) cellColor = event.customColor || (ACTIVITY_TYPES.find(t => t.id === event.type)?.color || cellColor);

                                                    return (
                                                        <div key={`${dateStr}-${time}`} onDragEnter={e=>e.preventDefault()} onDragOver={e=>{e.preventDefault(); e.dataTransfer.dropEffect='move'}} onDrop={e=>handleDrop(e,dateStr,dayName,time)} onClick={() => handleSlotClick(dateStr, dayName, time)} className={`relative p-1 border-r border-stone-100 dark:border-zinc-800 last:border-r-0 transition-all duration-200 group overflow-hidden ${event ? 'bg-white dark:bg-zinc-900' : isToday ? 'bg-indigo-50/30 dark:bg-indigo-900/5' : ''} ${isDuplicationTarget ? 'cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/20' : ''}`}>
                                                            {isSelectedForDuplication && <div className="absolute inset-0 bg-indigo-500/20 z-10 flex items-center justify-center animate-pulse"><CheckCircle2 className="text-indigo-500"/></div>}
                                                            
                                                            {event ? (
                                                                <div draggable={!duplicationMode.active} onDragStart={e=>handleDragStart(e,event.id)} onDragEnd={()=>setDraggedEventId(null)} className={`draggable-item h-full w-full rounded-xl p-2.5 border-2 shadow-sm flex flex-col justify-between relative transition-transform ${draggedEventId===event.id ? 'opacity-40 scale-95' : 'hover:scale-[1.02]'} ${cellColor} ${duplicationMode.active ? 'opacity-50 pointer-events-none' : 'cursor-grab active:cursor-grabbing'}`}>
                                                                    
                                                                    {/* BOTÃ“N ELIMINAR BLINDADO */}
                                                                    {!duplicationMode.active && (
                                                                        <div className="absolute top-1.5 right-1.5 flex opacity-0 group-hover:opacity-100 z-20 transition-opacity">
                                                                            <button 
                                                                                onTouchStart={e => e.stopPropagation()} 
                                                                                onPointerDown={e => e.stopPropagation()} 
                                                                                onClick={e => initDeleteTile(e,event)} 
                                                                                className="p-2 md:p-1.5 bg-rose-500 text-white rounded-lg shadow-md hover:bg-rose-600 active:scale-95"
                                                                            >
                                                                                <Trash2 size={18} className="md:w-4 md:h-4"/>
                                                                            </button>
                                                                        </div>
                                                                    )}
                                                                    <div className="font-black text-xs md:text-sm leading-tight uppercase z-10 mr-8 line-clamp-2" title={event.title}>{event.title}</div>
                                                                    <div>
                                                                        {event.student && event.student !== event.title && <div className="flex items-center gap-1 text-[10px] font-bold opacity-60 mt-1 truncate"><User size={10}/> {event.student}</div>}
                                                                        {event.meetLink && <div className="flex items-center gap-1 text-[10px] font-bold text-blue-600 dark:text-blue-400 mt-1"><LinkIcon size={10}/> Link OK</div>}
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className={`h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer ${isDuplicationTarget ? 'opacity-100 border-2 border-dashed border-indigo-400 rounded-xl' : ''}`}>{isDuplicationTarget ? <span className="text-xs font-bold text-indigo-400">Pegar</span> : <Plus className="text-stone-300"/>}</div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* MODALS DE EDICIÃ“N */}
                        {isModalOpen && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-stone-200 dark:border-zinc-700 flex flex-col max-h-[90vh]">
                                    <div className="bg-stone-50 dark:bg-zinc-950 px-6 py-4 flex justify-between items-center shrink-0">
                                        <div><h3 className="font-black">{editingEvent ? 'Editar' : 'Nueva Entrada'}</h3><p className="text-sm text-stone-500">{currentSlot.dayName} {currentSlot.dateStr} â€¢ {formatTimeDisplay(currentSlot.time, MY_TIME_OFFSET)}</p></div>
                                        <div className="flex items-center gap-3">
                                            {/* BOTÃ“N DUPLICAR (SOLO EN EL MODAL) */}
                                            {editingEvent && (
                                                <button onClick={initDuplicateModal} className="flex items-center gap-1 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-colors active:scale-95">
                                                    <Copy size={14}/> Duplicar
                                                </button>
                                            )}
                                            <button onClick={()=>setIsModalOpen(false)} className="p-1 text-stone-400 hover:text-stone-600"><X size={20}/></button>
                                        </div>
                                    </div>
                                    <div className="p-6 space-y-4 overflow-y-auto">
                                        
                                        <div>
                                            <label className="block text-xs font-black text-stone-400 dark:text-zinc-500 uppercase mb-2">Tipo</label>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                                                {ACTIVITY_TYPES.map(t=>(<button key={t.id} type="button" onClick={()=>handleTypeChange(t.id)} className={`p-2 border-2 rounded-lg text-xs font-bold text-left flex items-center gap-2 ${formData.type===t.id ? 'border-teal-500 bg-teal-50 dark:bg-teal-900/40' : 'dark:border-zinc-700 hover:border-stone-300'}`}><div className={`w-3 h-3 rounded-full ${t.color.split(' ')[0]}`}></div> {t.label}</button>))}
                                            </div>
                                        </div>

                                        {formData.type === 'class' && (
                                            <div className="space-y-4 animate-in fade-in">
                                                <div><label className="text-xs font-black uppercase">TÃ­tulo</label><input value={formData.title} onChange={handleTitleChange} className="w-full p-3 rounded-xl border-2 dark:bg-zinc-800 dark:border-zinc-700" autoFocus/></div>
                                                <div><label className="text-xs font-black uppercase">Alumno</label><div className="flex gap-2"><input value={formData.student} onChange={handleStudentChange} className="w-full p-3 rounded-xl border-2 dark:bg-zinc-800 dark:border-zinc-700"/><button onClick={copyStudentLink} className="p-3 bg-indigo-100 text-indigo-700 rounded-xl hover:bg-indigo-200"><LinkIcon size={18}/></button></div></div>
                                                <div><label className="text-xs font-black uppercase">Meet Link</label><input value={formData.meetLink} onChange={e=>setFormData({...formData, meetLink:e.target.value})} className="w-full p-3 rounded-xl border-2 dark:bg-zinc-800 dark:border-zinc-700 text-blue-500"/></div>
                                                <div>
                                                    <label className="block text-xs font-black text-stone-400 dark:text-zinc-500 uppercase">Paleta Frutas y Flores</label>
                                                    <div className="grid grid-cols-5 gap-2 mt-2">
                                                        {FRUIT_FLOWER_PALETTE.map(c=>(<button key={c.id} onClick={()=>setFormData({...formData, customColor:c.class})} className={`h-8 w-8 rounded-full border-2 ${c.class.split(' ')[0]} ${formData.customColor===c.class?'ring-2 ring-black dark:ring-white scale-110':''}`}></button>))}
                                                    </div>
                                                </div>
                                                {formData.customColor && formData.title.trim() && (<div className="flex items-center gap-2 mt-2 p-2 bg-stone-50 dark:bg-zinc-800 rounded cursor-pointer" onClick={()=>setFormData({...formData, applyColorToAll:!formData.applyColorToAll})}><input type="checkbox" checked={formData.applyColorToAll} readOnly className="w-4 h-4"/><span className="text-xs font-bold">Pintar todos los "{formData.title.trim()}"</span></div>)}
                                            </div>
                                        )}

                                        {(formData.type === 'project' || formData.type === 'other') && (
                                            <div className="space-y-4 animate-in fade-in">
                                                <div><label className="text-xs font-black uppercase">TÃ­tulo</label><input value={formData.title} onChange={e=>setFormData({...formData, title: e.target.value})} className="w-full p-3 rounded-xl border-2 dark:bg-zinc-800 dark:border-zinc-700 font-bold" autoFocus/></div>
                                                <div><label className="text-xs font-black uppercase flex items-center gap-2"><BookOpen size={14}/> Detalles / Apuntes</label><textarea value={formData.notes} onChange={e=>setFormData({...formData, notes: e.target.value})} className="w-full p-4 rounded-xl border-2 dark:bg-zinc-800 dark:border-zinc-700 notebook-lines h-48 resize-none text-sm" placeholder="Escribe aquÃ­ las tareas o detalles..."/></div>
                                            </div>
                                        )}

                                        {(formData.type === 'lunch' || formData.type === 'personal') && (
                                            <div className="bg-stone-100 dark:bg-zinc-800 p-6 rounded-xl text-center text-stone-500 dark:text-zinc-400 font-bold animate-in fade-in flex flex-col items-center gap-2">
                                                <CheckCircle2 size={32} className="opacity-50"/>
                                                Bloque RÃ¡pido Seleccionado.<br/>Haz clic en Guardar para apartar la hora.
                                            </div>
                                        )}
                                        
                                        {!editingEvent && formData.type === 'class' && (<div className="flex items-center space-x-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800 cursor-pointer" onClick={()=>setFormData({...formData, applyToAllWeek:!formData.applyToAllWeek})}><Repeat className="text-blue-500 w-5 h-5" /><span className="text-sm font-bold flex-1">Repetir Lunes a SÃ¡bado</span><input type="checkbox" checked={formData.applyToAllWeek} readOnly className="w-5 h-5"/></div>)}
                                    </div>

                                    <div className="p-4 bg-stone-50 dark:bg-zinc-950 flex justify-end">
                                        <button onClick={handleSave} className="bg-stone-900 dark:bg-white text-white dark:text-black px-6 py-2 rounded-xl font-bold hover:scale-105 transition-transform">Guardar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {deleteConfirm.open && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                                <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl p-6 w-full max-w-sm">
                                    <h3 className="font-black text-lg mb-4">Â¿Eliminar {deleteConfirm.event?.title}?</h3>
                                    <label className="flex items-center gap-2 mb-6 cursor-pointer bg-stone-50 dark:bg-zinc-800 p-3 rounded-xl"><input type="checkbox" onChange={e=>setDeleteConfirm({...deleteConfirm, deleteAll: e.target.checked})} className="w-5 h-5"/> <span className="font-bold text-sm">Borrar todos los de este alumno</span></label>
                                    <div className="flex justify-end gap-2"><button onClick={()=>setDeleteConfirm({open:false})} className="px-4 py-2 font-bold">Cancelar</button><button onClick={confirmDelete} className="bg-red-500 text-white px-6 py-2 rounded-lg font-bold">Eliminar</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
