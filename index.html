<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Play Flashcards üéì</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; background-color: #f3f4f6; }
        
        /* Animaciones */
        .perspective-1000 { perspective: 1000px; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        
        @keyframes confetti { 0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(720deg); opacity: 0; } }
        .animate-confetti { animation: confetti 1s ease-out forwards; }
        
        @keyframes zoomIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        .animate-zoom-in { animation: zoomIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, getDoc } from 'firebase/firestore';
        import { 
            Play, RotateCcw, Check, X, ArrowLeft, ArrowRight, Pause, 
            Settings, Volume2, VolumeX, List, GraduationCap, RotateCw, 
            Zap, Music, Star, LogOut, Shuffle 
        } from 'lucide-react';

        // --- FIREBASE CONFIG (Tu proyecto real) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- COMPONENTE CONFETTI ---
        const Confetti = () => {
            const colors = ['#ef4444', '#22c55e', '#3b82f6', '#eab308', '#a855f7'];
            return (
                <div className="absolute inset-0 pointer-events-none z-50 overflow-hidden flex justify-center">
                    {[...Array(40)].map((_, i) => (
                        <div key={i} className="absolute w-3 h-3 rounded-full animate-confetti"
                            style={{
                                backgroundColor: colors[i % colors.length],
                                left: '50%', top: '50%',
                                '--tx': `${(Math.random() - 0.5) * 800}px`,
                                '--ty': `${(Math.random() - 1) * 800}px`,
                                animationDelay: `${Math.random() * 0.5}s`
                            }}
                        />
                    ))}
                </div>
            );
        };

        const FlashcardsGame = () => {
            const [gameState, setGameState] = useState('LOADING');
            const [gameData, setGameData] = useState(null);
            const [originalCards, setOriginalCards] = useState([]); // Backup para orden original
            const [cards, setCards] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            
            // Preferencias
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [isShuffled, setIsShuffled] = useState(false);
            const [autoPlayAudio, setAutoPlayAudio] = useState(true);
            
            // UI States
            const [feedback, setFeedback] = useState(null);
            const [showConfetti, setShowConfetti] = useState(false);
            const [introStep, setIntroStep] = useState(null);

            const audioSfx = useRef({});

            // 1. CARGA INICIAL
            useEffect(() => {
                const loadGame = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const gameId = params.get('id');
                    if (!gameId) { alert("Error: No hay ID de juego"); return; }

                    try {
                        const docRef = doc(db, 'artifacts/periplo-app-v1/users/teacher_builder_001/quizzes', gameId);
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            const data = snap.data();
                            const loadedCards = data.questions.map(q => ({ ...q, status: 'pending' }));
                            setGameData(data);
                            setOriginalCards(loadedCards);
                            setCards(loadedCards);
                            setGameState('WELCOME');
                        } else {
                            alert("Juego no encontrado");
                        }
                    } catch (e) { console.error(e); }
                };
                loadGame();

                // Cargar SFX
                const sfxUrls = {
                    click: 'https://actions.google.com/sounds/v1/percussion/wood_block_hit.ogg',
                    flip: 'https://www.soundjay.com/misc/sounds/page-flip-02.mp3',
                    success: 'https://www.soundjay.com/misc/sounds/magic-chime-01.mp3',
                    wrong: 'https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg',
                    intro: 'https://actions.google.com/sounds/v1/science_fiction/scifi_laser_3.ogg'
                };
                Object.entries(sfxUrls).forEach(([k, v]) => { audioSfx.current[k] = new Audio(v); });
            }, []);

            const playSfx = (type) => { if (soundEnabled) { audioSfx.current[type].currentTime = 0; audioSfx.current[type].play().catch(()=>{}); } };

            const speak = (text, lang) => {
                window.speechSynthesis.cancel();
                const ut = new SpeechSynthesisUtterance(text);
                ut.lang = lang === 'en' ? 'en-US' : 'es-MX';
                window.speechSynthesis.speak(ut);
            };

            // Audio Auto
            useEffect(() => {
                if (gameState === 'PLAYING' && isFlipped && autoPlayAudio && cards[currentIndex]) {
                    const lang = gameData.config?.audio?.right || 'es';
                    setTimeout(() => speak(cards[currentIndex].back, lang), 400);
                }
            }, [isFlipped]);

            // L√≥gica Shuffle
            const toggleShuffle = () => {
                const newShuffle = !isShuffled;
                setIsShuffled(newShuffle);
                // Si activamos shuffle, revolvemos. Si no, volvemos al original.
                if (newShuffle) {
                    setCards([...cards].sort(() => Math.random() - 0.5));
                } else {
                    // Restaurar orden original pero mantener estado de aprendido/pendiente
                    // (Esta es una implementaci√≥n simple, resetea al inicio para evitar bugs de √≠ndice)
                    setCards(originalCards); 
                    setCurrentIndex(0);
                }
            };

            const handleStart = () => {
                playSfx('click');
                setGameState('INTRO');
                setIntroStep('READY');
                
                // Reiniciar mazo seg√∫n modo shuffle
                let deck = originalCards.map(c => ({...c, status: 'pending'}));
                if (isShuffled) deck = deck.sort(() => Math.random() - 0.5);
                setCards(deck);
                setCurrentIndex(0);
                setIsFlipped(false);

                // Secuencia Intro
                setTimeout(() => setIntroStep('SET'), 800);
                setTimeout(() => setIntroStep('GO!'), 1600);
                setTimeout(() => { setGameState('PLAYING'); setIntroStep(null); }, 2400);
            };

            const handleNext = () => {
                if (currentIndex < cards.length - 1) {
                    playSfx('click');
                    setIsFlipped(false);
                    setCurrentIndex(prev => prev + 1);
                }
            };

            const handlePrev = () => {
                if (currentIndex > 0) {
                    playSfx('click');
                    setIsFlipped(false);
                    setCurrentIndex(prev => prev - 1);
                }
            };

            const updateStatus = (status) => {
                const newCards = [...cards];
                newCards[currentIndex].status = status;
                setCards(newCards);
                
                if (status === 'learned') { 
                    playSfx('success'); 
                    setFeedback('success'); 
                    setShowConfetti(true); 
                } else { 
                    playSfx('wrong'); 
                    setFeedback('error'); 
                }

                setTimeout(() => {
                    setFeedback(null);
                    setShowConfetti(false);
                    
                    if (currentIndex === cards.length - 1) {
                        // Fin del mazo
                        const pending = newCards.filter(c => c.status !== 'learned');
                        if (pending.length === 0) setGameState('VICTORY');
                        else {
                            // Ronda de repaso
                            alert(`Ronda terminada. Repasando ${pending.length} tarjetas.`);
                            setCards(pending.map(c => ({...c, status: 'pending'}))); // Reiniciar status para repaso
                            setCurrentIndex(0);
                            setIsFlipped(false);
                        }
                    } else {
                        setCurrentIndex(prev => prev + 1);
                        setIsFlipped(false);
                    }
                }, 1000);
            };

            // SALIR INTELIGENTE
            const handleExit = () => {
                // Intenta volver atr√°s en el historial (a la carpeta exacta)
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Fallback si abri√≥ el link directo
                    window.location.href = 'index.html'; 
                }
            };

            if (gameState === 'LOADING') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-indigo-50 text-indigo-600 font-black text-xl gap-4">
                    <div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                    Cargando Clase...
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-50 to-blue-100">
                    
                    {/* CONTENEDOR PRINCIPAL TIPO TABLET */}
                    <div className="relative w-full max-w-4xl min-h-[650px] bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-8 border-white ring-4 ring-slate-200 flex flex-col">
                        
                        {/* HEADER DEL JUEGO */}
                        <div className="h-20 bg-slate-50 border-b border-slate-100 flex items-center justify-between px-8">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsPaused(true)} className="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 flex items-center justify-center shadow-sm transition-all">
                                    <Pause size={20} fill="currentColor"/>
                                </button>
                                <div className="flex flex-col">
                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Progreso</span>
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold text-slate-700">{currentIndex + 1} / {cards.length}</span>
                                        {/* Barra de progreso */}
                                        <div className="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div className="h-full bg-indigo-500 transition-all duration-500" style={{ width: `${((currentIndex + 1) / cards.length) * 100}%` }}></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button onClick={handleExit} className="text-slate-400 hover:text-rose-500 transition-colors font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                                Salir <LogOut size={18}/>
                            </button>
                        </div>

                        {/* √ÅREA DE JUEGO */}
                        <div className="flex-1 bg-slate-100/50 relative overflow-hidden flex flex-col">
                            
                            {/* PANTALLA WELCOME */}
                            {gameState === 'WELCOME' && (
                                <div className="absolute inset-0 z-10 flex flex-col items-center justify-center bg-white/90 backdrop-blur-sm p-10 animate-zoom-in text-center">
                                    <div className="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-600 shadow-inner">
                                        <GraduationCap size={48} />
                                    </div>
                                    <h1 className="text-4xl font-black text-slate-800 mb-2">{gameData.title}</h1>
                                    <p className="text-slate-500 font-medium mb-10">Mazo de {cards.length} tarjetas</p>
                                    <button onClick={handleStart} className="bg-indigo-600 text-white px-12 py-5 rounded-2xl font-black text-xl shadow-xl shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 transition-all flex items-center gap-3">
                                        <Play fill="currentColor"/> START
                                    </button>
                                </div>
                            )}

                            {/* CONTEO REGRESIVO */}
                            {gameState === 'INTRO' && (
                                <div className="absolute inset-0 z-50 flex items-center justify-center bg-indigo-600 text-white">
                                    <h1 className="text-9xl font-black italic animate-bounce">{introStep}</h1>
                                </div>
                            )}

                            {/* JUEGO ACTIVO */}
                            {gameState === 'PLAYING' && (
                                <div className="flex-1 flex flex-col p-6 items-center justify-center relative">
                                    {showConfetti && <Confetti />}
                                    
                                    {/* ZONA DE TARJETA */}
                                    <div className="w-full max-w-md aspect-[3/4] md:aspect-[4/3] perspective-1000 cursor-pointer group" onClick={() => { playSfx('flip'); setIsFlipped(!isFlipped); }}>
                                        <div className={`relative w-full h-full transition-all duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                                            
                                            {/* FRENTE (Pregunta) */}
                                            <div className="absolute inset-0 w-full h-full bg-white rounded-3xl shadow-xl border-b-8 border-slate-200 flex flex-col items-center justify-center p-8 backface-hidden">
                                                {cards[currentIndex].image && (
                                                    <div className="w-full h-48 mb-6 rounded-2xl overflow-hidden shadow-inner bg-slate-100 relative">
                                                        <img src={cards[currentIndex].image} 
                                                             className="w-full h-full object-cover" 
                                                             style={{
                                                                transform: `translate(${cards[currentIndex].crop?.x - 50}%, ${cards[currentIndex].crop?.y - 50}%) scale(${cards[currentIndex].crop?.zoom})`,
                                                                transformOrigin: 'center'
                                                             }} 
                                                        />
                                                    </div>
                                                )}
                                                <h2 className="text-4xl font-black text-slate-800 text-center mb-4">{cards[currentIndex].front}</h2>
                                                <button onClick={(e) => { e.stopPropagation(); speak(cards[currentIndex].front, gameData.config?.audio?.left || 'en'); }} className="p-3 bg-indigo-50 text-indigo-500 rounded-full hover:bg-indigo-100 transition-colors">
                                                    <Volume2 size={24} />
                                                </button>
                                                <span className="absolute bottom-6 text-xs font-bold text-slate-300 uppercase tracking-widest animate-pulse">Tap to flip</span>
                                            </div>

                                            {/* REVERSO (Respuesta) */}
                                            <div className="absolute inset-0 w-full h-full bg-white rounded-3xl shadow-xl border-b-8 border-indigo-200 flex flex-col items-center justify-center p-8 rotate-y-180 backface-hidden">
                                                <span className="text-xs font-black text-indigo-400 uppercase tracking-widest mb-2">Respuesta</span>
                                                <h2 className="text-5xl font-black text-indigo-600 text-center mb-12">{cards[currentIndex].back}</h2>
                                                
                                                {/* BOTONES DE EVALUACI√ìN */}
                                                <div className="flex gap-4 w-full" onClick={e => e.stopPropagation()}>
                                                    <button onClick={() => updateStatus('review')} className="flex-1 bg-rose-50 text-rose-500 border-2 border-rose-100 py-4 rounded-2xl font-bold hover:bg-rose-100 hover:border-rose-300 transition-all flex flex-col items-center gap-1">
                                                        <X size={28} /> <span>Repasar</span>
                                                    </button>
                                                    <button onClick={() => updateStatus('learned')} className="flex-1 bg-emerald-50 text-emerald-600 border-2 border-emerald-100 py-4 rounded-2xl font-bold hover:bg-emerald-100 hover:border-emerald-300 transition-all flex flex-col items-center gap-1">
                                                        <Check size={28} /> <span>¬°Lo s√©!</span>
                                                    </button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    {/* NAVEGACI√ìN MANUAL (Flechitas) */}
                                    <div className="absolute bottom-8 flex gap-8 items-center opacity-50 hover:opacity-100 transition-opacity">
                                        <button onClick={handlePrev} disabled={currentIndex === 0} className="p-3 rounded-full hover:bg-white hover:shadow-md disabled:opacity-30 disabled:cursor-not-allowed">
                                            <ArrowLeft size={24} className="text-slate-600"/>
                                        </button>
                                        <button onClick={handleNext} disabled={currentIndex === cards.length - 1} className="p-3 rounded-full hover:bg-white hover:shadow-md disabled:opacity-30 disabled:cursor-not-allowed">
                                            <ArrowRight size={24} className="text-slate-600"/>
                                        </button>
                                    </div>

                                    {/* FEEDBACK FLOTANTE */}
                                    {feedback && (
                                        <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                                            <div className={`p-8 rounded-3xl shadow-2xl animate-bounce-in ${feedback === 'success' ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>
                                                {feedback === 'success' ? <Check size={64} strokeWidth={4}/> : <X size={64} strokeWidth={4}/>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* PANTALLA VICTORIA */}
                            {gameState === 'VICTORY' && (
                                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-indigo-600 text-white p-10 animate-zoom-in text-center">
                                    <Confetti />
                                    <div className="mb-6 p-6 bg-white/20 rounded-full backdrop-blur-md">
                                        <Star size={80} fill="white" className="animate-spin-slow" />
                                    </div>
                                    <h1 className="text-5xl font-black mb-4">¬°MAESTR√çA TOTAL!</h1>
                                    <p className="text-indigo-100 text-lg mb-10 max-w-md">Has dominado todas las tarjetas de este mazo.</p>
                                    <button onClick={handleExit} className="bg-white text-indigo-600 px-10 py-4 rounded-2xl font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-xl">
                                        Volver al Men√∫
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* MODAL PAUSA (RECREO) */}
                    {isPaused && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-8 animate-bounce-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-black text-slate-800">PAUSA</h3>
                                    <button onClick={() => setIsPaused(false)} className="bg-slate-100 p-2 rounded-full hover:bg-slate-200"><X size={20}/></button>
                                </div>
                                
                                <div className="space-y-3 mb-8">
                                    <button onClick={() => setSoundEnabled(!soundEnabled)} className="w-full p-4 rounded-xl border-2 border-slate-100 flex items-center justify-between font-bold text-slate-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all">
                                        <span className="flex items-center gap-3"><Volume2/> Sonido</span>
                                        <div className={`w-10 h-5 rounded-full relative transition-colors ${soundEnabled ? 'bg-indigo-500' : 'bg-slate-300'}`}>
                                            <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${soundEnabled ? 'left-6' : 'left-1'}`}></div>
                                        </div>
                                    </button>
                                    
                                    <button onClick={toggleShuffle} className="w-full p-4 rounded-xl border-2 border-slate-100 flex items-center justify-between font-bold text-slate-600 hover:border-purple-200 hover:bg-purple-50 transition-all">
                                        <span className="flex items-center gap-3"><Shuffle/> Aleatorio</span>
                                        <div className={`w-10 h-5 rounded-full relative transition-colors ${isShuffled ? 'bg-purple-500' : 'bg-slate-300'}`}>
                                            <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${isShuffled ? 'left-6' : 'left-1'}`}></div>
                                        </div>
                                    </button>
                                </div>

                                <div className="flex gap-2">
                                    <button onClick={() => { setGameState('WELCOME'); setIsPaused(false); }} className="flex-1 py-4 text-slate-400 font-bold hover:bg-slate-50 rounded-xl">Reiniciar</button>
                                    <button onClick={() => setIsPaused(false)} className="flex-1 py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700">Continuar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FlashcardsGame />);
    </script>
</body>
</html>
