<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Teacher Hub v15</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.location.search.includes('undefined') || window.location.search.includes('null')) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .drag-over { transform: scale(1.05); border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc } from 'firebase/firestore';
        import { 
            Share2, Plus, Folder, X, Flame, Rocket, LayoutGrid, 
            HelpCircle, Puzzle, Grid, ArrowLeft, Trash2, Copy, 
            Edit2, AlertTriangle, Map as MapIcon, Navigation, Gamepad2, BookOpen 
        } from 'lucide-react';

        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return (
                    <div className="h-screen flex flex-col items-center justify-center p-8 text-center text-slate-800">
                        <AlertTriangle size={48} className="text-rose-500 mb-4"/>
                        <h2 className="text-xl font-bold mb-2">Algo sali칩 mal</h2>
                        <button onClick={() => window.location.reload()} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold">Recargar</button>
                    </div>
                );
                return this.props.children;
            }
        }

        const GAME_TYPES = [
            { id: 'FLASHCARDS', name: 'Flashcards', icon: LayoutGrid, color: 'bg-indigo-500', isWordGame: true, desc: 'Repaso con im치genes' }, 
            { id: 'ANAGRAM', name: 'Anagrama', icon: Puzzle, color: 'bg-pink-500', isWordGame: true, desc: 'Ordena las letras' },
            { id: 'CROSSWORD', name: 'Crucigrama', icon: Grid, color: 'bg-emerald-500', isWordGame: true, desc: 'Cruza tus palabras' },
            { id: 'CONNECT4', name: 'Connect 4', icon: Gamepad2, color: 'bg-orange-500', isWordGame: false, desc: 'Estrategia y Gram치tica' },
            { id: 'READING', name: 'Reading Builder', icon: BookOpen, color: 'bg-emerald-600', isWordGame: false, desc: 'Lecturas con IA y Huecos' },
        ];

        const TOOL_TYPES = [
            { id: 'CITYMAP', name: 'City Map', icon: MapIcon, color: 'bg-slate-800', file: 'citymap.html', desc: 'Pr치ctica de direcciones' },
        ];

        function Dashboard() {
            const user = { uid: "teacher_builder_001" };
            const [path, setPath] = useState([]);
            const [userFolders, setUserFolders] = useState([]);
            const [userQuizzes, setUserQuizzes] = useState([]);
            const [modals, setModals] = useState({ folder: false, activity: false });
            const [dragOverFolderId, setDragOverFolderId] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const folderParam = params.get('folder');
                if (folderParam && folderParam !== 'undefined' && folderParam !== 'null') setPath(decodeURIComponent(folderParam).split('/'));
            }, []);

            useEffect(() => {
                const currentPath = path.join('/');
                const qF = query(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), where('parentPath', '==', currentPath));
                const unsubF = onSnapshot(qF, (s) => setUserFolders(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const qQ = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), where('parentPath', '==', currentPath));
                const unsubQ = onSnapshot(qQ, (s) => setUserQuizzes(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubF(); unsubQ(); };
            }, [path]);

            const navigateTo = (newPath) => {
                setPath(newPath);
                const url = new URL(window.location);
                if (newPath.length > 0) url.searchParams.set('folder', newPath.join('/')); else url.searchParams.delete('folder');
                window.history.pushState({}, '', url);
            };

            const createFolder = async (name) => {
                if (!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), {
                    name, parentPath: path.join('/'), createdAt: serverTimestamp()
                });
                setModals({...modals, folder: false});
            };

            const handleActivityClick = (gameType) => {
                const currentFolderId = path.join('/'); 
                const encodedFolder = encodeURIComponent(currentFolderId);
                
                if (gameType.id === 'CONNECT4') {
                    window.location.href = `dashboard-connect4.html?folder=${encodedFolder}`;
                } else if (gameType.id === 'READING') {
                    window.location.href = `dashboard-reading.html?folder=${encodedFolder}`;
                } else {
                    window.location.href = `dashboard.html?folderId=${encodedFolder}&type=${gameType.id}`;
                }
            };

            const handlePlayActivity = (q) => {
                if (q.type === 'CONNECT4') {
                    window.location.href = `connect4.html?id=${q.id}`;
                } else if (q.type === 'READING') {
                    window.location.href = `reading.html?id=${q.id}`;
                } else {
                    window.location.href = `activity.html?id=${q.id}`;
                }
            };

            const handleEditActivity = (e, q) => {
                e.stopPropagation();
                const currentFolderId = path.join('/'); 
                const encodedFolder = encodeURIComponent(currentFolderId);

                if (q.type === 'CONNECT4') {
                    window.location.href = `dashboard-connect4.html?edit=${q.id}&folder=${encodedFolder}`;
                } else if (q.type === 'READING') {
                    window.location.href = `dashboard-reading.html?edit=${q.id}&folder=${encodedFolder}`; 
                } else {
                    alert("Edici칩n para este tipo de juego a칰n no disponible en esta versi칩n.");
                }
            };

            const handleDeleteActivity = async (e, id) => {
                e.stopPropagation();
                if(confirm("쮼st치s seguro de eliminar esta actividad?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quizzes', id));
                }
            };

            const handleToolClick = (tool) => {
                window.location.href = tool.file;
            };

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in min-h-screen text-slate-800">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-8 flex justify-between items-center sticky top-4 z-20">
                        <div className="flex items-center gap-3">
                            {path.length > 0 && <button onClick={() => navigateTo(path.slice(0, -1))} className="p-2 hover:bg-slate-100 rounded-xl text-slate-400 hover:text-indigo-600 transition-all"><ArrowLeft size={20}/></button>}
                            <h1 className="text-xl font-black flex items-center gap-2 tracking-tight text-indigo-600 uppercase italic">PERIPLO <span className="text-[10px] not-italic bg-indigo-100 px-2 rounded-full border border-indigo-200">v15</span></h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setModals({...modals, folder: true})} className="bg-slate-50 text-slate-600 px-4 py-2 rounded-xl font-bold flex gap-2 hover:bg-slate-100 border border-slate-200 transition-all text-sm items-center"><Plus size={16}/> Carpeta</button>
                            <button onClick={() => setModals({...modals, activity: true})} className="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold flex gap-2 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all text-sm items-center"><Plus size={16}/> Nueva Actividad</button>
                        </div>
                    </div>

                    {/* Breadcrumbs */}
                    <div className="flex gap-2 mb-6 text-xs font-bold text-slate-400 overflow-x-auto pb-2 uppercase tracking-widest">
                        <button onClick={() => navigateTo([])} className={`hover:text-indigo-600 transition-colors ${path.length===0?"text-indigo-600":""}`}>INICIO</button>
                        {path.map((f, i) => (<React.Fragment key={i}><span>/</span><button onClick={() => navigateTo(path.slice(0, i+1))} className="hover:text-indigo-600 transition-colors text-slate-600">{f}</button></React.Fragment>))}
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {userFolders.map((f) => (
                            <button key={f.id} onClick={() => navigateTo([...path, f.name])} className="aspect-[4/3] bg-white border border-slate-100 rounded-3xl flex flex-col items-center justify-center gap-3 shadow-sm hover:border-indigo-300 hover:shadow-md transition-all group">
                                <Folder size={32} className="text-slate-300 group-hover:text-indigo-400 transition-colors"/>
                                <span className="font-bold text-[11px] text-center px-4 uppercase tracking-wide text-slate-600 truncate w-full">{f.name}</span>
                            </button>
                        ))}
                        {userQuizzes.map((q) => {
                            const info = GAME_TYPES.find(g => g.id === q.type) || GAME_TYPES[0];
                            return (
                                <div key={q.id} onClick={() => handlePlayActivity(q)} className="aspect-[4/3] bg-white rounded-3xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer relative">
                                    {/* Botones de Acci칩n Hover */}
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                        <button onClick={(e) => handleEditActivity(e, q)} className="p-2 bg-white/90 backdrop-blur rounded-full text-slate-400 hover:text-blue-600 hover:bg-blue-50 border border-slate-100 shadow-sm transition-colors" title="Editar"><Edit2 size={14}/></button>
                                        <button onClick={(e) => handleDeleteActivity(e, q.id)} className="p-2 bg-white/90 backdrop-blur rounded-full text-slate-400 hover:text-red-600 hover:bg-red-50 border border-slate-100 shadow-sm transition-colors" title="Eliminar"><Trash2 size={14}/></button>
                                    </div>
                                    
                                    <div className={`h-1/2 ${info.color} flex items-center justify-center text-white relative`}>
                                        <info.icon size={32} />
                                    </div>
                                    <div className="p-4 flex-1 flex flex-col justify-between bg-white text-slate-700">
                                        <div className="font-bold text-sm leading-tight line-clamp-2">{q.title}</div>
                                        <div className="text-[9px] text-slate-400 font-black uppercase tracking-widest">{info.name}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Modales */}
                    {modals.folder && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl animate-in zoom-in-95">
                                <h3 className="font-black text-xl mb-6">Nueva Carpeta</h3>
                                <input id="fName" placeholder="Nombre..." className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 font-bold outline-none focus:border-indigo-500" autoFocus/>
                                <div className="flex gap-2"><button onClick={() => setModals({...modals, folder: false})} className="flex-1 py-3 text-slate-400 font-bold">Cancelar</button><button onClick={() => createFolder(document.getElementById('fName').value)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">Crear</button></div>
                            </div>
                        </div>
                    )}

                    {modals.activity && (
                        <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in">
                            <div className="bg-white rounded-[2rem] w-full max-w-4xl max-h-[85vh] flex flex-col overflow-hidden shadow-2xl">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                    <div><h3 className="font-black text-2xl text-slate-800 tracking-tight">Crea o Selecciona</h3><p className="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">Elige el motor para tu actividad</p></div>
                                    <button onClick={() => setModals({...modals, activity: false})} className="w-10 h-10 rounded-full bg-slate-50 hover:bg-rose-50 hover:text-rose-500 flex items-center justify-center transition-all"><X size={20}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 bg-slate-50/50">
                                    <div className="mb-8">
                                        <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Generadores (IA Ready)</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {GAME_TYPES.map(g => (
                                                <button key={g.id} onClick={() => handleActivityClick(g)} className="bg-white p-5 rounded-[1.5rem] border border-slate-100 hover:border-indigo-500 hover:shadow-xl transition-all text-left flex flex-col gap-4 group">
                                                    <div className={`w-12 h-12 ${g.color} text-white rounded-2xl flex items-center justify-center shadow-md group-hover:scale-110 transition-transform`}><g.icon size={24}/></div>
                                                    <div><div className="font-black text-slate-700 text-lg">{g.name}</div><div className="text-xs text-slate-400 font-medium">{g.desc}</div></div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Herramientas de Clase</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            {TOOL_TYPES.map(t => (
                                                <button key={t.id} onClick={() => handleToolClick(t)} className="bg-slate-800 p-5 rounded-[1.5rem] border border-slate-700 hover:shadow-xl transition-all text-left flex flex-col gap-4 group">
                                                    <div className="w-12 h-12 bg-white/10 text-white rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform"><t.icon size={24}/></div>
                                                    <div><div className="font-black text-white text-lg">{t.name}</div><div className="text-xs text-slate-400 font-medium">{t.desc}</div></div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><Dashboard /></ErrorBoundary>);
    </script>
</body>
</html>
