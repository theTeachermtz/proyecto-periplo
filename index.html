<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Menu v10.1 (Fixed)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (window.location.search.includes('undefined') || window.location.search.includes('null')) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap'); 
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .drag-over { transform: scale(1.05); border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div id="rescue-btn" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:9999;">
        <h2 style="font-size:2rem; color:#e11d48; font-weight:bold;">‚ö†Ô∏è Sistema Trabado</h2>
        <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.href=window.location.pathname;" style="background:#e11d48; color:white; padding:15px 30px; border-radius:15px; font-weight:bold; border:none; cursor:pointer;">REINICIAR</button>
    </div>
    <script>setTimeout(() => { if (!document.getElementById('root').hasChildNodes()) document.getElementById('rescue-btn').style.display = 'block'; }, 2500);</script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, deleteDoc, updateDoc } from 'firebase/firestore';
        import { Share2, Plus, Folder, X, Flame, Rocket, LayoutGrid, HelpCircle, Puzzle, Grid, ArrowLeft, Trash2, Copy, Edit2, AlertTriangle } from 'lucide-react';

        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        // --- ESTA ES LA PIEZA QUE FALTABA ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() {
                if (this.state.hasError) return (
                    <div className="h-screen flex flex-col items-center justify-center p-8 text-center text-slate-800">
                        <AlertTriangle size={48} className="text-rose-500 mb-4"/>
                        <h2 className="text-xl font-bold mb-2">Algo sali√≥ mal</h2>
                        <button onClick={() => window.location.reload()} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold">Recargar</button>
                    </div>
                );
                return this.props.children;
            }
        }
        // -------------------------------------

        const GAME_TYPES = [
            { id: 'FLASHCARDS', name: 'Flashcards', icon: LayoutGrid, color: 'bg-indigo-500', isWordGame: true }, 
            { id: 'ANAGRAM', name: 'Anagrama', icon: Puzzle, color: 'bg-pink-500', isWordGame: true },
            { id: 'CROSSWORD', name: 'Crucigrama', icon: Grid, color: 'bg-emerald-500', isWordGame: true },
            { id: 'HANGMAN', name: 'Ahorcado', icon: HelpCircle, color: 'bg-orange-500', isWordGame: true },
        ];

        const FOLDER_COLORS = ["bg-slate-100", "bg-rose-100", "bg-orange-100", "bg-emerald-100", "bg-indigo-100", "bg-violet-100"];

        function Dashboard() {
            const user = { uid: "teacher_builder_001" };
            const [path, setPath] = useState([]);
            const [userFolders, setUserFolders] = useState([]);
            const [userQuizzes, setUserQuizzes] = useState([]);
            const [modals, setModals] = useState({ folder: false, activity: false });
            
            // Estado para Drag & Drop
            const [draggedItem, setDraggedItem] = useState(null); 
            const [dragOverFolderId, setDragOverFolderId] = useState(null);

            useEffect(() => {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const folderParam = params.get('folder');
                    if (folderParam && folderParam !== 'undefined' && folderParam !== 'null') setPath(decodeURIComponent(folderParam).split('/'));
                } catch(e) {}
            }, []);

            useEffect(() => {
                const currentPath = path.join('/');
                const qF = query(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), where('parentPath', '==', currentPath));
                const unsubF = onSnapshot(qF, (s) => setUserFolders(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const qQ = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), where('parentPath', '==', currentPath));
                const unsubQ = onSnapshot(qQ, (s) => setUserQuizzes(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubF(); unsubQ(); };
            }, [path]);

            const createFolder = async (name) => {
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), {
                    name, color: FOLDER_COLORS[Math.floor(Math.random()*FOLDER_COLORS.length)], parentPath: path.join('/'), createdAt: serverTimestamp()
                });
                setModals({...modals, folder: false});
            };

            // --- ACCIONES DE UI ---
            const deleteItem = async (e, id, type) => {
                e.stopPropagation();
                if(!confirm("¬øSeguro que quieres eliminar esto? No se puede deshacer.")) return;
                const collectionName = type === 'folder' ? 'folders' : 'quizzes';
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, collectionName, id));
            };

            const renameItem = async (e, id, type, currentName) => {
                e.stopPropagation();
                const newName = prompt("Nuevo nombre:", currentName);
                if (!newName) return;
                const collectionName = type === 'folder' ? 'folders' : 'quizzes';
                const field = type === 'folder' ? 'name' : 'title';
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, collectionName, id), { [field]: newName });
            };

            const duplicateQuiz = async (e, quiz) => {
                e.stopPropagation();
                const newQuiz = { ...quiz, title: `${quiz.title} (Copia)`, createdAt: serverTimestamp() };
                delete newQuiz.id;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), newQuiz);
            };

            // --- DRAG & DROP LOGIC ---
            const handleDragStart = (e, item, type) => {
                setDraggedItem({ id: item.id, type, data: item });
                e.dataTransfer.effectAllowed = "move";
            };

            const handleDragOver = (e, folderId) => {
                e.preventDefault(); 
                if (draggedItem && draggedItem.id !== folderId) {
                    setDragOverFolderId(folderId);
                }
            };

            const handleDragLeave = () => {
                setDragOverFolderId(null);
            };

            const handleDrop = async (e, targetFolder) => {
                e.preventDefault();
                setDragOverFolderId(null);
                
                if (!draggedItem) return;
                if (draggedItem.type === 'folder') {
                    alert("A√∫n no se pueden mover carpetas dentro de carpetas.");
                    return;
                }

                const newParentPath = [...path, targetFolder.name].join('/');

                if (confirm(`¬øMover "${draggedItem.data.title}" a la carpeta "${targetFolder.name}"?`)) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quizzes', draggedItem.id), {
                        parentPath: newParentPath
                    });
                }
                setDraggedItem(null);
            };

            const handleActivityClick = (gameType) => {
                if (gameType.isWordGame) {
                    const currentFolderId = path.join('/'); 
                    window.location.href = `dashboard.html?folderId=${encodeURIComponent(currentFolderId)}&type=${gameType.id}`;
                } else {
                    alert("Pr√≥ximamente");
                }
            };

            const navigateTo = (newPath) => {
                setPath(newPath);
                const url = new URL(window.location);
                if (newPath.length > 0) url.searchParams.set('folder', newPath.join('/')); else url.searchParams.delete('folder');
                window.history.pushState({}, '', url);
            };

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in min-h-screen text-slate-800">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-8 flex justify-between items-center sticky top-4 z-20">
                        <div className="flex items-center gap-3">
                            {path.length > 0 && <button onClick={() => navigateTo(path.slice(0, -1))} className="p-2 hover:bg-slate-100 rounded-xl text-slate-400 hover:text-indigo-600 transition-all"><ArrowLeft size={20}/></button>}
                            <h1 className="text-xl font-black flex items-center gap-2 tracking-tight text-indigo-600 uppercase">PERIPLO <span className="text-[10px] bg-indigo-100 px-2 rounded-full border border-indigo-200">v10.1</span></h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setModals({...modals, folder: true})} className="bg-slate-50 text-slate-600 px-4 py-2 rounded-xl font-bold flex gap-2 hover:bg-slate-100 border border-slate-200 transition-all text-sm items-center"><Plus size={16}/> Carpeta</button>
                            <button onClick={() => setModals({...modals, activity: true})} className="bg-indigo-600 text-white px-5 py-2 rounded-xl font-bold flex gap-2 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all text-sm items-center"><Plus size={16}/> Actividad</button>
                        </div>
                    </div>

                    <div className="flex gap-2 mb-6 text-xs font-bold text-slate-400 overflow-x-auto pb-2 uppercase tracking-widest">
                        <button onClick={() => navigateTo([])} className={`hover:text-indigo-600 transition-colors ${path.length===0?"text-indigo-600":""}`}>INICIO</button>
                        {path.map((f, i) => (<React.Fragment key={i}><span>/</span><button onClick={() => navigateTo(path.slice(0, i+1))} className="hover:text-indigo-600 transition-colors text-slate-600">{f}</button></React.Fragment>))}
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {/* CARPETAS */}
                        {userFolders.map((f) => (
                            <div 
                                key={f.id}
                                onDragOver={(e) => handleDragOver(e, f.id)}
                                onDragLeave={handleDragLeave}
                                onDrop={(e) => handleDrop(e, f)}
                                className={`relative group ${dragOverFolderId === f.id ? 'z-10' : ''}`}
                            >
                                <button 
                                    onClick={() => navigateTo([...path, f.name])} 
                                    className={`w-full aspect-[4/3] rounded-3xl flex flex-col items-center justify-center gap-3 shadow-sm border transition-all ${f.color || 'bg-white border-slate-100'} ${dragOverFolderId === f.id ? 'scale-110 border-indigo-500 ring-4 ring-indigo-100' : 'hover:border-indigo-300 hover:shadow-md hover:-translate-y-1'}`}
                                >
                                    <Folder size={32} className={`text-slate-400 ${dragOverFolderId === f.id ? 'text-indigo-600 scale-125 transition-transform' : ''}`}/>
                                    <span className="font-bold text-[11px] text-center px-4 uppercase tracking-wide text-slate-600 truncate w-full">{f.name}</span>
                                </button>
                                
                                <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={(e) => renameItem(e, f.id, 'folder', f.name)} className="p-1.5 bg-white rounded-full text-slate-400 hover:text-indigo-600 shadow-sm border border-slate-100"><Edit2 size={12}/></button>
                                    <button onClick={(e) => deleteItem(e, f.id, 'folder')} className="p-1.5 bg-white rounded-full text-slate-400 hover:text-rose-500 shadow-sm border border-slate-100"><Trash2 size={12}/></button>
                                </div>
                            </div>
                        ))}

                        {/* QUIZZES */}
                        {userQuizzes.map((q) => {
                            const info = GAME_TYPES.find(g => g.id === q.type) || GAME_TYPES[0];
                            const Icon = info.icon;
                            return (
                                <div 
                                    key={q.id} 
                                    draggable="true"
                                    onDragStart={(e) => handleDragStart(e, q, 'quiz')}
                                    onClick={() => window.location.href = `activity.html?id=${q.id}`} 
                                    className="relative group aspect-[4/3] bg-white rounded-3xl shadow-sm border border-slate-200 flex flex-col overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer"
                                >
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                        <button onClick={(e) => duplicateQuiz(e, q)} className="p-1.5 bg-white/90 backdrop-blur rounded-full text-slate-500 hover:text-blue-600 shadow-sm"><Copy size={12}/></button>
                                        <button onClick={(e) => renameItem(e, q.id, 'quiz', q.title)} className="p-1.5 bg-white/90 backdrop-blur rounded-full text-slate-500 hover:text-indigo-600 shadow-sm"><Edit2 size={12}/></button>
                                        <button onClick={(e) => deleteItem(e, q.id, 'quiz')} className="p-1.5 bg-white/90 backdrop-blur rounded-full text-slate-500 hover:text-rose-600 shadow-sm"><Trash2 size={12}/></button>
                                    </div>

                                    <div className={`h-1/2 ${info.color} flex items-center justify-center text-white relative overflow-hidden`}>
                                        <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-all"/>
                                        <Icon size={32} className="group-hover:scale-110 transition-transform"/>
                                    </div>
                                    <div className="p-4 flex-1 flex flex-col justify-between bg-white">
                                        <div className="font-bold text-sm leading-tight text-slate-700 line-clamp-2">{q.title}</div>
                                        <div className="text-[9px] text-slate-400 font-black uppercase tracking-widest">{info.name}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {userFolders.length === 0 && userQuizzes.length === 0 && <div className="text-center py-20 text-slate-300 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center gap-4"><div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center"><Folder size={32}/></div><p className="font-bold text-sm">Esta carpeta est√° vac√≠a</p></div>}

                    {modals.folder && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in zoom-in duration-200">
                            <div className="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-black text-xl mb-6 text-slate-800">Nueva Carpeta</h3>
                                <input id="fName" placeholder="Nombre..." className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 font-bold outline-none focus:border-indigo-500" autoFocus/>
                                <div className="flex gap-2"><button onClick={() => setModals({...modals, folder: false})} className="flex-1 py-3 text-slate-400 font-bold hover:bg-slate-50 rounded-xl">Cancelar</button><button onClick={() => createFolder(document.getElementById('fName').value)} className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-indigo-600">Crear</button></div>
                            </div>
                        </div>
                    )}

                    {modals.activity && (
                        <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in zoom-in duration-200">
                            <div className="bg-white rounded-[2rem] w-full max-w-4xl max-h-[85vh] flex flex-col overflow-hidden shadow-2xl">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10"><div><h3 className="font-black text-2xl text-slate-800">Elige plantilla</h3><p className="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">¬øQu√© vamos a crear hoy?</p></div><button onClick={() => setModals({...modals, activity: false})} className="w-10 h-10 rounded-full bg-slate-50 hover:bg-rose-50 hover:text-rose-500 transition-all flex items-center justify-center"><X size={20}/></button></div>
                                <div className="flex-1 overflow-y-auto p-8 bg-slate-50/50"><div className="grid grid-cols-2 md:grid-cols-3 gap-4">{GAME_TYPES.map(g => (<button key={g.id} onClick={() => handleActivityClick(g)} className="bg-white p-5 rounded-[1.5rem] border border-slate-100 hover:border-indigo-500 hover:shadow-xl hover:-translate-y-1 transition-all text-left flex flex-col gap-4 group relative overflow-hidden"><div className={`w-12 h-12 ${g.color} text-white rounded-2xl flex items-center justify-center shadow-md group-hover:scale-110 group-hover:rotate-3 transition-transform`}><g.icon size={24}/></div><div><div className="font-black text-slate-700 text-lg group-hover:text-indigo-600 transition-colors">{g.name}</div><div className="text-xs text-slate-400 font-medium mt-1">{g.desc}</div></div>{g.isWordGame && <div className="absolute top-4 right-4 text-[10px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded-lg font-black uppercase tracking-widest">IA</div>}</button>))}</div></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><Dashboard /></ErrorBoundary>);
    </script>
</body>
</html>
