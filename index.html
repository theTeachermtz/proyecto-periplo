<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Dashboard Constructor ðŸš§</title>
    
    <!-- LIBRERÃAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, 
            addDoc, query, where, orderBy
        } from 'firebase/firestore';
        import { 
            Folder, FileText, Plus, Home, ArrowLeft, X, Search, MoreVertical,
            Flame, BookOpen, Rocket, Puzzle, Grid, Mic, Library, HelpCircle,
            Gamepad2, Layers, Shuffle, Move, Edit3, Type, ListChecks,
            Globe, Languages, Headphones, Book, MessageCircle
        } from 'lucide-react';

        // --- 1. CONFIGURACIÃ“N ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        // --- 2. DATOS MAESTROS ---
        
        // Estructura fija inicial
        const BASE_STRUCTURE = {
            root: [
                { name: "INGLÃ‰S", color: "bg-blue-100 text-blue-600", icon: Globe },
                { name: "ESPAÃ‘OL", color: "bg-red-100 text-red-600", icon: Languages }
            ],
            "INGLÃ‰S": [
                { name: "CONVERSATIONS", color: "bg-white", icon: MessageCircle },
                { name: "GRAMMAR", color: "bg-white", icon: Puzzle },
                { name: "PRONUNCIATION", color: "bg-white", icon: Mic },
                { name: "READINGS", color: "bg-white", icon: Book },
                { name: "VOCABULARY", color: "bg-white", icon: Library }
            ],
            "ESPAÃ‘OL": [
                { name: "CONVERSACIONES", color: "bg-white", icon: MessageCircle },
                { name: "GRAMÃTICA", color: "bg-white", icon: Puzzle },
                { name: "PRONUNCIACIÃ“N", color: "bg-white", icon: Mic },
                { name: "LECTURAS", color: "bg-white", icon: Book },
                { name: "VOCABULARIO", color: "bg-white", icon: Library }
            ]
        };

        // Lista completa de juegos
        const GAME_TYPES = [
            { id: 'ALIEN', name: 'Alien Surfer', icon: Rocket, color: 'bg-purple-500', desc: 'Fly into correct answers' },
            { id: 'ANAGRAM', name: 'Anagram', icon: Type, color: 'bg-green-500', desc: 'Unscramble the word' },
            { id: 'FLASHCARDS', name: 'Flashcards', icon: BookOpen, color: 'bg-blue-500', desc: 'Study tool' },
            { id: 'HANGMAN', name: 'Hangman', icon: HelpCircle, color: 'bg-pink-500', desc: 'Guess the word' },
            { id: 'MYSTERY', name: 'Mystery Box', icon: Layers, color: 'bg-amber-500', desc: 'Tap to reveal' },
            { id: 'WHEEL', name: 'Spin the Wheel', icon: Move, color: 'bg-cyan-500', desc: 'Random selector' },
            { id: 'CROSSWORD', name: 'Crossword', icon: Grid, color: 'bg-emerald-500', desc: 'Solve clues' },
            { id: 'WORDSEARCH', name: 'Wordsearch', icon: Search, color: 'bg-indigo-500', desc: 'Find hidden words' },
            { id: 'MEMORAMA', name: 'Memorama', icon: Grid, color: 'bg-rose-500', desc: 'Matching pairs' },
            { id: 'FRUITS', name: 'Flying Fruits', icon: Rocket, color: 'bg-lime-500', desc: 'Tap correct answer' },
            { id: 'MATCH', name: 'Matching Defs', icon: ListChecks, color: 'bg-teal-500', desc: 'Keyword to definition' },
            { id: 'UNSCRAMBLE', name: 'Unscramble Sentence', icon: Shuffle, color: 'bg-orange-500', desc: 'Order the sentence' },
            { id: 'SPELL', name: 'Spell the Word', icon: Edit3, color: 'bg-fuchsia-500', desc: 'Type correctly' },
            { id: 'CLOZE', name: 'Complete Sentence', icon: Type, color: 'bg-sky-500', desc: 'Fill in blanks' },
            { id: 'SORT', name: 'Speed Sorting', icon: Layers, color: 'bg-violet-500', desc: 'Categorize fast' },
            { id: 'QUIZ', name: 'Quiz', icon: Flame, color: 'bg-red-500', desc: 'Classic multiple choice' },
            { id: 'VOLCANO', name: 'El VolcÃ¡n', icon: Flame, color: 'bg-orange-600', desc: 'Original Periplo Game' },
        ];

        const FOLDER_COLORS = [
            "bg-slate-100 text-slate-600", "bg-red-100 text-red-600", "bg-orange-100 text-orange-600",
            "bg-amber-100 text-amber-600", "bg-green-100 text-green-600", "bg-emerald-100 text-emerald-600",
            "bg-teal-100 text-teal-600", "bg-cyan-100 text-cyan-600", "bg-blue-100 text-blue-600",
            "bg-indigo-100 text-indigo-600", "bg-violet-100 text-violet-600", "bg-purple-100 text-purple-600",
            "bg-fuchsia-100 text-fuchsia-600", "bg-pink-100 text-pink-600", "bg-rose-100 text-rose-600"
        ];

        // --- 3. APP PRINCIPAL ---
        function PeriploApp() {
            // Usuario "Hardcoded" para modo construcciÃ³n
            const user = { uid: "teacher_builder_001", displayName: "Profe Constructor" };
            
            // Estados
            const [path, setPath] = useState([]); // Array de strings, ej: ["INGLÃ‰S", "VOCABULARY"]
            const [userFolders, setUserFolders] = useState([]);
            const [userQuizzes, setUserQuizzes] = useState([]);
            
            // Modales
            const [showFolderModal, setShowFolderModal] = useState(false);
            const [showActivityModal, setShowActivityModal] = useState(false);

            // Cargar datos reales de Firebase
            useEffect(() => {
                const currentPathStr = path.join('/');
                
                // 1. Cargar Carpetas creadas por usuario
                const qFolders = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'folders'),
                    where('parentPath', '==', currentPathStr)
                );
                const unsubFolders = onSnapshot(qFolders, (snap) => {
                    setUserFolders(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                // 2. Cargar Actividades creadas por usuario
                const qQuizzes = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'),
                    where('parentPath', '==', currentPathStr)
                );
                const unsubQuizzes = onSnapshot(qQuizzes, (snap) => {
                    setUserQuizzes(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                return () => { unsubFolders(); unsubQuizzes(); };
            }, [path, user.uid]);

            // Combinar carpetas fijas + carpetas de usuario
            const visibleItems = useMemo(() => {
                const currentPathStr = path.join('/');
                const baseItems = BASE_STRUCTURE[currentPathStr] || (path.length === 0 ? BASE_STRUCTURE.root : []);
                
                return {
                    folders: [...baseItems, ...userFolders],
                    quizzes: userQuizzes
                };
            }, [path, userFolders, userQuizzes]);

            // Handlers
            const handleCreateFolder = async (name, colorClass) => {
                if (!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), {
                    name,
                    color: colorClass,
                    parentPath: path.join('/'),
                    createdAt: serverTimestamp()
                });
                setShowFolderModal(false);
            };

            const handleCreateActivity = async (typeId, name) => {
                if (!name) return;
                const newQuiz = {
                    title: name,
                    type: typeId,
                    parentPath: path.join('/'),
                    createdAt: serverTimestamp(),
                    questions: [] // VacÃ­o por ahora
                };
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), newQuiz);
                setShowActivityModal(false);
                alert("Â¡Actividad creada! (AquÃ­ se abrirÃ¡ el editor en el futuro)");
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    {/* Header */}
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 text-white p-2 rounded-lg"><Share2 size={20}/></div>
                            <h1 className="text-xl font-bold text-slate-800">Periplo Dashboard</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-sm font-bold text-amber-600 bg-amber-50 px-3 py-1 rounded-full">Modo ConstrucciÃ³n ðŸš§</span>
                            <div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center font-bold text-slate-600">P</div>
                        </div>
                    </header>

                    {/* Main Area */}
                    <main className="flex-1 p-6 max-w-7xl mx-auto w-full">
                        
                        {/* Breadcrumbs */}
                        <div className="flex items-center gap-2 mb-8 text-sm text-slate-500 overflow-x-auto">
                            <button onClick={() => setPath([])} className={`flex items-center gap-1 hover:text-indigo-600 ${path.length===0 ? 'font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded':''}`}>
                                <Home size={16}/> Inicio
                            </button>
                            {path.map((folder, i) => (
                                <React.Fragment key={i}>
                                    <span className="opacity-50">/</span>
                                    <button onClick={() => setPath(path.slice(0, i+1))} className={`hover:text-indigo-600 whitespace-nowrap ${i===path.length-1 ? 'font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded':''}`}>
                                        {folder}
                                    </button>
                                </React.Fragment>
                            ))}
                        </div>

                        {/* Actions */}
                        <div className="flex gap-4 mb-6">
                            <button onClick={() => setShowFolderModal(true)} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 font-bold text-slate-700 shadow-sm transition-transform active:scale-95">
                                <Plus size={18}/> Nueva Carpeta
                            </button>
                            <button onClick={() => setShowActivityModal(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-md transition-transform active:scale-95">
                                <Plus size={18}/> Crear Actividad
                            </button>
                        </div>

                        {/* Grid Content */}
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            
                            {/* Render Folders */}
                            {visibleItems.folders.map((f, i) => {
                                const Icon = f.icon || Folder;
                                return (
                                    <button key={i} onClick={() => setPath([...path, f.name])} className={`aspect-[4/3] rounded-2xl flex flex-col items-center justify-center gap-3 shadow-sm border border-transparent hover:border-indigo-300 hover:shadow-md transition-all group ${f.color || 'bg-white'}`}>
                                        <Icon size={40} className="opacity-80 group-hover:scale-110 transition-transform"/>
                                        <span className="font-bold text-sm text-center px-2 leading-tight">{f.name}</span>
                                    </button>
                                );
                            })}

                            {/* Render Quizzes */}
                            {visibleItems.quizzes.map((q) => {
                                const gameInfo = GAME_TYPES.find(g => g.id === q.type) || GAME_TYPES[15];
                                const Icon = gameInfo.icon;
                                return (
                                    <div key={q.id} className="aspect-[4/3] bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:shadow-lg transition-all">
                                        <div className={`h-1/2 ${gameInfo.color} flex items-center justify-center text-white`}>
                                            <Icon size={32} />
                                        </div>
                                        <div className="p-3 flex-1 flex flex-col justify-between">
                                            <div className="font-bold text-sm text-slate-800 line-clamp-2">{q.title}</div>
                                            <div className="flex justify-between items-end">
                                                <span className="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-bold">{gameInfo.name}</span>
                                                <button className="text-slate-400 hover:text-indigo-600"><MoreVertical size={16}/></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {visibleItems.folders.length === 0 && visibleItems.quizzes.length === 0 && (
                            <div className="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                                <Folder size={48} className="mx-auto mb-2 opacity-20"/>
                                <p>Carpeta vacÃ­a</p>
                            </div>
                        )}
                    </main>

                    {/* MODAL: NUEVA CARPETA */}
                    {showFolderModal && (
                        <FolderModal onClose={() => setShowFolderModal(false)} onCreate={handleCreateFolder} colors={FOLDER_COLORS} />
                    )}

                    {/* MODAL: NUEVA ACTIVIDAD */}
                    {showActivityModal && (
                        <ActivityModal onClose={() => setShowActivityModal(false)} onCreate={handleCreateActivity} games={GAME_TYPES} />
                    )}

                </div>
            );
        }

        // --- SUBCOMPONENTES ---

        function FolderModal({ onClose, onCreate, colors }) {
            const [name, setName] = useState('');
            const [selectedColor, setSelectedColor] = useState(colors[0]);

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in-95">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">Nueva Carpeta</h3>
                            <button onClick={onClose}><X className="text-slate-400"/></button>
                        </div>
                        
                        <input value={name} onChange={e => setName(e.target.value)} placeholder="Nombre de la carpeta" className="w-full p-3 border border-slate-300 rounded-lg mb-4 font-bold text-lg outline-none focus:border-indigo-500" autoFocus />
                        
                        <div className="mb-6">
                            <p className="text-xs font-bold text-slate-400 mb-2 uppercase">Color de etiqueta</p>
                            <div className="grid grid-cols-5 gap-2">
                                {colors.map(c => (
                                    <button key={c} onClick={() => setSelectedColor(c)} className={`w-8 h-8 rounded-full ${c} border-2 ${selectedColor === c ? 'border-indigo-600 scale-110' : 'border-transparent'} transition-all`}></button>
                                ))}
                            </div>
                        </div>

                        <button onClick={() => onCreate(name, selectedColor)} disabled={!name} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg disabled:opacity-50 hover:bg-indigo-700">Crear Carpeta</button>
                    </div>
                </div>
            );
        }

        function ActivityModal({ onClose, onCreate, games }) {
            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-5xl h-[80vh] flex flex-col shadow-2xl animate-in zoom-in-95 overflow-hidden">
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="text-2xl font-black text-slate-800">Elige una plantilla</h3>
                                <p className="text-slate-500">Â¿QuÃ© quieres crear hoy?</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><X /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {games.map(game => (
                                    <button 
                                        key={game.id} 
                                        onClick={() => {
                                            const name = prompt(`TÃ­tulo para tu nuevo "${game.name}":`);
                                            if(name) onCreate(game.id, name);
                                        }}
                                        className="bg-white p-4 rounded-xl border-2 border-transparent hover:border-indigo-500 shadow-sm hover:shadow-xl transition-all group text-left flex flex-col gap-3"
                                    >
                                        <div className={`w-12 h-12 ${game.color} rounded-lg flex items-center justify-center text-white shadow-md group-hover:scale-110 transition-transform`}>
                                            <game.icon size={24} />
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800">{game.name}</div>
                                            <div className="text-xs text-slate-500 leading-tight mt-1">{game.desc}</div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PeriploApp />);
    </script>
</body>
</html>