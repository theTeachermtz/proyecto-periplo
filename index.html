<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Dashboard v3 (Blindado) üõ°Ô∏è</title>
    
    <!-- SISTEMA DE REPORTE DE ERRORES (Para que no se quede blanco) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.body.innerHTML = `
                <div style="background:red; color:white; padding:20px; font-family:sans-serif;">
                    <h1>‚ö†Ô∏è ALERTA DE ERROR</h1>
                    <p>No es tu culpa, es un error en el c√≥digo. M√°ndale esto a Gemini:</p>
                    <pre style="background:black; padding:10px; overflow:auto;">${msg}\nLine: ${line}</pre>
                </div>
            `;
        };
    </script>

    <!-- LIBRER√çAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp 
        } from 'firebase/firestore';
        // Importamos solo los √≠conos esenciales para evitar crash
        import { 
            Share2, Plus, Home, Folder, MoreVertical, Search, X, 
            Gamepad2, Layers, Zap, PenTool, LayoutGrid, Music, Image
        } from 'lucide-react';

        // 1. CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        // 2. LISTA DE JUEGOS (TU LISTA MAESTRA)
        const GAME_TYPES = [
            { id: 'VOLCANO', name: 'El Volc√°n', icon: FlameIcon, color: 'bg-orange-600', desc: 'Juego insignia' },
            { id: 'ALIEN', name: 'Alien Surfer', icon: RocketIcon, color: 'bg-purple-500', desc: 'Esquiva obst√°culos' },
            { id: 'ANAGRAM', name: 'Anagram', icon: TypeIcon, color: 'bg-green-500', desc: 'Ordena las letras' },
            { id: 'FLASHCARDS', name: 'Flashcards', icon: BookIcon, color: 'bg-blue-500', desc: 'Tarjetas de estudio' },
            { id: 'HANGMAN', name: 'Hangman', icon: HelpIcon, color: 'bg-pink-500', desc: 'Adivina la palabra' },
            { id: 'MYSTERY', name: 'Mystery Box', icon: BoxIcon, color: 'bg-amber-500', desc: 'Abre y descubre' },
            { id: 'WHEEL', name: 'Spin Wheel', icon: MoveIcon, color: 'bg-cyan-500', desc: 'Rueda de la fortuna' },
            { id: 'CROSSWORD', name: 'Crossword', icon: GridIcon, color: 'bg-emerald-500', desc: 'Crucigrama cl√°sico' },
            { id: 'WORDSEARCH', name: 'Wordsearch', icon: Search, color: 'bg-indigo-500', desc: 'Sopa de letras' },
            { id: 'MEMORAMA', name: 'Memorama', icon: GridIcon, color: 'bg-rose-500', desc: 'Pares iguales' },
            { id: 'FRUITS', name: 'Flying Fruits', icon: RocketIcon, color: 'bg-lime-500', desc: 'Corta la correcta' },
            { id: 'MATCH', name: 'Matching', icon: ListIcon, color: 'bg-teal-500', desc: 'Une con l√≠neas' },
            { id: 'UNSCRAMBLE', name: 'Unscramble', icon: ShuffleIcon, color: 'bg-orange-500', desc: 'Ordena la frase' },
            { id: 'SPELL', name: 'Spelling', icon: PenTool, color: 'bg-fuchsia-500', desc: 'Deletreo auditivo' },
            { id: 'CLOZE', name: 'Complete', icon: TypeIcon, color: 'bg-sky-500', desc: 'Rellena huecos' },
            { id: 'SORT', name: 'Sorting', icon: Layers, color: 'bg-violet-500', desc: 'Clasifica r√°pido' },
            { id: 'QUIZ', name: 'Quiz', icon: Zap, color: 'bg-red-500', desc: 'Examen r√°pido' },
        ];

        // 3. COMPONENTES DE √çCONOS (Para evitar errores de importaci√≥n masiva)
        function FlameIcon(p) { return <Zap {...p} /> }
        function RocketIcon(p) { return <Gamepad2 {...p} /> }
        function TypeIcon(p) { return <PenTool {...p} /> }
        function BookIcon(p) { return <LayoutGrid {...p} /> }
        function HelpIcon(p) { return <Search {...p} /> }
        function BoxIcon(p) { return <Layers {...p} /> }
        function MoveIcon(p) { return <Gamepad2 {...p} /> }
        function GridIcon(p) { return <LayoutGrid {...p} /> }
        function ListIcon(p) { return <MoreVertical {...p} /> }
        function ShuffleIcon(p) { return <Gamepad2 {...p} /> }

        // 4. ESTRUCTURA INICIAL
        const BASE_STRUCTURE = {
            root: [
                { name: "INGL√âS", color: "bg-blue-100 text-blue-600", icon: Folder },
                { name: "ESPA√ëOL", color: "bg-red-100 text-red-600", icon: Folder }
            ],
            "INGL√âS": [
                { name: "CONVERSATIONS", color: "bg-white", icon: Folder },
                { name: "GRAMMAR", color: "bg-white", icon: Folder },
                { name: "PRONUNCIATION", color: "bg-white", icon: Folder },
                { name: "READINGS", color: "bg-white", icon: Folder },
                { name: "VOCABULARY", color: "bg-white", icon: Folder }
            ],
            "INGL√âS/VOCABULARY": [
                { name: "VERBOS", color: "bg-white", icon: Folder },
                { name: "NOUNS", color: "bg-white", icon: Folder }
            ]
        };

        const FOLDER_COLORS = ["bg-slate-100", "bg-red-100", "bg-orange-100", "bg-green-100", "bg-blue-100", "bg-purple-100"];

        // --- 5. COMPONENTE PRINCIPAL ---
        function Dashboard() {
            // Usuario Constructor
            const user = { uid: "teacher_builder_001" };
            
            const [path, setPath] = useState([]);
            const [userFolders, setUserFolders] = useState([]);
            const [userQuizzes, setUserQuizzes] = useState([]);
            
            // Modales
            const [modals, setModals] = useState({ folder: false, activity: false });

            // Cargar datos
            useEffect(() => {
                const currentPathStr = path.join('/');
                
                // Cargar carpetas y quizzes (con try-catch silencioso)
                try {
                    const qF = query(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), where('parentPath', '==', currentPathStr));
                    const unsubF = onSnapshot(qF, (s) => setUserFolders(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    
                    const qQ = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), where('parentPath', '==', currentPathStr));
                    const unsubQ = onSnapshot(qQ, (s) => setUserQuizzes(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    
                    return () => { unsubF(); unsubQ(); };
                } catch(e) {
                    console.error("Error de conexi√≥n (probablemente reglas de Firebase)", e);
                }
            }, [path]);

            // Combinar items
            const items = useMemo(() => {
                const currentPathStr = path.join('/');
                const base = BASE_STRUCTURE[currentPathStr] || (path.length === 0 ? BASE_STRUCTURE.root : []);
                return { folders: [...base, ...userFolders], quizzes: userQuizzes };
            }, [path, userFolders, userQuizzes]);

            // Crear carpeta
            const createFolder = async (name, color) => {
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), {
                    name, color: color + " text-slate-700", parentPath: path.join('/'), createdAt: serverTimestamp()
                });
                setModals({...modals, folder: false});
            };

            // Crear Actividad
            const createActivity = async (typeId, name) => {
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), {
                    title: name, type: typeId, parentPath: path.join('/'), createdAt: serverTimestamp(), questions: []
                });
                setModals({...modals, activity: false});
                alert("¬°Actividad creada! Listo para editar.");
            };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h1 className="text-xl font-black text-slate-800 flex items-center gap-2">
                            <Share2 className="text-indigo-600"/> PERIPLO <span className="text-xs bg-amber-100 text-amber-700 px-2 rounded">BETA</span>
                        </h1>
                        <div className="flex gap-2">
                             <button onClick={() => setModals({...modals, folder: true})} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold flex gap-2 hover:bg-slate-200"><Plus size={20}/> Carpeta</button>
                             <button onClick={() => setModals({...modals, activity: true})} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2 hover:bg-indigo-700 shadow-lg"><Plus size={20}/> Actividad</button>
                        </div>
                    </div>

                    {/* Breadcrumbs */}
                    <div className="flex gap-2 mb-6 text-sm text-slate-500 overflow-x-auto">
                        <button onClick={() => setPath([])} className={path.length===0 ? "text-indigo-600 font-bold":""}>Inicio</button>
                        {path.map((f, i) => (
                            <React.Fragment key={i}>
                                <span>/</span>
                                <button onClick={() => setPath(path.slice(0, i+1))}>{f}</button>
                            </React.Fragment>
                        ))}
                    </div>

                    {/* Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {items.folders.map((f, i) => {
                            const Icon = f.icon || Folder;
                            return (
                                <button key={i} onClick={() => setPath([...path, f.name])} className={`aspect-[4/3] rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm border border-transparent hover:border-indigo-300 hover:shadow-md transition-all ${f.color || 'bg-white'}`}>
                                    <Icon size={32} className="opacity-70"/>
                                    <span className="font-bold text-sm text-center px-2">{f.name}</span>
                                </button>
                            )
                        })}
                        {items.quizzes.map((q) => {
                            const info = GAME_TYPES.find(g => g.id === q.type) || GAME_TYPES[0];
                            const Icon = info.icon;
                            return (
                                <div key={q.id} className="aspect-[4/3] bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:shadow-lg transition-all">
                                    <div className={`h-1/2 ${info.color} flex items-center justify-center text-white`}>
                                        <Icon size={28}/>
                                    </div>
                                    <div className="p-3 flex-1 flex flex-col justify-between">
                                        <div className="font-bold text-sm leading-tight">{q.title}</div>
                                        <div className="text-[10px] text-slate-400 font-bold uppercase">{info.name}</div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    {items.folders.length === 0 && items.quizzes.length === 0 && (
                        <div className="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                            <Folder size={48} className="mx-auto mb-2 opacity-20"/>
                            <p>Esta carpeta est√° vac√≠a.</p>
                        </div>
                    )}

                    {/* MODAL CARPETA */}
                    {modals.folder && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-lg mb-4">Nueva Carpeta</h3>
                                <input id="folderName" placeholder="Nombre..." className="w-full p-3 border rounded-lg mb-4 text-lg font-bold outline-none focus:border-indigo-500" autoFocus/>
                                <div className="flex gap-2 mb-4">
                                    {FOLDER_COLORS.map(c => <div key={c} className={`w-6 h-6 rounded-full ${c} border border-slate-200`}></div>)}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => createFolder(document.getElementById('folderName').value, FOLDER_COLORS[0])} className="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold">Crear</button>
                                    <button onClick={() => setModals({...modals, folder: false})} className="px-4 text-slate-400">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL ACTIVIDAD */}
                    {modals.activity && (
                        <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden shadow-2xl">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-xl">Elige una plantilla</h3>
                                    <button onClick={() => setModals({...modals, activity: false})}><X/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 bg-slate-100">
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                        {GAME_TYPES.map(g => (
                                            <button key={g.id} onClick={() => {
                                                const name = prompt("T√≠tulo de la actividad:");
                                                if(name) createActivity(g.id, name);
                                            }} className="bg-white p-4 rounded-xl border-2 border-transparent hover:border-indigo-500 hover:shadow-xl transition-all text-left flex flex-col gap-2 group">
                                                <div className={`w-10 h-10 ${g.color} text-white rounded-lg flex items-center justify-center shadow group-hover:scale-110 transition-transform`}>
                                                    <g.icon size={20}/>
                                                </div>
                                                <div>
                                                    <div className="font-bold text-slate-800 text-sm">{g.name}</div>
                                                    <div className="text-xs text-slate-500 leading-tight">{g.desc}</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>