<!DOCTYPE html>
<html lang="es">
<head>
<script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
      "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
    }
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - Dashboard v4 (Anti-Crash) üõ°Ô∏è</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); 
        body { font-family: 'Nunito', sans-serif; background-color: #f1f5f9; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from 'firebase/firestore';
        import { getAuth, signOut } from 'firebase/auth'; // Para limpiar sesiones viejas
        
        // √çCONOS
        import { 
            Share2, Plus, Home, Folder, MoreVertical, Search, X, 
            Flame, Rocket, PenTool, LayoutGrid, HelpCircle, Layers, 
            Move, Shuffle, List, AlertTriangle, RefreshCw
        } from 'lucide-react';

        // --- 1. CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        // Limpieza autom√°tica de fantasmas al iniciar
        try {
            const auth = getAuth(app);
            // No cerramos sesi√≥n forzoso para no alentar, pero preparamos el terreno
        } catch(e) { console.log("Limpieza auth saltada"); }

        // --- 2. ERROR BOUNDARY (EL PARACA√çDAS) ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            
            resetApp = () => {
                // Borrar cach√© local y recargar
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-red-50 p-6 text-center">
                            <AlertTriangle size={64} className="text-red-500 mb-4"/>
                            <h1 className="text-2xl font-black text-red-900 mb-2">¬°Ups! Algo se ator√≥.</h1>
                            <p className="text-red-700 mb-6 max-w-md">
                                Probablemente una sesi√≥n antigua choc√≥ con la nueva versi√≥n.
                                <br/><span className="text-xs opacity-70 font-mono">{this.state.error?.message}</span>
                            </p>
                            <button onClick={this.resetApp} className="bg-red-600 text-white px-8 py-4 rounded-xl font-bold flex items-center gap-2 hover:bg-red-700 shadow-lg">
                                <RefreshCw/> REINICIAR Y LIMPIAR
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- 3. DATOS ---
        const GAME_TYPES = [
            { id: 'VOLCANO', name: 'El Volc√°n', icon: Flame, color: 'bg-orange-600', desc: 'Juego insignia' },
            { id: 'ALIEN', name: 'Alien Surfer', icon: Rocket, color: 'bg-purple-500', desc: 'Esquiva obst√°culos' },
            { id: 'FLASHCARDS', name: 'Flashcards', icon: LayoutGrid, color: 'bg-blue-500', desc: 'Tarjetas' },
            { id: 'HANGMAN', name: 'Hangman', icon: HelpCircle, color: 'bg-pink-500', desc: 'Ahorcado' },
            { id: 'MYSTERY', name: 'Mystery Box', icon: Layers, color: 'bg-amber-500', desc: 'Caja Sorpresa' },
            { id: 'WHEEL', name: 'Spin Wheel', icon: Move, color: 'bg-cyan-500', desc: 'Rueda' },
            { id: 'QUIZ', name: 'Quiz', icon: HelpCircle, color: 'bg-red-500', desc: 'Examen' },
            // Agrega m√°s si quieres, reduje la lista para aligerar la carga inicial
        ];

        const BASE_STRUCTURE = {
            root: [
                { name: "INGL√âS", color: "bg-blue-100 text-blue-600" },
                { name: "ESPA√ëOL", color: "bg-red-100 text-red-600" }
            ],
            "INGL√âS": ["CONVERSATIONS", "GRAMMAR", "PRONUNCIATION", "READINGS", "VOCABULARY"],
            "ESPA√ëOL": ["CONVERSACIONES", "GRAM√ÅTICA", "PRONUNCIACI√ìN", "LECTURAS", "VOCABULARIO"],
            "INGL√âS/VOCABULARY": ["VERBOS", "NOUNS"]
        };

        const FOLDER_COLORS = ["bg-slate-100", "bg-red-100", "bg-orange-100", "bg-green-100", "bg-blue-100", "bg-purple-100"];

        // --- 4. APP PRINCIPAL ---
        function Dashboard() {
            // USUARIO CONSTRUCTOR (Hardcoded para estabilidad)
            const user = { uid: "teacher_builder_001" };
            
            const [path, setPath] = useState([]);
            const [userFolders, setUserFolders] = useState([]);
            const [userQuizzes, setUserQuizzes] = useState([]);
            const [modals, setModals] = useState({ folder: false, activity: false });

            // Carga de datos segura
            useEffect(() => {
                const currentPath = path.join('/');
                try {
                    const qF = query(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), where('parentPath', '==', currentPath));
                    const unsubF = onSnapshot(qF, (s) => setUserFolders(s.docs.map(d => ({id: d.id, ...d.data()}))));
                    
                    const qQ = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), where('parentPath', '==', currentPath));
                    const unsubQ = onSnapshot(qQ, (s) => setUserQuizzes(s.docs.map(d => ({id: d.id, ...d.data()}))));
                    
                    return () => { unsubF(); unsubQ(); };
                } catch (e) { console.error("Error Firebase:", e); }
            }, [path]);

            const visibleItems = useMemo(() => {
                const p = path.join('/');
                let base = BASE_STRUCTURE[p] || (path.length === 0 ? BASE_STRUCTURE.root : []);
                base = base.map(b => typeof b === 'string' ? { name: b, color: 'bg-white' } : b);
                return { folders: [...base, ...userFolders], quizzes: userQuizzes };
            }, [path, userFolders, userQuizzes]);

            // Acciones
            const createFolder = async (name, color) => {
                if(!name) return;
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'folders'), {
                    name, color: color + " text-slate-700", parentPath: path.join('/'), createdAt: serverTimestamp()
                });
                setModals({...modals, folder: false});
            };

            const createActivity = async (typeId, name) => {
                if(!name) return;
                // AQU√ç ES DONDE CONECTAREMOS EL EDITOR EN EL SIGUIENTE PASO
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), {
                    title: name, type: typeId, parentPath: path.join('/'), createdAt: serverTimestamp(), questions: []
                });
                setModals({...modals, activity: false});
                // Feedback visual simple
                alert(`¬°Actividad "${name}" creada con √©xito!`);
            };

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in">
                    {/* Header */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border mb-6 flex justify-between items-center sticky top-0 z-20">
                        <h1 className="text-xl font-bold flex items-center gap-2 text-slate-800">
                            <Share2 className="text-indigo-600"/> PERIPLO
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={() => setModals({...modals, folder: true})} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold flex gap-2 hover:bg-slate-200"><Plus size={20}/><span className="hidden md:inline">Carpeta</span></button>
                            <button onClick={() => setModals({...modals, activity: true})} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2 hover:bg-indigo-700 shadow"><Plus size={20}/><span className="hidden md:inline">Actividad</span></button>
                        </div>
                    </div>

                    {/* Breadcrumbs */}
                    <div className="flex gap-2 mb-6 text-sm text-slate-500 overflow-x-auto pb-2">
                        <button onClick={() => setPath([])} className={path.length===0?"text-indigo-600 font-bold":""}>Inicio</button>
                        {path.map((f, i) => (
                            <React.Fragment key={i}>
                                <span>/</span>
                                <button onClick={() => setPath(path.slice(0, i+1))} className="hover:text-indigo-600">{f}</button>
                            </React.Fragment>
                        ))}
                    </div>

                    {/* Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {visibleItems.folders.map((f, i) => (
                            <button key={i} onClick={() => setPath([...path, f.name])} className={`aspect-[4/3] rounded-2xl flex flex-col items-center justify-center gap-2 shadow-sm border border-transparent hover:border-indigo-300 hover:shadow-md transition-all ${f.color || 'bg-white'}`}>
                                <Folder size={32} className="opacity-60"/>
                                <span className="font-bold text-sm text-center px-2 leading-tight">{f.name}</span>
                            </button>
                        ))}
                        {visibleItems.quizzes.map((q) => {
                            const info = GAME_TYPES.find(g => g.id === q.type) || GAME_TYPES[0];
                            const Icon = info.icon;
                            return (
                                <div key={q.id} className="aspect-[4/3] bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden group hover:shadow-lg transition-all cursor-pointer">
                                    <div className={`h-1/2 ${info.color} flex items-center justify-center text-white`}>
                                        <Icon size={28}/>
                                    </div>
                                    <div className="p-3 flex-1 flex flex-col justify-between">
                                        <div className="font-bold text-sm leading-tight">{q.title}</div>
                                        <div className="text-[10px] text-slate-400 font-bold uppercase">{info.name}</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Estado Vac√≠o */}
                    {visibleItems.folders.length === 0 && visibleItems.quizzes.length === 0 && (
                        <div className="text-center py-20 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                            <Folder size={48} className="mx-auto mb-2 opacity-20"/>
                            <p>Carpeta vac√≠a</p>
                        </div>
                    )}

                    {/* MODAL CARPETA */}
                    {modals.folder && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                                <h3 className="font-bold text-lg mb-4">Nueva Carpeta</h3>
                                <input id="fName" placeholder="Nombre..." className="w-full p-3 border rounded-lg mb-4 font-bold outline-none focus:border-indigo-500" autoFocus/>
                                <div className="flex gap-2 mb-4">
                                    {FOLDER_COLORS.map(c => <button key={c} onClick={() => createFolder(document.getElementById('fName').value, c)} className={`w-8 h-8 rounded-full ${c} border hover:scale-110`}></button>)}
                                </div>
                                <button onClick={() => setModals({...modals, folder: false})} className="w-full py-2 text-slate-400">Cancelar</button>
                            </div>
                        </div>
                    )}

                    {/* MODAL ACTIVIDAD */}
                    {modals.activity && (
                        <div className="fixed inset-0 bg-slate-900/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden shadow-2xl">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                    <h3 className="font-bold text-xl">Elige plantilla</h3>
                                    <button onClick={() => setModals({...modals, activity: false})}><X/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {GAME_TYPES.map(g => (
                                            <button key={g.id} onClick={() => {
                                                const n = prompt("Nombre de la actividad:");
                                                if(n) createActivity(g.id, n);
                                            }} className="bg-white p-4 rounded-xl border-2 border-transparent hover:border-indigo-500 hover:shadow-xl transition-all text-left flex flex-col gap-3 group">
                                                <div className={`w-10 h-10 ${g.color} text-white rounded-lg flex items-center justify-center shadow group-hover:scale-110 transition-transform`}>
                                                    <g.icon size={20}/>
                                                </div>
                                                <div>
                                                    <div className="font-bold text-slate-800">{g.name}</div>
                                                    <div className="text-xs text-slate-500">{g.desc}</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <Dashboard />
            </ErrorBoundary>
        );
    </script>
</body>
</html>