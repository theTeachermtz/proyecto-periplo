<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Periplo - MODO CONSTRUCCI√ìN üöß</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <script type="module" src="https://esm.sh/run"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap'); body { font-family: 'Nunito', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        // NOTA: Quitamos Auth por ahora para trabajar en el interior
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, 
            addDoc, query, getDoc
        } from 'firebase/firestore';
        import { 
            Share2, UserCircle, Users, ArrowLeft, LogOut, Loader2, Play, Flame, 
            Folder, Edit, Plus, BookOpen, Lightbulb, Music, Home, Grid, FileText, CheckCircle
        } from 'lucide-react';

        // --- 1. CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyD4d-Kx1jQbgrKIdeOftv7BM729m7MIGPo",
            authDomain: "proyecto-periplo.firebaseapp.com",
            projectId: "proyecto-periplo",
            storageBucket: "proyecto-periplo.firebasestorage.app",
            messagingSenderId: "236795998392",
            appId: "1:236795998392:web:0da24b4f018611b55c844d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'periplo-app-v1';

        // --- USUARIO SIMULADO (LA LLAVE MAESTRA) ---
        const TEST_USER = {
            uid: "teacher_dev_mode_123",
            email: "israel@periplo.dev",
            displayName: "Profe Israel (Modo Constructor)"
        };

        const FOLDER_STRUCTURE = {
            root: ["INGL√âS", "ESPA√ëOL"],
            "INGL√âS": ["GRAMMAR", "VOCABULARY", "LISTENING"],
            "INGL√âS/VOCABULARY": ["VERBOS", "NOUNS"],
        };

        // --- APP PRINCIPAL ---
        function PeriploApp() {
            // Estado inicial: ¬°Ya estamos logueados!
            const [user, setUser] = useState(TEST_USER);
            const [profile, setProfile] = useState({ name: TEST_USER.displayName, role: 'TEACHER' });
            const [view, setView] = useState('TEACHER'); 
            const [activeQuiz, setActiveQuiz] = useState(null);
            const [gameCode, setGameCode] = useState('');

            // Router simple
            if (view === 'TEACHER') return <TeacherDashboard user={user} profile={profile} onLaunch={(q, c) => { setActiveQuiz(q); setGameCode(c); setView('GAME_HOST'); }} onEdit={(q) => { setActiveQuiz(q); setView('EDITOR'); }} />;
            if (view === 'GAME_HOST') return <VolcanoHost gameCode={gameCode} onExit={() => setView('TEACHER')} />;
            if (view === 'EDITOR') return <Editor initialData={activeQuiz} user={user} onBack={() => setView('TEACHER')} onSave={() => setView('TEACHER')} />;

            return <div>Vista no encontrada: {view}</div>;
        }

        // --- PISO 1: EL CREADOR (DASHBOARD) ---
        function TeacherDashboard({ user, profile, onLaunch, onEdit }) {
            const [path, setPath] = useState([]);
            const [quizzes, setQuizzes] = useState([]);
            const [loading, setLoading] = useState(true);

            // Cargar actividades
            useEffect(() => {
                console.log("Cargando actividades para:", user.uid);
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'));
                const unsub = onSnapshot(q, (snap) => {
                    const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.log("Actividades encontradas:", all);
                    setQuizzes(all.filter(quiz => quiz.path === path.join('/')));
                    setLoading(false);
                }, (error) => {
                    console.error("Error cargando actividades:", error);
                    alert("Error de base de datos: Revisa las REGLAS en Firebase (deben estar en true).");
                });
                return unsub;
            }, [user, path]);

            const currentSubfolders = useMemo(() => {
                const p = path.join('/');
                return FOLDER_STRUCTURE[p] || (path.length === 0 ? FOLDER_STRUCTURE.root : []);
            }, [path]);

            const handleCreate = async () => {
                const title = prompt("Nombre de la actividad nueva:");
                if(!title) return;

                const newQuiz = { 
                    title, 
                    path: path.join('/'), 
                    type: 'VOLCANO', 
                    questions: [], 
                    createdAt: serverTimestamp(), 
                    authorId: user.uid 
                };

                try {
                    console.log("Intentando crear actividad...", newQuiz);
                    const ref = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quizzes'), newQuiz);
                    console.log("¬°Actividad creada! ID:", ref.id);
                    // Abrir editor
                    onEdit({ ...newQuiz, id: ref.id });
                } catch (e) {
                    console.error("Error al crear:", e);
                    alert("No se pudo crear: " + e.message + "\n\nIMPORTANTE: Ve a Firebase > Firestore Database > Reglas y aseg√∫rate que digan 'allow read, write: if true;'");
                }
            };

            const launchGame = async (quiz) => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', `game_${code}`), {
                    hostId: user.uid, status: 'LOBBY', quizData: quiz, createdAt: serverTimestamp()
                });
                onLaunch(quiz, code);
            };

            return (
                <div className="min-h-screen bg-slate-100 p-6">
                    <div className="bg-yellow-200 text-yellow-800 px-4 py-2 rounded mb-4 text-center text-sm font-bold">
                        üöß MODO CONSTRUCTOR ACTIVO: Login autom√°tico como {user.displayName} üöß
                    </div>

                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-slate-800 flex gap-2"><Share2/> Nido de {profile?.name}</h1>
                    </header>

                    <div className="flex gap-2 mb-6 text-sm text-slate-500">
                        <button onClick={() => setPath([])} className={path.length===0 ? "font-bold text-indigo-600":""}><Home size={16}/></button>
                        {path.map((f, i) => <React.Fragment key={i}><span>/</span><button onClick={() => setPath(path.slice(0, i+1))}>{f}</button></React.Fragment>)}
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {/* BOT√ìN CREAR */}
                        <button onClick={handleCreate} className="p-6 border-2 border-dashed border-indigo-300 rounded-xl text-indigo-500 flex flex-col items-center justify-center hover:bg-indigo-50 font-bold transition-all active:scale-95">
                            <Plus size={32}/> <span>Crear Actividad</span>
                        </button>

                        {/* CARPETAS */}
                        {currentSubfolders.map(f => (
                            <button key={f} onClick={() => setPath([...path, f])} className="p-6 bg-white rounded-xl shadow border hover:shadow-lg flex flex-col items-center gap-2">
                                <Folder size={40} className="text-amber-400 fill-amber-400"/> <span className="font-bold">{f}</span>
                            </button>
                        ))}

                        {/* ACTIVIDADES */}
                        {loading ? <div className="p-4">Cargando...</div> : quizzes.map(q => (
                            <div key={q.id} className="p-4 bg-white rounded-xl shadow border flex flex-col gap-2 relative group">
                                <div className="font-bold flex items-center gap-2"><Flame className="text-orange-500"/> {q.title}</div>
                                <div className="text-xs text-slate-400">{q.questions?.length || 0} preguntas</div>
                                <div className="mt-auto flex gap-2">
                                    <button onClick={() => launchGame(q)} className="flex-1 bg-green-600 text-white text-xs font-bold py-2 rounded hover:bg-green-500">Jugar</button>
                                    <button onClick={() => onEdit(q)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 rounded"><Edit size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- EDITOR (Para probar guardar preguntas) ---
        function Editor({ initialData, user, onBack, onSave }) {
            const [questions, setQuestions] = useState(initialData.questions || []);

            const addQuestion = () => {
                setQuestions([...questions, { q: "Nueva Pregunta", options: ["A", "B", "C", "D"], correct: "A" }]);
            };

            const save = async () => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quizzes', initialData.id), { 
                        ...initialData, 
                        questions 
                    });
                    alert("¬°Guardado exitoso!");
                    onSave();
                } catch(e) {
                    alert("Error al guardar: " + e.message);
                }
            };

            return (
                <div className="min-h-screen bg-white p-6">
                    <div className="max-w-3xl mx-auto">
                        <button onClick={onBack} className="mb-4 text-slate-500 flex gap-2"><ArrowLeft/> Volver</button>
                        <h1 className="text-2xl font-bold mb-4">Editando: {initialData.title}</h1>
                        
                        <div className="space-y-4 mb-8">
                            {questions.map((q, i) => (
                                <div key={i} className="p-4 border rounded bg-slate-50">
                                    <div className="font-bold">Pregunta {i+1}</div>
                                    <input value={q.q} onChange={(e) => {
                                        const newQs = [...questions];
                                        newQs[i].q = e.target.value;
                                        setQuestions(newQs);
                                    }} className="w-full p-2 border rounded mt-2"/>
                                </div>
                            ))}
                        </div>

                        <button onClick={addQuestion} className="w-full py-3 border-2 border-dashed border-slate-300 text-slate-500 font-bold rounded mb-4 hover:bg-slate-50">+ Agregar Pregunta Manual</button>
                        
                        <button onClick={save} className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-green-500">Guardar Todo</button>
                    </div>
                </div>
            )
        }

        function VolcanoHost({ gameCode, onExit }) {
            return (
                <div className="h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-4 text-center">
                    <h1 className="text-4xl font-black text-orange-500 mb-2">LOBBY VOLC√ÅN</h1>
                    <div className="text-8xl font-mono font-black mb-8">{gameCode}</div>
                    <button onClick={onExit} className="text-slate-500">Salir</button>
                </div>
            )
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PeriploApp />);
    </script>
</body>
</html>